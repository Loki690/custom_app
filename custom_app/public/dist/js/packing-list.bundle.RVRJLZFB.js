(()=>{var mn=Object.create;var Me=Object.defineProperty,hn=Object.defineProperties,vn=Object.getOwnPropertyDescriptor,gn=Object.getOwnPropertyDescriptors,yn=Object.getOwnPropertyNames,Ft=Object.getOwnPropertySymbols,bn=Object.getPrototypeOf,Vt=Object.prototype.hasOwnProperty,wn=Object.prototype.propertyIsEnumerable;var Gt=(e,t,i)=>t in e?Me(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,z=(e,t)=>{for(var i in t||(t={}))Vt.call(t,i)&&Gt(e,i,t[i]);if(Ft)for(var i of Ft(t))wn.call(t,i)&&Gt(e,i,t[i]);return e},J=(e,t)=>hn(e,gn(t));var g=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var $n=(e,t,i,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of yn(t))!Vt.call(e,a)&&a!==i&&Me(e,a,{get:()=>t[a],enumerable:!(n=vn(t,a))||n.enumerable});return e};var Ht=(e,t,i)=>(i=e!=null?mn(bn(e)):{},$n(t||!e||!e.__esModule?Me(i,"default",{value:e,enumerable:!0}):i,e));var Kt=g((Be,Le)=>{(function(e,t){typeof Be=="object"&&typeof Le!="undefined"?Le.exports=t():typeof define=="function"&&define.amd?define(t()):e.onScan=t()})(Be,function(){var e={attachTo:function(t,i){if(t.scannerDetectionData!==void 0)throw new Error("onScan.js is already initialized for DOM element "+t);var n={onScan:function(a,r){},onScanError:function(a){},onKeyProcess:function(a,r){},onKeyDetect:function(a,r){},onPaste:function(a,r){},keyCodeMapper:function(a){return e.decodeKeyEvent(a)},onScanButtonLongPress:function(){},scanButtonKeyCode:!1,scanButtonLongPressTime:500,timeBeforeScanTest:100,avgTimeByChar:30,minLength:6,suffixKeyCodes:[9,13],prefixKeyCodes:[],ignoreIfFocusOn:!1,stopPropagation:!1,preventDefault:!1,captureEvents:!1,reactToKeydown:!0,reactToPaste:!1,singleScanQty:1};return i=this._mergeOptions(n,i),t.scannerDetectionData={options:i,vars:{firstCharTime:0,lastCharTime:0,accumulatedString:"",testTimer:!1,longPressTimeStart:0,longPressed:!1}},i.reactToPaste===!0&&t.addEventListener("paste",this._handlePaste,i.captureEvents),i.scanButtonKeyCode!==!1&&t.addEventListener("keyup",this._handleKeyUp,i.captureEvents),(i.reactToKeydown===!0||i.scanButtonKeyCode!==!1)&&t.addEventListener("keydown",this._handleKeyDown,i.captureEvents),this},detachFrom:function(t){t.scannerDetectionData.options.reactToPaste&&t.removeEventListener("paste",this._handlePaste),t.scannerDetectionData.options.scanButtonKeyCode!==!1&&t.removeEventListener("keyup",this._handleKeyUp),t.removeEventListener("keydown",this._handleKeyDown),t.scannerDetectionData=void 0},getOptions:function(t){return t.scannerDetectionData.options},setOptions:function(t,i){switch(t.scannerDetectionData.options.reactToPaste){case!0:i.reactToPaste===!1&&t.removeEventListener("paste",this._handlePaste);break;case!1:i.reactToPaste===!0&&t.addEventListener("paste",this._handlePaste);break}switch(t.scannerDetectionData.options.scanButtonKeyCode){case!1:i.scanButtonKeyCode!==!1&&t.addEventListener("keyup",this._handleKeyUp);break;default:i.scanButtonKeyCode===!1&&t.removeEventListener("keyup",this._handleKeyUp);break}return t.scannerDetectionData.options=this._mergeOptions(t.scannerDetectionData.options,i),this._reinitialize(t),this},decodeKeyEvent:function(t){var i=this._getNormalizedKeyNum(t);switch(!0){case(i>=48&&i<=90):case(i>=106&&i<=111):if(t.key!==void 0&&t.key!=="")return t.key;var n=String.fromCharCode(i);switch(t.shiftKey){case!1:n=n.toLowerCase();break;case!0:n=n.toUpperCase();break}return n;case(i>=96&&i<=105):return 0+(i-96)}return""},simulate:function(t,i){return this._reinitialize(t),Array.isArray(i)?i.forEach(function(n){var a={};(typeof n=="object"||typeof n=="function")&&n!==null?a=n:a.keyCode=parseInt(n);var r=new KeyboardEvent("keydown",a);document.dispatchEvent(r)}):this._validateScanCode(t,i),this},_reinitialize:function(t){var i=t.scannerDetectionData.vars;i.firstCharTime=0,i.lastCharTime=0,i.accumulatedString=""},_isFocusOnIgnoredElement:function(t){var i=t.scannerDetectionData.options.ignoreIfFocusOn;if(!i)return!1;var n=document.activeElement;if(Array.isArray(i)){for(var a=0;a<i.length;a++)if(n.matches(i[a])===!0)return!0}else if(n.matches(i))return!0;return!1},_validateScanCode:function(t,i){var n=t.scannerDetectionData,a=n.options,r=n.options.singleScanQty,o=n.vars.firstCharTime,s=n.vars.lastCharTime,h={},b;switch(!0){case i.length<a.minLength:h={message:"Receieved code is shorter then minimal length"};break;case s-o>i.length*a.avgTimeByChar:h={message:"Receieved code was not entered in time"};break;default:return a.onScan.call(t,i,r),b=new CustomEvent("scan",{detail:{scanCode:i,qty:r}}),t.dispatchEvent(b),e._reinitialize(t),!0}return h.scanCode=i,h.scanDuration=s-o,h.avgTimeByChar=a.avgTimeByChar,h.minLength=a.minLength,a.onScanError.call(t,h),b=new CustomEvent("scanError",{detail:h}),t.dispatchEvent(b),e._reinitialize(t),!1},_mergeOptions:function(t,i){var n={},a;for(a in t)Object.prototype.hasOwnProperty.call(t,a)&&(n[a]=t[a]);for(a in i)Object.prototype.hasOwnProperty.call(i,a)&&(n[a]=i[a]);return n},_getNormalizedKeyNum:function(t){return t.which||t.keyCode},_handleKeyDown:function(t){var i=e._getNormalizedKeyNum(t),n=this.scannerDetectionData.options,a=this.scannerDetectionData.vars,r=!1;if(n.onKeyDetect.call(this,i,t)!==!1&&!e._isFocusOnIgnoredElement(this)){if(n.scanButtonKeyCode!==!1&&i==n.scanButtonKeyCode){a.longPressed||(a.longPressTimer=setTimeout(n.onScanButtonLongPress,n.scanButtonLongPressTime,this),a.longPressed=!0);return}switch(!0){case(a.firstCharTime&&n.suffixKeyCodes.indexOf(i)!==-1):t.preventDefault(),t.stopImmediatePropagation(),r=!0;break;case(!a.firstCharTime&&n.prefixKeyCodes.indexOf(i)!==-1):t.preventDefault(),t.stopImmediatePropagation(),r=!1;break;default:var o=n.keyCodeMapper.call(this,t);if(o===null)return;a.accumulatedString+=o,n.preventDefault&&t.preventDefault(),n.stopPropagation&&t.stopImmediatePropagation(),r=!1;break}a.firstCharTime||(a.firstCharTime=Date.now()),a.lastCharTime=Date.now(),a.testTimer&&clearTimeout(a.testTimer),r?(e._validateScanCode(this,a.accumulatedString),a.testTimer=!1):a.testTimer=setTimeout(e._validateScanCode,n.timeBeforeScanTest,this,a.accumulatedString),n.onKeyProcess.call(this,o,t)}},_handlePaste:function(t){var i=this.scannerDetectionData.options,n=this.scannerDetectionData.vars,a=(event.clipboardData||window.clipboardData).getData("text");e._isFocusOnIgnoredElement(this)||(t.preventDefault(),i.stopPropagation&&t.stopImmediatePropagation(),i.onPaste.call(this,a,event),n.firstCharTime=0,n.lastCharTime=0,e._validateScanCode(this,a))},_handleKeyUp:function(t){if(!e._isFocusOnIgnoredElement(this)){var i=e._getNormalizedKeyNum(t);i==this.scannerDetectionData.options.scanButtonKeyCode&&(clearTimeout(this.scannerDetectionData.vars.longPressTimer),this.scannerDetectionData.vars.longPressed=!1)}},isScanInProgressFor:function(t){return t.scannerDetectionData.vars.firstCharTime>0},isAttachedTo:function(t){return t.scannerDetectionData!==void 0}};return e})});var B=g(Ne=>{"use strict";Object.defineProperty(Ne,"__esModule",{value:!0});function kn(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var xn=function e(t,i){kn(this,e),this.data=t,this.text=i.text||t,this.options=i};Ne.default=xn});var Wt=g(xe=>{"use strict";Object.defineProperty(xe,"__esModule",{value:!0});xe.CODE39=void 0;var On=function(){function e(t,i){for(var n=0;n<i.length;n++){var a=i[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),En=B(),Sn=Pn(En);function Pn(e){return e&&e.__esModule?e:{default:e}}function Cn(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Dn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t&&(typeof t=="object"||typeof t=="function")?t:e}function Tn(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var An=function(e){Tn(t,e);function t(i,n){return Cn(this,t),i=i.toUpperCase(),n.mod43&&(i+=Rn(Mn(i))),Dn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,i,n))}return On(t,[{key:"encode",value:function(){for(var n=ze("*"),a=0;a<this.data.length;a++)n+=ze(this.data[a])+"0";return n+=ze("*"),{data:n,text:this.text}}},{key:"valid",value:function(){return this.data.search(/^[0-9A-Z\-\.\ \$\/\+\%]+$/)!==-1}}]),t}(Sn.default),Ut=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","-","."," ","$","/","+","%","*"],qn=[20957,29783,23639,30485,20951,29813,23669,20855,29789,23645,29975,23831,30533,22295,30149,24005,21623,29981,23837,22301,30023,23879,30545,22343,30161,24017,21959,30065,23921,22385,29015,18263,29141,17879,29045,18293,17783,29021,18269,17477,17489,17681,20753,35770];function ze(e){return In(Xt(e))}function In(e){return qn[e].toString(2)}function Rn(e){return Ut[e]}function Xt(e){return Ut.indexOf(e)}function Mn(e){for(var t=0,i=0;i<e.length;i++)t+=Xt(e[i]);return t=t%43,t}xe.CODE39=An});var ee=g(D=>{"use strict";Object.defineProperty(D,"__esModule",{value:!0});var de;function je(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}var Yt=D.SET_A=0,Qt=D.SET_B=1,Jt=D.SET_C=2,ul=D.SHIFT=98,Bn=D.START_A=103,Ln=D.START_B=104,Nn=D.START_C=105,fl=D.MODULO=103,pl=D.STOP=106,ml=D.FNC1=207,hl=D.SET_BY_CODE=(de={},je(de,Bn,Yt),je(de,Ln,Qt),je(de,Nn,Jt),de),vl=D.SWAP={101:Yt,100:Qt,99:Jt},gl=D.A_START_CHAR=String.fromCharCode(208),yl=D.B_START_CHAR=String.fromCharCode(209),bl=D.C_START_CHAR=String.fromCharCode(210),wl=D.A_CHARS="[\0-_\xC8-\xCF]",$l=D.B_CHARS="[ -\x7F\xC8-\xCF]",kl=D.C_CHARS="(\xCF*[0-9]{2}\xCF*)",xl=D.BARS=[11011001100,11001101100,11001100110,10010011e3,10010001100,10001001100,10011001e3,10011000100,10001100100,11001001e3,11001000100,11000100100,10110011100,10011011100,10011001110,10111001100,10011101100,10011100110,11001110010,11001011100,11001001110,11011100100,11001110100,11101101110,11101001100,11100101100,11100100110,11101100100,11100110100,11100110010,11011011e3,11011000110,11000110110,10100011e3,10001011e3,10001000110,10110001e3,10001101e3,10001100010,11010001e3,11000101e3,11000100010,10110111e3,10110001110,10001101110,10111011e3,10111000110,10001110110,11101110110,11010001110,11000101110,11011101e3,11011100010,11011101110,11101011e3,11101000110,11100010110,11101101e3,11101100010,11100011010,11101111010,11001000010,11110001010,1010011e4,10100001100,1001011e4,10010000110,10000101100,10000100110,1011001e4,10110000100,1001101e4,10011000010,10000110100,10000110010,11000010010,1100101e4,11110111010,11000010100,10001111010,10100111100,10010111100,10010011110,10111100100,10011110100,10011110010,11110100100,11110010100,11110010010,11011011110,11011110110,11110110110,10101111e3,10100011110,10001011110,10111101e3,10111100010,11110101e3,11110100010,10111011110,10111101110,11101011110,11110101110,11010000100,1101001e4,11010011100,1100011101011]});var _e=g(Fe=>{"use strict";Object.defineProperty(Fe,"__esModule",{value:!0});var zn=function(){function e(t,i){for(var n=0;n<i.length;n++){var a=i[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),jn=B(),Fn=Gn(jn),L=ee();function Gn(e){return e&&e.__esModule?e:{default:e}}function Vn(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Hn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t&&(typeof t=="object"||typeof t=="function")?t:e}function Kn(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var Un=function(e){Kn(t,e);function t(i,n){Vn(this,t);var a=Hn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,i.substring(1),n));return a.bytes=i.split("").map(function(r){return r.charCodeAt(0)}),a}return zn(t,[{key:"valid",value:function(){return/^[\x00-\x7F\xC8-\xD3]+$/.test(this.data)}},{key:"encode",value:function(){var n=this.bytes,a=n.shift()-105,r=L.SET_BY_CODE[a];if(r===void 0)throw new RangeError("The encoding does not start with a start character.");this.shouldEncodeAsEan128()===!0&&n.unshift(L.FNC1);var o=t.next(n,1,r);return{text:this.text===this.data?this.text.replace(/[^\x20-\x7E]/g,""):this.text,data:t.getBar(a)+o.result+t.getBar((o.checksum+a)%L.MODULO)+t.getBar(L.STOP)}}},{key:"shouldEncodeAsEan128",value:function(){var n=this.options.ean128||!1;return typeof n=="string"&&(n=n.toLowerCase()==="true"),n}}],[{key:"getBar",value:function(n){return L.BARS[n]?L.BARS[n].toString():""}},{key:"correctIndex",value:function(n,a){if(a===L.SET_A){var r=n.shift();return r<32?r+64:r-32}else return a===L.SET_B?n.shift()-32:(n.shift()-48)*10+n.shift()-48}},{key:"next",value:function(n,a,r){if(!n.length)return{result:"",checksum:0};var o=void 0,s=void 0;if(n[0]>=200){s=n.shift()-105;var h=L.SWAP[s];h!==void 0?o=t.next(n,a+1,h):((r===L.SET_A||r===L.SET_B)&&s===L.SHIFT&&(n[0]=r===L.SET_A?n[0]>95?n[0]-96:n[0]:n[0]<32?n[0]+96:n[0]),o=t.next(n,a+1,r))}else s=t.correctIndex(n,r),o=t.next(n,a+1,r);var b=t.getBar(s),v=s*a;return{result:b+o.result,checksum:v+o.checksum}}}]),t}(Fn.default);Fe.default=Un});var ni=g(Ve=>{"use strict";Object.defineProperty(Ve,"__esModule",{value:!0});var W=ee(),Zt=function(t){return t.match(new RegExp("^"+W.A_CHARS+"*"))[0].length},ei=function(t){return t.match(new RegExp("^"+W.B_CHARS+"*"))[0].length},ti=function(t){return t.match(new RegExp("^"+W.C_CHARS+"*"))[0]};function Ge(e,t){var i=t?W.A_CHARS:W.B_CHARS,n=e.match(new RegExp("^("+i+"+?)(([0-9]{2}){2,})([^0-9]|$)"));if(n)return n[1]+String.fromCharCode(204)+ii(e.substring(n[1].length));var a=e.match(new RegExp("^"+i+"+"))[0];return a.length===e.length?e:a+String.fromCharCode(t?205:206)+Ge(e.substring(a.length),!t)}function ii(e){var t=ti(e),i=t.length;if(i===e.length)return e;e=e.substring(i);var n=Zt(e)>=ei(e);return t+String.fromCharCode(n?206:205)+Ge(e,n)}Ve.default=function(e){var t=void 0,i=ti(e).length;if(i>=2)t=W.C_START_CHAR+ii(e);else{var n=Zt(e)>ei(e);t=(n?W.A_START_CHAR:W.B_START_CHAR)+Ge(e,n)}return t.replace(/[\xCD\xCE]([^])[\xCD\xCE]/,function(a,r){return String.fromCharCode(203)+r})}});var ri=g(Ke=>{"use strict";Object.defineProperty(Ke,"__esModule",{value:!0});var Xn=_e(),Wn=ai(Xn),Yn=ni(),Qn=ai(Yn);function ai(e){return e&&e.__esModule?e:{default:e}}function Jn(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function He(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t&&(typeof t=="object"||typeof t=="function")?t:e}function Zn(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var ea=function(e){Zn(t,e);function t(i,n){if(Jn(this,t),/^[\x00-\x7F\xC8-\xD3]+$/.test(i))var a=He(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,(0,Qn.default)(i),n));else var a=He(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,i,n));return He(a)}return t}(Wn.default);Ke.default=ea});var si=g(Ue=>{"use strict";Object.defineProperty(Ue,"__esModule",{value:!0});var ta=function(){function e(t,i){for(var n=0;n<i.length;n++){var a=i[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),ia=_e(),na=aa(ia),oi=ee();function aa(e){return e&&e.__esModule?e:{default:e}}function ra(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function oa(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t&&(typeof t=="object"||typeof t=="function")?t:e}function sa(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var ca=function(e){sa(t,e);function t(i,n){return ra(this,t),oa(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,oi.A_START_CHAR+i,n))}return ta(t,[{key:"valid",value:function(){return new RegExp("^"+oi.A_CHARS+"+$").test(this.data)}}]),t}(na.default);Ue.default=ca});var li=g(Xe=>{"use strict";Object.defineProperty(Xe,"__esModule",{value:!0});var la=function(){function e(t,i){for(var n=0;n<i.length;n++){var a=i[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),da=_e(),_a=ua(da),ci=ee();function ua(e){return e&&e.__esModule?e:{default:e}}function fa(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function pa(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t&&(typeof t=="object"||typeof t=="function")?t:e}function ma(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var ha=function(e){ma(t,e);function t(i,n){return fa(this,t),pa(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,ci.B_START_CHAR+i,n))}return la(t,[{key:"valid",value:function(){return new RegExp("^"+ci.B_CHARS+"+$").test(this.data)}}]),t}(_a.default);Xe.default=ha});var _i=g(We=>{"use strict";Object.defineProperty(We,"__esModule",{value:!0});var va=function(){function e(t,i){for(var n=0;n<i.length;n++){var a=i[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),ga=_e(),ya=ba(ga),di=ee();function ba(e){return e&&e.__esModule?e:{default:e}}function wa(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function $a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t&&(typeof t=="object"||typeof t=="function")?t:e}function ka(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var xa=function(e){ka(t,e);function t(i,n){return wa(this,t),$a(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,di.C_START_CHAR+i,n))}return va(t,[{key:"valid",value:function(){return new RegExp("^"+di.C_CHARS+"+$").test(this.data)}}]),t}(ya.default);We.default=xa});var ui=g(V=>{"use strict";Object.defineProperty(V,"__esModule",{value:!0});V.CODE128C=V.CODE128B=V.CODE128A=V.CODE128=void 0;var Oa=ri(),Ea=Oe(Oa),Sa=si(),Pa=Oe(Sa),Ca=li(),Da=Oe(Ca),Ta=_i(),Aa=Oe(Ta);function Oe(e){return e&&e.__esModule?e:{default:e}}V.CODE128=Ea.default;V.CODE128A=Pa.default;V.CODE128B=Da.default;V.CODE128C=Aa.default});var te=g(Y=>{"use strict";Object.defineProperty(Y,"__esModule",{value:!0});var ql=Y.SIDE_BIN="101",Il=Y.MIDDLE_BIN="01010",Rl=Y.BINARIES={L:["0001101","0011001","0010011","0111101","0100011","0110001","0101111","0111011","0110111","0001011"],G:["0100111","0110011","0011011","0100001","0011101","0111001","0000101","0010001","0001001","0010111"],R:["1110010","1100110","1101100","1000010","1011100","1001110","1010000","1000100","1001000","1110100"],O:["0001101","0011001","0010011","0111101","0100011","0110001","0101111","0111011","0110111","0001011"],E:["0100111","0110011","0011011","0100001","0011101","0111001","0000101","0010001","0001001","0010111"]},Ml=Y.EAN2_STRUCTURE=["LL","LG","GL","GG"],Bl=Y.EAN5_STRUCTURE=["GGLLL","GLGLL","GLLGL","GLLLG","LGGLL","LLGGL","LLLGG","LGLGL","LGLLG","LLGLG"],Ll=Y.EAN13_STRUCTURE=["LLLLLL","LLGLGG","LLGGLG","LLGGGL","LGLLGG","LGGLLG","LGGGLL","LGLGLG","LGLGGL","LGGLGL"]});var ie=g(Ye=>{"use strict";Object.defineProperty(Ye,"__esModule",{value:!0});var qa=te(),Ia=function(t,i,n){var a=t.split("").map(function(o,s){return qa.BINARIES[i[s]]}).map(function(o,s){return o?o[t[s]]:""});if(n){var r=t.length-1;a=a.map(function(o,s){return s<r?o+n:o})}return a.join("")};Ye.default=Ia});var Je=g(Qe=>{"use strict";Object.defineProperty(Qe,"__esModule",{value:!0});var Ra=function(){function e(t,i){for(var n=0;n<i.length;n++){var a=i[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),ne=te(),Ma=ie(),fi=pi(Ma),Ba=B(),La=pi(Ba);function pi(e){return e&&e.__esModule?e:{default:e}}function Na(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function za(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t&&(typeof t=="object"||typeof t=="function")?t:e}function ja(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var Fa=function(e){ja(t,e);function t(i,n){Na(this,t);var a=za(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,i,n));return a.fontSize=!n.flat&&n.fontSize>n.width*10?n.width*10:n.fontSize,a.guardHeight=n.height+a.fontSize/2+n.textMargin,a}return Ra(t,[{key:"encode",value:function(){return this.options.flat?this.encodeFlat():this.encodeGuarded()}},{key:"leftText",value:function(n,a){return this.text.substr(n,a)}},{key:"leftEncode",value:function(n,a){return(0,fi.default)(n,a)}},{key:"rightText",value:function(n,a){return this.text.substr(n,a)}},{key:"rightEncode",value:function(n,a){return(0,fi.default)(n,a)}},{key:"encodeGuarded",value:function(){var n={fontSize:this.fontSize},a={height:this.guardHeight};return[{data:ne.SIDE_BIN,options:a},{data:this.leftEncode(),text:this.leftText(),options:n},{data:ne.MIDDLE_BIN,options:a},{data:this.rightEncode(),text:this.rightText(),options:n},{data:ne.SIDE_BIN,options:a}]}},{key:"encodeFlat",value:function(){var n=[ne.SIDE_BIN,this.leftEncode(),ne.MIDDLE_BIN,this.rightEncode(),ne.SIDE_BIN];return{data:n.join(""),text:this.text}}}]),t}(La.default);Qe.default=Fa});var hi=g(Ze=>{"use strict";Object.defineProperty(Ze,"__esModule",{value:!0});var Ga=function(){function e(t,i){for(var n=0;n<i.length;n++){var a=i[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),ue=function e(t,i,n){t===null&&(t=Function.prototype);var a=Object.getOwnPropertyDescriptor(t,i);if(a===void 0){var r=Object.getPrototypeOf(t);return r===null?void 0:e(r,i,n)}else{if("value"in a)return a.value;var o=a.get;return o===void 0?void 0:o.call(n)}},Va=te(),Ha=Je(),Ka=Ua(Ha);function Ua(e){return e&&e.__esModule?e:{default:e}}function Xa(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Wa(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t&&(typeof t=="object"||typeof t=="function")?t:e}function Ya(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var mi=function(t){var i=t.substr(0,12).split("").map(function(n){return+n}).reduce(function(n,a,r){return r%2?n+a*3:n+a},0);return(10-i%10)%10},Qa=function(e){Ya(t,e);function t(i,n){Xa(this,t),i.search(/^[0-9]{12}$/)!==-1&&(i+=mi(i));var a=Wa(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,i,n));return a.lastChar=n.lastChar,a}return Ga(t,[{key:"valid",value:function(){return this.data.search(/^[0-9]{13}$/)!==-1&&+this.data[12]===mi(this.data)}},{key:"leftText",value:function(){return ue(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"leftText",this).call(this,1,6)}},{key:"leftEncode",value:function(){var n=this.data.substr(1,6),a=Va.EAN13_STRUCTURE[this.data[0]];return ue(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"leftEncode",this).call(this,n,a)}},{key:"rightText",value:function(){return ue(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"rightText",this).call(this,7,6)}},{key:"rightEncode",value:function(){var n=this.data.substr(7,6);return ue(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"rightEncode",this).call(this,n,"RRRRRR")}},{key:"encodeGuarded",value:function(){var n=ue(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"encodeGuarded",this).call(this);return this.options.displayValue&&(n.unshift({data:"000000000000",text:this.text.substr(0,1),options:{textAlign:"left",fontSize:this.fontSize}}),this.options.lastChar&&(n.push({data:"00"}),n.push({data:"00000",text:this.options.lastChar,options:{fontSize:this.fontSize}}))),n}}]),t}(Ka.default);Ze.default=Qa});var gi=g(et=>{"use strict";Object.defineProperty(et,"__esModule",{value:!0});var Ja=function(){function e(t,i){for(var n=0;n<i.length;n++){var a=i[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),Ee=function e(t,i,n){t===null&&(t=Function.prototype);var a=Object.getOwnPropertyDescriptor(t,i);if(a===void 0){var r=Object.getPrototypeOf(t);return r===null?void 0:e(r,i,n)}else{if("value"in a)return a.value;var o=a.get;return o===void 0?void 0:o.call(n)}},Za=Je(),er=tr(Za);function tr(e){return e&&e.__esModule?e:{default:e}}function ir(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function nr(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t&&(typeof t=="object"||typeof t=="function")?t:e}function ar(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var vi=function(t){var i=t.substr(0,7).split("").map(function(n){return+n}).reduce(function(n,a,r){return r%2?n+a:n+a*3},0);return(10-i%10)%10},rr=function(e){ar(t,e);function t(i,n){return ir(this,t),i.search(/^[0-9]{7}$/)!==-1&&(i+=vi(i)),nr(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,i,n))}return Ja(t,[{key:"valid",value:function(){return this.data.search(/^[0-9]{8}$/)!==-1&&+this.data[7]===vi(this.data)}},{key:"leftText",value:function(){return Ee(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"leftText",this).call(this,0,4)}},{key:"leftEncode",value:function(){var n=this.data.substr(0,4);return Ee(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"leftEncode",this).call(this,n,"LLLL")}},{key:"rightText",value:function(){return Ee(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"rightText",this).call(this,4,4)}},{key:"rightEncode",value:function(){var n=this.data.substr(4,4);return Ee(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"rightEncode",this).call(this,n,"RRRR")}}]),t}(er.default);et.default=rr});var bi=g(tt=>{"use strict";Object.defineProperty(tt,"__esModule",{value:!0});var or=function(){function e(t,i){for(var n=0;n<i.length;n++){var a=i[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),sr=te(),cr=ie(),lr=yi(cr),dr=B(),_r=yi(dr);function yi(e){return e&&e.__esModule?e:{default:e}}function ur(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function fr(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t&&(typeof t=="object"||typeof t=="function")?t:e}function pr(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var mr=function(t){var i=t.split("").map(function(n){return+n}).reduce(function(n,a,r){return r%2?n+a*9:n+a*3},0);return i%10},hr=function(e){pr(t,e);function t(i,n){return ur(this,t),fr(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,i,n))}return or(t,[{key:"valid",value:function(){return this.data.search(/^[0-9]{5}$/)!==-1}},{key:"encode",value:function(){var n=sr.EAN5_STRUCTURE[mr(this.data)];return{data:"1011"+(0,lr.default)(this.data,n,"01"),text:this.text}}}]),t}(_r.default);tt.default=hr});var $i=g(it=>{"use strict";Object.defineProperty(it,"__esModule",{value:!0});var vr=function(){function e(t,i){for(var n=0;n<i.length;n++){var a=i[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),gr=te(),yr=ie(),br=wi(yr),wr=B(),$r=wi(wr);function wi(e){return e&&e.__esModule?e:{default:e}}function kr(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function xr(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t&&(typeof t=="object"||typeof t=="function")?t:e}function Or(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var Er=function(e){Or(t,e);function t(i,n){return kr(this,t),xr(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,i,n))}return vr(t,[{key:"valid",value:function(){return this.data.search(/^[0-9]{2}$/)!==-1}},{key:"encode",value:function(){var n=gr.EAN2_STRUCTURE[parseInt(this.data)%4];return{data:"1011"+(0,br.default)(this.data,n,"01"),text:this.text}}}]),t}($r.default);it.default=Er});var at=g(Se=>{"use strict";Object.defineProperty(Se,"__esModule",{value:!0});var Sr=function(){function e(t,i){for(var n=0;n<i.length;n++){var a=i[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();Se.checksum=nt;var Pr=ie(),ae=ki(Pr),Cr=B(),Dr=ki(Cr);function ki(e){return e&&e.__esModule?e:{default:e}}function Tr(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Ar(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t&&(typeof t=="object"||typeof t=="function")?t:e}function qr(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var Ir=function(e){qr(t,e);function t(i,n){Tr(this,t),i.search(/^[0-9]{11}$/)!==-1&&(i+=nt(i));var a=Ar(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,i,n));return a.displayValue=n.displayValue,n.fontSize>n.width*10?a.fontSize=n.width*10:a.fontSize=n.fontSize,a.guardHeight=n.height+a.fontSize/2+n.textMargin,a}return Sr(t,[{key:"valid",value:function(){return this.data.search(/^[0-9]{12}$/)!==-1&&this.data[11]==nt(this.data)}},{key:"encode",value:function(){return this.options.flat?this.flatEncoding():this.guardedEncoding()}},{key:"flatEncoding",value:function(){var n="";return n+="101",n+=(0,ae.default)(this.data.substr(0,6),"LLLLLL"),n+="01010",n+=(0,ae.default)(this.data.substr(6,6),"RRRRRR"),n+="101",{data:n,text:this.text}}},{key:"guardedEncoding",value:function(){var n=[];return this.displayValue&&n.push({data:"00000000",text:this.text.substr(0,1),options:{textAlign:"left",fontSize:this.fontSize}}),n.push({data:"101"+(0,ae.default)(this.data[0],"L"),options:{height:this.guardHeight}}),n.push({data:(0,ae.default)(this.data.substr(1,5),"LLLLL"),text:this.text.substr(1,5),options:{fontSize:this.fontSize}}),n.push({data:"01010",options:{height:this.guardHeight}}),n.push({data:(0,ae.default)(this.data.substr(6,5),"RRRRR"),text:this.text.substr(6,5),options:{fontSize:this.fontSize}}),n.push({data:(0,ae.default)(this.data[11],"R")+"101",options:{height:this.guardHeight}}),this.displayValue&&n.push({data:"00000000",text:this.text.substr(11,1),options:{textAlign:"right",fontSize:this.fontSize}}),n}}]),t}(Dr.default);function nt(e){var t=0,i;for(i=1;i<11;i+=2)t+=parseInt(e[i]);for(i=0;i<11;i+=2)t+=parseInt(e[i])*3;return(10-t%10)%10}Se.default=Ir});var Ei=g(ot=>{"use strict";Object.defineProperty(ot,"__esModule",{value:!0});var Rr=function(){function e(t,i){for(var n=0;n<i.length;n++){var a=i[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),Mr=ie(),Br=Oi(Mr),Lr=B(),Nr=Oi(Lr),zr=at();function Oi(e){return e&&e.__esModule?e:{default:e}}function jr(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function rt(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t&&(typeof t=="object"||typeof t=="function")?t:e}function Fr(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var Gr=["XX00000XXX","XX10000XXX","XX20000XXX","XXX00000XX","XXXX00000X","XXXXX00005","XXXXX00006","XXXXX00007","XXXXX00008","XXXXX00009"],Vr=[["EEEOOO","OOOEEE"],["EEOEOO","OOEOEE"],["EEOOEO","OOEEOE"],["EEOOOE","OOEEEO"],["EOEEOO","OEOOEE"],["EOOEEO","OEEOOE"],["EOOOEE","OEEEOO"],["EOEOEO","OEOEOE"],["EOEOOE","OEOEEO"],["EOOEOE","OEEOEO"]],Hr=function(e){Fr(t,e);function t(i,n){jr(this,t);var a=rt(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,i,n));if(a.isValid=!1,i.search(/^[0-9]{6}$/)!==-1)a.middleDigits=i,a.upcA=xi(i,"0"),a.text=n.text||""+a.upcA[0]+i+a.upcA[a.upcA.length-1],a.isValid=!0;else if(i.search(/^[01][0-9]{7}$/)!==-1)if(a.middleDigits=i.substring(1,i.length-1),a.upcA=xi(a.middleDigits,i[0]),a.upcA[a.upcA.length-1]===i[i.length-1])a.isValid=!0;else return rt(a);else return rt(a);return a.displayValue=n.displayValue,n.fontSize>n.width*10?a.fontSize=n.width*10:a.fontSize=n.fontSize,a.guardHeight=n.height+a.fontSize/2+n.textMargin,a}return Rr(t,[{key:"valid",value:function(){return this.isValid}},{key:"encode",value:function(){return this.options.flat?this.flatEncoding():this.guardedEncoding()}},{key:"flatEncoding",value:function(){var n="";return n+="101",n+=this.encodeMiddleDigits(),n+="010101",{data:n,text:this.text}}},{key:"guardedEncoding",value:function(){var n=[];return this.displayValue&&n.push({data:"00000000",text:this.text[0],options:{textAlign:"left",fontSize:this.fontSize}}),n.push({data:"101",options:{height:this.guardHeight}}),n.push({data:this.encodeMiddleDigits(),text:this.text.substring(1,7),options:{fontSize:this.fontSize}}),n.push({data:"010101",options:{height:this.guardHeight}}),this.displayValue&&n.push({data:"00000000",text:this.text[7],options:{textAlign:"right",fontSize:this.fontSize}}),n}},{key:"encodeMiddleDigits",value:function(){var n=this.upcA[0],a=this.upcA[this.upcA.length-1],r=Vr[parseInt(a)][parseInt(n)];return(0,Br.default)(this.middleDigits,r)}}]),t}(Nr.default);function xi(e,t){for(var i=parseInt(e[e.length-1]),n=Gr[i],a="",r=0,o=0;o<n.length;o++){var s=n[o];s==="X"?a+=e[r++]:a+=s}return a=""+t+a,""+a+(0,zr.checksum)(a)}ot.default=Hr});var Si=g(R=>{"use strict";Object.defineProperty(R,"__esModule",{value:!0});R.UPCE=R.UPC=R.EAN2=R.EAN5=R.EAN8=R.EAN13=void 0;var Kr=hi(),Ur=re(Kr),Xr=gi(),Wr=re(Xr),Yr=bi(),Qr=re(Yr),Jr=$i(),Zr=re(Jr),eo=at(),to=re(eo),io=Ei(),no=re(io);function re(e){return e&&e.__esModule?e:{default:e}}R.EAN13=Ur.default;R.EAN8=Wr.default;R.EAN5=Qr.default;R.EAN2=Zr.default;R.UPC=to.default;R.UPCE=no.default});var Pi=g(fe=>{"use strict";Object.defineProperty(fe,"__esModule",{value:!0});var Wl=fe.START_BIN="1010",Yl=fe.END_BIN="11101",Ql=fe.BINARIES=["00110","10001","01001","11000","00101","10100","01100","00011","10010","01010"]});var ct=g(st=>{"use strict";Object.defineProperty(st,"__esModule",{value:!0});var ao=function(){function e(t,i){for(var n=0;n<i.length;n++){var a=i[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),Pe=Pi(),ro=B(),oo=so(ro);function so(e){return e&&e.__esModule?e:{default:e}}function co(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function lo(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t&&(typeof t=="object"||typeof t=="function")?t:e}function _o(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var uo=function(e){_o(t,e);function t(){return co(this,t),lo(this,(t.__proto__||Object.getPrototypeOf(t)).apply(this,arguments))}return ao(t,[{key:"valid",value:function(){return this.data.search(/^([0-9]{2})+$/)!==-1}},{key:"encode",value:function(){var n=this,a=this.data.match(/.{2}/g).map(function(r){return n.encodePair(r)}).join("");return{data:Pe.START_BIN+a+Pe.END_BIN,text:this.text}}},{key:"encodePair",value:function(n){var a=Pe.BINARIES[n[1]];return Pe.BINARIES[n[0]].split("").map(function(r,o){return(r==="1"?"111":"1")+(a[o]==="1"?"000":"0")}).join("")}}]),t}(oo.default);st.default=uo});var Di=g(lt=>{"use strict";Object.defineProperty(lt,"__esModule",{value:!0});var fo=function(){function e(t,i){for(var n=0;n<i.length;n++){var a=i[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),po=ct(),mo=ho(po);function ho(e){return e&&e.__esModule?e:{default:e}}function vo(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function go(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t&&(typeof t=="object"||typeof t=="function")?t:e}function yo(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var Ci=function(t){var i=t.substr(0,13).split("").map(function(n){return parseInt(n,10)}).reduce(function(n,a,r){return n+a*(3-r%2*2)},0);return Math.ceil(i/10)*10-i},bo=function(e){yo(t,e);function t(i,n){return vo(this,t),i.search(/^[0-9]{13}$/)!==-1&&(i+=Ci(i)),go(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,i,n))}return fo(t,[{key:"valid",value:function(){return this.data.search(/^[0-9]{14}$/)!==-1&&+this.data[13]===Ci(this.data)}}]),t}(mo.default);lt.default=bo});var Ai=g(oe=>{"use strict";Object.defineProperty(oe,"__esModule",{value:!0});oe.ITF14=oe.ITF=void 0;var wo=ct(),$o=Ti(wo),ko=Di(),xo=Ti(ko);function Ti(e){return e&&e.__esModule?e:{default:e}}oe.ITF=$o.default;oe.ITF14=xo.default});var se=g(dt=>{"use strict";Object.defineProperty(dt,"__esModule",{value:!0});var Oo=function(){function e(t,i){for(var n=0;n<i.length;n++){var a=i[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),Eo=B(),So=Po(Eo);function Po(e){return e&&e.__esModule?e:{default:e}}function Co(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Do(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t&&(typeof t=="object"||typeof t=="function")?t:e}function To(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var Ao=function(e){To(t,e);function t(i,n){return Co(this,t),Do(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,i,n))}return Oo(t,[{key:"encode",value:function(){for(var n="110",a=0;a<this.data.length;a++){var r=parseInt(this.data[a]),o=r.toString(2);o=qo(o,4-o.length);for(var s=0;s<o.length;s++)n+=o[s]=="0"?"100":"110"}return n+="1001",{data:n,text:this.text}}},{key:"valid",value:function(){return this.data.search(/^[0-9]+$/)!==-1}}]),t}(So.default);function qo(e,t){for(var i=0;i<t;i++)e="0"+e;return e}dt.default=Ao});var pe=g(Ce=>{"use strict";Object.defineProperty(Ce,"__esModule",{value:!0});Ce.mod10=Io;Ce.mod11=Ro;function Io(e){for(var t=0,i=0;i<e.length;i++){var n=parseInt(e[i]);(i+e.length)%2===0?t+=n:t+=n*2%10+Math.floor(n*2/10)}return(10-t%10)%10}function Ro(e){for(var t=0,i=[2,3,4,5,6,7],n=0;n<e.length;n++){var a=parseInt(e[e.length-1-n]);t+=i[n%i.length]*a}return(11-t%11)%11}});var qi=g(_t=>{"use strict";Object.defineProperty(_t,"__esModule",{value:!0});var Mo=se(),Bo=No(Mo),Lo=pe();function No(e){return e&&e.__esModule?e:{default:e}}function zo(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function jo(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t&&(typeof t=="object"||typeof t=="function")?t:e}function Fo(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var Go=function(e){Fo(t,e);function t(i,n){return zo(this,t),jo(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,i+(0,Lo.mod10)(i),n))}return t}(Bo.default);_t.default=Go});var Ii=g(ut=>{"use strict";Object.defineProperty(ut,"__esModule",{value:!0});var Vo=se(),Ho=Uo(Vo),Ko=pe();function Uo(e){return e&&e.__esModule?e:{default:e}}function Xo(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Wo(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t&&(typeof t=="object"||typeof t=="function")?t:e}function Yo(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var Qo=function(e){Yo(t,e);function t(i,n){return Xo(this,t),Wo(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,i+(0,Ko.mod11)(i),n))}return t}(Ho.default);ut.default=Qo});var Mi=g(ft=>{"use strict";Object.defineProperty(ft,"__esModule",{value:!0});var Jo=se(),Zo=es(Jo),Ri=pe();function es(e){return e&&e.__esModule?e:{default:e}}function ts(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function is(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t&&(typeof t=="object"||typeof t=="function")?t:e}function ns(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var as=function(e){ns(t,e);function t(i,n){return ts(this,t),i+=(0,Ri.mod10)(i),i+=(0,Ri.mod10)(i),is(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,i,n))}return t}(Zo.default);ft.default=as});var Li=g(pt=>{"use strict";Object.defineProperty(pt,"__esModule",{value:!0});var rs=se(),os=ss(rs),Bi=pe();function ss(e){return e&&e.__esModule?e:{default:e}}function cs(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function ls(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t&&(typeof t=="object"||typeof t=="function")?t:e}function ds(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var _s=function(e){ds(t,e);function t(i,n){return cs(this,t),i+=(0,Bi.mod11)(i),i+=(0,Bi.mod10)(i),ls(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,i,n))}return t}(os.default);pt.default=_s});var Ni=g(j=>{"use strict";Object.defineProperty(j,"__esModule",{value:!0});j.MSI1110=j.MSI1010=j.MSI11=j.MSI10=j.MSI=void 0;var us=se(),fs=me(us),ps=qi(),ms=me(ps),hs=Ii(),vs=me(hs),gs=Mi(),ys=me(gs),bs=Li(),ws=me(bs);function me(e){return e&&e.__esModule?e:{default:e}}j.MSI=fs.default;j.MSI10=ms.default;j.MSI11=vs.default;j.MSI1010=ys.default;j.MSI1110=ws.default});var zi=g(De=>{"use strict";Object.defineProperty(De,"__esModule",{value:!0});De.pharmacode=void 0;var $s=function(){function e(t,i){for(var n=0;n<i.length;n++){var a=i[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),ks=B(),xs=Os(ks);function Os(e){return e&&e.__esModule?e:{default:e}}function Es(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Ss(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t&&(typeof t=="object"||typeof t=="function")?t:e}function Ps(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var Cs=function(e){Ps(t,e);function t(i,n){Es(this,t);var a=Ss(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,i,n));return a.number=parseInt(i,10),a}return $s(t,[{key:"encode",value:function(){for(var n=this.number,a="";!isNaN(n)&&n!=0;)n%2===0?(a="11100"+a,n=(n-2)/2):(a="100"+a,n=(n-1)/2);return a=a.slice(0,-2),{data:a,text:this.text}}},{key:"valid",value:function(){return this.number>=3&&this.number<=131070}}]),t}(xs.default);De.pharmacode=Cs});var ji=g(Te=>{"use strict";Object.defineProperty(Te,"__esModule",{value:!0});Te.codabar=void 0;var Ds=function(){function e(t,i){for(var n=0;n<i.length;n++){var a=i[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),Ts=B(),As=qs(Ts);function qs(e){return e&&e.__esModule?e:{default:e}}function Is(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Rs(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t&&(typeof t=="object"||typeof t=="function")?t:e}function Ms(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var Bs=function(e){Ms(t,e);function t(i,n){Is(this,t),i.search(/^[0-9\-\$\:\.\+\/]+$/)===0&&(i="A"+i+"A");var a=Rs(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,i.toUpperCase(),n));return a.text=a.options.text||a.text.replace(/[A-D]/g,""),a}return Ds(t,[{key:"valid",value:function(){return this.data.search(/^[A-D][0-9\-\$\:\.\+\/]+[A-D]$/)!==-1}},{key:"encode",value:function(){for(var n=[],a=this.getEncodings(),r=0;r<this.data.length;r++)n.push(a[this.data.charAt(r)]),r!==this.data.length-1&&n.push("0");return{text:this.text,data:n.join("")}}},{key:"getEncodings",value:function(){return{0:"101010011",1:"101011001",2:"101001011",3:"110010101",4:"101101001",5:"110101001",6:"100101011",7:"100101101",8:"100110101",9:"110100101","-":"101001101",$:"101100101",":":"1101011011","/":"1101101011",".":"1101101101","+":"1011011011",A:"1011001001",B:"1001001011",C:"1010010011",D:"1010011001"}}}]),t}(As.default);Te.codabar=Bs});var Fi=g(Ae=>{"use strict";Object.defineProperty(Ae,"__esModule",{value:!0});Ae.GenericBarcode=void 0;var Ls=function(){function e(t,i){for(var n=0;n<i.length;n++){var a=i[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),Ns=B(),zs=js(Ns);function js(e){return e&&e.__esModule?e:{default:e}}function Fs(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Gs(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t&&(typeof t=="object"||typeof t=="function")?t:e}function Vs(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var Hs=function(e){Vs(t,e);function t(i,n){return Fs(this,t),Gs(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,i,n))}return Ls(t,[{key:"encode",value:function(){return{data:"10101010101010101010101010101010101010101",text:this.text}}},{key:"valid",value:function(){return!0}}]),t}(zs.default);Ae.GenericBarcode=Hs});var Vi=g(mt=>{"use strict";Object.defineProperty(mt,"__esModule",{value:!0});var Ks=Wt(),qe=ui(),ce=Si(),Gi=Ai(),he=Ni(),Us=zi(),Xs=ji(),Ws=Fi();mt.default={CODE39:Ks.CODE39,CODE128:qe.CODE128,CODE128A:qe.CODE128A,CODE128B:qe.CODE128B,CODE128C:qe.CODE128C,EAN13:ce.EAN13,EAN8:ce.EAN8,EAN5:ce.EAN5,EAN2:ce.EAN2,UPC:ce.UPC,UPCE:ce.UPCE,ITF14:Gi.ITF14,ITF:Gi.ITF,MSI:he.MSI,MSI10:he.MSI10,MSI11:he.MSI11,MSI1010:he.MSI1010,MSI1110:he.MSI1110,pharmacode:Us.pharmacode,codabar:Xs.codabar,GenericBarcode:Ws.GenericBarcode}});var ve=g(ht=>{"use strict";Object.defineProperty(ht,"__esModule",{value:!0});var Ys=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e[n]=i[n])}return e};ht.default=function(e,t){return Ys({},e,t)}});var Hi=g(vt=>{"use strict";Object.defineProperty(vt,"__esModule",{value:!0});vt.default=Qs;function Qs(e){var t=[];function i(n){if(Array.isArray(n))for(var a=0;a<n.length;a++)i(n[a]);else n.text=n.text||"",n.data=n.data||"",t.push(n)}return i(e),t}});var Ki=g(gt=>{"use strict";Object.defineProperty(gt,"__esModule",{value:!0});gt.default=Js;function Js(e){return e.marginTop=e.marginTop||e.margin,e.marginBottom=e.marginBottom||e.margin,e.marginRight=e.marginRight||e.margin,e.marginLeft=e.marginLeft||e.margin,e}});var bt=g(yt=>{"use strict";Object.defineProperty(yt,"__esModule",{value:!0});yt.default=Zs;function Zs(e){var t=["width","height","textMargin","fontSize","margin","marginTop","marginBottom","marginLeft","marginRight"];for(var i in t)t.hasOwnProperty(i)&&(i=t[i],typeof e[i]=="string"&&(e[i]=parseInt(e[i],10)));return typeof e.displayValue=="string"&&(e.displayValue=e.displayValue!="false"),e}});var $t=g(wt=>{"use strict";Object.defineProperty(wt,"__esModule",{value:!0});var ec={width:2,height:100,format:"auto",displayValue:!0,fontOptions:"",font:"monospace",text:void 0,textAlign:"center",textPosition:"bottom",textMargin:2,fontSize:20,background:"#ffffff",lineColor:"#000000",margin:10,marginTop:void 0,marginBottom:void 0,marginLeft:void 0,marginRight:void 0,valid:function(){}};wt.default=ec});var Wi=g(kt=>{"use strict";Object.defineProperty(kt,"__esModule",{value:!0});var tc=bt(),ic=Xi(tc),nc=$t(),Ui=Xi(nc);function Xi(e){return e&&e.__esModule?e:{default:e}}function ac(e){var t={};for(var i in Ui.default)Ui.default.hasOwnProperty(i)&&(e.hasAttribute("jsbarcode-"+i.toLowerCase())&&(t[i]=e.getAttribute("jsbarcode-"+i.toLowerCase())),e.hasAttribute("data-"+i.toLowerCase())&&(t[i]=e.getAttribute("data-"+i.toLowerCase())));return t.value=e.getAttribute("jsbarcode-value")||e.getAttribute("data-value"),t=(0,ic.default)(t),t}kt.default=ac});var xt=g(F=>{"use strict";Object.defineProperty(F,"__esModule",{value:!0});F.getTotalWidthOfEncodings=F.calculateEncodingAttributes=F.getBarcodePadding=F.getEncodingHeight=F.getMaximumHeightOfEncodings=void 0;var rc=ve(),oc=sc(rc);function sc(e){return e&&e.__esModule?e:{default:e}}function Yi(e,t){return t.height+(t.displayValue&&e.text.length>0?t.fontSize+t.textMargin:0)+t.marginTop+t.marginBottom}function Qi(e,t,i){if(i.displayValue&&t<e){if(i.textAlign=="center")return Math.floor((e-t)/2);if(i.textAlign=="left")return 0;if(i.textAlign=="right")return Math.floor(e-t)}return 0}function cc(e,t,i){for(var n=0;n<e.length;n++){var a=e[n],r=(0,oc.default)(t,a.options),o;r.displayValue?o=_c(a.text,r,i):o=0;var s=a.data.length*r.width;a.width=Math.ceil(Math.max(o,s)),a.height=Yi(a,r),a.barcodePadding=Qi(o,s,r)}}function lc(e){for(var t=0,i=0;i<e.length;i++)t+=e[i].width;return t}function dc(e){for(var t=0,i=0;i<e.length;i++)e[i].height>t&&(t=e[i].height);return t}function _c(e,t,i){var n;if(i)n=i;else if(typeof document!="undefined")n=document.createElement("canvas").getContext("2d");else return 0;n.font=t.fontOptions+" "+t.fontSize+"px "+t.font;var a=n.measureText(e);if(!a)return 0;var r=a.width;return r}F.getMaximumHeightOfEncodings=dc;F.getEncodingHeight=Yi;F.getBarcodePadding=Qi;F.calculateEncodingAttributes=cc;F.getTotalWidthOfEncodings=lc});var Ji=g(Et=>{"use strict";Object.defineProperty(Et,"__esModule",{value:!0});var uc=function(){function e(t,i){for(var n=0;n<i.length;n++){var a=i[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),fc=ve(),pc=mc(fc),Ot=xt();function mc(e){return e&&e.__esModule?e:{default:e}}function hc(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var vc=function(){function e(t,i,n){hc(this,e),this.canvas=t,this.encodings=i,this.options=n}return uc(e,[{key:"render",value:function(){if(!this.canvas.getContext)throw new Error("The browser does not support canvas.");this.prepareCanvas();for(var i=0;i<this.encodings.length;i++){var n=(0,pc.default)(this.options,this.encodings[i].options);this.drawCanvasBarcode(n,this.encodings[i]),this.drawCanvasText(n,this.encodings[i]),this.moveCanvasDrawing(this.encodings[i])}this.restoreCanvas()}},{key:"prepareCanvas",value:function(){var i=this.canvas.getContext("2d");i.save(),(0,Ot.calculateEncodingAttributes)(this.encodings,this.options,i);var n=(0,Ot.getTotalWidthOfEncodings)(this.encodings),a=(0,Ot.getMaximumHeightOfEncodings)(this.encodings);this.canvas.width=n+this.options.marginLeft+this.options.marginRight,this.canvas.height=a,i.clearRect(0,0,this.canvas.width,this.canvas.height),this.options.background&&(i.fillStyle=this.options.background,i.fillRect(0,0,this.canvas.width,this.canvas.height)),i.translate(this.options.marginLeft,0)}},{key:"drawCanvasBarcode",value:function(i,n){var a=this.canvas.getContext("2d"),r=n.data,o;i.textPosition=="top"?o=i.marginTop+i.fontSize+i.textMargin:o=i.marginTop,a.fillStyle=i.lineColor;for(var s=0;s<r.length;s++){var h=s*i.width+n.barcodePadding;r[s]==="1"?a.fillRect(h,o,i.width,i.height):r[s]&&a.fillRect(h,o,i.width,i.height*r[s])}}},{key:"drawCanvasText",value:function(i,n){var a=this.canvas.getContext("2d"),r=i.fontOptions+" "+i.fontSize+"px "+i.font;if(i.displayValue){var o,s;i.textPosition=="top"?s=i.marginTop+i.fontSize-i.textMargin:s=i.height+i.textMargin+i.marginTop+i.fontSize,a.font=r,i.textAlign=="left"||n.barcodePadding>0?(o=0,a.textAlign="left"):i.textAlign=="right"?(o=n.width-1,a.textAlign="right"):(o=n.width/2,a.textAlign="center"),a.fillText(n.text,o,s)}}},{key:"moveCanvasDrawing",value:function(i){var n=this.canvas.getContext("2d");n.translate(i.width,0)}},{key:"restoreCanvas",value:function(){var i=this.canvas.getContext("2d");i.restore()}}]),e}();Et.default=vc});var Zi=g(Pt=>{"use strict";Object.defineProperty(Pt,"__esModule",{value:!0});var gc=function(){function e(t,i){for(var n=0;n<i.length;n++){var a=i[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),yc=ve(),bc=wc(yc),St=xt();function wc(e){return e&&e.__esModule?e:{default:e}}function $c(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var Ie="http://www.w3.org/2000/svg",kc=function(){function e(t,i,n){$c(this,e),this.svg=t,this.encodings=i,this.options=n,this.document=n.xmlDocument||document}return gc(e,[{key:"render",value:function(){var i=this.options.marginLeft;this.prepareSVG();for(var n=0;n<this.encodings.length;n++){var a=this.encodings[n],r=(0,bc.default)(this.options,a.options),o=this.createGroup(i,r.marginTop,this.svg);this.setGroupOptions(o,r),this.drawSvgBarcode(o,r,a),this.drawSVGText(o,r,a),i+=a.width}}},{key:"prepareSVG",value:function(){for(;this.svg.firstChild;)this.svg.removeChild(this.svg.firstChild);(0,St.calculateEncodingAttributes)(this.encodings,this.options);var i=(0,St.getTotalWidthOfEncodings)(this.encodings),n=(0,St.getMaximumHeightOfEncodings)(this.encodings),a=i+this.options.marginLeft+this.options.marginRight;this.setSvgAttributes(a,n),this.options.background&&this.drawRect(0,0,a,n,this.svg).setAttribute("style","fill:"+this.options.background+";")}},{key:"drawSvgBarcode",value:function(i,n,a){var r=a.data,o;n.textPosition=="top"?o=n.fontSize+n.textMargin:o=0;for(var s=0,h=0,b=0;b<r.length;b++)h=b*n.width+a.barcodePadding,r[b]==="1"?s++:s>0&&(this.drawRect(h-n.width*s,o,n.width*s,n.height,i),s=0);s>0&&this.drawRect(h-n.width*(s-1),o,n.width*s,n.height,i)}},{key:"drawSVGText",value:function(i,n,a){var r=this.document.createElementNS(Ie,"text");if(n.displayValue){var o,s;r.setAttribute("style","font:"+n.fontOptions+" "+n.fontSize+"px "+n.font),n.textPosition=="top"?s=n.fontSize-n.textMargin:s=n.height+n.textMargin+n.fontSize,n.textAlign=="left"||a.barcodePadding>0?(o=0,r.setAttribute("text-anchor","start")):n.textAlign=="right"?(o=a.width-1,r.setAttribute("text-anchor","end")):(o=a.width/2,r.setAttribute("text-anchor","middle")),r.setAttribute("x",o),r.setAttribute("y",s),r.appendChild(this.document.createTextNode(a.text)),i.appendChild(r)}}},{key:"setSvgAttributes",value:function(i,n){var a=this.svg;a.setAttribute("width",i+"px"),a.setAttribute("height",n+"px"),a.setAttribute("x","0px"),a.setAttribute("y","0px"),a.setAttribute("viewBox","0 0 "+i+" "+n),a.setAttribute("xmlns",Ie),a.setAttribute("version","1.1"),a.setAttribute("style","transform: translate(0,0)")}},{key:"createGroup",value:function(i,n,a){var r=this.document.createElementNS(Ie,"g");return r.setAttribute("transform","translate("+i+", "+n+")"),a.appendChild(r),r}},{key:"setGroupOptions",value:function(i,n){i.setAttribute("style","fill:"+n.lineColor+";")}},{key:"drawRect",value:function(i,n,a,r,o){var s=this.document.createElementNS(Ie,"rect");return s.setAttribute("x",i),s.setAttribute("y",n),s.setAttribute("width",a),s.setAttribute("height",r),o.appendChild(s),s}}]),e}();Pt.default=kc});var en=g(Ct=>{"use strict";Object.defineProperty(Ct,"__esModule",{value:!0});var xc=function(){function e(t,i){for(var n=0;n<i.length;n++){var a=i[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();function Oc(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var Ec=function(){function e(t,i,n){Oc(this,e),this.object=t,this.encodings=i,this.options=n}return xc(e,[{key:"render",value:function(){this.object.encodings=this.encodings}}]),e}();Ct.default=Ec});var tn=g(Tt=>{"use strict";Object.defineProperty(Tt,"__esModule",{value:!0});var Sc=Ji(),Pc=Dt(Sc),Cc=Zi(),Dc=Dt(Cc),Tc=en(),Ac=Dt(Tc);function Dt(e){return e&&e.__esModule?e:{default:e}}Tt.default={CanvasRenderer:Pc.default,SVGRenderer:Dc.default,ObjectRenderer:Ac.default}});var Rt=g(ge=>{"use strict";Object.defineProperty(ge,"__esModule",{value:!0});function At(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function qt(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t&&(typeof t=="object"||typeof t=="function")?t:e}function It(e,t){if(typeof t!="function"&&t!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var qc=function(e){It(t,e);function t(i,n){At(this,t);var a=qt(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return a.name="InvalidInputException",a.symbology=i,a.input=n,a.message='"'+a.input+'" is not a valid input for '+a.symbology,a}return t}(Error),Ic=function(e){It(t,e);function t(){At(this,t);var i=qt(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return i.name="InvalidElementException",i.message="Not supported type to render on",i}return t}(Error),Rc=function(e){It(t,e);function t(){At(this,t);var i=qt(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return i.name="NoElementException",i.message="No element to render on.",i}return t}(Error);ge.InvalidInputException=qc;ge.InvalidElementException=Ic;ge.NoElementException=Rc});var an=g(Lt=>{"use strict";Object.defineProperty(Lt,"__esModule",{value:!0});var Mc=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Symbol=="function"&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Bc=Wi(),Mt=nn(Bc),Lc=tn(),ye=nn(Lc),Nc=Rt();function nn(e){return e&&e.__esModule?e:{default:e}}function Bt(e){if(typeof e=="string")return zc(e);if(Array.isArray(e)){for(var t=[],i=0;i<e.length;i++)t.push(Bt(e[i]));return t}else{if(typeof HTMLCanvasElement!="undefined"&&e instanceof HTMLImageElement)return jc(e);if(e&&e.nodeName&&e.nodeName.toLowerCase()==="svg"||typeof SVGElement!="undefined"&&e instanceof SVGElement)return{element:e,options:(0,Mt.default)(e),renderer:ye.default.SVGRenderer};if(typeof HTMLCanvasElement!="undefined"&&e instanceof HTMLCanvasElement)return{element:e,options:(0,Mt.default)(e),renderer:ye.default.CanvasRenderer};if(e&&e.getContext)return{element:e,renderer:ye.default.CanvasRenderer};if(e&&(typeof e=="undefined"?"undefined":Mc(e))==="object"&&!e.nodeName)return{element:e,renderer:ye.default.ObjectRenderer};throw new Nc.InvalidElementException}}function zc(e){var t=document.querySelectorAll(e);if(t.length!==0){for(var i=[],n=0;n<t.length;n++)i.push(Bt(t[n]));return i}}function jc(e){var t=document.createElement("canvas");return{element:t,options:(0,Mt.default)(e),renderer:ye.default.CanvasRenderer,afterRender:function(){e.setAttribute("src",t.toDataURL())}}}Lt.default=Bt});var rn=g(Nt=>{"use strict";Object.defineProperty(Nt,"__esModule",{value:!0});var Fc=function(){function e(t,i){for(var n=0;n<i.length;n++){var a=i[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(t,a.key,a)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}();function Gc(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var Vc=function(){function e(t){Gc(this,e),this.api=t}return Fc(e,[{key:"handleCatch",value:function(i){if(i.name==="InvalidInputException")if(this.api._options.valid!==this.api._defaults.valid)this.api._options.valid(!1);else throw i.message;else throw i;this.api.render=function(){}}},{key:"wrapBarcodeCall",value:function(i){try{var n=i.apply(void 0,arguments);return this.api._options.valid(!0),n}catch(a){return this.handleCatch(a),this.api}}}]),e}();Nt.default=Vc});var fn=g((Sd,un)=>{"use strict";var Hc=Vi(),Z=Q(Hc),Kc=ve(),be=Q(Kc),Uc=Hi(),sn=Q(Uc),Xc=Ki(),on=Q(Xc),Wc=an(),Yc=Q(Wc),Qc=bt(),Jc=Q(Qc),Zc=rn(),el=Q(Zc),cn=Rt(),tl=$t(),ln=Q(tl);function Q(e){return e&&e.__esModule?e:{default:e}}var U=function(){},Re=function(t,i,n){var a=new U;if(typeof t=="undefined")throw Error("No element to render on was provided.");return a._renderProperties=(0,Yc.default)(t),a._encodings=[],a._options=ln.default,a._errorHandler=new el.default(a),typeof i!="undefined"&&(n=n||{},n.format||(n.format=_n()),a.options(n)[n.format](i,n).render()),a};Re.getModule=function(e){return Z.default[e]};for(zt in Z.default)Z.default.hasOwnProperty(zt)&&il(Z.default,zt);var zt;function il(e,t){U.prototype[t]=U.prototype[t.toUpperCase()]=U.prototype[t.toLowerCase()]=function(i,n){var a=this;return a._errorHandler.wrapBarcodeCall(function(){n.text=typeof n.text=="undefined"?void 0:""+n.text;var r=(0,be.default)(a._options,n);r=(0,Jc.default)(r);var o=e[t],s=dn(i,o,r);return a._encodings.push(s),a})}}function dn(e,t,i){e=""+e;var n=new t(e,i);if(!n.valid())throw new cn.InvalidInputException(n.constructor.name,e);var a=n.encode();a=(0,sn.default)(a);for(var r=0;r<a.length;r++)a[r].options=(0,be.default)(i,a[r].options);return a}function _n(){return Z.default.CODE128?"CODE128":Object.keys(Z.default)[0]}U.prototype.options=function(e){return this._options=(0,be.default)(this._options,e),this};U.prototype.blank=function(e){var t=new Array(e+1).join("0");return this._encodings.push({data:t}),this};U.prototype.init=function(){if(!!this._renderProperties){Array.isArray(this._renderProperties)||(this._renderProperties=[this._renderProperties]);var e;for(var t in this._renderProperties){e=this._renderProperties[t];var i=(0,be.default)(this._options,e.options);i.format=="auto"&&(i.format=_n()),this._errorHandler.wrapBarcodeCall(function(){var n=i.value,a=Z.default[i.format.toUpperCase()],r=dn(n,a,i);jt(e,r,i)})}}};U.prototype.render=function(){if(!this._renderProperties)throw new cn.NoElementException;if(Array.isArray(this._renderProperties))for(var e=0;e<this._renderProperties.length;e++)jt(this._renderProperties[e],this._encodings,this._options);else jt(this._renderProperties,this._encodings,this._options);return this};U.prototype._defaults=ln.default;function jt(e,t,i){t=(0,sn.default)(t);for(var n=0;n<t.length;n++)t[n].options=(0,be.default)(i,t[n].options),(0,on.default)(t[n].options);(0,on.default)(i);var a=e.renderer,r=new a(e.element,t,i);r.render(),e.afterRender&&e.afterRender()}typeof window!="undefined"&&(window.JsBarcode=Re);typeof jQuery!="undefined"&&(jQuery.fn.JsBarcode=function(e,t){var i=[];return jQuery(this).each(function(){i.push(this)}),Re(i,e,t)});un.exports=Re});var ke=Ht(Kt());custom_app.PointOfSale.ItemSelector=class{constructor({frm:e,wrapper:t,events:i,pos_profile:n,settings:a}){this.wrapper=t,this.events=i,this.pos_profile=n,this.hide_images=a.hide_images,this.auto_add_item=a.auto_add_item_to_cart,this.init_component()}init_component(){this.prepare_dom(),this.make_search_bar(),this.load_items_data(),this.bind_events(),this.attach_shortcuts(),this.inject_css()}inject_css(){let e=`
			.highlight {
				background-color: #0289f7;
                color: white;
                font-weight: bold;
			}
            .text{
                font-size: 1em;
                font-weight: semi-bold;
            }
            .text-description{
                font-size: 1em;
                font-weight: semi-bold;
            }
            .quantity-field{
                width: 1rem;
                height: 10rem;
            }
            .custom-quantity-field {
                width: 200px; /* Adjust the width as needed */
            }
           
		`,t=document.createElement("style");t.type="text/css",t.styleSheet?t.styleSheet.cssText=e:t.appendChild(document.createTextNode(e)),document.head.appendChild(t)}prepare_dom(){let e=localStorage.getItem("selected_warehouse");this.wrapper.append(`<section class="items-selector" style="margin-top:0.3rem; grid-column: span 4 / span 4;">

                <div class="filter-section" style="display: flex; align-items: center; gap: 10px;">
                    <div class="label" style="flex: 1;">
                        ${__("All Items")} ${e||""}
                    </div>
                    <div class="search-field" style="flex: 2;">
                        <input type="text" placeholder="Search by item code, serial number or barcode" style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;">
                    </div>
                    <div class="item-group-field" style="flex: 1;">
                        <input type="text" placeholder="Select item group" style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;">
                    </div>
                  
                </div>
                <div class="table-responsive">
                    <table class="table items-table">
                        <thead style="position: sticky; top: 0; background-color: #fff; z-index: 1; font-size:11px;">
                            <tr>
                                <th>Item Code</th>
                                <th>Name</th>
                                <th>Generic Name</th>
                                <th>Vat Type</th>
                                <th>Price</th>
                                <th>UOM</th>
                                <th>QOH</th>
                            </tr>
                        </thead>
                        <tbody class="items-container"></tbody>
                    </table>
                </div>
            </section>
            `),this.$component=this.wrapper.find(".items-selector"),this.$items_container=this.$component.find(".items-container")}async load_items_data(){if(!this.item_group){let t=await frappe.db.get_value("Item Group",{lft:1,is_group:1},"name");this.parent_item_group=t.message.name}if(!this.price_list){let t=await frappe.db.get_value("POS Profile",this.pos_profile,"selling_price_list");this.price_list=t.message.selling_price_list}this.selected_uom="PC",this.item_uom&&(this.item_uom.set_value("PC"),this.item_uom.refresh());let{message:e}=await this.get_items({});this.render_item_list(e.items),this.filter_items({uom:this.selected_uom})}get_items({start:e=0,page_length:t=20,search_term:i=""}){let n=this.events.get_frm().doc,a=n&&n.selling_price_list||this.price_list,{item_group:r,pos_profile:o}=this;!r&&(r=this.parent_item_group);let s=localStorage.getItem("selected_warehouse");return frappe.call({method:"custom_app.customapp.page.packing_list.packing_list.get_items",freeze:!0,args:{start:e,page_length:t,price_list:a,item_group:r,search_term:i,pos_profile:o,selected_warehouse:s}})}render_item_list(e){this.$items_container.html(""),this.items=e,e.forEach(t=>{let i=this.get_item_html(t);this.$items_container.append(i)}),this.highlighted_row_index=-1,this.highlight_row(this.highlighted_row_index)}get_item_html(e){let t=this,{item_code:i,item_image:n,serial_no:a,batch_no:r,barcode:o,actual_qty:s,uom:h,price_list_rate:b,description:v,latest_expiry_date:u,batch_number:l,custom_is_vatable:f,custom_generic_name:c,item_group:d}=e,_=flt(b,2)%1!=0?2:0,y,p=s;if(h!=="PC")return"";e.is_stock_item?y=s>10?"green":s<=0?"red":"orange":(y="",p="");let m=b/(1+.12),k=v||"Description not available";return`<tr class="item-wrapper" style="border-bottom: 1px solid #ddd; font-size: 12px;" 
        onmouseover="this.style.backgroundColor='#0289f7'; this.style.color='white'; this.style.fontWeight='bold';"
        onmouseout="this.style.backgroundColor=''; this.style.color=''; this.style.fontWeight='';"
            data-item-code="${escape(i)}" data-serial-no="${escape(a)}"
            data-batch-no="${escape(r)}" data-uom="${escape(h)}"
            data-rate="${escape(b||0)}" data-description="${escape(k)}" data-qty="${p}">
            <td class="item-code" style=" width: 1rem;">${i}</td> 
             <td class="item-name" style="width: 15rem; white-space: normal; overflow: hidden; text-overflow: ellipsis;">${e.item_name}</td>
            <td class="item-name" style="width: 8rem; white-space: normal; overflow: hidden; text-overflow: ellipsis;">${c||""}</td>
            <td class="item-vat" style=" width: 10%;">${f==0?"VAT-Exempt":"VATable"}</td>
            <td class="item-rate" style=" width:8%;">${format_currency(b,e.currency)}</td>
            <td class="item-uom" style=" width: 5%;">${h}</td>
            <td class="item-qty" style=" width: 8%;"><span class="indicator-pill whitespace-nowrap ${y}">${s}</span></td>
        </tr>`}handle_broken_image(e){let t=$(e).attr("alt");$(e).parent().replaceWith(`<div class="item-display abbr">${t}</div>`)}make_search_bar(){let e=this,t=e.events.get_frm().doc;this.$component.find(".search-field").html(""),this.$component.find(".item-group-field").html(""),this.search_field=frappe.ui.form.make_control({df:{label:__("Search"),fieldtype:"Data",placeholder:__("Search by item code, serial number, barcode, generic name or description")},parent:this.$component.find(".search-field"),render_input:!0}),this.search_field.$input.on("input",()=>{let i=this.search_field.get_value().trim()}),this.item_group_field=frappe.ui.form.make_control({df:{label:__("Item Group"),fieldtype:"Link",options:"Item Group",placeholder:__("Select item group"),onchange:function(){e.item_group=this.value,!e.item_group&&(e.item_group=e.parent_item_group),e.filter_items()},get_query:function(){return{query:"custom_app.customapp.page.packing_list.packing_list.item_group_query",filters:{pos_profile:t?t.pos_profile:""}}}},parent:this.$component.find(".item-group-field"),render_input:!0}),this.item_group_field.$input.on("input",()=>{let i=this.item_group_field.get_value().trim()}),this.search_field.toggle_label(!1),this.item_group_field.toggle_label(!1),this.attach_clear_btn()}attach_clear_btn(){this.search_field.$wrapper.find(".control-input").append(`<span class="link-btn" style="top: 2px;">
				<a class="btn-open no-decoration" title="${__("Clear")}">
					${frappe.utils.icon("close","sm")}
				</a>
			</span>`),this.$clear_search_btn=this.search_field.$wrapper.find(".link-btn"),this.$clear_search_btn.on("click","a",()=>{this.set_search_value(""),this.search_field.set_focus()})}set_search_value(e){$(this.search_field.$input[0]).val(e).trigger("input")}bind_events(){let e=this;window.onScan=ke.default,ke.default.decodeKeyEvent=function(i){var n=this._getNormalizedKeyNum(i);switch(!0){case(n>=48&&n<=90):case(n>=106&&n<=111):case(n>=160&&n<=164||n==170):case(n>=186&&n<=194):case(n>=219&&n<=222):case n==32:if(i.key!==void 0&&i.key!=="")return i.key;var a=String.fromCharCode(n);switch(i.shiftKey){case!1:a=a.toLowerCase();break;case!0:a=a.toUpperCase();break}return a;case(n>=96&&n<=105):return 0+(n-96)}return""},ke.default.attachTo(document,{onScan:i=>{this.search_field&&this.$component.is(":visible")&&(this.search_field.set_focus(),this.set_search_value(i),this.barcode_scanned=!0)}});let t;this.$component.on("click",".item-wrapper",async function(){let i=$(this);e.selectedItem=i;let n=unescape(i.attr("data-item-code")),a=unescape(i.attr("data-uom")),r=parseFloat(unescape(i.attr("data-rate"))),o=unescape(i.attr("data-description")),s=parseFloat(unescape(i.attr("data-qty"))),h=e.events.get_pos_profile();frappe.call({method:"custom_app.customapp.page.packing_list.packing_list.get_item_uom_prices",args:{item_code:n},callback:function(b){if(b.message){let v=b.message.uom_prices,u=Object.keys(v).filter(d=>d&&d!=="null").map(d=>({label:d,value:d})),l=a;if(!v.hasOwnProperty(l)&&(l=u.length>0?u[0].value:null,!l)){frappe.msgprint(__("No valid UOMs found for this item."));return}let f=v[l],c=new frappe.ui.Dialog({title:__("Item Details"),fields:[{fieldtype:"HTML",title:__("Item Details"),options:`
                                        <div class="row">
                                            <div class="col-lg">
                                                <div class="form-group">
                                                    <label class="control-label">Item Code</label>
                                                    <input class="form-control" readonly data-fieldname="description" type="text" value="${n}"/>
                                                </div>
                                            </div>
                                        </div>
                                    `},{fieldtype:"HTML",title:__("Item Details"),options:`
                                        <div class="row">
                                            <div class="col-lg">
                                                <div class="form-group">
                                                    <label class="control-label">Item Description</label>
                                                    <input class="form-control" readonly data-fieldname="description" type="text" value="${o}"/>
                                                </div>
                                            </div>
                                        </div>
                                    `},{fieldtype:"HTML",label:__("Quantity"),options:`
                                        <div class="row">
                                            <div class="col-lg">
                                                <div class="form-group">
                                                    <label class="control-label">${__("Quantity")}</label>
                                                     <input class="form-control" type="number" data-fieldname="quantity" required value="1" min="1" /> </div>
                                                </div>
                                            </div>
                                        </div>
                                    `},{fieldtype:"Select",label:__("UOM"),fieldname:"uom",options:u,default:l},{fieldtype:"HTML",label:__("Amount"),options:`
                                        <div class="row">
                                            <div class="col-lg">
                                                <div class="form-group">
                                                    <label class="control-label">Amount</label>
                                                    <input class="form-control" data-fieldname="total_amount" value="${f.toFixed(2)}" readonly />
                                                </div>
                                            </div>
                                        </div>
                                    `},{label:"Branch Item INVTY",fieldtype:"Button",btn_size:"sm",click:function(){let d=[];frappe.call({method:"frappe.client.get_list",args:{doctype:"Warehouse",fields:["name","warehouse_type","parent_warehouse"],limit_page_length:0},callback:function(_){d=_.message;let y=d.map(w=>new Promise((m,k)=>{frappe.call({method:"custom_app.customapp.page.packing_list.packing_list.get_item_qty_per_warehouse",args:{warehouse:w.name,item_code:n},callback:function(C){w.actual_qty=C.message,m(w)},error:function(C){k(C)}})}));Promise.all(y).then(w=>{w=w.filter(k=>k.actual_qty>0);let m=new frappe.ui.Dialog({title:`${n} ${o}`,fields:[{fieldtype:"HTML",fieldname:"warehouse_table_html",options:p(w)}],primary_action_label:__("Ok"),primary_action:function(){m.hide()}});m.show(),$(m.$wrapper).css({"max-height":"80vh","overflow-y":"auto"}),$(m.fields_dict.warehouse_table_html.$wrapper).css({"max-height":"60vh","overflow-y":"auto"})}).catch(w=>{console.error("Error fetching warehouse data:",w)});function p(w){let m='<table class="table table-bordered">';return m+="<thead><tr>",m+="<th>Name</th>",m+="<th>Quantity</th>",m+="</tr></thead>",m+="<tbody>",w.forEach(k=>{m+="<tr>",m+=`<td>${k.name}</td>`,m+=`<td>${k.actual_qty}</td>`,m+="</tr>"}),m+="</tbody>",m+="</table>",m}}})}}],primary_action_label:__("Ok"),primary_action:function(){let d=parseFloat(c.wrapper.find('input[data-fieldname="quantity"]').val()),_=c.wrapper.find('select[data-fieldname="uom"]').val(),y=parseFloat(c.wrapper.find('input[data-fieldname="total_amount"]').val());if(!d||d<=0){frappe.msgprint(__("Please enter a valid quantity."));return}if(!e.selectedItem){frappe.msgprint(__("No item selected."));return}if(d>s){frappe.msgprint(__("Entered Quantity Exceeded"));return}frappe.call({method:"custom_app.customapp.page.packing_list.packing_list.get_item_uom_conversion",args:{item_code:n,uom_code:_},callback:function(p){if(p.message){let w=p.message;if(d*w>s){frappe.msgprint(__("Entered Quantity Exceeded"));return}e.selectedItem.find(".item-uom").text(_);let k=unescape(e.selectedItem.attr("data-item-code")),C=unescape(e.selectedItem.attr("data-batch-no")),x=unescape(e.selectedItem.attr("data-serial-no"));e.events.item_selected({field:"qty",value:"+"+d,item:{item_code:k,batch_no:C,serial_no:x,uom:_,quantity:d,rate:y}}),e.search_field.set_focus(),c.hide()}else frappe.msgprint(__("Failed to fetch UOM conversion factor."))}})}});c.on_page_show=function(){setTimeout(()=>{let d=c.wrapper.find('input[data-fieldname="quantity"]');d.focus(),d.select()},300)},c.show(),c.wrapper.find('select[data-fieldname="uom"]').val(l),c.wrapper.find('input[data-fieldname="total_amount"]').val(f.toFixed(2)),c.wrapper.find('input[data-fieldname="quantity"]').on("input",function(){let d=parseFloat($(this).val()),_=c.wrapper.find('select[data-fieldname="uom"]').val(),y=v[_];if(isNaN(d))c.wrapper.find('input[data-fieldname="total_amount"]').val(y.toFixed(2));else{let p=(d*y).toFixed(2);c.wrapper.find('input[data-fieldname="total_amount"]').val(p)}}),c.wrapper.find('select[data-fieldname="uom"]').on("change",function(){let d=$(this).val(),_=v[d],y=parseFloat(c.wrapper.find('input[data-fieldname="quantity"]').val());if(isNaN(y))c.wrapper.find('input[data-fieldname="total_amount"]').val(_.toFixed(2));else{let p=(y*_).toFixed(2);c.wrapper.find('input[data-fieldname="total_amount"]').val(p)}}),c.wrapper.find('input[data-fieldname="quantity"]').on("keypress",function(d){d.which===13&&(d.preventDefault(),c.primary_action())})}}})}),this.search_field.$input.on("input",i=>{clearTimeout(this.last_search),this.last_search=setTimeout(()=>{let n=i.target.value;this.filter_items({search_term:n})},300),this.$clear_search_btn.toggle(Boolean(this.search_field.$input.val()))}),this.search_field.$input.on("focus",()=>{this.$clear_search_btn.toggle(Boolean(this.search_field.$input.val()))}),this.$component.on("keydown",i=>{let n=i.which||i.keyCode,a=i.ctrlKey;switch(n){case 38:i.preventDefault(),this.navigate_up();break;case 40:i.preventDefault(),this.navigate_down();break;case 9:i.preventDefault(),this.navigate_down(),this.focus_next_field();break;case 13:if(a)break;i.preventDefault(),this.select_highlighted_item();break}})}attach_shortcuts(){let e=frappe.utils.is_mac()?"\u2318":"Ctrl";this.search_field.parent.attr("title",`${e}+S`),frappe.ui.keys.add_shortcut({shortcut:"ctrl+s",action:()=>this.search_field.set_focus(),condition:()=>this.$component.is(":visible"),description:__("Focus on search input"),ignore_inputs:!0,page:cur_page.page.page}),this.item_group_field.parent.attr("title",`${e}+G`),frappe.ui.keys.add_shortcut({shortcut:"ctrl+g",action:()=>this.item_group_field.set_focus(),condition:()=>this.$component.is(":visible"),description:__("Focus on Item Group filter"),ignore_inputs:!0,page:cur_page.page.page}),document.addEventListener("keydown",t=>{if(t.key==="Enter"&&t.ctrlKey)return t.preventDefault(),console.log("Ctrl + Enter pressed for checkout"),!1}),frappe.ui.keys.on("enter",t=>{if(t.ctrlKey)return;let i=this.$component.is(":visible"),n=document.querySelector(".modal.show");if(!(!i||this.search_field.get_value()==="")&&(this.items.length==0&&this.barcode_scanned&&(frappe.show_alert({message:__("No items found. Scan barcode again."),indicator:"orange"}),frappe.utils.play_sound("error"),this.barcode_scanned=!1,this.set_search_value("")),n&&document.activeElement.tagName==="SELECT")){this.selectedItem.find(".item-uom").text(dialog.wrapper.find('select[data-fieldname="uom"]').val());let a=unescape(this.selectedItem.attr("data-item-code")),r=unescape(this.selectedItem.attr("data-batch-no")),o=unescape(this.selectedItem.attr("data-serial-no"));this.events.item_selected({field:"qty",value:quantity,item:{item_code:a,batch_no:r,serial_no:o,uom:selectedUOM,quantity,rate}}),this.search_field.set_focus()}})}item_lookup_per_branch(){let e=new frappe.ui.Dialog({title:"Hello",primary_action_label:__("Ok"),primary_action:function(){e.hide()}});e.show()}focus_next_field(){let e=document.querySelector("_init_customer_selector"),t=document.querySelector("init_doctor_selector");document.activeElement===this.search_field.$input[0]?e.focus():document.activeElement===e&&t.focus()}navigate_up(){this.highlighted_row_index>-1&&(this.highlighted_row_index--,this.highlight_row(this.highlighted_row_index))}navigate_down(){this.highlighted_row_index<this.items.length-1&&(this.highlighted_row_index++,this.highlight_row(this.highlighted_row_index))}highlight_row(e){if(e===-1){this.$items_container.find(".item-wrapper").removeClass("highlight");return}this.$items_container.find(".item-wrapper").removeClass("highlight"),e>=0&&e<this.items.length&&this.$items_container.find(".item-wrapper").eq(e).addClass("highlight")}select_highlighted_item(){if(this.isClicking)return;if(this.highlighted_row_index===-1){frappe.msgprint({title:__("No Item Highlighted"),indicator:"orange",message:__("Please select an item to highlight before proceeding.")});return}this.isClicking=!0;let e=this.$items_container.find(".item-wrapper").eq(this.highlighted_row_index);e.length&&e.click(),setTimeout(()=>{this.isClicking=!1},1e3)}filter_items({search_term:e="",uom:t="PC"}={}){if(e&&(e=e.toLowerCase(),this.search_index=this.search_index||{},this.search_index[e])){let i=this.search_index[e];this.items=i,t&&(this.items=this.items.filter(n=>n.uom===t)),this.render_item_list(this.items),this.auto_add_item&&this.items.length==1&&this.add_filtered_item_to_cart();return}this.get_items({search_term:e}).then(({message:i})=>{let{items:n,serial_no:a,batch_no:r,barcode:o}=i;e&&!o&&(this.search_index[e]=n),t&&(n=n.filter(s=>s.uom===t)),this.items=n,this.render_item_list(n),this.auto_add_item&&this.items.length==1&&this.add_filtered_item_to_cart()})}add_filtered_item_to_cart(){this.$items_container.find(".item-wrapper").click(),this.set_search_value("")}resize_selector(e){e?this.$component.css({opacity:"0","pointer-events":"none","grid-column":"span 1 / span 1","grid-template-columns":"repeat(13, minmax(0, 1fr))"}):(this.$component.css({opacity:"1","pointer-events":"auto","grid-column":"span 4 / span 4"}),this.$component.find(".filter-section").css("grid-template-columns","repeat(12, minmax(0, 1fr))"),this.$component.find(".search-field").css("margin","0px var(--margin-sm)"),this.$items_container.css("grid-template-columns","repeat(4, minmax(0, 1fr))"))}toggle_component(e){this.set_search_value(""),this.$component.css("display",e?"flex":"none")}};custom_app.PointOfSale.ItemCart=class{constructor({wrapper:e,events:t,settings:i}){this.wrapper=e,this.events=t,this.customer_info=void 0,this.hide_images=i.hide_images,this.allowed_customer_groups=i.customer_groups,this.allowed_doctor_groups=i.doctor_groups,this.allow_rate_change=i.allow_rate_change,this.allow_discount_change=i.allow_discount_change,this.init_component()}init_component(){this.prepare_dom(),this.init_child_components(),this.bind_events(),this.attach_shortcuts()}prepare_dom(){this.wrapper.append('<section class="customer-cart-container" style="margin-top:-1rem; grid-column: span 6/ span 6;"></section>'),this.$component=this.wrapper.find(".customer-cart-container")}init_child_components(){this.init_customer_selector(),this.init_doctor_selector(),this.init_cart_components()}init_customer_selector(){this.$component.append('<div class="customer-section mb-2 mt-4"></div>'),this.$customer_section=this.$component.find(".customer-section"),this.make_customer_selector()}init_doctor_selector(){this.$component.append(`<div class="doctor-section" style="display: flex;
		flex-direction: column;
		padding: var(--padding-md) var(--padding-lg);
		overflow: visible; background-color: var(--fg-color);
		box-shadow: var(--shadow-base);
		border-radius: var(--border-radius-md);
	  }; margin-top: 1em;"></div>`),this.$doctor_section=this.$component.find(".doctor-section"),this.make_doctor_selector()}reset_customer_selector(){this.events.get_frm().set_value("customer",""),this.make_customer_selector(),this.customer_field.set_focus()}reset_doctor_selector(){this.events.get_frm().set_value("doctor",""),this.make_doctor_selector(),this.doctor_field.set_focus()}init_cart_components(){this.$component.append(`<div class="cart-container">
				<div class="abs-cart-container">
					<div class="cart-label" >${__("Item Cart")}</div>
					<div class="cart-header">
						<div class="name-header">${__("Item")}</div>
						<div class="qty-header">${__("Vat Type")}</div>
						<div class="qty-header">${__("Price")}</div>
						<div class="qty-header" >${__("Disc %")}</div>
						<div class="qty-header">${__("Quantity")}</div>
						
						<div class="rate-amount-header">${__("Amount")}</div>
					</div>
					<div class="cart-items-section"></div>
					<div class="cart-totals-section"></div>
					<div class="numpad-section"></div>
				</div>
			</div>`),this.$cart_container=this.$component.find(".cart-container"),this.make_cart_totals_section(),this.make_cart_items_section(),this.make_cart_numpad()}make_cart_items_section(){this.$cart_header=this.$component.find(".cart-header"),this.$cart_items_wrapper=this.$component.find(".cart-items-section"),this.make_no_items_placeholder()}make_no_items_placeholder(){this.$cart_header.css("display","none"),this.$cart_items_wrapper.html(`<div class="no-item-wrapper">${__("No items in cart")}</div>`)}add_keyboard_navigation(){this.$component.on("keydown",'[tabindex="0"]',e=>{switch(e.key==="Enter"&&$(e.target).trigger("click"),e.key){case"ArrowUp":e.preventDefault(),this.focusPreviousElement(e.target);break;case"ArrowDown":e.preventDefault(),this.focusNextElement(e.target);break}})}focusNextElement(e){let t=$(e).nextAll('[tabindex="0"]').first();t.length||(t=this.$component.find('[tabindex="0"]').first()),t.focus()}focusPreviousElement(e){let t=$(e).prevAll('[tabindex="0"]').first();t.length||(t=this.$component.find('[tabindex="0"]').last()),t.focus()}get_cart_item(e){return this.$cart_items_wrapper.find(`[data-row-name="${escape(e.name)}"]`)}get_discount_icon(){return`<svg class="discount-icon" width="24" height="24" viewBox="0 0 24 24" stroke="currentColor" fill="none" xmlns="http://www.w3.org/2000/svg">
				<path d="M19 15.6213C19 15.2235 19.158 14.842 19.4393 14.5607L20.9393 13.0607C21.5251 12.4749 21.5251 11.5251 20.9393 10.9393L19.4393 9.43934C19.158 9.15804 19 8.7765 19 8.37868V6.5C19 5.67157 18.3284 5 17.5 5H15.6213C15.2235 5 14.842 4.84196 14.5607 4.56066L13.0607 3.06066C12.4749 2.47487 11.5251 2.47487 10.9393 3.06066L9.43934 4.56066C9.15804 4.84196 8.7765 5 8.37868 5H6.5C5.67157 5 5 5.67157 5 6.5V8.37868C5 8.7765 4.84196 9.15804 4.56066 9.43934L3.06066 10.9393C2.47487 11.5251 2.47487 12.4749 3.06066 13.0607L4.56066 14.5607C4.84196 14.842 5 15.2235 5 15.6213V17.5C5 18.3284 5.67157 19 6.5 19H8.37868C8.7765 19 9.15804 19.158 9.43934 19.4393L10.9393 20.9393C11.5251 21.5251 12.4749 21.5251 13.0607 20.9393L14.5607 19.4393C14.842 19.158 15.2235 19 15.6213 19H17.5C18.3284 19 19 18.3284 19 17.5V15.6213Z" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
				<path d="M15 9L9 15" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
				<path d="M10.5 9.5C10.5 10.0523 10.0523 10.5 9.5 10.5C8.94772 10.5 8.5 10.0523 8.5 9.5C8.5 8.94772 8.94772 8.5 9.5 8.5C10.0523 8.5 10.5 8.94772 10.5 9.5Z" fill="white" stroke-linecap="round" stroke-linejoin="round"/>
				<path d="M15.5 14.5C15.5 15.0523 15.0523 15.5 14.5 15.5C13.9477 15.5 13.5 15.0523 13.5 14.5C13.5 13.9477 13.9477 13.5 14.5 13.5C15.0523 13.5 15.5 13.9477 15.5 14.5Z" fill="white" stroke-linecap="round" stroke-linejoin="round"/>
			</svg>`}make_cart_totals_section(){this.$totals_section=this.$component.find(".cart-totals-section"),this.$totals_section.append(`
			<div class="item-qty-total-container">
				<div class="item-qty-total-label">${__("Total Items")}</div>
				<div class="item-qty-total-value">0.00</div>
			</div>
			<div class="vatable-sales-container"></div>
			<div class="vat-exempt-container"></div>
			<div class="zero-rated-container"></div>
			
			
			<div class="ex-total-container"></div>
				<div class="net-total-container" style="line-height: 0rem; font-size:12px;">
				<div class="net-total-label">${__("Sub Total:")}</div>
				<div class="net-total-value" style="font-size:12px;">0.00</div>
			</div>

		 <div class="taxes-container"></div>
		 <div class="vat-container"></div>
		<div class="total-vat-container"></div>
			<div class="grand-total-container" style="line-height: 0rem;">
				<div>${__("Total")}</div>
				<div>0.00</div>
			</div> 

			<div class="checkout-btn">${__("Order")}</div>
			<div class="edit-cart-btn">${__("Edit Cart")}</div>`),this.$add_discount_elem=this.$component.find(".add-discount-wrapper")}make_cart_numpad(){this.$numpad_section=this.$component.find(".numpad-section"),this.number_pad=new custom_app.PointOfSale.NumberPad({wrapper:this.$numpad_section,events:{numpad_event:this.on_numpad_event.bind(this)},cols:5,keys:[["Discount","Quantity","","Remove"]],css_classes:[["","","","col-span-2 remove-btn"],["","","","col-span-2"],["","","","col-span-2"],["","","","col-span-2"]],fieldnames_map:{Quantity:"qty",Discount:"discount_percentage"}}),this.$numpad_section.prepend(`<div class="numpad-totals">
			<span class="numpad-item-qty-total"></span>
				<span class="numpad-net-total"></span>
				<span class="numpad-grand-total"></span>
			</div>`),this.$numpad_section.append(`<div class="numpad-btn checkout-btn" data-button-value="checkout">${__("Order")}</div>`)}bind_events(){let e=this;this.$customer_section.on("click",".reset-customer-btn",function(){e.reset_customer_selector()}),this.$customer_section.on("click",".close-details-btn",function(){e.toggle_customer_info(!1)}),this.$customer_section.on("click",".customer-display",function(t){if($(t.target).closest(".reset-customer-btn").length)return;let i=e.$cart_container.is(":visible");e.toggle_customer_info(i)}),this.$doctor_section.on("click",".reset-doctor-btn",function(){e.reset_doctor_selector()}),this.$doctor_section.on("click",".close-details-btn",function(){e.toggle_doctor_info(!1)}),this.$doctor_section.on("click",".doctor-display",function(t){if($(t.target).closest(".reset-doctor-btn").length)return;let i=e.$cart_container.is(":visible");e.toggle_doctor_info(i)}),this.$cart_items_wrapper.on("click",".cart-item-wrapper",function(){let t=$(this);if(e.toggle_item_highlight(this),!!e.$totals_section.find(".edit-cart-btn").is(":visible")){e.$totals_section.find(".edit-cart-btn").click();return}let n=unescape(t.attr("data-row-name"));e.events.cart_item_clicked({name:n}),this.numpad_value=""}),this.$component.on("click",".checkout-btn",async function(){$(this).attr("style").indexOf("--blue-500")!=-1&&(await e.events.checkout(),e.toggle_checkout_btn(!1),e.allow_discount_change&&e.$add_discount_elem.removeClass("d-none"))}),this.$totals_section.on("click",".edit-cart-btn",()=>{this.passwordDialog&&(this.passwordDialog.$wrapper.remove(),delete this.passwordDialog),this.passwordDialog=new frappe.ui.Dialog({title:__("Enter OIC Password"),fields:[{fieldtype:"HTML",fieldname:"password_html",options:`
							<div class="form-group">
								<label for="password_field">${__("Password")}</label>
								<input type="password" id="password_field" class="form-control" required>
							</div>
						`}],primary_action_label:__("Ok"),primary_action:()=>{let t=document.getElementById("password_field").value;frappe.call({method:"custom_app.customapp.page.packing_list.packing_list.confirm_user_password",args:{password:t},callback:i=>{i.message&&i.message.name?(this.events.edit_cart(),this.toggle_checkout_btn(!0),this.passwordDialog.hide()):frappe.show_alert({message:__("Incorrect password or user is not an OIC"),indicator:"red"})}})}}),this.passwordDialog.show(),this.passwordDialog.$wrapper.on("shown.bs.modal",function(){setTimeout(()=>{document.getElementById("password_field").focus()},100)})}),this.$component.on("click",".add-discount-wrapper",()=>{if(this.is_oic_authenticated){let t=this.$add_discount_elem.find(".edit-discount-btn").length;(!this.discount_field||t)&&this.show_discount_control()}else{let t=new frappe.ui.Dialog({title:__("Enter OIC Password"),fields:[{fieldname:"password",fieldtype:"Password",label:__("Password"),reqd:1}],primary_action_label:__("Add Discount"),primary_action:i=>{let n=i.password,a="oic";frappe.call({method:"custom_app.customapp.page.amesco_point_of_sale.amesco_point_of_sale.confirm_user_password",args:{password:n,role:a},callback:r=>{r.message?(this.is_oic_authenticated=!0,this.show_discount_control(),t.hide()):frappe.show_alert({message:__("Incorrect password or user is not an OIC"),indicator:"red"})}})}});t.show()}}),this.$add_discount_elem.find(".edit-discount-btn").on("click",()=>{this.is_oic_authenticated=!1,this.$component.trigger("click",".add-discount-wrapper")}),frappe.ui.form.on("POS Invoice","paid_amount",t=>{this.update_totals_section(t)})}attach_shortcuts(){document.addEventListener("keydown",function(t){let i={116:!0,"Ctrl+82":!0,"Ctrl+16+82":!0,"Ctrl+83":!0,"Ctrl+80":!0,"Ctrl+87":!0,"Ctrl+Shift+73":!0,"Ctrl+74":!0,"Ctrl+69":!0},n=(t.ctrlKey?"Ctrl+":"")+(t.shiftKey?"Shift+":"")+(t.altKey?"Alt+":"")+t.keyCode;(i[n]||i[t.keyCode])&&t.preventDefault()});for(let t of this.number_pad.keys)for(let i of t){if(typeof i!="string")continue;let n=`ctrl+${frappe.scrub(String(i))[0]}`;i==="Delete"&&(n="ctrl+backspace"),i==="Remove"&&(n="ctrl+x"),i==="Quantity"&&(n="ctrl+q"),i==="Rate"&&(n="ctrl+a"),i==="Discount"&&(n="ctrl+shift+d"),i==="."&&(n="ctrl+>");let a=this.number_pad.fieldnames[i]?this.number_pad.fieldnames[i]:typeof i=="string"?frappe.scrub(i):i,r=n.split("+").map(frappe.utils.to_title_case).join("+");r=frappe.utils.is_mac()?r.replace("Ctrl","\u2318"):r,this.$numpad_section.find(`.numpad-btn[data-button-value="${a}"]`).attr("title",r),frappe.ui.keys.on(`${n}`,()=>{this.$component.is(":visible")&&this.item_is_selected&&this.$numpad_section.is(":visible")&&this.$numpad_section.find(`.numpad-btn[data-button-value="${a}"]`).click()})}let e=frappe.utils.is_mac()?"\u2318":"Ctrl";this.$component.find(".checkout-btn").attr("title",`${e}+Enter`),frappe.ui.keys.add_shortcut({shortcut:"ctrl+enter",action:()=>this.$component.find(".checkout-btn").click(),condition:()=>this.$component.is(":visible")&&!this.$totals_section.find(".edit-cart-btn").is(":visible"),description:__("Checkout Order / Submit Order / New Order"),ignore_inputs:!0,page:cur_page.page.page}),this.$component.find(".edit-cart-btn").attr("title",`${e}+E`),frappe.ui.keys.on("ctrl+e",()=>{let t=this.$component.is(":visible"),i=!this.$totals_section.find(".checkout-btn").is("visible");t&&i&&this.$component.find(".edit-cart-btn").click()}),this.$component.find(".add-discount-wrapper").attr("title",`${e}+D`),frappe.ui.keys.add_shortcut({shortcut:"ctrl+d",action:()=>this.$component.find(".add-discount-wrapper").click(),condition:()=>this.$add_discount_elem.is(":visible"),description:__("Add Order Discount"),ignore_inputs:!0,page:cur_page.page.page}),frappe.ui.keys.on("escape",()=>{this.$component.is(":visible")&&this.discount_field&&this.discount_field.parent.is(":visible")&&this.discount_field.set_value(0)}),this.doctor_field.parent.attr("title",`${e}+R`),frappe.ui.keys.add_shortcut({shortcut:"ctrl+r",action:()=>this.doctor_field.set_focus(),condition:()=>this.$component.is(":visible"),description:__("Doctor"),ignore_inputs:!0,page:cur_page.page.page}),this.customer_field.parent.attr("title",`${e}+M`),frappe.ui.keys.add_shortcut({shortcut:"ctrl+m",action:()=>this.customer_field.set_focus(),condition:()=>this.$component.is(":visible"),description:__("Customer"),ignore_inputs:!0,page:cur_page.page.page}),frappe.ui.keys.add_shortcut({shortcut:"ctrl+<",action:()=>{this.reset_customer_selector()},condition:()=>!0,description:__("Reset Customer Selector"),ignore_inputs:!0,page:cur_page.page.page})}toggle_item_highlight(e){let t=$(e),i=t.attr("style")=="background-color:var(--gray-50);";!e||i?(this.item_is_selected=!1,this.$cart_container.find(".cart-item-wrapper").css("background-color","")):(t.css("background-color","var(--control-bg)"),this.item_is_selected=!0,this.$cart_container.find(".cart-item-wrapper").not(e).css("background-color",""))}make_customer_selector(){this.$customer_section.html(`
			<div class="customer-field" tabindex="0"></div>
		`);let e=this,t=this.allowed_customer_groups||[],i={};t.length&&(i={customer_group:["in",t]}),this.customer_field=frappe.ui.form.make_control({df:{label:__("Customer"),fieldtype:"Link",options:"Customer",placeholder:__("Search by customer name, phone, email."),get_query:function(){return{filters:i}},onchange:function(){if(this.value){let n=e.events.get_frm();frappe.dom.freeze(),frappe.model.set_value(n.doc.doctype,n.doc.name,"customer",this.value),n.script_manager.trigger("customer",n.doc.doctype,n.doc.name).then(()=>{frappe.run_serially([()=>e.fetch_customer_details(this.value),()=>e.events.customer_details_updated(e.customer_info),()=>e.update_customer_section(),()=>frappe.dom.unfreeze()])})}}},parent:this.$customer_section.find(".customer-field"),render_input:!0}),this.customer_field.toggle_label(!1)}make_doctor_selector(){this.$doctor_section.html(`
        <div class="doctor-field"></div>
    `);let e=this,t=this.allowed_doctor_groups||[],i={};t.length&&(i={doctor_group:["in",t]}),this.doctor_field=frappe.ui.form.make_control({df:{label:__("Doctor"),fieldtype:"Link",options:"Doctor",placeholder:__("Doctor"),onchange:function(){if(this.value){let n=e.events.get_frm();frappe.dom.freeze(),frappe.model.set_value(n.doc.doctype,n.doc.name,"custom_doctors_information",this.value),n.script_manager.trigger("custom_doctors_information",n.doc.doctype,n.doc.name).then(()=>{frappe.run_serially([()=>frappe.dom.unfreeze()])})}}},parent:this.$doctor_section.find(".doctor-field"),render_input:!0}),this.doctor_field.toggle_label(!1),$(document).on("keydown",function(n){n.altKey&&n.key==="d"&&e.doctor_field.$input.focus()})}fetch_customer_details(e){return e?new Promise(t=>{frappe.db.get_value("Customer",e,["email_id","customer_name","mobile_no","image","loyalty_program","custom_osca_id","custom_pwd_id","customer_group"]).then(({message:i})=>{let{loyalty_program:n}=i;n?frappe.call({method:"erpnext.accounts.doctype.loyalty_program.loyalty_program.get_loyalty_program_details_with_points",args:{customer:e,loyalty_program:n,silent:!0},callback:a=>{let{loyalty_points:r,conversion_factor:o}=a.message;a.exc||(this.customer_info=J(z({},i),{customer:e,loyalty_points:r,conversion_factor:o}),t())}}):(this.customer_info=J(z({},i),{customer:e}),t())})}):new Promise(t=>{this.customer_info={},t()})}fetch_doctor_details(e){return e?new Promise(t=>{frappe.db.get_value("Doctor",e,["first_name","last_name","prc_number","image"]).then(({message:i})=>{this.doctor_info=J(z({},i),{doctor:e}),console.log(this.doctor_info),t()})}):new Promise(t=>{this.doctor_info={},t()})}show_discount_control(){this.$add_discount_elem.css({padding:"0px",border:"none"}),this.$add_discount_elem.html('<div class="add-discount-field"></div>');let e=this,t=e.events.get_frm(),i=t.doc.additional_discount_percentage;this.discount_field=frappe.ui.form.make_control({df:{label:__("Discount"),fieldtype:"Data",placeholder:i?i+"%":__("Enter discount percentage."),input_class:"input-xs",onchange:function(){flt(this.value)!=0?(frappe.model.set_value(t.doc.doctype,t.doc.name,"additional_discount_percentage",flt(this.value)),e.hide_discount_control(this.value)):(frappe.model.set_value(t.doc.doctype,t.doc.name,"additional_discount_percentage",0),e.$add_discount_elem.css({border:"1px dashed var(--gray-500)",padding:"var(--padding-sm) var(--padding-md)"}),e.$add_discount_elem.html(`${e.get_discount_icon()} ${__("Add Discount")}`),e.discount_field=void 0)}},parent:this.$add_discount_elem.find(".add-discount-field"),render_input:!0}),this.discount_field.toggle_label(!1),this.discount_field.set_focus()}hide_discount_control(e){e?(this.$add_discount_elem.css({border:"1px dashed var(--dark-green-500)",padding:"var(--padding-sm) var(--padding-md)"}),this.$add_discount_elem.html(`<div class="edit-discount-btn">
					${this.get_discount_icon()} ${__("Additional")}&nbsp;${String(e).bold()}% ${__("discount applied")}
				</div>`)):(this.$add_discount_elem.css({padding:"0px",border:"none"}),this.$add_discount_elem.html('<div class="add-discount-field"></div>'))}update_customer_section(){let e=this,{customer:t,email_id:i="",mobile_no:n="",image:a,customer_name:r="",customer_group:o=""}=this.customer_info||{};t?this.$customer_section.html(`<div class="customer-details">
					<div class="customer-display">
						${this.get_customer_image()}
						<div class="customer-name-desc">
							<div class="customer-name"> ${r} -  ${o} </div>
							${s()}
						</div>
					</div>
				</div>`):this.reset_customer_selector();function s(){return!i&&!n?`<div class="customer-desc">${__("Click to add email / phone")}</div>`:i&&!n?`<div class="customer-desc">${i}</div>`:n&&!i?`<div class="customer-desc">${n}</div>`:`<div class="customer-desc">${i} - ${n}</div>`}}update_doctor_section(){let e=this,{doctor:t,first_name:i="",last_name:n="",prc_number:a="",image:r}=this.doctor_info||{};t?this.$doctor_section.html(`<div class="doctor-details">
					<div class="doctor-display">
						${this.get_doctor_image()}
						<div class="doctor-name-desc">
							<div class="doctor-name">${t}</div>
							${o()}
						</div>
						<div class="reset-doctors-btn" data-doctors="${escape(doctors)}">
							<svg width="32" height="32" viewBox="0 0 14 14" fill="none">
								<path d="M4.93764 4.93759L7.00003 6.99998M9.06243 9.06238L7.00003 6.99998M7.00003 6.99998L4.93764 9.06238L9.06243 4.93759" stroke="#8D99A6"/>
							</svg>
						</div>
					</div>
				</div>`):this.reset_doctor_selector();function o(){return!email_id&&!mobile_no?`<div class="doctor-desc">${__("Click to add email / phone")}</div>`:email_id&&!mobile_no?`<div class="doctor-desc">${email_id}</div>`:mobile_no&&!email_id?`<div class="doctor-desc">${mobile_no}</div>`:`<div class="doctorvv-desc">${email_id} - ${mobile_no}</div>`}}get_customer_image(){let{customer:e,image:t}=this.customer_info||{};return t?`<div class="customer-image"><img src="${t}" alt="${t}""></div>`:`<div class="customer-image customer-abbr">${frappe.get_abbr(e)}</div>`}get_doctor_image(){let{doctor:e,image:t}=this.doctor_info||{};return t?`<div class="doctor-image"><img src="${t}" alt="${t}""></div>`:`<div class="doctor-image doctor-abbr">${frappe.get_abbr(e)}</div>`}update_totals_section(e){e||(e=this.events.get_frm()),this.render_vatable_sales(e.doc.custom_vatable_sales),this.render_vat_exempt_sales(e.doc.custom_vat_exempt_sales),this.render_zero_rated_sales(e.doc.custom_zero_rated_sales),this.render_net_total(e.doc.net_total),this.render_total_item_qty(e.doc.items);let t=cint(frappe.sys_defaults.disable_rounded_total)?e.doc.grand_total:e.doc.rounded_total;this.render_grand_total(t),this.render_total_vat(e.doc.total_taxes_and_charges)}render_net_total(e){let t=this.events.get_frm().doc.currency;this.$totals_section.find(".net-total-container").html(`<div style="font-size:12px;">${__("Sub Total")}</div> <div>${format_currency(e,t)}</div>`),this.$numpad_section.find(".numpad-net-total").html(`<div>${__("Sub Total")}: <span>${format_currency(e,t)}</span></div>`)}render_vatable_sales(e){let t=this.events.get_frm().doc.currency;this.$totals_section.find(".vatable-sales-container").html(`
				<div style="display: flex; align-items: center; width: 100%; font-size:12px;">
					<span style="flex: 1;">
						${__("VATable Sales")}: 
					</span>
					<span style="flex-shrink: 0;  ">${format_currency(e,t)}</span>
					</span>
				</div>
			`)}render_vat_exempt_sales(e){let t=this.events.get_frm().doc.currency;this.$totals_section.find(".vat-exempt-container").html(`
				<div style="display: flex; align-items: center; width: 100%; font-size:12px;">
					<span style="flex: 1;">
						${__("VAT-Exempt Sales")}: 
					</span>
					<span style="flex-shrink: 0;">${format_currency(e,t)}</span>
				</div>
			`)}render_zero_rated_sales(e){let t=this.events.get_frm().doc.currency;this.$totals_section.find(".zero-rated-container").html(`
				<div style="display: flex; align-items: center; width: 100%; font-size:12px;">
					<span style="flex: 1;">
						${__("Zero Rated Sales")}: 
					</span>
					<span style="flex-shrink: 0;">${format_currency(e,t)}</span>
				</div>
			`)}render_vat(e){let t=this.events.get_frm().doc.currency;this.$totals_section.find(".vat-container").html(`
				<div style="display: flex; align-items: center; width: 100%; font-size:12px;">
					<span style="flex: 1;">
						${__("VAT 12%")}:
					</span>
					<span style="flex-shrink: 0;">${format_currency(e,t)}</span>
				</div>
			`)}render_total_vat(e){let t=this.events.get_frm().doc.currency;this.$totals_section.find(".total-vat-container").html(`
				<div style="display: flex; justify-content: space-between; font-size:12px;">
					<span style="flex: 1;">${__("Total VAT")}: </span>
					<span style="flex-shrink: 0;">${format_currency(e,t)}</span>
				</div>
			`)}render_ex_total(e){let t=this.events.get_frm().doc.currency;this.$totals_section.find(".ex-total-container").html(`
				<div style="display: flex; align-items: center; width: 100%; font-size:10px;>
					<span style="flex: 1;">
						${__("Ex Total")}: 
					</span>
					<span style="flex-shrink: 0;">${format_currency(e,t)}</span>
				</div>
			`)}render_total_item_qty(e){var t=0;e.map(i=>{t=t+i.qty}),this.$totals_section.find(".item-qty-total-container").html(`<div>${__("Total Quantity")}</div><div>${t}</div>`),this.$numpad_section.find(".numpad-item-qty-total").html(`<div>${__("Total Quantity")}: <span>${t}</span></div>`)}render_grand_total(e){let t=this.events.get_frm().doc.currency;this.$totals_section.find(".grand-total-container").html(`<div style="font-size:14px;">${__("Total")}</div><div>${format_currency(e,t)}</div>`),this.$numpad_section.find(".numpad-grand-total").html(`<div>${__("Total")}: <span>${format_currency(e,t)}</span></div>`)}render_taxes(e){if(e&&e.length){let t=this.events.get_frm().doc.currency,i=e.map(n=>n.tax_amount_after_discount_amount==0?void 0:`<div class="tax-row">
					<div class="tax-label">${/[0-9]+/.test(n.description)?n.description:n.rate!=0?`${n.description} ${n.rate}%`:n.description}</div>
					<div class="tax-value">${format_currency(n.tax_amount_after_discount_amount,t)}</div>
				</div>`).join("");this.$totals_section.find(".taxes-container").css("display","flex").html(i)}else this.$totals_section.find(".taxes-container").css("display","none").html("")}get_cart_item({name:e}){let t=`.cart-item-wrapper[data-row-name="${escape(e)}"]`;return this.$cart_items_wrapper.find(t)}get_item_from_frm(e){return this.events.get_frm().doc.items.find(i=>i.name==e.name)}update_item_html(e,t){let i=this.get_cart_item(e),n=JSON.parse(localStorage.getItem("posCartItems"))||[];if(t)i&&(i.next().remove(),i.remove(),n=n.filter(r=>r.item_code!==e.item_code),localStorage.setItem("posCartItems",JSON.stringify(n)),this.remove_customer(),this.set_cash_customer(),frappe.run_serially([()=>frappe.dom.unfreeze()]));else{let r=this.get_item_from_frm(e);this.render_cart_item(r,i);let o=n.findIndex(s=>s.item_code===e.item_code);o>-1?n[o]=e:n.push(e),localStorage.setItem("posCartItems",JSON.stringify(n))}let a=this.$cart_items_wrapper.find(".cart-item-wrapper").length;this.highlight_checkout_btn(a>0),this.update_empty_cart_section(a)}remove_customer(){let e=this.events.get_frm(),t=e.doc.customer;frappe.model.set_value(e.doc.doctype,e.doc.name,"custom_customer_2",t),frappe.model.set_value(e.doc.doctype,e.doc.name,"customer",""),this.update_customer_section()}set_cash_customer(){let e=this.events.get_frm(),t=e.doc.custom_customer_2;frappe.model.set_value(e.doc.doctype,e.doc.name,"customer",t),this.update_customer_section()}render_cart_item(e,t){let i=this.events.get_frm().doc.currency,n=this,a=n.events.get_frm().doc.customer_group,r=.12,o=e.price_list_rate/(1+r);t.length||(this.$cart_items_wrapper.append(`<div class="cart-item-wrapper" tabindex="0" data-row-name="${escape(e.name)}" style="font-size: 12px; padding: 5px;">
					<div class="separator" style="height: 0.8px; background-color: #e0e0e0; margin: 4px 0;"></div>`),t=this.get_cart_item(e)),t.html(`${u()}
			<div class="item-name-desc" style="font-size: 10px;">
				<div class="item-name" style="font-size: 12px;">
					${e.item_name}
				</div>
				${v()}
			</div>
			
			<div class="item-vat mx-3" style="font-size: 10px;">
				<strong>${h(e)}</strong>
			</div> 
			
			<div class="item-vat mx-3" style="font-size: 10px;">
				<strong>${format_currency(e.price_list_rate,i)}</strong>
			</div>
			
			<div class="item-discount mx-3" style="font-size: 10px;">
				<strong>${Math.round(e.discount_percentage)}%</strong>
			</div>
			${b(a)}`),s();function s(){let l=Array.from(n.$cart_items_wrapper.find(".item-rate-amount"));n.$cart_header.find(".rate-amount-header").css("width",""),n.$cart_items_wrapper.find(".item-rate-amount").css("width","");let f=l.reduce((c,d)=>($(d).width()>c&&(c=$(d).width()),c),0);f+=1,f===1&&(f=""),n.$cart_header.find(".rate-amount-header").css("width",f),n.$cart_items_wrapper.find(".item-rate-amount").css("width",f)}function h(l){return l.custom_vat_exempt_amount&&l.custom_vat_exempt_amount!=0?"VAT-E":l.custom_vatable_amount&&l.custom_vatable_amount!=0?"VAT":l.custom_zero_rated_amount&&l.custom_zero_rated_amount!=0?"ZR":l.custom_free===1?"FREE":"Unknown"}function b(l){return l==="Zero Rated"?`
						<div class="item-qty-rate">
							<div class="item-qty" style="font-size:10px;"><span>${e.qty||0} ${e.uom}</span></div>
							<div class="item-rate-amount">
								<div class="item-rate" style="font-size:11px;">${format_currency(e.custom_zero_rated_amount,i)}</div>
								
							</div>
						</div>`:l==="Senior Citizen"||l==="PWD"?`
					<div class="item-qty-rate">
						<div class="item-qty" style="font-size:10px;"><span>${e.qty||0} ${e.uom}</span></div>
						<div class="item-rate-amount">
							<div class="item-rate" style="font-size:11px;">${format_currency(e.pricing_rules===`[
 "PRLE-0005330"
]`||e.pricing_rules===""?e.amount:e.custom_vatable_amount?e.custom_vatable_amount:e.custom_vat_exempt_amount,i)}</div>
						</div>
					</div>`:e.rate&&e.amount&&e.rate!==e.amount?`
						<div class="item-qty-rate">
							<div class="item-qty" style="font-size:10px;"><span>${e.qty||0} ${e.uom}</span></div>
							<div class="item-rate-amount">
								<div class="item-rate" style="font-size:11px;">${format_currency(e.amount,i)}</div>
							</div>
						</div>`:`
						<div class="item-qty-rate">
							<div class="item-qty" style="font-size:10px;"><span>${e.qty||0} ${e.uom}</span></div>
							<div class="item-rate-amount">
								<div class="item-rate" style="font-size:11px;">${format_currency(e.rate,i)}</div>
							</div>
						</div>`}function v(){if(e.description){if(e.description.indexOf("<div>")!==-1)try{e.description=$(e.description).text()}catch(l){e.description=e.description.replace(/<div>/g," ").replace(/<\/div>/g," ").replace(/ +/g," ")}return e.description=frappe.ellipsis(e.description,45),`<div class="item-desc" style="font-size:10px;">${e.description}</div>`}return""}function u(){let{image:l,item_name:f}=e;return!n.hide_images&&l?`
					<div class="item-image">
						<img
							onerror="cur_pos.cart.handle_broken_image(this)"
							src="${l}" alt="${frappe.get_abbr(f)}">
					</div>`:`<div class="item-image item-abbr">${frappe.get_abbr(f)}</div>`}this.$cart_items_wrapper.off("keydown",".cart-item-wrapper").on("keydown",".cart-item-wrapper",function(l){let f=n.$cart_items_wrapper.find(".cart-item-wrapper"),c=f.index($(this)),d=c;switch(l.which){case 13:$(this).click();break;case 38:d=c>0?c-1:f.length-1;break;case 40:d=c<f.length-1?c+1:0;break;default:return}f.eq(d).focus()}),frappe.ui.keys.add_shortcut({shortcut:"ctrl+c",action:()=>{let l=n.$cart_items_wrapper.find(".cart-item-wrapper");l.length&&l.first().focus()},condition:()=>n.$cart_items_wrapper.is(":visible"),description:__("Activate Cart Item Focus"),ignore_inputs:!0,page:cur_page.page.page})}handle_broken_image(e){let t=$(e).attr("alt");$(e).parent().replaceWith(`<div class="item-image item-abbr">${t}</div>`)}update_selector_value_in_cart_item(e,t,i){this.get_cart_item(i).attr(`data-${e}`,escape(t))}toggle_checkout_btn(e){e?(this.$totals_section.find(".checkout-btn").css("display","flex"),this.$totals_section.find(".edit-cart-btn").css("display","none")):(this.$totals_section.find(".checkout-btn").css("display","none"),this.$totals_section.find(".edit-cart-btn").css("display","flex"))}highlight_checkout_btn(e){e?(this.$add_discount_elem.css("display","flex"),this.$cart_container.find(".checkout-btn").css({"background-color":"var(--blue-500)"})):(this.$add_discount_elem.css("display","none"),this.$cart_container.find(".checkout-btn").css({"background-color":"var(--blue-200)"}))}update_empty_cart_section(e){let t=this.$cart_items_wrapper.find(".no-item-wrapper");e>0&&t&&t.remove()&&this.$cart_header.css("display","flex"),e===0&&!t.length&&this.make_no_items_placeholder()}on_numpad_event(e){let t=e.attr("data-button-value"),i=["qty","discount_percentage","rate"].includes(t),n=i?t=="rate"&&this.allow_rate_change||t=="discount_percentage"&&this.allow_discount_change||t=="qty":!0,a=this.prev_action===t,r=!this.prev_action,o=this.prev_action&&this.prev_action!=t;if(i){if(!n){let h=t=="rate"?"Rate".bold():"Discount".bold(),b=__("Editing {0} is not allowed as per POS Profile settings",[h]);frappe.show_alert({indicator:"red",message:b}),frappe.utils.play_sound("error");return}r||o?this.prev_action=t:a&&(this.prev_action=void 0),this.numpad_value=""}else if(t==="checkout"){this.prev_action=void 0,this.toggle_item_highlight(),this.events.numpad_event(void 0,t);return}else if(t==="remove"){this.prev_action=void 0,this.toggle_item_highlight(),this.events.numpad_event(void 0,t);return}else this.numpad_value=t==="delete"?this.numpad_value.slice(0,-1):this.numpad_value+t,this.numpad_value=this.numpad_value||0;if(!i&&r){frappe.show_alert({indicator:"red",message:__("Please select a field to edit from numpad")}),frappe.utils.play_sound("error");return}flt(this.numpad_value)>100&&this.prev_action==="discount_percentage"&&(frappe.show_alert({message:__("Discount cannot be greater than 100%"),indicator:"orange"}),frappe.utils.play_sound("error"),this.numpad_value=t),this.highlight_numpad_btn(e,t),this.events.numpad_event(this.numpad_value,this.prev_action)}highlight_numpad_btn(e,t){let i=e.hasClass("highlighted-numpad-btn"),n=["qty","discount_percentage","rate","done"].includes(t);i||e.addClass("highlighted-numpad-btn"),this.prev_action===t&&i&&e.removeClass("highlighted-numpad-btn"),this.prev_action&&this.prev_action!==t&&n&&$(`[data-button-value='${this.prev_action}']`).removeClass("highlighted-numpad-btn"),(!n||t==="done")&&setTimeout(()=>{e.removeClass("highlighted-numpad-btn")},200)}toggle_numpad(e){e?(this.$totals_section.css("display","none"),this.$numpad_section.css("display","flex")):(this.$totals_section.css("display","flex"),this.$numpad_section.css("display","none")),this.reset_numpad()}reset_numpad(){this.numpad_value="",this.prev_action=void 0,this.$numpad_section.find(".highlighted-numpad-btn").removeClass("highlighted-numpad-btn")}toggle_numpad_field_edit(e){["qty","discount_percentage","rate"].includes(e)&&this.$numpad_section.find(`[data-button-value="${e}"]`).click()}toggle_customer_info(e){if(e){let{customer:t}=this.customer_info||{};this.$cart_container.css("display","none"),this.$customer_section.css({height:"100%","padding-top":"0px"}),this.$customer_section.find(".customer-details").html(`<div class="header">
					<div class="label">Contact Details</div>
					<div class="close-details-btn">
						<svg width="32" height="32" viewBox="0 0 14 14" fill="none">
							<path d="M4.93764 4.93759L7.00003 6.99998M9.06243 9.06238L7.00003 6.99998M7.00003 6.99998L4.93764 9.06238L9.06243 4.93759" stroke="#8D99A6"/>
						</svg>
					</div>
				</div>
				<div class="customer-display">
					${this.get_customer_image()}
					<div class="customer-name-desc">
						<div class="customer-name">${t}</div>
						<div class="customer-desc"></div>
					</div>
				</div>
				<div class="customer-fields-container">
					<div class="email_id-field"></div>
					<div class="mobile_no-field"></div>
					<div class="custom_osca_id-field"></div>
					<div class="custom_pwd_id-field"></div>
					<div class="loyalty_program-field"></div>
					<div class="loyalty_points-field"></div>
				
				</div>
				<div class="transactions-label">Recent Transactions</div>`),this.$customer_section.append('<div class="customer-transactions"></div>'),this.render_customer_fields(),this.fetch_customer_transactions()}else this.$cart_container.css("display","flex"),this.$customer_section.css({height:"","padding-top":""}),this.update_customer_section()}render_customer_fields(){let e=this.$customer_section.find(".customer-fields-container"),t=[{fieldname:"email_id",label:__("Email"),fieldtype:"Data",options:"email",placeholder:__("Enter customer's email")},{fieldname:"mobile_no",label:__("Phone Number"),fieldtype:"Data",placeholder:__("Enter customer's phone number")},{fieldname:"loyalty_program",label:__("Loyalty Program"),fieldtype:"Link",options:"Loyalty Program",placeholder:__("Select Loyalty Program")},{fieldname:"loyalty_points",label:__("Loyalty Points"),fieldtype:"Data",read_only:1},{fieldname:"custom_osca_id",label:__("OSCA ID"),fieldtype:"Data",read_only:1},{fieldname:"custom_pwd_id",label:__("PWD ID"),fieldtype:"Data",read_only:1}],i=this;t.forEach(a=>{this[`customer_${a.fieldname}_field`]=frappe.ui.form.make_control({df:J(z({},a),{onchange:n}),parent:e.find(`.${a.fieldname}-field`),render_input:!0}),this[`customer_${a.fieldname}_field`].set_value(this.customer_info[a.fieldname])});function n(){let a=i.customer_info[this.df.fieldname],r=i.customer_info.customer;this.value&&a!=this.value&&this.df.fieldname!="loyalty_points"&&frappe.call({method:"custom_app.customapp.page.amesco_point_of_sale.amesco_point_of_sale.set_customer_info",args:{fieldname:this.df.fieldname,customer:r,value:this.value},callback:o=>{o.exc||(i.customer_info[this.df.fieldname]=this.value,frappe.show_alert({message:__("Customer contact updated successfully."),indicator:"green"}),frappe.utils.play_sound("submit"))}})}}fetch_customer_transactions(){frappe.db.get_list("POS Invoice",{filters:{customer:this.customer_info.customer,docstatus:1},fields:["name","grand_total","status","posting_date","posting_time","currency","custom_invoice_series"],limit:20}).then(e=>{let t=this.$customer_section.find(".customer-transactions");if(!e.length){t.html('<div class="no-transactions-placeholder">No recent transactions found</div>');return}let i=moment(e[0].posting_date+" "+e[0].posting_time).fromNow();this.$customer_section.find(".customer-desc").html(`Last transacted ${i}`),e.forEach(n=>{let a=moment(n.posting_date+" "+n.posting_time).format("Do MMMM, h:mma"),r={Paid:"green",Draft:"red",Return:"gray",Consolidated:"blue"};t.append(`<div class="invoice-wrapper" data-invoice-name="${escape(n.name)}">
						<div class="invoice-name-date">
							<div class="invoice-name">${n.custom_invoice_series}</div>
							<div class="invoice-date">${a}</div>
						</div>
						<div class="invoice-total-status">
							<div class="invoice-total">
								${format_currency(n.grand_total,n.currency,0)||0}
							</div>
							<div class="invoice-status">
								<span class="indicator-pill whitespace-nowrap ${r[n.status]}">
									<span>${n.status}</span>
								</span>
							</div>
						</div>
					</div>
					<div class="seperator"></div>`)})})}attach_refresh_field_event(e){$(e.wrapper).off("refresh-fields"),$(e.wrapper).on("refresh-fields",()=>{e.doc.items.length&&(this.$cart_items_wrapper.html(""),e.doc.items.forEach(t=>{this.update_item_html(t)})),this.update_totals_section(e)})}load_invoice(){let e=this.events.get_frm();this.attach_refresh_field_event(e),this.fetch_customer_details(e.doc.customer).then(()=>{this.events.customer_details_updated(this.customer_info),this.update_customer_section()}),this.$cart_items_wrapper.html(""),e.doc.items.length?e.doc.items.forEach(t=>{this.update_item_html(t)}):(this.make_no_items_placeholder(),this.highlight_checkout_btn(!1)),this.update_totals_section(e),e.doc.docstatus===1?(this.$totals_section.find(".checkout-btn").css("display","none"),this.$totals_section.find(".edit-cart-btn").css("display","none")):(this.$totals_section.find(".checkout-btn").css("display","flex"),this.$totals_section.find(".edit-cart-btn").css("display","none")),this.toggle_component(!0)}toggle_component(e){e?this.$component.css("display","flex"):this.$component.css("display","none")}};custom_app.PointOfSale.ItemDetails=class{constructor({wrapper:e,events:t,settings:i}){this.wrapper=e,this.events=t,this.hide_images=i.hide_images,this.allow_rate_change=i.allow_rate_change,this.allow_discount_change=i.allow_discount_change,this.current_item={},this.init_component()}init_component(){this.prepare_dom(),this.init_child_components(),this.bind_events(),this.attach_shortcuts()}prepare_dom(){this.wrapper.append('<section class="item-details-container" style="grid-column:span 3 / span 3;"></section>'),this.$component=this.wrapper.find(".item-details-container")}init_child_components(){this.$component.html(`<div class="item-details-header">
				<div class="label">${__("Item Details")}</div>
				<div class="close-btn">
					<svg width="32" height="32" viewBox="0 0 14 14" fill="none">
						<path d="M4.93764 4.93759L7.00003 6.99998M9.06243 9.06238L7.00003 6.99998M7.00003 6.99998L4.93764 9.06238L9.06243 4.93759" stroke="#8D99A6"/>
					</svg>
				</div>
			</div>
			<div class="item-display">
				<div class="item-name-desc-price">
					<div class="item-name"></div>
					<div class="item-desc"></div>
					<div class="item-price"></div>
				</div>
			</div>
			<div class="discount-section"></div>
			<div class="form-container"></div>
			<div class="serial-batch-container"></div>`),this.$item_name=this.$component.find(".item-name"),this.$item_description=this.$component.find(".item-desc"),this.$item_price=this.$component.find(".item-price"),this.$item_image=this.$component.find(".item-image"),this.$form_container=this.$component.find(".form-container"),this.$dicount_section=this.$component.find(".discount-section"),this.$serial_batch_container=this.$component.find(".serial-batch-container")}compare_with_current_item(e){return e&&e.name==this.current_item.name}async toggle_item_details_section(e){let t=!this.compare_with_current_item(e),i=!Boolean(e)||!t;(!i&&t||i)&&await this.validate_serial_batch_item(),this.events.toggle_item_selector(!i),this.toggle_component(!i),e&&t?(this.doctype=e.doctype,this.item_meta=frappe.get_meta(this.doctype),this.name=e.name,this.item_row=e,this.currency=this.events.get_frm().doc.currency,this.current_item=e,this.render_dom(e),this.render_discount_dom(e),this.render_form(e),this.events.highlight_cart_item(e)):this.current_item={}}validate_serial_batch_item(){let t=this.events.get_frm().doc.items.find(r=>r.name===this.name);if(!t)return;let i=t.has_serial_no,n=t.has_batch_no,a=!t.serial_and_batch_bundle;if(i&&a||n&&a)return frappe.show_alert({message:__("Item is removed since no serial / batch no selected."),indicator:"orange"}),frappe.utils.play_sound("cancel"),this.events.remove_item_from_cart()}render_dom(e){let{item_name:t,description:i,image:n,price_list_rate:a,custom_remarks:r,custom_vat:o}=e;function s(){return i?(i=i.indexOf("...")===-1&&i.length>140?i.substr(0,139)+"...":i,i):""}this.$item_name.html(t),this.$item_description.html(s()),this.$item_price.html(format_currency(a,this.currency))}handle_broken_image(e){let t=$(e).attr("alt");$(e).replaceWith(`<div class="item-abbr">${t}</div>`)}render_discount_dom(e){e.discount_percentage?(this.$dicount_section.html(`<div class="item-rate">${format_currency(e.price_list_rate,this.currency)}</div>
				<div class="item-discount">${e.discount_percentage}% off</div>`),this.$item_price.html(format_currency(e.rate,this.currency))):this.$dicount_section.html("")}render_form(e){let t=this.get_form_fields(e);this.$form_container.html(""),this.original_rate=e.rate,t.forEach((i,n)=>{this.$form_container.append(`<div class="${i}-control" data-fieldname="${i}"></div>`);let a=this.item_meta.fields.find(o=>o.fieldname===i);i==="discount_percentage"&&(a.label=__("Discount (%)"));let r=this;this[`${i}_control`]=frappe.ui.form.make_control({df:J(z({},a),{onchange:function(){r.events.form_updated(r.current_item,i,this.value),r.is_oic_authenticated=!1}}),parent:this.$form_container.find(`.${i}-control`),render_input:!0}),this[`${i}_control`].set_value(e[i]),(i==="discount_percentage"||i==="discount_amount"||i==="rate")&&this.$form_container.find(`.${i}-control input`).on("focus",function(){r.is_oic_authenticated||r.oic_authentication(i,e)})}),this.make_auto_serial_selection_btn(e),this.bind_custom_control_change_event()}oic_authentication(e,t){let i=this,n=i.events.get_frm(),a=new frappe.ui.Dialog({title:__("Authorization Required OIC"),fields:[{fieldname:"password",fieldtype:"Password",label:__("Password"),reqd:1}],primary_action_label:__("Authorize"),primary_action:r=>{let o=r.password;frappe.call({method:"custom_app.customapp.page.packing_list.packing_list.confirm_user_password",args:{password:o},callback:s=>{s.message?s.message.name?(frappe.show_alert({message:__("Verified"),indicator:"green"}),a.hide(),i.enable_discount_input(e),i.set_discount_log(n,t,s),i.is_oic_authenticated=!0):frappe.show_alert({message:__("Incorrect password or user is not an OIC"),indicator:"red"}):frappe.show_alert({message:__("Incorrect password or user is not an OIC"),indicator:"red"})}})}});a.show()}set_discount_log(e,t,i){let n=e.doc.custom_manual_dicsount||"",a=`${t.item_code} - ${i.message.full_name} - ${frappe.datetime.now_datetime()}
`,r=n+a;e.set_value("custom_manual_dicsount",r)}enable_discount_input(e){this.$form_container.find(`.${e}-control input`).prop("disabled",!1)}get_form_fields(e){let t=["custom_free","qty","price_list_rate","rate","uom","discount_percentage","discount_amount","custom_batch_number","custom_batch_expiry","custom_vat_amount","custom_vatable_amount","custom_vat_exempt_amount","custom_zero_rated_amount","custom_remarks"];return e.has_serial_no&&t.push("serial_no"),e.has_batch_no&&t.push("batch_no"),t}make_auto_serial_selection_btn(e){if(e.has_serial_no||e.has_batch_no){let t=e.has_serial_no?__("Select Serial No"):__("Select Batch No");this.$form_container.append(`<div class="btn btn-sm btn-secondary auto-fetch-btn">${t}</div>`),this.$form_container.find(".serial_no-control").find("textarea").css("height","6rem")}}bind_custom_control_change_event(){let e=this;if(this.rate_control){let t=e.events.get_frm();if(this.rate_control.df.onchange=null,this.rate_control.df.onchange=function(){(this.value||flt(this.value)===0)&&(this._debounce&&clearTimeout(this._debounce),this._debounce=setTimeout(()=>{e.events.form_updated(e.current_item,"rate",this.value).then(()=>{let i=frappe.get_doc(e.doctype,e.name),n=e.events.get_frm().doc;e.$item_price.html(format_currency(i.rate,n.currency)),e.render_discount_dom(i)})},200))},t.doc.customer_group==="Senior Citizen")return;this.rate_control.df.read_only=!this.allow_rate_change,this.rate_control.refresh()}if(e.events&&e.events.get_frm()&&e.events.get_frm().doc){let t=e.events.get_frm();if(t.doc.customer_group==="Senior Citizen"||t.doc.customer_group==="PWD")return;e.discount_percentage_control&&!e.allow_discount_change&&(e.discount_percentage_control.df.read_only=1,e.discount_percentage_control.refresh())}this.warehouse_control&&(this.warehouse_control.df.reqd=1,this.warehouse_control.df.onchange=function(){this.value&&e.events.form_updated(e.current_item,"warehouse",this.value).then(()=>{e.item_stock_map=e.events.get_item_stock_map();let t=e.item_stock_map[e.item_row.item_code][this.value][0],i=Boolean(e.item_stock_map[e.item_row.item_code][this.value][1]);if(t===void 0)e.events.get_available_stock(e.item_row.item_code,this.value).then(()=>{e.warehouse_control.set_value(this.value)});else if(t===0&&i){e.warehouse_control.set_value("");let n=e.item_row.item_code.bold(),a=this.value.bold();frappe.throw(__("Item Code: {0} is not available under warehouse {1}.",[n,a]))}e.actual_qty_control.set_value(t)})},this.warehouse_control.df.get_query=()=>({filters:{company:this.events.get_frm().doc.company}}),this.warehouse_control.refresh()),this.serial_no_control&&(this.serial_no_control.df.reqd=1,this.serial_no_control.df.onchange=async function(){!e.current_item.batch_no&&await e.auto_update_batch_no(),e.events.form_updated(e.current_item,"serial_no",this.value)},this.serial_no_control.refresh()),this.batch_no_control&&(this.batch_no_control.df.reqd=1,this.batch_no_control.df.get_query=()=>({query:"erpnext.controllers.queries.get_batch_no",filters:{item_code:e.item_row.item_code,warehouse:e.item_row.warehouse,posting_date:e.events.get_frm().doc.posting_date}}),this.batch_no_control.refresh()),this.uom_control&&(this.uom_control.df.onchange=function(){e.events.form_updated(e.current_item,"uom",this.value);let t=frappe.get_doc(e.doctype,e.name);e.conversion_factor_control.df.read_only=t.stock_uom==this.value,e.conversion_factor_control.refresh()}),frappe.model.on("POS Invoice Item","*",(t,i,n)=>{let a=this[`${t}_control`];this.compare_with_current_item(n)&&a&&a.get_value()!==i&&(a.set_value(i),cur_pos.update_cart_html(n))})}async auto_update_batch_no(){if(this.serial_no_control&&this.batch_no_control){let e=this.serial_no_control.get_value().split(`
`).filter(s=>s);if(!e.length)return;let i=(await frappe.db.get_list("Serial No",{filters:{name:["in",e]},fields:["batch_no","name"]})).reduce((s,h)=>(s[h.batch_no]||(s[h.batch_no]=[]),s[h.batch_no]=[...s[h.batch_no],h.name],s),{}),n=Object.keys(i)[0],a=i[n].join(`
`),r=e.length!==i[n].length;this.batch_no_control.get_value()!=n&&await this.batch_no_control.set_value(n),r&&(this.serial_no_control.set_value(a),this.qty_control.set_value(i[n].length),delete i[n],this.events.clone_new_batch_item_in_frm(i,this.current_item))}}bind_events(){this.bind_auto_serial_fetch_event(),this.bind_fields_to_numpad_fields(),this.$component.on("click",".close-btn",()=>{this.events.close_item_details()})}attach_shortcuts(){this.wrapper.find(".close-btn").attr("title","Esc"),frappe.ui.keys.on("escape",()=>{this.$component.is(":visible")&&this.events.close_item_details()})}bind_fields_to_numpad_fields(){let e=this;this.$form_container.on("click",".input-with-feedback",function(){let t=$(this).attr("data-fieldname");this.last_field_focused!=t&&(e.events.item_field_focused(t),this.last_field_focused=t)})}bind_auto_serial_fetch_event(){this.$form_container.on("click",".auto-fetch-btn",()=>{let e=this.events.get_frm(),t=this.item_row;t.type_of_transaction="Outward",new erpnext.SerialBatchPackageSelector(e,t,i=>{i&&frappe.model.set_value(t.doctype,t.name,{serial_and_batch_bundle:i.name,qty:Math.abs(i.total_qty)})})})}toggle_component(e){e?this.$component.css("display","flex"):this.$component.css("display","none")}};custom_app.PointOfSale.NumberPad=class{constructor({wrapper:e,events:t,cols:i,keys:n,css_classes:a,fieldnames_map:r}){this.wrapper=e,this.events=t,this.cols=i,this.keys=n,this.css_classes=a||[],this.fieldnames=r||{},this.init_component()}init_component(){this.prepare_dom(),this.bind_events()}prepare_dom(){let{cols:e,keys:t,css_classes:i,fieldnames:n}=this;function a(){return t.reduce((r,o,s)=>r+o.reduce((h,b,v)=>{let u=i&&i[s]?i[s][v]:"",l=n&&n[b]?n[b]:typeof b=="string"?frappe.scrub(b):b;return h+`<div class="numpad-btn ${u}" data-button-value="${l}">${__(b)}</div>`},""),"")}this.wrapper.html(`<div class="numpad-container">
				${a()}
			</div>`)}bind_events(){let e=this;this.wrapper.on("click",".numpad-btn",function(){let t=$(this);e.events.numpad_event(t)})}};custom_app.PointOfSale.Payment=class{constructor({events:e,wrapper:t}){this.wrapper=t,this.events=e,this.init_component()}init_component(){this.prepare_dom(),this.bind_events(),this.attach_shortcuts()}prepare_dom(){this.wrapper.append(`<section class="payment-container" style="grid-column:span 4 / span 4;">
				<div class="fields-numpad-container">
					<div class="fields-section">
						<div class="section-label payment-section">${__("Payment Method")}</div>
						<div class="payment-modes"></div>
					</div>
				</div>
				<div class="totals-section">
					<div class="totals"></div>
				</div>
				<div class="submit-order-btn">${__("Print Order")}</div>
			</section>`),this.$component=this.wrapper.find(".payment-container"),this.$payment_modes=this.$component.find(".payment-modes"),this.$totals_section=this.$component.find(".totals-section"),this.$totals=this.$component.find(".totals"),this.$numpad=this.$component.find(".number-pad"),this.$invoice_fields_section=this.$component.find(".fields-section")}make_invoice_fields_control(){frappe.db.get_doc("POS Settings",void 0).then(e=>{let t=e.invoice_fields;if(!t.length)return;this.$invoice_fields=this.$invoice_fields_section.find(".invoice-fields"),this.$invoice_fields.html("");let i=this.events.get_frm();t.forEach(n=>{this.$invoice_fields.append(`<div class="invoice_detail_field ${n.fieldname}-field" data-fieldname="${n.fieldname}"></div>`);let a={onchange:function(){i.set_value(this.df.fieldname,this.get_value())}};n.fieldtype=="Button"&&(a={click:function(){i.script_manager.has_handlers(n.fieldname,i.doc.doctype)&&i.script_manager.trigger(n.fieldname,i.doc.doctype,i.doc.docname)}}),this[`${n.fieldname}_field`]=frappe.ui.form.make_control({df:z(z({},n),a),parent:this.$invoice_fields.find(`.${n.fieldname}-field`),render_input:!0}),this[`${n.fieldname}_field`].set_value(i.doc[n.fieldname])})})}initialize_numpad(){let e=this;this.number_pad=new erpnext.PointOfSale.NumberPad({wrapper:this.$numpad,events:{numpad_event:function(t){e.on_numpad_clicked(t)}},cols:3,keys:[[1,2,3],[4,5,6],[7,8,9],[".",0,"Delete"]]}),this.numpad_value=""}on_numpad_clicked(e){let t=e.attr("data-button-value");i(e),this.numpad_value=t==="delete"?this.numpad_value.slice(0,-1):this.numpad_value+t,this.selected_mode.$input.get(0).focus(),this.selected_mode.set_value(this.numpad_value);function i(n){n.addClass("shadow-base-inner bg-selected"),setTimeout(()=>{n.removeClass("shadow-base-inner bg-selected")},100)}}bind_events(){let e=this;function t(){$(".mode-of-payment-control").hide(),$(".mobile-number").hide(),$(".approval-code").hide(),$(".reference-number").hide(),$(".bank-name").hide(),$(".holder-name").hide(),$(".card_type_control").hide(),$(".card-number").hide(),$(".expiry-date").hide(),$(".confirmation-code").hide(),$(".cash-shortcuts").hide(),$(".check-name").hide(),$(".check-number").hide(),$(".check-date").hide(),$(".actual-gov-one").hide(),$(".actual-gov-two").hide(),$(".payment-type").hide(),$(".bank-type").hide(),$(".qr-reference-number").hide(),$(".customer").hide(),$(".charge-invoice-number").hide(),$(".po-number").hide(),$(".representative").hide(),$(".id-number").hide(),$(".approved-by").hide(),$(".gift-code").hide(),$(".button-code").hide(),$(".amesco-code").hide(),$(".button-amesco-plus").hide(),$(".save-button").hide(),$(".discard-button").hide(),$(".cash-button").hide(),e.$payment_modes.find(".pay-amount").css("display","inline"),e.$payment_modes.find(".loyalty-amount-name").hide()}function i(n){let a=n.find(".frappe-control.input-max-width[data-fieldtype='Currency'] input");a.focus(),a[0].setSelectionRange(0,a.val().length)}this.$payment_modes.on("click",".mode-of-payment",function(n){let a=$(this);if(!$(n.target).is(a))return;let r=a.offset().left-e.$payment_modes.offset().left+e.$payment_modes.scrollLeft();e.$payment_modes.animate({scrollLeft:r});let o=a.attr("data-mode");t(),$(".mode-of-payment").removeClass("border-primary"),a.hasClass("border-primary")?(a.removeClass("border-primary"),t()):(a.addClass("border-primary"),a.find(".mode-of-payment-control").css("display","flex"),a.find(".cash-button").css("display","flex"),o==="gcash"||o==="paymaya"?(a.find(".mobile-number").css("display","flex"),a.find(".reference-number").css("display","flex"),a.find(".save-button").css("display","flex"),a.find(".discard-button").css("display","flex")):o==="cards"||o==="debit_card"||o==="credit_card"?(a.find(".bank-name").css("display","flex"),a.find(".holder-name").css("display","flex"),a.find(".card_type_control").css("display","flex"),a.find(".card-number").css("display","flex"),a.find(".expiry-date").css("display","flex"),a.find(".approval-code").css("display","flex"),a.find(".save-button").css("display","flex"),a.find(".discard-button").css("display","flex")):o==="cheque"?(a.find(".bank-name").css("display","flex"),a.find(".check-name").css("display","flex"),a.find(".check-number").css("display","flex"),a.find(".check-date").css("display","flex"),a.find(".save-button").css("display","flex"),a.find(".discard-button").css("display","flex")):o==="2307g"?(a.find(".actual-gov-one").css("display","flex"),a.find(".save-button").css("display","flex"),a.find(".discard-button").css("display","flex")):o==="2307"?(a.find(".actual-gov-two").css("display","flex"),a.find(".save-button").css("display","flex"),a.find(".discard-button").css("display","flex")):o==="qr_payment"?(a.find(".payment-type").css("display","flex"),a.find(".bank-type").css("display","flex"),a.find(".qr-reference-number").css("display","flex"),a.find(".save-button").css("display","flex"),a.find(".discard-button").css("display","flex")):o==="charge"?(a.find(".customer").css("display","flex"),a.find(".charge-invoice-number").css("display","flex"),a.find(".po-number").css("display","flex"),a.find(".representative").css("display","flex"),a.find(".id-number").css("display","flex"),a.find(".approved-by").css("display","flex"),a.find(".save-button").css("display","flex"),a.find(".discard-button").css("display","flex")):o==="gift_certificate"?(a.find(".gift-code").css("display","flex"),a.find(".button-code").css("display","flex"),a.find(".discard-button").css("display","flex")):o==="amesco_plus"&&(a.find(".amesco-code").css("display","flex"),a.find(".button-amesco-plus").css("display","flex"),a.find(".discard-button").css("display","flex")),i(a),e.selected_mode&&e.selected_mode.$input.get(),e.auto_set_remaining_amount())}),$(document).on("click",function(n){$(n.target).closest(".mode-of-payment").length||(t(),$(".mode-of-payment").removeClass("border-primary"))}),frappe.ui.form.on("POS Invoice","contact_mobile",n=>{var o;let a=n.doc.contact_mobile,r=$((o=this.request_for_payment_field)==null?void 0:o.$input[0]);a?r.removeClass("btn-default").addClass("btn-primary"):r.removeClass("btn-primary").addClass("btn-default")}),frappe.ui.form.on("POS Invoice","coupon_code",n=>{n.doc.coupon_code&&!n.applying_pos_coupon_code&&(n.doc.ignore_pricing_rule?n.doc.ignore_pricing_rule&&frappe.show_alert({message:__("Ignore Pricing Rule is enabled. Cannot apply coupon code."),indicator:"orange"}):(n.applying_pos_coupon_code=!0,frappe.run_serially([()=>n.doc.ignore_pricing_rule=1,()=>n.trigger("ignore_pricing_rule"),()=>n.doc.ignore_pricing_rule=0,()=>n.trigger("apply_pricing_rule"),()=>n.save(),()=>this.update_totals_section(n.doc),()=>n.applying_pos_coupon_code=!1])))}),this.setup_listener_for_payments(),this.$payment_modes.on("click",".shortcut",function(){let n=$(this).attr("data-value");e.selected_mode.set_value(n)}),this.$component.on("click",".submit-order-btn",()=>{let n=this.events.get_frm().doc,a=parseFloat(n.paid_amount).toFixed(2),r=n.items,o=n.payments,s=cint(frappe.sys_defaults.disable_rounded_total)?parseFloat(n.grand_total).toFixed(2):parseFloat(n.rounded_total).toFixed(2);if(a===0||!r.length){let l=r.length?__("You cannot submit the order without payment."):__("You cannot submit an empty order.");frappe.show_alert({message:l,indicator:"orange"}),frappe.utils.play_sound("error");return}let h=o.reduce((l,f)=>l+(f.amount||0),0),b=parseFloat(h).toFixed(2),v=parseFloat(s).toFixed(2),u=o.some(l=>l.mode_of_payment==="Cash"||l.mode_of_payment==="Gift Certificate"&&l.amount>0);if(parseFloat(b)>parseFloat(v)&&!u){frappe.show_alert({message:__("Paid amount cannot be greater than the grand total for non-cash payments."),indicator:"orange"}),frappe.utils.play_sound("error");return}this.events.save_as_draft()}),frappe.ui.form.on("POS Invoice","paid_amount",n=>{this.update_totals_section(n.doc);let a=!this.$payment_modes.find(".cash-shortcuts").is(":visible");this.attach_cash_shortcuts(n.doc),!a&&this.$payment_modes.find(".cash-shortcuts").css("display","grid"),this.render_payment_mode_dom()}),frappe.ui.form.on("POS Invoice","loyalty_amount",n=>{let a=format_currency(n.doc.loyalty_amount,n.doc.currency);this.$payment_modes.find(".loyalty-amount-amount").html(a)}),frappe.ui.form.on("Sales Invoice Payment","amount",(n,a,r)=>{let o=locals[a][r],s=o.mode_of_payment.replace(/ +/g,"_").toLowerCase();this[`${s}_control`]&&this[`${s}_control`].get_value()!=o.amount&&this[`${s}_control`].set_value(o.amount)})}setup_listener_for_payments(){frappe.realtime.on("process_phone_payment",e=>{let t=this.events.get_frm().doc,{response:i,amount:n,success:a,failure_message:r}=e,o,s;if(a){s=__("Payment Received");let h=cint(frappe.sys_defaults.disable_rounded_total)?t.grand_total:t.rounded_total;n>=h?(frappe.dom.unfreeze(),o=__("Payment of {0} received successfully.",[format_currency(n,t.currency,0)]),this.events.submit_invoice(),cur_frm.reload_doc()):o=__("Payment of {0} received successfully. Waiting for other requests to complete...",[format_currency(n,t.currency,0)])}else r&&(o=r,s=__("Payment Failed"));frappe.msgprint({message:o,title:s})})}auto_set_remaining_amount(){let e=this.events.get_frm().doc,i=(cint(frappe.sys_defaults.disable_rounded_total)?e.grand_total:e.rounded_total)-e.paid_amount;!(this.selected_mode?this.selected_mode.get_value():void 0)&&i>0&&this.selected_mode&&this.selected_mode.set_value(i)}attach_shortcuts(){let e=frappe.utils.is_mac()?"\u2318":"Shift";this.$component.find(".submit-order-btn").attr("title",`${e}+Enter`),frappe.ui.keys.on("shift+enter",()=>{this.$component.find(".payment-section").is(":visible")&&this.$component.find(".submit-order-btn").click()}),frappe.ui.keys.add_shortcut({shortcut:"shift+tab",action:()=>{let t=this.$component.is(":visible"),i=this.$payment_modes.find(".border-primary");if(i=i.length?i.attr("data-mode"):void 0,!i)return;let n=Array.from(this.$payment_modes.find(".mode-of-payment")).map(s=>$(s).attr("data-mode")),a=n.indexOf(i),r=(a+1)%n.length,o=this.$payment_modes.find(`.mode-of-payment[data-mode="${n[r]}"]`);t&&a!=r&&o.click()},condition:()=>this.$component.is(":visible")&&this.$payment_modes.find(".border-primary").length,description:__("Switch Between Payment Modes"),ignore_inputs:!0,page:cur_page.page.page})}toggle_numpad(){}render_payment_section(){this.render_payment_mode_dom(),this.make_invoice_fields_control(),this.update_totals_section(),this.focus_on_default_mop()}after_render(){let e=this.events.get_frm();e.script_manager.trigger("after_payment_render",e.doc.doctype,e.doc.docname)}edit_cart(){this.events.toggle_other_sections(!1),this.toggle_component(!1)}checkout(){this.events.toggle_other_sections(!0),this.toggle_component(!0),this.render_payment_section(),this.after_render()}toggle_remarks_control(){this.$remarks.find(".frappe-control").length?this.$remarks.html("+ Add Remark"):(this.$remarks.html(""),this.remark_control=frappe.ui.form.make_control({df:{label:__("Remark"),fieldtype:"Data",onchange:function(){}},parent:this.$totals_section.find(".remarks"),render_input:!0}),this.remark_control.set_value(""))}render_payment_mode_dom(){let e=this.events.get_frm().doc,t=e.payments,i=e.currency,n=e.customer_group,a=["2306","2307"];this.$payment_modes.html(`<div style="display: flex; flex-wrap: wrap; gap: 16px;">
				${t.map((r,o)=>{let s=r.mode_of_payment.replace(/ +/g,"_").toLowerCase(),h=r.type,b=r.amount>0?format_currency(r.amount,i):"",u=`
						<div class="payment-mode-wrapper" style="flex: 0 0 calc(50% - 16px); min-width: calc(50% - 16px); ${r.mode_of_payment==="2307G"&&n!=="Government"?"display: none;":""}">
						<div class="mode-of-payment" data-mode="${s}" data-payment-type="${h}" style="border: 1px solid #ccc; border-radius: 8px; padding: 16px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); background-color: #fff;">
							 ${r.mode_of_payment}
							<div class="${s}-amount pay-amount" style="font-weight: bold;">${b}</div>
							<div class="${s} mode-of-payment-control"></div>
							<div class="${s} cash-button"></div>
					`;switch(r.mode_of_payment){case"Cards":case"Debit Card":case"Credit Card":u+=`
								<div class="${s} bank-name"></div>
								<div class="${s} holder-name"></div>
								<div class="${s} card_type_control"></div>
								<div class="${s} card-number"></div>
								<div class="${s} expiry-date"></div>
								<div class="${s} approval-code"></div>
								<div class="${s} button-row" style="display: flex; gap: 5px; align-items: center;">
									<div class="${s} save-button"></div>
									<div class="${s} discard-button"></div>
								</div>
							`;break;case"GCash":case"PayMaya":u+=`
								<div class="${s} mobile-number" style="margin-top:10px;"></div>
								<div class="${s} reference-number" style="margin-top:10px;"></div>
								<div class="${s} button-row" style="display: flex; gap: 5px; align-items: center;">
									<div class="${s} save-button"></div>
									<div class="${s} discard-button"></div>
								</div>
							`;break;case"Cheque":u+=`
								<div class="${s} bank-name"></div>
								<div class="${s} check-name"></div>
								<div class="${s} check-number"></div>
								<div class="${s} check-date"></div>
								<div class="${s} button-row" style="display: flex; gap: 5px; align-items: center;">
									<div class="${s} save-button"></div>
									<div class="${s} discard-button"></div>
								</div>
							`;break;case"2307G":u+=`
								<div class="${s} actual-gov-one"></div>
								<div class="${s} button-row" style="display: flex; gap: 5px; align-items: center;">
									<div class="${s} save-button"></div>
									<div class="${s} discard-button"></div>
								</div>
							`;break;case"2307":u+=`
								<div class="${s} actual-gov-two"></div>
								<div class="${s} button-row" style="display: flex; gap: 5px; align-items: center;">
									<div class="${s} save-button"></div>
									<div class="${s} discard-button"></div>
								</div>
							`;break;case"QR Payment":u+=`
								<div class="${s} payment-type"></div>
								<div class="${s} bank-type"></div>
								<div class="${s} qr-reference-number"></div>
								<div class="${s} button-row" style="display: flex; gap: 5px; align-items: center;">
									<div class="${s} save-button"></div>
									<div class="${s} discard-button"></div>
								</div>
							`;break;case"Charge":u+=`
								<div class="${s} customer"></div>
								<div class="${s} charge-invoice-number"></div>
								<div class="${s} po-number"></div>
								<div class="${s} representative"></div>
								<div class="${s} id-number"></div>
								<div class="${s} approved-by"></div>
								<div class="${s} button-row" style="display: flex; gap: 5px; align-items: center;">
									<div class="${s} save-button"></div>
									<div class="${s} discard-button"></div>
								</div>
								
							`;break;case"Gift Certificate":u+=`
							  <div class="${s} gift-code"></div>
							  <div class="${s} button-row" style="display: flex; gap: 3px; align-items: center;">
							  		<div class="${s} button-code mt-2" ></div>
									<div class="${s} discard-button"></div>
								</div>
						   `;break;case"Amesco Plus":u+=`
							<div class="${s} amesco-code"></div>
							<div class="${s} button-row" style="display: flex; gap: 3px; align-items: center;">
								<div class="${s} button-amesco-plus mt-2" ></div>
								<div class="${s} discard-button"></div>
							</div>	
							
							   `;break}return u+=`
							</div>
						</div>
					`,u}).join("")}
			</div>`),t.forEach(r=>{let o=r.mode_of_payment.replace(/ +/g,"_").toLowerCase(),s=this,h=this.events.get_frm();if(this[`${o}_control`]=frappe.ui.form.make_control({df:{label:"Amount",fieldtype:"Currency",placeholder:__("Enter {0} amount.",[r.mode_of_payment]),read_only:o==="gift_certificate",onchange:function(){if(frappe.model.get_value(r.doctype,r.name,"amount")!=this.value){let u=format_currency(this.value,i);s.$payment_modes.find(`.${o}-amount`).html(u)}},reqd:!0},parent:this.$payment_modes.find(`.${o}.mode-of-payment-control`),render_input:!0}),setTimeout(()=>{let v=this.$payment_modes.find(`.${o}.mode-of-payment-control input[data-fieldname="amount"]`);v.focus(),v.select()},300),o==="cash"){let v=$("<button/>",{text:"Save",class:"btn btn-primary",click:function(){let f=s[`${o}_control`].get_value();if(!f){let c=frappe.msgprint({title:__("Validation Warning"),message:__("All fields are required."),indicator:"orange",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(d){d.which===13&&c.$wrapper.is(":visible")&&c.get_primary_btn().trigger("click")}),c.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")});return}frappe.model.set_value(r.doctype,r.name,"amount",flt(f)).then(()=>{s.update_totals_section();let c=format_currency(f,i);s.$payment_modes.find(`.${o}-amount`).html(c);let d=frappe.msgprint({title:__("Success"),message:__("Cash payment details have been saved."),indicator:"green",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(_){_.which===13&&d.$wrapper.is(":visible")&&d.get_primary_btn().trigger("click")}),d.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")})})}}),u=$("<button/>",{text:"Discard",class:"btn btn-secondary",click:function(){s[`${o}_control`].set_value(0),frappe.model.set_value(r.doctype,r.name,"amount",0).then(()=>{s.update_totals_section(),s.$payment_modes.find(`.${o}-amount`).html(format_currency(0,i));let f=frappe.msgprint({message:__("Cash payment details have been discarded."),indicator:"blue",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(c){c.which===13&&f.$wrapper.is(":visible")&&f.get_primary_btn().trigger("click")}),f.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")})})}}),l=$("<div/>",{style:"display: flex; gap: 5px; align-items: center;"});l.append(v),l.append(u),this.$payment_modes.find(`.${o}.cash-button`).append(l),this.$payment_modes.find(`.${o}.mode-of-payment-control input`).keypress(function(f){f.which===13&&v.click()}),this.$payment_modes.find(`.${o}.mode-of-payment-control input`).keypress(function(f){f.which===8&&u.click()})}if(this[`${o}_control`].set_value(0),r.mode_of_payment==="Cards"){let S=function(O){return/^\d{4}$/.test(O)};var b=S;let v=frappe.model.get_value(r.doctype,r.name,"custom_bank_name"),u=frappe.ui.form.make_control({df:{label:"Bank",fieldtype:"Data",placeholder:"Bank Name",reqd:!0},parent:this.$payment_modes.find(`.${o}.bank-name`),render_input:!0});u.set_value(v||""),u.refresh();let l=cur_frm.doc.customer,f=frappe.model.get_value(r.doctype,r.name,"custom_card_name"),c=frappe.ui.form.make_control({df:{label:"Name on Card",fieldtype:"Data",placeholder:"Card name holder",reqd:!0},parent:this.$payment_modes.find(`.${o}.holder-name`),render_input:!0});frappe.db.get_value("Customer",l,"customer_name").then(O=>{let E=O.message.customer_name;c.set_value(f||E||"")}).catch(O=>{console.error("Error fetching customer name:",O)}),c.refresh();let d=frappe.model.get_value(r.doctype,r.name,"custom_card_type"),_=frappe.ui.form.make_control({df:{label:"Card Type",fieldtype:"Select",options:[{label:"Select Card Type",value:""},{label:"Visa",value:"Visa"},{label:"Visa Debit",value:"Visa Debit"},{label:"Visa Electron",value:"Visa Electron"},{label:"Credit Card",value:"Credit Card"},{label:"Mastercard",value:"Mastercard"},{label:"Mastercard Debit",value:"Mastercard Debit"},{label:"Maestro",value:"Maestro"},{label:"American Express (Amex)",value:"American Express (Amex)"},{label:"Discover",value:"Discover"},{label:"Diners Club",value:"Diners Club"},{label:"JCB",value:"JCB"},{label:"UnionPay",value:"UnionPay"},{label:"RuPay",value:"RuPay"},{label:"Interac",value:"Interac"},{label:"Carte Bancaire (CB)",value:"Carte Bancaire (CB)"},{label:"Elo",value:"Elo"},{label:"Mir",value:"Mir"},{label:"Others",value:"Others"}],reqd:!0},parent:this.$payment_modes.find(`.${o}.card_type_control`),render_input:!0});_.set_value(d||""),_.refresh();let y=frappe.model.get_value(r.doctype,r.name,"custom_card_number"),p=frappe.ui.form.make_control({df:{label:"Card Number",fieldtype:"Data",placeholder:"Last 4 digits",maxlength:4,reqd:!0},parent:this.$payment_modes.find(`.${o}.card-number`),render_input:!0});p.set_value(y||""),p.refresh();let w=frappe.model.get_value(r.doctype,r.name,"custom_card_expiration_date"),m=frappe.ui.form.make_control({df:{label:"Card Expiration Date",fieldtype:"Data",placeholder:"MM/YY",reqd:!0},parent:this.$payment_modes.find(`.${o}.expiry-date`),render_input:!0});m.set_value(w||""),m.refresh(),m.$input.on("input",function(){let O=this.value.replace(/\D/g,"");O.length>=2?this.value=O.slice(0,2)+"/"+O.slice(2):this.value=O});let k=frappe.model.get_value(r.doctype,r.name,"custom_approval_code"),C=frappe.ui.form.make_control({df:{label:"Approval Code",fieldtype:"Data",placeholder:"Approval Code",reqd:!0},parent:this.$payment_modes.find(`.${o}.approval-code`),render_input:!0});C.set_value(k||""),C.refresh();let x=$('<button class="btn btn-primary"style="text-align: right;"">Save</button>');this.$payment_modes.find(`.${o}.save-button`).append(x);let P=$('<button class="btn btn-secondary" style="text-align: right; margin-left: 10px;">Discard</button>');this.$payment_modes.find(`.${o}.discard-button`).append(P);let A=this;x.on("click",function(){let O=A[`${o}_control`].get_value(),E=u.get_value(),T=c.get_value(),q=_.get_value(),N=p.get_value(),X=m.get_value(),H=C.get_value();if(!O||!E||!T||!q||!N||!X||!H){let M=frappe.msgprint({title:__("Validation Warning"),message:__("All fields are required."),indicator:"orange",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(I){I.which===13&&M.$wrapper.is(":visible")&&M.get_primary_btn().trigger("click")}),M.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")});return}if(!S(N)){let M=frappe.msgprint({title:__("Validation Warning"),message:__("Card number must be exactly 4 digits."),indicator:"orange",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(I){I.which===13&&M.$wrapper.is(":visible")&&M.get_primary_btn().trigger("click")}),M.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")});return}let K=cint(frappe.sys_defaults.disable_rounded_total)?e.grand_total:e.rounded_total,we=e.currency;if(O>K){frappe.msgprint({title:__("Validation Warning"),message:__("Amount must not exceed the grand total."),indicator:"orange"});return}frappe.model.set_value(r.doctype,r.name,"amount",flt(O)),frappe.model.set_value(r.doctype,r.name,"custom_bank_name",E),frappe.model.set_value(r.doctype,r.name,"custom_card_name",T),frappe.model.set_value(r.doctype,r.name,"custom_card_type",q),frappe.model.set_value(r.doctype,r.name,"custom_card_number",N),frappe.model.set_value(r.doctype,r.name,"custom_card_expiration_date",X),frappe.model.set_value(r.doctype,r.name,"custom_approval_code",H);let $e=frappe.msgprint({title:__("Success"),message:__("Card payment details have been saved."),indicator:"green",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(M){M.which===13&&$e.$wrapper.is(":visible")&&$e.get_primary_btn().trigger("click")}),$e.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")})}),P.on("click",function(){this[`${o}_control`].set_value(0),u.set_value(""),c.set_value(""),_.set_value(""),p.set_value(""),m.set_value(""),C.set_value(""),frappe.model.set_value(r.doctype,r.name,"amount",0),frappe.model.set_value(r.doctype,r.name,"custom_bank_name",""),frappe.model.set_value(r.doctype,r.name,"custom_card_name",""),frappe.model.set_value(r.doctype,r.name,"custom_card_type",""),frappe.model.set_value(r.doctype,r.name,"custom_card_number",""),frappe.model.set_value(r.doctype,r.name,"custom_card_expiration_date",""),frappe.model.set_value(r.doctype,r.name,"custom_approval_code",""),frappe.msgprint({message:__("Payment details have been discarded."),indicator:"blue",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}})}),[A[`${o}_control`],u,c,_,p,m,C].forEach(O=>{O.$input&&O.$input.keypress(function(E){E.which===13&&x.click()})})}if(r.mode_of_payment==="GCash"||r.mode_of_payment==="PayMaya"){let v=frappe.model.get_value(r.doctype,r.name,"custom_phone_number"),u=frappe.ui.form.make_control({df:{label:"Number",fieldtype:"Data",placeholder:"09876543212"},parent:this.$payment_modes.find(`.${o}.mobile-number`),render_input:!0});u.set_value(v||""),u.refresh();let l=frappe.model.get_value(r.doctype,r.name,"reference_no"),f=frappe.ui.form.make_control({df:{label:"Reference No",fieldtype:"Data",placeholder:"Reference No."},parent:this.$payment_modes.find(`.${o}.reference-number`),render_input:!0,default:r.reference_no||""});f.set_value(l||""),f.refresh();let c=$('<button class="btn btn-primary" style="text-align: right;">save</button>');this.$payment_modes.find(`.${o}.save-button`).append(c);let d=$('<button class="btn btn-secondary" style="text-align: right; margin-left: 10px;">Discard</button>');this.$payment_modes.find(`.${o}.discard-button`).append(d);let _=this;c.on("click",function(){let p=_[`${o}_control`].get_value(),w=u.get_value(),m=f.get_value();if(!p){let P=frappe.msgprint({title:__("Validation Warning"),message:__("All fields are required."),indicator:"orange",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(A){A.which===13&&P.$wrapper.is(":visible")&&P.get_primary_btn().trigger("click")}),P.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")});return}let k=cint(frappe.sys_defaults.disable_rounded_total)?e.grand_total:e.rounded_total,C=e.currency;if(p>k){let P=frappe.msgprint({title:__("Validation Warning"),message:__("Amount must not exceed the grand total."),indicator:"orange",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(A){A.which===13&&P.$wrapper.is(":visible")&&P.get_primary_btn().trigger("click")}),P.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")});return}frappe.model.set_value(r.doctype,r.name,"amount",flt(p)),frappe.model.set_value(r.doctype,r.name,"custom_phone_number",w),frappe.model.set_value(r.doctype,r.name,"reference_no",m);let x=frappe.msgprint({title:__("Success"),message:__("Payment details have been saved."),indicator:"green",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(P){P.which===13&&x.$wrapper.is(":visible")&&x.get_primary_btn().trigger("click")}),x.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")})}),d.on("click",function(){_[`${o}_control`].set_value(0),u.set_value(""),f.set_value(""),frappe.model.set_value(r.doctype,r.name,"amount",0),frappe.model.set_value(r.doctype,r.name,"custom_phone_number",""),frappe.model.set_value(r.doctype,r.name,"reference_no",""),frappe.msgprint({message:__("Payment details have been discarded."),indicator:"blue",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}})}),[_[`${o}_control`],u,f].forEach(p=>{p.$input&&p.$input.keypress(function(w){w.which===13&&c.click()})})}if(r.mode_of_payment==="Debit Card"||r.mode_of_payment==="Credit Card"){let G=function(E){return/^\d{4}$/.test(E)};var b=G;let v=frappe.model.get_value(r.doctype,r.name,"custom_bank_name"),u=frappe.model.get_value(r.doctype,r.name,"custom_card_name"),l=frappe.model.get_value(r.doctype,r.name,"custom_card_type"),f=frappe.model.get_value(r.doctype,r.name,"custom_card_number"),c=frappe.model.get_value(r.doctype,r.name,"custom_card_expiration_date"),d=frappe.model.get_value(r.doctype,r.name,"custom_approval_code"),_=frappe.ui.form.make_control({df:{label:"Bank",fieldtype:"Data",placeholder:"Bank Name",reqd:!0},parent:this.$payment_modes.find(`.${o}.bank-name`),render_input:!0});_.set_value(v||""),_.refresh();let y=cur_frm.doc.customer,p=frappe.ui.form.make_control({df:{label:"Name on Card",fieldtype:"Data",placeholder:"Card name holder",reqd:!0},parent:this.$payment_modes.find(`.${o}.holder-name`),render_input:!0});frappe.db.get_value("Customer",y,"customer_name").then(E=>{let T=E.message.customer_name;p.set_value(u||T||"")}).catch(E=>{console.error("Error fetching customer name:",E)}),p.refresh();let w=frappe.ui.form.make_control({df:{label:"Card Type",fieldtype:"Select",options:[{label:"Select Card Type",value:""},{label:"Visa",value:"Visa"},{label:"Visa Debit",value:"Visa Debit"},{label:"Visa Electron",value:"Visa Electron"},{label:"Credit Card",value:"Credit Card"},{label:"Mastercard",value:"Mastercard"},{label:"Mastercard Debit",value:"Mastercard Debit"},{label:"Maestro",value:"Maestro"},{label:"American Express (Amex)",value:"American Express (Amex)"},{label:"Discover",value:"Discover"},{label:"Diners Club",value:"Diners Club"},{label:"JCB",value:"JCB"},{label:"UnionPay",value:"UnionPay"},{label:"RuPay",value:"RuPay"},{label:"Interac",value:"Interac"},{label:"Carte Bancaire (CB)",value:"Carte Bancaire (CB)"},{label:"Elo",value:"Elo"},{label:"Mir",value:"Mir"},{label:"Others",value:"Others"}]},parent:this.$payment_modes.find(`.${o}.card_type_control`),render_input:!0});w.set_value(l||""),w.refresh();let m=frappe.ui.form.make_control({df:{label:"Card Number",fieldtype:"Data",placeholder:"Last 4 digits",maxlength:4,reqd:!0},parent:this.$payment_modes.find(`.${o}.card-number`),render_input:!0});m.set_value(f||""),m.refresh();let k=frappe.ui.form.make_control({df:{label:"Card Expiration Date",fieldtype:"Data",placeholder:"MM/YY",reqd:!0},parent:this.$payment_modes.find(`.${o}.expiry-date`),render_input:!0});k.set_value(c||""),k.refresh(),k.$input.on("input",function(){let E=this.value.replace(/\D/g,"");E.length>=2?this.value=E.slice(0,2)+"/"+E.slice(2):this.value=E});let C=frappe.ui.form.make_control({df:{label:"Approval Code",fieldtype:"Data",placeholder:"Approval Code"},parent:this.$payment_modes.find(`.${o}.approval-code`),render_input:!0});C.set_value(d||""),C.refresh();let x=$('<button class="btn btn-primary" style="text-align: right;">Save</button>');this.$payment_modes.find(`.${o}.save-button`).append(x);let P=$('<button class="btn btn-secondary" style="text-align: right; margin-left: 10px;">Discard</button>');this.$payment_modes.find(`.${o}.discard-button`).append(P);let A=this;x.on("click",function(){let E=A[`${o}_control`].get_value(),T=_.get_value(),q=p.get_value(),N=w.get_value(),X=m.get_value(),H=k.get_value(),K=C.get_value();if(!E||!T||!q||!X||!H){let I=frappe.msgprint({title:__("Validation Warning"),message:__("All fields are required."),indicator:"orange",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(le){le.which===13&&I.$wrapper.is(":visible")&&I.get_primary_btn().trigger("click")}),I.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")});return}if(!G(X)){let I=frappe.msgprint({title:__("Validation Warning"),message:__("Card number must be exactly 4 digits."),indicator:"orange",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(le){le.which===13&&I.$wrapper.is(":visible")&&I.get_primary_btn().trigger("click")}),I.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")});return}let we=cint(frappe.sys_defaults.disable_rounded_total)?e.grand_total:e.rounded_total,$e=e.currency;if(E>we){let I=frappe.msgprint({title:__("Validation Warning"),message:__("Amount must not exceed the grand total."),indicator:"orange"});$(document).on("keydown",function(le){le.which===13&&I.$wrapper.is(":visible")&&I.get_primary_btn().trigger("click")}),I.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")});return}frappe.model.set_value(r.doctype,r.name,"amount",flt(E)),frappe.model.set_value(r.doctype,r.name,"custom_bank_name",T),frappe.model.set_value(r.doctype,r.name,"custom_card_name",q),frappe.model.set_value(r.doctype,r.name,"custom_card_type",N),frappe.model.set_value(r.doctype,r.name,"custom_card_number",X),frappe.model.set_value(r.doctype,r.name,"custom_card_expiration_date",H),frappe.model.set_value(r.doctype,r.name,"custom_approval_code",K);let M=frappe.msgprint({title:__("Success"),message:__("Card payment details have been saved."),indicator:"green",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(I){I.which===13&&M.$wrapper.is(":visible")&&M.get_primary_btn().trigger("click")}),M.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")})}),P.on("click",function(){A[`${o}_control`].set_value(0),_.set_value(""),p.set_value(""),m.set_value(""),k.set_value(""),C.set_value(""),frappe.model.set_value(r.doctype,r.name,"amount",0),frappe.model.set_value(r.doctype,r.name,"custom_bank_name",""),frappe.model.set_value(r.doctype,r.name,"custom_card_name",""),frappe.model.set_value(r.doctype,r.name,"custom_card_number",""),frappe.model.set_value(r.doctype,r.name,"custom_card_expiration_date",""),frappe.model.set_value(r.doctype,r.name,"custom_approval_code","");let E=frappe.msgprint({message:__("Payment details have been discarded."),indicator:"blue",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(T){T.which===13&&E.$wrapper.is(":visible")&&E.get_primary_btn().trigger("click")}),E.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")})}),[A[`${o}_control`],_,p,m,k,C].forEach(E=>{E.$input&&E.$input.keypress(function(T){T.which===13&&x.click()})})}if(r.mode_of_payment==="Cheque"||r.mode_of_payment==="Government"){let v=frappe.model.get_value(r.doctype,r.name,"custom_check_bank_name"),u=frappe.ui.form.make_control({df:{label:"Bank Of Cheque",fieldtype:"Data",placeholder:"Bank Of Cheque",reqd:!0},parent:this.$payment_modes.find(`.${o}.bank-name`),render_input:!0});u.set_value(v||""),u.refresh();let l=cur_frm.doc.customer,f=frappe.model.get_value(r.doctype,r.name,"custom_name_on_check"),c=frappe.ui.form.make_control({df:{label:"Name On Cheque",fieldtype:"Data",placeholder:"Cheque Name",reqd:!0},parent:this.$payment_modes.find(`.${o}.check-name`),render_input:!0});frappe.db.get_value("Customer",l,"customer_name").then(x=>{let P=x.message.customer_name;c.set_value(f||P||"")}).catch(x=>{console.error("Error fetching customer name:",x)}),c.refresh();let d=frappe.model.get_value(r.doctype,r.name,"custom_check_number"),_=frappe.ui.form.make_control({df:{label:"Cheque Number",fieldtype:"Data",placeholder:"Cheque Number",reqd:!0},parent:this.$payment_modes.find(`.${o}.check-number`),render_input:!0});_.set_value(d||""),_.refresh();let y=frappe.model.get_value(r.doctype,r.name,"custom_check_date"),p=frappe.ui.form.make_control({df:{fieldname:"custom_check_date",label:"Cheque Date",fieldtype:"Date",placeholder:"Cheque Date",reqd:!0},parent:this.$payment_modes.find(`.${o}.check-date`),render_input:!0});p.set_value(y||frappe.datetime.nowdate()),p.refresh();let w=$('<button class="btn btn-primary"style="text-align: right;"">Save</button>');this.$payment_modes.find(`.${o}.save-button`).append(w);let m=$('<button class="btn btn-secondary" style="text-align: right; margin-left: 10px;">Discard</button>');this.$payment_modes.find(`.${o}.discard-button`).append(m);let k=this;w.on("click",function(){let x=k[`${o}_control`].get_value(),P=u.get_value(),A=c.get_value(),G=_.get_value(),S=p.get_value();if(!x||!P||!A||!G||!S){let q=frappe.msgprint({title:__("Validation Warning"),message:__("All fields are required."),indicator:"orange",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(N){N.which===13&&q.$wrapper.is(":visible")&&q.get_primary_btn().trigger("click")}),q.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")});return}let O=cint(frappe.sys_defaults.disable_rounded_total)?e.grand_total:e.rounded_total,E=e.currency;if(x>O){let q=frappe.msgprint({title:__("Validation Warning"),message:__("Amount must not exceed the grand total."),indicator:"orange",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(N){N.which===13&&q.$wrapper.is(":visible")&&q.get_primary_btn().trigger("click")}),q.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")});return}frappe.model.set_value(r.doctype,r.name,"amount",flt(x)),frappe.model.set_value(r.doctype,r.name,"custom_check_bank_name",P),frappe.model.set_value(r.doctype,r.name,"custom_name_on_check",A),frappe.model.set_value(r.doctype,r.name,"custom_check_number",G),frappe.model.set_value(r.doctype,r.name,"custom_check_date",S);let T=frappe.msgprint({title:__("Success"),message:__("Cheque payment details have been saved."),indicator:"green",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(q){q.which===13&&T.$wrapper.is(":visible")&&T.get_primary_btn().trigger("click")}),T.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")})}),m.on("click",function(){k[`${o}_control`].set_value(0),u.set_value(""),c.set_value(""),_.set_value(""),p.set_value(""),frappe.model.set_value(r.doctype,r.name,"amount",0),frappe.model.set_value(r.doctype,r.name,"custom_check_bank_name",""),frappe.model.set_value(r.doctype,r.name,"custom_name_on_check",""),frappe.model.set_value(r.doctype,r.name,"custom_check_number",""),frappe.model.set_value(r.doctype,r.name,"custom_check_date","");let x=frappe.msgprint({message:__("Payment details have been discarded."),indicator:"blue",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(P){P.which===13&&x.$wrapper.is(":visible")&&x.get_primary_btn().trigger("click")}),x.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")})}),[k[`${o}_control`],u,c,_,p].forEach(x=>{x.$input&&x.$input.keypress(function(P){P.which===13&&w.click()})})}if(r.mode_of_payment==="2307G"){let v=frappe.ui.form.make_control({df:{label:"Expected 2307G Amount",fieldtype:"Currency",placeholder:"Actual 2307G",read_only:1},parent:this.$payment_modes.find(`.${o}.actual-gov-one`),render_input:!0}),u=e.custom_2306;frappe.model.set_value(r.doctype,r.name,"custom_form_2306",u),v.set_value(u||""),v.refresh();let l=$('<button class="btn btn-primary"style="text-align: right;"">Save</button>');this.$payment_modes.find(`.${o}.save-button`).append(l);let f=$('<button class="btn btn-secondary" style="text-align: right; margin-left: 10px;">Discard</button>');this.$payment_modes.find(`.${o}.discard-button`).append(f);let c=this;l.on("click",function(){let _=c[`${o}_control`].get_value();if(!_){let p=frappe.msgprint({title:__("Validation Warning"),message:__("All fields are required."),indicator:"orange",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(w){w.which===13&&p.$wrapper.is(":visible")&&p.get_primary_btn().trigger("click")}),p.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")});return}frappe.model.set_value(r.doctype,r.name,"amount",flt(_));let y=frappe.msgprint({title:__("Success"),message:__("Payment details have been saved."),indicator:"green",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(p){p.which===13&&y.$wrapper.is(":visible")&&y.get_primary_btn().trigger("click")}),y.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")})}),f.on("click",function(){c[`${o}_control`].set_value(""),frappe.model.set_value(r.doctype,r.name,"amount",0);let _=frappe.msgprint({message:__("Payment details have been discarded."),indicator:"blue",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(y){y.which===13&&_.$wrapper.is(":visible")&&_.get_primary_btn().trigger("click")}),_.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")})}),[c[`${o}_control`]].forEach(_=>{_.$input&&_.$input.keypress(function(y){y.which===13&&l.click()})})}if(r.mode_of_payment==="2307"){let v=frappe.ui.form.make_control({df:{label:"Expected 2307 Amount",fieldtype:"Currency",placeholder:"Actual 2307",read_only:1},parent:this.$payment_modes.find(`.${o}.actual-gov-two`),render_input:!0}),u=e.custom_2307;frappe.model.set_value(r.doctype,r.name,"custom_form_2307",u),v.set_value(u||""),v.refresh();let l=$('<button class="btn btn-primary"style="text-align: right;"">Save</button>');this.$payment_modes.find(`.${o}.save-button`).append(l);let f=$('<button class="btn btn-secondary" style="text-align: right; margin-left: 10px;">Discard</button>');this.$payment_modes.find(`.${o}.discard-button`).append(f);let c=this;l.on("click",function(){let _=c[`${o}_control`].get_value();if(!_){let p=frappe.msgprint({title:__("Validation Warning"),message:__("All fields are required."),indicator:"orange",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(w){w.which===13&&p.$wrapper.is(":visible")&&p.get_primary_btn().trigger("click")}),p.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")});return}frappe.model.set_value(r.doctype,r.name,"amount",flt(_));let y=frappe.msgprint({title:__("Success"),message:__("Payment details have been saved."),indicator:"green",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(p){p.which===13&&y.$wrapper.is(":visible")&&y.get_primary_btn().trigger("click")}),y.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")})}),f.on("click",function(){c[`${o}_control`].set_value(""),frappe.model.set_value(r.doctype,r.name,"amount",0);let _=frappe.msgprint({message:__("Payment details have been discarded."),indicator:"blue",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(y){y.which===13&&_.$wrapper.is(":visible")&&_.get_primary_btn().trigger("click")}),_.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")})}),[c[`${o}_control`]].forEach(_=>{_.$input&&_.$input.keypress(function(y){y.which===13&&l.click()})})}if(r.mode_of_payment==="QR Payment"){let v=frappe.model.get_value(r.doctype,r.name,"custom_payment_type"),u=frappe.ui.form.make_control({df:{label:"Payment Type",fieldtype:"Select",options:[{label:"Select Payment Type",value:""},{label:"Standee",value:"Standee"},{label:"Terminal",value:"Terminal"}],reqd:!0},parent:this.$payment_modes.find(`.${o}.payment-type`),render_input:!0});u.set_value(v||""),u.refresh();let l=frappe.model.get_value(r.doctype,r.name,"custom_bank_type"),f=frappe.ui.form.make_control({df:{label:"Bank",fieldtype:"Select",options:[{label:"Select Bank Type",value:""},{label:"SBC",value:"SBC"},{label:"MBTC",value:"MBTC"},{label:"MAYA",value:"MAYA"},{label:"GCASH",value:"GCASH"},{label:"BDO",value:"BDO"}],reqd:!0},parent:this.$payment_modes.find(`.${o}.bank-type`),render_input:!0});f.set_value(l||""),f.refresh();let c=frappe.model.get_value(r.doctype,r.name,"custom_qr_reference_number"),d=frappe.ui.form.make_control({df:{label:"Confirmation Code",fieldtype:"Data",placeholder:"Reference # or Confirmation Code"},parent:this.$payment_modes.find(`.${o}.qr-reference-number`),render_input:!0});d.set_value(c||""),d.refresh();let _=$('<button class="btn btn-primary"style="text-align: right;"">Save</button>');this.$payment_modes.find(`.${o}.save-button`).append(_);let y=$('<button class="btn btn-secondary" style="text-align: right; margin-left: 10px;">Discard</button>');this.$payment_modes.find(`.${o}.discard-button`).append(y);let p=this;_.on("click",function(){let m=p[`${o}_control`].get_value(),k=u.get_value(),C=f.get_value(),x=d.get_value();if(!m||!k||!C){let S=frappe.msgprint({title:__("Validation Warning"),message:__("All fields are required."),indicator:"orange",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(O){O.which===13&&S.$wrapper.is(":visible")&&S.get_primary_btn().trigger("click")}),S.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")});return}let P=cint(frappe.sys_defaults.disable_rounded_total)?e.grand_total:e.rounded_total,A=e.currency;if(m>P){let S=frappe.msgprint({title:__("Validation Warning"),message:__("Amount must not exceed the grand total."),indicator:"orange",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(O){O.which===13&&S.$wrapper.is(":visible")&&S.get_primary_btn().trigger("click")}),S.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")});return}frappe.model.set_value(r.doctype,r.name,"amount",flt(m)),frappe.model.set_value(r.doctype,r.name,"custom_payment_type",k),frappe.model.set_value(r.doctype,r.name,"custom_bank_type",C),frappe.model.set_value(r.doctype,r.name,"custom_qr_reference_number",x);let G=frappe.msgprint({title:__("Success"),message:__("Payment details have been saved."),indicator:"green",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(S){S.which===13&&G.$wrapper.is(":visible")&&G.get_primary_btn().trigger("click")}),G.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")})}),y.on("click",function(){p[`${o}_control`].set_value(0),u.set_value(""),f.set_value(""),d.set_value(""),frappe.model.set_value(r.doctype,r.name,"amount",0),frappe.model.set_value(r.doctype,r.name,"custom_payment_type",""),frappe.model.set_value(r.doctype,r.name,"custom_bank_type",""),frappe.model.set_value(r.doctype,r.name,"custom_qr_reference_number","");let m=frappe.msgprint({message:__("Payment details have been discarded."),indicator:"blue",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(k){k.which===13&&m.$wrapper.is(":visible")&&m.get_primary_btn().trigger("click")}),m.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")})}),[p[`${o}_control`],u,f,d].forEach(m=>{m.$input&&m.$input.keypress(function(k){k.which===13&&_.click()})})}if(r.mode_of_payment==="Charge"){let v=cur_frm.doc.customer,u=frappe.model.get_value(r.doctype,r.name,"custom_customer"),l=frappe.ui.form.make_control({df:{label:"Customer",fieldtype:"Data",placeholder:"Customer Name",reqd:!0},parent:this.$payment_modes.find(`.${o}.customer`),render_input:!0});frappe.db.get_value("Customer",v,"customer_name").then(S=>{let O=S.message.customer_name;l.set_value(u||O||"")}).catch(S=>{console.error("Error fetching customer name:",S)}),l.refresh();let f=frappe.model.get_value(r.doctype,r.name,"custom_charge_invoice_number"),c=frappe.ui.form.make_control({df:{label:"Charge Invoice Number",fieldtype:"Data",placeholder:"Charge Invoice Number"},parent:this.$payment_modes.find(`.${o}.charge-invoice-number`),render_input:!0});c.set_value(f||""),c.refresh();let d=frappe.model.get_value(r.doctype,r.name,"custom_po_number"),_=frappe.ui.form.make_control({df:{label:"PO Number",fieldtype:"Data",placeholder:"PO Number",reqd:!0},parent:this.$payment_modes.find(`.${o}.po-number`),render_input:!0});_.set_value(d||""),_.refresh();let y=frappe.model.get_value(r.doctype,r.name,"custom_representative"),p=frappe.ui.form.make_control({df:{label:"Representative",fieldtype:"Data",placeholder:"Representative",reqd:!0},parent:this.$payment_modes.find(`.${o}.representative`),render_input:!0});p.set_value(y||""),p.refresh();let w=frappe.model.get_value(r.doctype,r.name,"custom_id_number"),m=frappe.ui.form.make_control({df:{label:"ID Number",fieldtype:"Data",placeholder:"ID Number",reqd:!0},parent:this.$payment_modes.find(`.${o}.id-number`),render_input:!0});m.set_value(w||""),m.refresh();let k=frappe.model.get_value(r.doctype,r.name,"custom_approved_by"),C=frappe.ui.form.make_control({df:{label:"Approved By",fieldtype:"Data",placeholder:"Approver name"},parent:this.$payment_modes.find(`.${o}.approved-by`),render_input:!0});C.set_value(k||""),C.refresh();let x=$('<button class="btn btn-primary"style="text-align: right;"">Save</button>');this.$payment_modes.find(`.${o}.save-button`).append(x);let P=$('<button class="btn btn-secondary" style="text-align: right; margin-left: 10px;">Discard</button>');this.$payment_modes.find(`.${o}.discard-button`).append(P);let A=this;x.on("click",function(){let S=A[`${o}_control`].get_value(),O=l.get_value(),E=c.get_value(),T=_.get_value(),q=p.get_value(),N=m.get_value(),X=C.get_value();if(!S||!O||!T||!q||!N){let K=frappe.msgprint({title:__("Validation Warning"),message:__("All fields are required."),indicator:"orange",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(we){we.which===13&&K.$wrapper.is(":visible")&&K.get_primary_btn().trigger("click")}),K.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")});return}frappe.model.set_value(r.doctype,r.name,"amount",flt(S)),frappe.model.set_value(r.doctype,r.name,"custom_customer",O),frappe.model.set_value(r.doctype,r.name,"custom_charge_invoice_number",E),frappe.model.set_value(r.doctype,r.name,"custom_po_number",T),frappe.model.set_value(r.doctype,r.name,"custom_representative",q),frappe.model.set_value(r.doctype,r.name,"custom_id_number",N),frappe.model.set_value(r.doctype,r.name,"custom_approved_by",X);let H=frappe.msgprint({title:__("Success"),message:__("Payment details have been saved."),indicator:"green",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(K){K.which===13&&H.$wrapper.is(":visible")&&H.get_primary_btn().trigger("click")}),H.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")})}),P.on("click",function(){A[`${o}_control`].set_value(0),l.set_value(""),c.set_value(""),_.set_value(""),p.set_value(""),m.set_value(""),C.set_value(""),frappe.model.set_value(r.doctype,r.name,"amount",0),frappe.model.set_value(r.doctype,r.name,"custom_customer",""),frappe.model.set_value(r.doctype,r.name,"custom_charge_invoice_number",""),frappe.model.set_value(r.doctype,r.name,"custom_po_number",""),frappe.model.set_value(r.doctype,r.name,"custom_representative",""),frappe.model.set_value(r.doctype,r.name,"custom_id_number",""),frappe.model.set_value(r.doctype,r.name,"custom_approved_by","");let S=frappe.msgprint({message:__("Payment details have been discarded."),indicator:"blue",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(O){O.which===13&&S.$wrapper.is(":visible")&&S.get_primary_btn().trigger("click")}),S.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")})}),[A[`${o}_control`],l,_,c,p,m,C].forEach(S=>{S.$input&&S.$input.keypress(function(O){O.which===13&&x.click()})})}if(r.mode_of_payment==="Gift Certificate"){let v=frappe.ui.form.make_control({df:{fieldtype:"Data",label:"Gift Code",placeholder:"Enter Gift Code"},parent:this.$payment_modes.find(`.${o}.gift-code`)[0],render_input:!0});v.refresh();let u=frappe.ui.form.make_control({df:{label:"Add Gift Code",fieldtype:"Button",btn_size:"sm",click:function(){let c=v.get_value();c?frappe.db.get_doc("Amesco Gift Certificate",c).then(d=>{if(d.is_used!==1){let _=flt(frappe.model.get_value(r.doctype,r.name,"amount"));frappe.model.set_value(r.doctype,r.name,"amount",_+flt(d.amount)),h.add_child("custom_gift_cert_used",{code:c});let y=frappe.msgprint({title:__("Success"),message:__("Gift Certificate code added successfully."),indicator:"green",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(p){p.which===13&&y.$wrapper.is(":visible")&&y.get_primary_btn().trigger("click")}),y.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")}),v.set_value("")}else frappe.msgprint({title:__("Error"),indicator:"red",message:__("Gift Code Already Used. Please check the code and try again.")})}).catch(d=>{frappe.msgprint({title:__("Error"),indicator:"red",message:__("Invalid Gift Code. Please check the code and try again.")})}):frappe.msgprint({title:__("Error"),indicator:"red",message:__("Please enter a gift code before clicking Add Gift Code.")})}},parent:this.$payment_modes.find(`.${o}.button-code`)[0],render_input:!0});u.refresh();let l=$('<button class="btn btn-secondary">Discard</button>');this.$payment_modes.find(`.${o}.discard-button`).append(l);let f=this;l.on("click",function(){f[`${o}_control`].set_value(""),frappe.model.set_value(r.doctype,r.name,"amount",0);let c=frappe.msgprint({message:__("Payment details have been discarded."),indicator:"blue",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(d){d.which===13&&c.$wrapper.is(":visible")&&c.get_primary_btn().trigger("click")}),c.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")})}),v.$input&&v.$input.keypress(function(c){c.which===13&&u.$input.trigger("click")})}if(r.mode_of_payment==="Amesco Plus"){frappe.ui.form.make_control({df:{label:"Scan",fieldtype:"Button",btn_size:"sm",click:function(){new frappe.ui.Scanner({dialog:!0,multiple:!1,on_scan(c){let d=c.decodedText.split(",");console.log("scannedData",d);let _=d[0],y=d[1],p=d[4],w=d[2];frappe.call({method:"custom_app.customapp.doctype.used_ameco_plus_code.used_ameco_plus_code.check_used_amesco_plus_code",args:{code:_},callback:function(m){if(m.message)frappe.msgprint(__("Amesco Plus voucher is already used."));else{let k=new frappe.ui.Dialog({title:__("Scanned Amesco Plus User"),fields:[{label:"Voucher Code",fieldname:"voucher_code",fieldtype:"Data",read_only:1,default:_},{label:"User ID",fieldname:"user_id",fieldtype:"Data",read_only:1,default:y},{label:"Email",fieldname:"email",fieldtype:"Data",read_only:1,default:p},{label:"Redeem Points",fieldname:"points",fieldtype:"Data",read_only:1,default:w}],primary_action_label:__("Ok"),primary_action:function(){frappe.model.set_value(r.doctype,r.name,"custom_am_voucher_code",_),frappe.model.set_value(r.doctype,r.name,"custom_am_plus_user_id",y),frappe.model.set_value(r.doctype,r.name,"custom_am_plus_user_email",p),frappe.model.set_value(r.doctype,r.name,"amount",flt(w)),h.add_child("custom_ameco_plus_code_used",{code:_}),k.hide()}});k.show()}}})}})}},parent:this.$payment_modes.find(`.${o}.button-amesco-plus`)[0],render_input:!0}).refresh();let u=$('<button class="btn btn-secondary" >Discard</button>');this.$payment_modes.find(`.${o}.discard-button`).append(u);let l=this;u.on("click",function(){l[`${o}_control`].set_value(""),frappe.model.set_value(r.doctype,r.name,"amount",0);let c=frappe.msgprint({message:__("Payment details have been discarded."),indicator:"blue",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(d){d.which===13&&c.$wrapper.is(":visible")&&c.get_primary_btn().trigger("click")}),c.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")})}),[l[`${o}_control`]].forEach(c=>{c.$input&&c.$input.keypress(function(d){d.which===13&&save_button.click()})})}this[`${o}_control`].set_value(r.amount)}),this.render_loyalty_points_payment_mode(),this.attach_cash_shortcuts(e)}focus_on_default_mop(){this.events.get_frm().doc.payments.forEach(i=>{let n=i.mode_of_payment.replace(/ +/g,"_").toLowerCase();i.default&&setTimeout(()=>{this.$payment_modes.find(`.${n}.mode-of-payment-control`).parent().click()},500)})}attach_cash_shortcuts(e){let t=cint(frappe.sys_defaults.disable_rounded_total)?e.grand_total:e.rounded_total,i=e.currency,n=this.get_cash_shortcuts(flt(t));this.$payment_modes.find(".cash-shortcuts").remove();let a=n.map(r=>`<div class="shortcut" data-value="${r}">${format_currency(r,i,0)}</div>`).join("");this.$payment_modes.find('[data-payment-type="Cash"]').find(".mode-of-payment-control").after(`<div class="cash-shortcuts">${a}</div>`)}get_cash_shortcuts(e){let t=[1,5,10],i=String(Math.round(e)).length;t=t.map(r=>r*10**(i-2));let n=(r,o)=>{let s=Math.ceil(r/o)*o;return s===r?s+o:s},a=t.reduce((r,o)=>{let s=n(e,o);return s=r.indexOf(s)!=-1?s+o:s,[...r,s]},[]);return e>100&&(a.includes(500)||a.push(500),a.includes(1e3)||a.push(1e3)),a.sort((r,o)=>r-o),a}render_loyalty_points_payment_mode(){let e=this,t=this.events.get_frm().doc,{loyalty_program:i,loyalty_points:n,conversion_factor:a}=this.events.get_customer_details();if(this.$payment_modes.find('.mode-of-payment[data-mode="loyalty-amount"]').parent().remove(),!i)return;let r,o,s;n?(s=flt(flt(n)*flt(a),precision("loyalty_amount",t)),r=__("You can redeem upto {0}.",[format_currency(s)]),o=!1):(r=__("You don't have enough points to redeem."),o=!0);let h=this.$payment_modes.children().length%2===0?"pr-2":"pl-2",b=t.loyalty_amount>0?format_currency(t.loyalty_amount,t.currency):"";this.$payment_modes.append(`<div class="payment-mode-wrapper">
				<div class="mode-of-payment loyalty-card" data-mode="loyalty-amount" data-payment-type="loyalty-amount">
					Redeem Loyalty Points
					<div class="loyalty-amount-amount pay-amount">${b}</div>
					<div class="loyalty-amount-name">${i}</div>
					<div class="loyalty-amount mode-of-payment-control"></div>
				</div>
			</div>`),this["loyalty-amount_control"]=frappe.ui.form.make_control({df:{label:__("Redeem Loyalty Points"),fieldtype:"Currency",placeholder:__("Enter amount to be redeemed."),options:"company:currency",read_only:o,onchange:async function(){if(!n)return;if(this.value>s){frappe.show_alert({message:__("You cannot redeem more than {0}.",[format_currency(s)]),indicator:"red"}),frappe.utils.play_sound("submit"),e["loyalty-amount_control"].set_value(0);return}let v=this.value>0?1:0;await frappe.model.set_value(t.doctype,t.name,"redeem_loyalty_points",v),frappe.model.set_value(t.doctype,t.name,"loyalty_points",parseInt(this.value/a))},description:r},parent:this.$payment_modes.find(".loyalty-amount.mode-of-payment-control"),render_input:!0}),this["loyalty-amount_control"].toggle_label(!1)}render_add_payment_method_dom(){this.events.get_frm().doc.docstatus===0&&this.$payment_modes.append(`<div class="w-full pr-2">
					<div class="add-mode-of-payment w-half text-grey mb-4 no-select pointer">+ Add Payment Method</div>
				</div>`)}update_totals_section(e){e||(e=this.events.get_frm().doc);let t=e.paid_amount,i=cint(frappe.sys_defaults.disable_rounded_total)?e.grand_total:e.rounded_total,n=i-e.paid_amount,a=e.change_amount||n<=0?-1*n:void 0,r=e.currency,o=a?__("Change"):__("To Be Paid");this.$totals.html(`<div class="col">
				<div class="total-label">${__("Grand Total")}</div>
				<div class="value">${format_currency(i,r)}</div>
			</div>
			<div class="seperator-y"></div>
			<div class="col">
				<div class="total-label">${__("Paid Amount")}</div>
				<div class="value">${format_currency(t,r)}</div>
			</div>
			<div class="seperator-y"></div>
			<div class="col">
				<div class="total-label">${o}</div>
				<div class="value">${format_currency(a||n,r)}</div>
			</div>`)}toggle_component(e){e?this.$component.css("display","flex"):this.$component.css("display","none")}};custom_app.PointOfSale.PastOrderList=class{constructor({wrapper:e,events:t}){this.wrapper=e,this.events=t,this.invoice_count=0,this.init_component()}init_component(){this.prepare_dom(),this.make_filter_section(),this.bind_events()}prepare_dom(){this.wrapper.append(`<section class="past-order-list">
				<div class="filter-section">
					<div class="label">${__("Pending Orders")} <span class="invoice-count ml-3 badge rounded-pill bg-danger text-white"></span> </div>
					<div class="search-field"></div>
					<div class="status-field"></div>
				</div>
				<div class="invoices-container"></div>
			</section>`),this.$component=this.wrapper.find(".past-order-list"),this.$invoices_container=this.$component.find(".invoices-container"),this.$invoice_count=this.$component.find(".invoice-count")}bind_events(){let e=this;this.make_filter_section(),setTimeout(()=>{this.search_field.set_focus()},300),this.search_field.$input.on("input",t=>{clearTimeout(this.last_search),this.last_search=setTimeout(()=>{let i=t.target.value;this.refresh_list(i,this.status_field.get_value())},300)}),this.$invoices_container.on("click",".invoice-wrapper",function(){let t=unescape($(this).attr("data-invoice-name"));e.events.open_invoice_data(t)}),this.$invoices_container.off("keydown",".invoice-wrapper").on("keydown",".invoice-wrapper",function(t){let i=e.$invoices_container.find(".invoice-wrapper"),n=i.index($(this)),a=n;switch(t.which){case 13:$(this).click();break;case 38:a=n>0?n-1:i.length-1;break;case 40:a=n<i.length-1?n+1:0;break;default:return}i.eq(a).focus()}),frappe.ui.keys.add_shortcut({shortcut:"ctrl+i",action:()=>{let t=e.$invoices_container.find(".invoice-wrapper");t.length&&t.first().focus()},condition:()=>e.$invoices_container.is(":visible"),description:__("Activate Cart Item Focus"),ignore_inputs:!0,page:cur_page.page.page})}make_filter_section(){let e=this;this.search_field||(this.search_field=frappe.ui.form.make_control({df:{label:__("Search"),fieldtype:"Data",placeholder:__("Search by invoice id or customer name")},parent:this.$component.find(".search-field"),render_input:!0}),this.search_field.toggle_label(!0)),this.status_field||(this.status_field=frappe.ui.form.make_control({df:{label:__("Invoice Status"),fieldtype:"Select",options:"Draft",placeholder:__("Filter by invoice status"),onchange:function(){e.$component.is(":visible")&&e.refresh_list()}},parent:this.$component.find(".status-field"),render_input:!0}),this.status_field.toggle_label(!1),this.status_field.set_value("Draft"))}refresh_list(){frappe.dom.freeze(),this.events.reset_summary();let e=this.search_field.get_value(),t=this.status_field.get_value(),i=this.events.pos_profile();return this.$invoices_container.html(""),frappe.call({method:"custom_app.customapp.page.packing_list.packing_list.get_past_order_list",freeze:!0,args:{search_term:e,status:t,pos_profile:i},callback:n=>{frappe.dom.unfreeze(),n.message.forEach(a=>{let r=this.get_invoice_html(a);this.$invoices_container.append(r)}),this.$invoice_count.text(n.message.length)}})}get_invoice_html(e){let t=moment(e.posting_date+" "+e.posting_time).format("Do MMMM, h:mma");return`<div class="invoice-wrapper" tabindex="0" data-invoice-name="${escape(e.name)}">
				<div class="invoice-name-date">
					<div class="invoice-name">${e.name}</div>
					<div class="invoice-date">
						<svg class="mr-2" width="12" height="12" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
							<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
						</svg>
						${frappe.ellipsis(e.customer_name,20)}
					</div>
				</div>
				<div class="invoice-total-status">
					<div class="invoice-total">${format_currency(e.grand_total,e.currency)||0}</div>
					<div class="invoice-date">${t}</div>
				</div>
			</div>
			<div class="seperator"></div>`}toggle_component(e){e?this.$component.css("display","flex")&&this.refresh_list():this.$component.css("display","none")}};var pn=Ht(fn());custom_app.PointOfSale.PastOrderSummary=class{constructor({wrapper:e,events:t}){this.wrapper=e,this.events=t,this.init_component()}init_component(){this.prepare_dom(),this.init_email_print_dialog(),this.bind_events(),this.attach_shortcuts()}prepare_dom(){this.wrapper.append(`
			<section class="past-order-summary">
				<div class="no-summary-placeholder">
					${__("Select an invoice to load summary data")}
				</div>
				<div class="invoice-summary-wrapper" style="width:50rem !important;">
					<div class="abs-container">
						<div class="upper-section"></div>
						<div class="label">${__("Items")}</div>
						<div class="items-container summary-container"></div>
						<div class="label">${__("Totals")}</div>
						<div class="totals-container summary-container"></div>
						<div class="label">${__("Payments")}</div>
						<div class="payments-container summary-container"></div>
						<div class="change-container summary-container"></div>
						<div class="summary-btns"></div>
						<svg id="barcode" class="mt-3 mx-auto" style="max-width: 100%;" jsbarcode-format="code128"></svg>
					</div>
				</div>
			</section>`),this.$component=this.wrapper.find(".past-order-summary"),this.$summary_wrapper=this.$component.find(".invoice-summary-wrapper"),this.$summary_container=this.$component.find(".abs-container"),this.$upper_section=this.$summary_container.find(".upper-section"),this.$items_container=this.$summary_container.find(".items-container"),this.$totals_container=this.$summary_container.find(".totals-container"),this.$payment_container=this.$summary_container.find(".payments-container"),this.$change_container=this.$summary_container.find(".change-container"),this.$summary_btns=this.$summary_container.find(".summary-btns")}init_email_print_dialog(){let e=new frappe.ui.Dialog({title:"Email Receipt",fields:[{fieldname:"email_id",fieldtype:"Data",options:"Email",label:"Email ID",reqd:1},{fieldname:"content",fieldtype:"Small Text",label:"Message (if any)"}],primary_action:()=>{this.send_email()},primary_action_label:__("Send")});this.email_dialog=e;let t=new frappe.ui.Dialog({title:"Print Receipt",fields:[{fieldname:"print",fieldtype:"Data",label:"Print Preview"}],primary_action:()=>{this.print_receipt()},primary_action_label:__("Print")});this.print_dialog=t}get_upper_section_html(e){let{status:t}=e,i="",n=t==="Draft"?e.custom_pa_name:e.custom_cashier_name;return["Paid","Consolidated"].includes(t)&&(i="green"),t==="Draft"&&(i="red"),t==="Return"&&(i="grey"),`<div class="left-section">
					<div class="customer-name">${e.customer_name}</div>
					<div class="customer-email">${this.customer_email}</div>
					<div class="cashier"> Take by:  ${__(n)}</div>
				</div>
				<div class="right-section">
					<div class="paid-amount">${format_currency(e.grand_total,e.currency)}</div>
					<div class="invoice-name">${e.name}</div>
					<span class="indicator-pill whitespace-nowrap ${i}"><span>${e.status}</span></span>
				</div>`}get_item_html(e,t){return`<div class="item-row-wrapper">
					<div class="item-name">${t.item_name}</div>
					<div class="item-qty"></div>
					<div class="item-rate-disc">${i()}</div>
				</div>`;function i(){let n="",a=`<span class="item-amount" style="padding-left:1rem;">${format_currency(t.amount,e.currency)}</span>`,r=`<span class="qty" style="padding-left:1rem;">${t.qty||0} ${t.uom}</span>`;return t.rate&&t.price_list_rate&&t.rate!==t.price_list_rate?n=`<span class="item-disc">(${t.discount_percentage}% off)</span>
							 <div class="item-rate">${format_currency(t.rate,e.currency)}</div>`:n=`<div class="item-rate">${format_currency(t.price_list_rate||t.rate,e.currency)}  </div>`,`${n} ${r} ${a}`}}get_discount_html(e){return e.discount_amount?`<div class="summary-row-wrapper">
						<div>Discount (${e.additional_discount_percentage} %)</div>
						<div>${format_currency(e.discount_amount,e.currency)}</div>
					</div>`:""}get_vatable_sales_html(e){return`<div class="summary-row-wrapper">
					<div>${__("VATable Sales")}</div>
					<div>${format_currency(e.custom_vatable_sales,e.currency)}</div>
				</div>`}get_vatable_exempt_html(e){return`<div class="summary-row-wrapper">
					<div>${__("VAT-Exempt Sales")}</div>
					<div>${format_currency(e.custom_vat_exempt_sales,e.currency)}</div>
				</div>`}get_zero_rated_html(e){return`<div class="summary-row-wrapper">
					<div>${__("Zero-Rated")}</div>
					<div>${format_currency(e.custom_zero_rated_sales,e.currency)}</div>
				</div>`}get_vat_amount_html(e){return`<div class="summary-row-wrapper">
					<div>${__("VAT 12%")}</div>
					<div>${format_currency(e.custom_vat_amount,e.currency)}</div>
				</div>`}get_net_total_html(e){return`<div class="summary-row-wrapper">
					<div>${__("Net Total")}</div>
					<div>${format_currency(e.net_total,e.currency)}</div>
				</div>`}get_taxes_html(e){return e.taxes.length?`<div class="taxes-wrapper">${e.taxes.map(i=>`
				<div class="tax-row">
					<div class="tax-label">${/[0-9]+/.test(i.description)?i.description:i.rate!=0?`${i.description} @ ${i.rate}%`:i.description}</div>
					<div class="tax-value">${format_currency(i.tax_amount_after_discount_amount,e.currency)}</div>
				</div>
			`).join("")}</div>`:""}get_grand_total_html(e){return`<div class="summary-row-wrapper grand-total">
					<div>${__("Grand Total")}</div>
					<div>${format_currency(e.grand_total,e.currency)}</div>
				</div>`}get_payment_html(e,t){return`<div class="summary-row-wrapper payments">
					<div>${__(t.mode_of_payment)}</div>
					<div>${format_currency(t.amount,e.currency)}</div>
				</div>
				<div class="summary-row-wrapper change">
					<div>${__("Change")}</div>
					<div>${format_currency(e.change_amount,e.currency)}</div>
				</div>
				`}bind_events(){this.$summary_container.on("click",".return-btn",()=>{this.events.process_return(this.doc.name),this.toggle_component(!1),this.$component.find(".no-summary-placeholder").css("display","flex"),this.$summary_wrapper.css("display","none")}),this.$summary_container.on("click",".edit-btn",()=>{this.events.edit_order(this.doc.name),this.toggle_component(!1),this.$component.find(".no-summary-placeholder").css("display","flex"),this.$summary_wrapper.css("display","none")}),this.$summary_container.on("click",".delete-btn",()=>{this.events.delete_order(this.doc.name),this.show_summary_placeholder()}),this.$summary_container.on("click",".delete-btn",()=>{this.events.delete_order(this.doc.name),this.show_summary_placeholder()}),this.$summary_container.on("click",".new-btn",()=>{this.events.new_order(),this.toggle_component(!1),this.$component.find(".no-summary-placeholder").css("display","flex"),this.$summary_wrapper.css("display","none")}),this.$summary_container.on("click",".email-btn",()=>{this.email_dialog.fields_dict.email_id.set_value(this.customer_email),this.email_dialog.show()}),this.$summary_container.on("click",".print-btn",()=>{this.print_receipt()})}pos_new_order(){this.events.new_order()}print_receipt(){let e=this.events.get_frm();frappe.utils.print(this.doc.doctype,this.doc.name,e.pos_print_format,this.doc.letter_head,this.doc.language||frappe.boot.lang)}attach_shortcuts(){let e=frappe.utils.is_mac()?"\u2318":"Ctrl";this.$summary_container.find(".print-btn").attr("title",`${e}+P`),frappe.ui.keys.add_shortcut({shortcut:"ctrl+p",action:()=>this.$summary_container.find(".print-btn").click(),condition:()=>this.$component.is(":visible")&&this.$summary_container.find(".print-btn").is(":visible"),description:__("Print Receipt"),page:cur_page.page.page}),this.$summary_container.find(".new-btn").attr("title",`${e}+Enter`),frappe.ui.keys.on("ctrl+enter",()=>{this.$component.is(":visible")&&this.$summary_container.find(".new-btn").is(":visible")&&this.$summary_container.find(".new-btn").click()}),this.$summary_container.find(".edit-btn").attr("title",`${e}+E`),frappe.ui.keys.add_shortcut({shortcut:"ctrl+e",action:()=>this.$summary_container.find(".edit-btn").click(),condition:()=>this.$component.is(":visible")&&this.$summary_container.find(".edit-btn").is(":visible"),description:__("Edit Receipt"),page:cur_page.page.page}),this.$summary_container.find(".edit-btn").attr("title",`${e}+E`),frappe.ui.keys.add_shortcut({shortcut:"ctrl+e",action:()=>this.$summary_container.find(".edit-btn").click(),condition:()=>this.$component.is(":visible")&&this.$summary_container.find(".edit-btn").is(":visible"),description:__("Edit Receipt"),page:cur_page.page.page})}send_email(){let e=this.events.get_frm(),t=this.email_dialog.get_values().email_id,i=this.email_dialog.get_values().content,n=this.doc||e.doc,a=e.pos_print_format;frappe.call({method:"frappe.core.doctype.communication.email.make",args:{recipients:t,subject:__(e.meta.name)+": "+n.name,content:i||__(e.meta.name)+": "+n.name,doctype:n.doctype,name:n.name,send_email:1,print_format:a,sender_full_name:frappe.user.full_name(),_lang:n.language},callback:r=>{r.exc?frappe.msgprint(__("There were errors while sending email. Please try again.")):(frappe.utils.play_sound("email"),r.message.emails_not_sent_to?frappe.msgprint(__("Email not sent to {0} (unsubscribed / disabled)",[frappe.utils.escape_html(r.message.emails_not_sent_to)])):frappe.show_alert({message:__("Email sent successfully."),indicator:"green"}),this.email_dialog.hide())}})}add_summary_btns(e){this.$summary_btns.html(""),e.forEach(t=>{t.condition&&t.visible_btns.forEach(i=>{let n=i.split(" ")[0].toLowerCase(),a=__(i);this.$summary_btns.append(`<div class="summary-btn btn btn-default ${n}-btn">${a}</div>`)})}),this.$summary_btns.children().last().removeClass("mr-4")}toggle_summary_placeholder(e){e?(this.$summary_wrapper.css("display","none"),this.$component.find(".no-summary-placeholder").css("display","flex")):(this.$summary_wrapper.css("display","flex"),this.$component.find(".no-summary-placeholder").css("display","none"))}get_condition_btn_map(e){return e?[{condition:!0,visible_btns:["Print Receipt","Email Receipt","New Order"]}]:[{condition:this.doc.docstatus===0,visible_btns:["Edit Order"]},{condition:!this.doc.is_return&&this.doc.docstatus===1,visible_btns:["Print Receipt","Email Receipt","Return"]},{condition:this.doc.is_return&&this.doc.docstatus===1,visible_btns:["Print Receipt","Email Receipt"]}]}load_summary_of(e,t=!1){t?this.$component.css("grid-column","span 10 / span 10"):this.$component.css("grid-column","span 6 / span 6"),this.toggle_summary_placeholder(!1),this.doc=e,this.attach_document_info(e),this.attach_items_info(e),this.attach_totals_info(e),this.attach_payments_info(e);let i=this.get_condition_btn_map(t);this.add_summary_btns(i)}attach_document_info(e){frappe.db.get_value("Customer",this.doc.customer,"email_id").then(({message:t})=>{this.customer_email=t.email_id||"";let i=this.get_upper_section_html(e);(0,pn.default)("#barcode",e.name,{width:1}),this.$upper_section.html(i),SS})}attach_items_info(e){this.$items_container.html(""),e.items.forEach(t=>{let i=this.get_item_html(e,t);this.$items_container.append(i),this.set_dynamic_rate_header_width()})}set_dynamic_rate_header_width(){let e=Array.from(this.$items_container.find(".item-rate-disc"));this.$items_container.find(".item-rate-disc").css("width","");let t=e.reduce((i,n)=>($(n).width()>i&&(i=$(n).width()),i),0);t+=1,t==1&&(t=""),this.$items_container.find(".item-rate-disc").css("width",t)}attach_payments_info(e){if(this.$payment_container.html(""),e.payments.forEach(t=>{if(t.amount){let i=this.get_payment_html(e,t);this.$payment_container.append(i)}}),e.redeem_loyalty_points&&e.loyalty_amount){let t=this.get_payment_html(e,{mode_of_payment:"Loyalty Points",amount:e.loyalty_amount});this.$payment_container.append(t)}}attach_totals_info(e){this.$totals_container.html("");let t=this.get_net_total_html(e),i=this.get_vatable_sales_html(e),n=this.get_vatable_exempt_html(e),a=this.get_zero_rated_html(e),r=this.get_vat_amount_html(e),o=this.get_taxes_html(e),s=this.get_discount_html(e),h=this.get_grand_total_html(e);this.$totals_container.append(t),this.$totals_container.append(o),this.$totals_container.append(s),this.$totals_container.append(h)}toggle_component(e){e?this.$component.css("display","flex"):this.$component.css("display","none")}};custom_app.PointOfSale.Controller=class{constructor(e){this.wrapper=$(e).find(".layout-main-section"),this.page=e.page,this.init_pos_profile(),this.add_event_listeners(),console.log("Controller is loaded")}init_pos_profile(){let e=localStorage.getItem("pos_profile"),t=localStorage.getItem("selected_warehouse");e?this.prepare_app_defaults({pos_profile:e,warehouse:t}):this.select_pos_profile()}select_pos_profile(){let e=this,t=new frappe.ui.Dialog({title:__("Select POS Profile"),fields:[{fieldtype:"Link",label:__("POS Profile"),options:"POS Profile",fieldname:"pos_profile",reqd:1,get_query:()=>({query:"erpnext.accounts.doctype.pos_profile.pos_profile.pos_profile_query",filters:{company:frappe.defaults.get_default("company")}})}],primary_action:function({pos_profile:i}){localStorage.setItem("pos_profile",i),e.prepare_app_defaults({pos_profile:i}),t.hide(),location.reload()},primary_action_label:__("Select")});t.show()}async prepare_app_defaults(e){this.company=frappe.defaults.get_default("company"),this.pos_profile=e.pos_profile,this.warehouse=e.warehouse||null,this.item_stock_map={},this.settings={},frappe.db.get_value("Stock Settings",void 0,"allow_negative_stock").then(({message:t})=>{this.allow_negative_stock=flt(t.allow_negative_stock)||!1}),frappe.call({method:"custom_app.customapp.page.packing_list.packing_list.get_pos_profile_data",args:{pos_profile:this.pos_profile},callback:t=>{let i=t.message;Object.assign(this.settings,i),this.settings.customer_groups=i.customer_groups.map(n=>n.name),this.make_app()}})}set_opening_entry_status(){this.page.set_title_sub(`<span class="indicator orange">
				<a class="text-muted" href="#Form/POS%20Opening%20Entry/${this.pos_opening}">
					Opened at ${moment(this.pos_opening_time).format("Do MMMM, h:mma")}
				</a>
			</span>`)}make_app(){this.prepare_dom(),this.prepare_components(),this.prepare_menu(),this.add_buttons_to_toolbar(),this.make_new_invoice()}prepare_dom(){this.wrapper.append('<div class="point-of-sale-app"></div>'),this.$components_wrapper=this.wrapper.find(".point-of-sale-app")}prepare_components(){this.init_item_selector(),this.init_item_details(),this.init_item_cart(),this.init_payments(),this.init_recent_order_list(),this.init_order_summary()}prepare_dom(){this.wrapper.append('<div class="point-of-sale-app"></div>'),this.$components_wrapper=this.wrapper.find(".point-of-sale-app")}prepare_menu(){this.page.clear_menu(),this.page.add_menu_item(__("Item Selector (F1)"),this.add_new_order.bind(this),!1,"f1"),this.page.add_menu_item(__("Pending Transaction (F2)"),this.order_list.bind(this),!1,"f2"),this.page.add_menu_item(__("Branch Item Lookup (F4)"),this.show_branch_selection_dialog.bind(this),!1,"f4"),this.page.add_menu_item(__("Change POS Profile (F5)"),this.select_pos_profile.bind(this),!1,"f5"),this.page.add_menu_item(__("Save as Draft"),this.save_draft.bind(this),!1,"f3")}add_buttons_to_toolbar(){let e=[{label:__("Item Selector (F1)"),action:this.add_new_order.bind(this),shortcut:"f1"},{label:__("Pending Transaction (F2"),action:this.order_list.bind(this),shortcut:"f2"},{label:__("Save as Draft (F3)"),action:this.save_draft.bind(this),shortcut:"f3"},{label:__("Amesco Plus Member"),action:this.amesco_plus_scan.bind(this)},{label:__("Branch Item Lookup (F4)"),action:this.show_branch_selection_dialog.bind(this),shortcut:"f4"}];$(".page-actions .btn-custom").remove(),e.forEach(t=>{this.page.add_button(t.label,t.action,{shortcut:t.shortcut}).addClass("btn-custom")})}add_new_order(){frappe.run_serially([()=>frappe.dom.freeze(),()=>this.frm.call("reset_mode_of_payments"),()=>this.cart.load_invoice(),()=>this.make_new_invoice(),()=>this.item_selector.toggle_component(!0),()=>this.item_details.toggle_item_details_section(),()=>this.toggle_recent_order_list(!1),()=>window.location.reload(),()=>frappe.dom.unfreeze()])}order_list(){frappe.run_serially([()=>frappe.dom.freeze(),()=>this.toggle_recent_order_list(!0),()=>frappe.dom.unfreeze()])}amesco_plus_scan(){let t=this.frm,i=new frappe.ui.Dialog({title:__("Enter Scanned Data"),fields:[{label:"Scanned Data",fieldname:"scanned_data",fieldtype:"Data",reqd:1,description:"Enter the scanned data (comma-separated format)"}],primary_action_label:__("Submit"),primary_action(n){let a=n.scanned_data.split(",");if(a.length>=5){let r=a[0],o=a[2],s=a[3],h=a[4];t.set_value("custom_ameso_user",s),t.set_value("custom_amesco_user_id",r);let b=new frappe.ui.Dialog({title:__("Scanned User Details"),fields:[{label:"Name",fieldname:"user_name",fieldtype:"Data",read_only:1,default:o},{label:"Email",fieldname:"email",fieldtype:"Data",read_only:1,default:s},{label:"Points",fieldname:"points",fieldtype:"Data",read_only:1,default:h}],primary_action_label:__("Close"),primary_action:function(){b.hide()}});b.show()}else frappe.msgprint(__("Invalid data format. Please enter at least 5 comma-separated values."));i.hide()}});i.show()}set_discount_log(e,t,i){e.set_value("custom_ameso_user",updated_discount_log),e.set_value("custom_manual_dicsount",updated_discount_log)}handle_scanned_barcode(e){console.log("Scanned Barcode:",e)}show_branch_selection_dialog(){let e=localStorage.getItem("selected_warehouse")||"",t=new frappe.ui.Dialog({title:__("Select Branch"),fields:[{fieldtype:"Link",label:__("Warehouse"),options:"Warehouse",fieldname:"warehouse",default:e,reqd:1,get_query:()=>({query:"custom_app.customapp.page.packing_list.packing_list.warehouse_query",filters:{company:frappe.defaults.get_default("company")}})}],primary_action:function(i){localStorage.setItem("selected_warehouse",i.warehouse),location.reload(),t.hide()},primary_action_label:__("View"),secondary_action_label:__("Clear"),secondary_action:function(){localStorage.removeItem("selected_warehouse"),location.reload(),t.hide()}});t.show()}prepare_profile_selection(){let e=this,t=this.page.add_field({label:"Branch",fieldtype:"Select",fieldname:"warehouse",options:[],change(){let i=t.get_value();i&&e.set_warehouse(i)}});frappe.call({method:"custom_app.customapp.page.packing_list.packing_list.warehouse_query",args:{doctype:"Warehouse",txt:"",searchfield:"name",start:0,page_len:100,filters:{}},callback:function(i){if(i.message){let n=i.message.map(a=>a[0]);t.df.options=[...n],t.refresh()}}})}add_event_listeners(){frappe.logout=function(e){return function(){return localStorage.removeItem("pos_profile"),e.apply(this,arguments)}}(frappe.logout)}open_form_view(){frappe.model.sync(this.frm.doc),frappe.set_route("Form",this.frm.doc.doctype,this.frm.doc.name)}toggle_recent_order(){let e=this.recent_order_list.$component.is(":hidden");this.toggle_recent_order_list(e)}async save_draft_invoice(){if(this.passwordDialog&&(this.passwordDialog.hide(),this.passwordDialog.$wrapper.remove(),delete this.passwordDialog),!this.$components_wrapper.is(":visible"))return;let e=this.frm.doc.payments.reduce((t,i)=>t+i.amount,0);if(parseFloat(e.toFixed(2))<this.frm.doc.grand_total){let t=new frappe.ui.Dialog({title:__("Insufficient Payment"),primary_action_label:__("OK"),primary_action:()=>{t.hide()}});t.body.innerHTML=`
				<div style="text-align: center; font-size: 30px; margin: 20px 0;">
					${__("The payment amount is not enough to cover the grand total.")}
				</div>
			`,t.show();return}if(this.frm.doc.items.length===0){frappe.show_alert({message:__("You must add at least one item to complete the order."),indicator:"red"}),frappe.utils.play_sound("error");return}this.passwordDialog=new frappe.ui.Dialog({title:__("Enter Your Password"),fields:[{fieldtype:"HTML",fieldname:"password_html",options:`
						<div class="form-group">
							<label for="password_field">${__("Password")}</label>
							<input type="password" id="sumbit_password" class="form-control" required>
						</div>
					`}],primary_action_label:__("Ok"),primary_action:()=>{let t=document.getElementById("sumbit_password").value,i=!1;frappe.call({method:"custom_app.customapp.page.packing_list.packing_list.get_user_details_by_password",args:{password:t},callback:n=>{n.message&&n.message.name?(this.set_pharmacist_assist(this.frm,n.message.name),console.log("USER DATA",n.message),this.frm.save(void 0,void 0,void 0,()=>{frappe.show_alert({message:"There was an error saving the document.",indicator:"red"}),frappe.utils.play_sound("error"),i=!0}).then(()=>{i||(this.passwordDialog.hide(),this.order_summary.load_summary_of(this.frm.doc,!0),this.order_summary.print_receipt(),localStorage.removeItem("posCartItems"),frappe.show_alert({message:"Invoice Printed",indicator:"blue"}),frappe.run_serially([()=>frappe.dom.freeze(),()=>this.make_new_invoice(),()=>frappe.dom.unfreeze(),()=>window.location.reload()]))}).catch(a=>{frappe.show_alert({message:__("An unexpected error occurred while saving the document. Please try again."),indicator:"red"}),i=!0})):(frappe.show_alert({message:"Incorrect password",indicator:"red"}),i=!0)}})}}),this.passwordDialog.$wrapper.on("shown.bs.modal",()=>{setTimeout(()=>{let t=document.getElementById("sumbit_password");t&&t.focus()},100)}),this.passwordDialog.show()}save_draft(){if(this.passwordDialog&&(this.passwordDialog.hide(),this.passwordDialog.$wrapper.remove(),delete this.passwordDialog),!!this.$components_wrapper.is(":visible")){if(this.frm.doc.items.length===0){frappe.show_alert({message:__("You must add at least one item to complete the order."),indicator:"red"}),frappe.utils.play_sound("error");return}this.passwordDialog=new frappe.ui.Dialog({title:__("Enter Your Password"),fields:[{fieldtype:"HTML",fieldname:"password_html",options:`
						<div class="form-group">
							<label for="password_field">${__("Password")}</label>
							<input type="password" id="password_field" class="form-control" required>
						</div>
					`}],primary_action_label:__("Ok"),primary_action:()=>{let e=document.getElementById("password_field").value,t=!1;frappe.call({method:"custom_app.customapp.page.packing_list.packing_list.get_user_details_by_password",args:{password:e},callback:i=>{i.message&&i.message.name?(this.set_pharmacist_assist(this.frm,i.message.name),this.frm.save(void 0,void 0,void 0,()=>{frappe.show_alert({message:"There was an error saving the document.",indicator:"red"}),frappe.utils.play_sound("error"),t=!0}).then(()=>{t||(this.passwordDialog.hide(),this.order_summary.load_summary_of(this.frm.doc,!0),this.order_summary.print_receipt(),localStorage.removeItem("posCartItems"),frappe.show_alert({message:"Invoice Printed",indicator:"blue"}),frappe.run_serially([()=>frappe.dom.freeze(),()=>this.make_new_invoice(),()=>frappe.dom.unfreeze(),()=>window.location.reload()]))}).catch(n=>{console.error("Unexpected error:",n),t=!0})):(frappe.show_alert({message:"Incorrect password",indicator:"red"}),t=!0)}})}}),this.passwordDialog.$wrapper.on("shown.bs.modal",()=>{setTimeout(()=>{let e=document.getElementById("password_field");e&&e.focus()},100)}),this.passwordDialog.show()}}set_pharmacist_assist(e,t){frappe.model.set_value(e.doc.doctype,e.doc.name,"custom_pharmacist_assistant",t),e.refresh_field("custom_pharmacist_assistant")}close_pos(){if(!this.$components_wrapper.is(":visible"))return;let e=frappe.model.get_new_doc("POS Closing Entry");e.pos_profile=this.frm.doc.pos_profile,e.user=frappe.session.user,e.company=this.frm.doc.company,e.pos_opening_entry=this.pos_opening,e.period_end_date=frappe.datetime.now_datetime(),e.posting_date=frappe.datetime.now_date(),e.posting_time=frappe.datetime.now_time(),frappe.set_route("Form","POS Closing Entry",e.name)}init_item_selector(){this.item_selector=new custom_app.PointOfSale.ItemSelector({wrapper:this.$components_wrapper,pos_profile:this.pos_profile,settings:this.settings,events:{item_selected:async e=>{frappe.call({method:"custom_app.customapp.page.packing_list.packing_list.get_pos_warehouse",args:{pos_profile:this.pos_profile},callback:t=>{if(t.message){let i=t.message,n=localStorage.getItem("selected_warehouse");if(i===n||n===null)this.on_cart_update(e);else{frappe.show_alert({message:__("You cannot add items from a different branch."),indicator:"red"}),frappe.utils.play_sound("error");return}}else{frappe.show_alert({message:__("Could not retrieve the warehouse for the POS Profile."),indicator:"red"}),frappe.utils.play_sound("error");return}}})},get_frm:()=>this.frm||{},get_pos_profile:()=>this.pos_profile}})}init_item_cart(){this.cart=new custom_app.PointOfSale.ItemCart({wrapper:this.$components_wrapper,settings:this.settings,events:{get_frm:()=>this.frm,cart_item_clicked:(e,t)=>{let i=this.get_item_from_frm(e);this.item_details.toggle_item_details_section(i)},numpad_event:(e,t)=>this.update_item_field(e,t),checkout:()=>this.save_and_checkout(),edit_cart:()=>this.payment.edit_cart(),customer_details_updated:e=>{this.customer_details=e,this.payment.render_loyalty_points_payment_mode()}}})}init_item_details(){this.item_details=new custom_app.PointOfSale.ItemDetails({wrapper:this.$components_wrapper,settings:this.settings,events:{get_frm:()=>this.frm,toggle_item_selector:e=>{this.item_selector.resize_selector(e),this.cart.toggle_numpad(e)},form_updated:(e,t,i)=>{let n=frappe.model.get_doc(e.doctype,e.name);if(n&&n[t]!=i){let a={field:t,value:i,item:this.item_details.current_item};return this.on_cart_update(a)}return Promise.resolve()},highlight_cart_item:e=>{let t=this.cart.get_cart_item(e);this.cart.toggle_item_highlight(t)},item_field_focused:e=>{this.cart.toggle_numpad_field_edit(e)},set_value_in_current_cart_item:(e,t)=>{this.cart.update_selector_value_in_cart_item(e,t,this.item_details.current_item)},clone_new_batch_item_in_frm:(e,t)=>{Object.keys(e).forEach(i=>{let n=this.frm.doc.items.find(r=>r.name==t.name),a=this.frm.add_child("items",z({},n));a.batch_no=i,a.serial_no=e[i].join(`
`),a.qty=e[i].length,this.frm.doc.items.forEach(r=>{t.item_code===r.item_code&&this.update_cart_html(r)})})},remove_item_from_cart:()=>this.remove_item_from_cart(),get_item_stock_map:()=>this.item_stock_map,close_item_details:()=>{this.item_details.toggle_item_details_section(null),this.cart.prev_action=null,this.cart.toggle_item_highlight()},get_available_stock:(e,t)=>this.get_available_stock(e,t)}})}init_payments(){this.payment=new custom_app.PointOfSale.Payment({wrapper:this.$components_wrapper,events:{get_frm:()=>this.frm||{},get_customer_details:()=>this.customer_details||{},toggle_other_sections:e=>{e?(this.item_details.$component.is(":visible")&&this.item_details.$component.css("display","none"),this.item_selector.toggle_component(!1)):this.item_selector.toggle_component(!0)},submit_invoice:()=>{this.frm.savesubmit().then(e=>{this.toggle_components(!1),this.order_summary.toggle_component(!0),this.order_summary.load_summary_of(this.frm.doc,!0),frappe.show_alert({indicator:"green",message:__("POS invoice {0} created succesfully",[e.doc.name])})})},save_as_draft:()=>{this.save_draft_invoice()}}})}init_recent_order_list(){this.recent_order_list=new custom_app.PointOfSale.PastOrderList({wrapper:this.$components_wrapper,events:{open_invoice_data:e=>{frappe.db.get_doc("POS Invoice",e).then(t=>{this.order_summary.load_summary_of(t)})},pos_profile:()=>this.pos_profile,reset_summary:()=>this.order_summary.toggle_summary_placeholder(!0)}})}init_order_summary(){this.order_summary=new custom_app.PointOfSale.PastOrderSummary({wrapper:this.$components_wrapper,events:{get_frm:()=>this.frm,process_return:e=>{this.recent_order_list.toggle_component(!1),frappe.db.get_doc("POS Invoice",e).then(t=>{frappe.run_serially([()=>this.make_return_invoice(t),()=>this.cart.load_invoice(),()=>this.item_selector.toggle_component(!0)])})},edit_order:e=>{this.oic_edit_confirm(e)},delete_order:e=>{frappe.model.delete_doc(this.frm.doc.doctype,e,()=>{this.recent_order_list.refresh_list()})},new_order:()=>{frappe.run_serially([()=>frappe.dom.freeze(),()=>this.make_new_invoice(),()=>this.item_selector.toggle_component(!0),()=>frappe.dom.unfreeze()])}}})}oic_edit_confirm(e){this.passwordDialog&&(this.passwordDialog.$wrapper.remove(),delete this.passwordDialog);let t=!1;this.passwordDialog=new frappe.ui.Dialog({title:__("Authorization Required OIC"),fields:[{fieldtype:"HTML",fieldname:"password_html",options:`
						<div class="form-group">
							<label for="password_field">${__("Password")}</label>
							<input type="password" id="password_field" class="form-control" required>
						</div>
					`}],primary_action_label:__("Authorize"),primary_action:()=>{let i=document.getElementById("password_field").value;frappe.call({method:"custom_app.customapp.page.packing_list.packing_list.confirm_user_password",args:{password:i},callback:n=>{n.message?n.message.name?(t=!0,frappe.show_alert({message:__("Verified"),indicator:"green"}),frappe.run_serially([()=>this.frm.refresh(e),()=>this.cart.load_invoice(),()=>this.item_selector.toggle_component(!0),()=>this.toggle_recent_order_list(!1),()=>this.item_selector.load_items_data()]).then(()=>{this.passwordDialog.hide()})):frappe.show_alert({message:__("Incorrect password or user is not an OIC"),indicator:"red"}):frappe.show_alert({message:__("Incorrect password or user is not an OIC"),indicator:"red"})}})}}),this.passwordDialog.$wrapper.on("hidden.bs.modal",()=>{t||window.location.reload()}),this.passwordDialog.show(),this.passwordDialog.$wrapper.on("shown.bs.modal",()=>{setTimeout(()=>{document.getElementById("password_field").focus()},100)})}toggle_recent_order_list(e){this.toggle_components(!e),this.recent_order_list.toggle_component(e),this.order_summary.toggle_component(e)}toggle_components(e){this.cart.toggle_component(e),this.item_selector.toggle_component(e),e||this.item_details.toggle_component(!1)||this.payment.toggle_component(!1)}make_new_invoice(){return frappe.run_serially([()=>frappe.dom.freeze(),()=>this.make_sales_invoice_frm(),()=>this.set_pos_profile_data(),()=>this.set_pos_profile_status(),()=>this.cart.load_invoice(),()=>frappe.dom.unfreeze()])}make_sales_invoice_frm(){let e="POS Invoice";return new Promise(t=>{this.frm?(this.frm=this.get_new_frm(this.frm),this.frm.doc.items=[],this.frm.doc.is_pos=1,t()):frappe.model.with_doctype(e,()=>{this.frm=this.get_new_frm(),this.frm.doc.items=[],this.frm.doc.is_pos=1,t()})})}get_new_frm(e){let t="POS Invoice",i=$("<div>"),n=e||new frappe.ui.form.Form(t,i,!1),a=frappe.model.make_new_doc_and_get_name(t,!0);return n.refresh(a),n}async make_return_invoice(e){return frappe.dom.freeze(),this.frm=this.get_new_frm(this.frm),this.frm.doc.items=[],frappe.call({method:"erpnext.accounts.doctype.order_list.order_list.make_sales_return",args:{source_name:e.name,target_doc:this.frm.doc},callback:t=>{frappe.model.sync(t.message),frappe.get_doc(t.message.doctype,t.message.name).__run_link_triggers=!1,this.set_pos_profile_data().then(()=>{frappe.dom.unfreeze()})}})}set_pos_profile_data(){if(this.company&&!this.frm.doc.company&&(this.frm.doc.company=this.company),(this.pos_profile&&!this.frm.doc.pos_profile)|(this.frm.doc.is_return&&this.pos_profile!=this.frm.doc.pos_profile)&&(this.frm.doc.pos_profile=this.pos_profile),!!this.frm.doc.company)return this.frm.trigger("set_pos_data")}set_pos_profile_status(){this.page.set_indicator(this.pos_profile,"blue")}async on_cart_update(e){frappe.dom.freeze();let t;try{let{field:i,value:n,item:a}=e;t=this.get_item_from_frm(a);let r=!$.isEmptyObject(t),o=i==="qty"&&n==="+1";if(o&&(n=flt(t.stock_qty)+flt(n)),r){if(i==="qty"&&(n=flt(n)),["qty","conversion_factor"].includes(i)&&n>0&&!this.allow_negative_stock){let s=i==="qty"?n*t.conversion_factor:t.qty*n;await this.check_stock_availability(t,s,this.frm.doc.set_warehouse)}(this.is_current_item_being_edited(t)||o)&&(await frappe.model.set_value(t.doctype,t.name,i,n),this.update_cart_html(t))}else{if(!this.frm.doc.customer)return this.raise_customer_selection_alert();let{item_code:s,batch_no:h,serial_no:b,rate:v,uom:u}=a;if(!s)return;let l={item_code:s,batch_no:h,rate:v,uom:u,[i]:n};if(b&&b!=="undefined"&&(await this.check_serial_no_availablilty(s,this.frm.doc.set_warehouse,b),l.serial_no=b),i==="serial_no"&&(l.qty=n.split(`
`).length||0),t=this.frm.add_child("items",l),i==="qty"&&n!==0&&!this.allow_negative_stock){let f=n*t.conversion_factor;await this.check_stock_availability(t,f,this.frm.doc.set_warehouse)}await this.trigger_new_item_events(t),this.update_cart_html(t),this.item_details.$component.is(":visible")&&this.edit_item_details_of(t),this.check_serial_batch_selection_needed(t)&&!this.item_details.$component.is(":visible")&&this.edit_item_details_of(t)}}catch(i){console.log(i)}finally{return frappe.dom.unfreeze(),t}}raise_customer_selection_alert(){frappe.dom.unfreeze(),frappe.show_alert({message:__("You must select a customer before adding an item."),indicator:"orange"}),frappe.utils.play_sound("error")}get_item_from_frm({name:e,item_code:t,batch_no:i,uom:n,rate:a}){let r=null;if(e)r=this.frm.doc.items.find(o=>o.name==e);else{let o=i!=="null"&&i!==null;r=this.frm.doc.items.find(s=>s.item_code===t&&(!o||o&&s.batch_no===i)&&s.uom===n&&s.rate===flt(a))}return r||{}}edit_item_details_of(e){this.item_details.toggle_item_details_section(e)}is_current_item_being_edited(e){return e.name==this.item_details.current_item.name}update_cart_html(e,t){this.cart.update_item_html(e,t),this.cart.update_totals_section(this.frm)}check_serial_batch_selection_needed(e){let t=e.has_serial_no,i=e.has_batch_no,n=!e.serial_no,a=!e.batch_no;return!!(t&&n||i&&a||t&&i&&(a||n))}async trigger_new_item_events(e){await this.frm.script_manager.trigger("item_code",e.doctype,e.name),await this.frm.script_manager.trigger("qty",e.doctype,e.name)}async check_stock_availability(e,t,i){let n=(await this.get_available_stock(e.item_code,i)).message,a=n[0],r=n[1];frappe.dom.unfreeze();let o=e.stock_uom.bold(),s=e.item_code.bold(),h=i.bold(),b=a.toString().bold();if(a>0)r&&a<t&&(frappe.throw({message:__("Stock quantity not enough for Item Code: {0} under warehouse {1}. Available quantity {2} {3}.",[s,h,b,o]),indicator:"orange"}),frappe.utils.play_sound("error"));else if(r)frappe.model.clear_doc(e.doctype,e.name),frappe.throw({title:__("Not Available"),message:__("Item Code: {0} is not available under warehouse {1}.",[s,h])});else return;frappe.dom.freeze()}async check_serial_no_availablilty(e,t,i){let n="erpnext.stock.doctype.serial_no.serial_no.get_pos_reserved_serial_nos",a={filters:{item_code:e,warehouse:t}};(await frappe.call({method:n,args:a})).message.includes(i)&&frappe.throw({title:"Not Available",message:[i.bold()]})}get_available_stock(e,t){let i=this;return frappe.call({method:"erpnext.accounts.doctype.pos_invoice.pos_invoice.get_stock_availability",args:{item_code:e,warehouse:t},callback(n){i.item_stock_map[e]||(i.item_stock_map[e]={}),i.item_stock_map[e][t]=n.message}})}async auto_add_batch(e){try{let t=await frappe.db.get_list("Batch",{filters:{item:e.item_code,expiry_date:[">=",frappe.datetime.now_date()]},fields:["name","expiry_date"],order_by:"expiry_date desc"});if(t.length>0){let n=[{batch_no:t[0].name,qty:e.qty,name:"row 1",warehouse:this.frm.doc.set_warehouse}],a=await frappe.call({method:"erpnext.stock.doctype.serial_and_batch_bundle.serial_and_batch_bundle.add_serial_batch_ledgers",args:{entries:n,child_row:e,doc:this.frm.doc,warehouse:this.frm.doc.set_warehouse}});frappe.model.set_value(e.doctype,e.name,{serial_and_batch_bundle:a.message.name,qty:Math.abs(a.message.total_qty)})}}catch(t){frappe.show_alert({message:__("Batch fetch failed. Please try again."),indicator:"red"}),console.error(t)}}async update_item_field(e,t){if(t==="checkout")this.item_details.toggle_item_details_section(null);else if(t==="remove")this.remove_item_from_cart();else{let i=this.item_details[`${t}_control`];if(!i)return;i.set_focus(),e!=""&&i.set_value(e)}}remove_item_from_cart(){this.passwordDialog&&(this.passwordDialog.$wrapper.remove(),delete this.passwordDialog),this.passwordDialog=new frappe.ui.Dialog({title:__("Enter OIC Password"),fields:[{fieldtype:"HTML",fieldname:"password_html",options:`
						<div class="form-group">
							<label for="password_field">${__("Password")}</label>
							<input type="password" id="password_field" class="form-control" required>
						</div>
					`}],primary_action_label:__("Ok"),primary_action:()=>{let e=document.getElementById("password_field").value;frappe.call({method:"custom_app.customapp.page.packing_list.packing_list.confirm_user_password",args:{password:e},callback:t=>{if(t.message)if(t.message.name){frappe.dom.freeze();let{doctype:i,name:n,current_item:a}=this.item_details;frappe.model.set_value(i,n,"qty",0).then(()=>{frappe.model.clear_doc(i,n),this.update_cart_html(a,!0),this.item_details.toggle_item_details_section(null),frappe.dom.unfreeze(),this.passwordDialog.hide()}).catch(r=>{console.log(r),frappe.dom.unfreeze(),this.passwordDialog.hide()})}else frappe.show_alert({message:"Incorrect password",indicator:"red"});else frappe.show_alert({message:"Incorrect password",indicator:"red"})}})}}),this.passwordDialog.show(),this.passwordDialog.$wrapper.on("shown.bs.modal",function(){setTimeout(()=>{document.getElementById("password_field").focus()},100)})}async save_and_checkout(){if(this.frm.is_dirty()){let e=!1;!e&&this.payment.checkout(),e&&setTimeout(()=>{this.cart.toggle_checkout_btn(!0)},300)}else this.payment.checkout()}};})();
//# sourceMappingURL=packing-list.bundle.RVRJLZFB.js.map
