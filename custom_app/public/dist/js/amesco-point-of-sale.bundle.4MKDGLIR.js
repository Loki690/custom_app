(()=>{var J=Object.create;var G=Object.defineProperty,X=Object.defineProperties,ee=Object.getOwnPropertyDescriptor,te=Object.getOwnPropertyDescriptors,ie=Object.getOwnPropertyNames,Q=Object.getOwnPropertySymbols,ae=Object.getPrototypeOf,Y=Object.prototype.hasOwnProperty,se=Object.prototype.propertyIsEnumerable;var H=(e,t,i)=>t in e?G(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,A=(e,t)=>{for(var i in t||(t={}))Y.call(t,i)&&H(e,i,t[i]);if(Q)for(var i of Q(t))se.call(t,i)&&H(e,i,t[i]);return e},N=(e,t)=>X(e,te(t));var ne=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var oe=(e,t,i,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let o of ie(t))!Y.call(e,o)&&o!==i&&G(e,o,{get:()=>t[o],enumerable:!(s=ee(t,o))||s.enumerable});return e};var re=(e,t,i)=>(i=e!=null?J(ae(e)):{},oe(t||!e||!e.__esModule?G(i,"default",{value:e,enumerable:!0}):i,e));var Z=ne((W,U)=>{(function(e,t){typeof W=="object"&&typeof U!="undefined"?U.exports=t():typeof define=="function"&&define.amd?define(t()):e.onScan=t()})(W,function(){var e={attachTo:function(t,i){if(t.scannerDetectionData!==void 0)throw new Error("onScan.js is already initialized for DOM element "+t);var s={onScan:function(o,a){},onScanError:function(o){},onKeyProcess:function(o,a){},onKeyDetect:function(o,a){},onPaste:function(o,a){},keyCodeMapper:function(o){return e.decodeKeyEvent(o)},onScanButtonLongPress:function(){},scanButtonKeyCode:!1,scanButtonLongPressTime:500,timeBeforeScanTest:100,avgTimeByChar:30,minLength:6,suffixKeyCodes:[9,13],prefixKeyCodes:[],ignoreIfFocusOn:!1,stopPropagation:!1,preventDefault:!1,captureEvents:!1,reactToKeydown:!0,reactToPaste:!1,singleScanQty:1};return i=this._mergeOptions(s,i),t.scannerDetectionData={options:i,vars:{firstCharTime:0,lastCharTime:0,accumulatedString:"",testTimer:!1,longPressTimeStart:0,longPressed:!1}},i.reactToPaste===!0&&t.addEventListener("paste",this._handlePaste,i.captureEvents),i.scanButtonKeyCode!==!1&&t.addEventListener("keyup",this._handleKeyUp,i.captureEvents),(i.reactToKeydown===!0||i.scanButtonKeyCode!==!1)&&t.addEventListener("keydown",this._handleKeyDown,i.captureEvents),this},detachFrom:function(t){t.scannerDetectionData.options.reactToPaste&&t.removeEventListener("paste",this._handlePaste),t.scannerDetectionData.options.scanButtonKeyCode!==!1&&t.removeEventListener("keyup",this._handleKeyUp),t.removeEventListener("keydown",this._handleKeyDown),t.scannerDetectionData=void 0},getOptions:function(t){return t.scannerDetectionData.options},setOptions:function(t,i){switch(t.scannerDetectionData.options.reactToPaste){case!0:i.reactToPaste===!1&&t.removeEventListener("paste",this._handlePaste);break;case!1:i.reactToPaste===!0&&t.addEventListener("paste",this._handlePaste);break}switch(t.scannerDetectionData.options.scanButtonKeyCode){case!1:i.scanButtonKeyCode!==!1&&t.addEventListener("keyup",this._handleKeyUp);break;default:i.scanButtonKeyCode===!1&&t.removeEventListener("keyup",this._handleKeyUp);break}return t.scannerDetectionData.options=this._mergeOptions(t.scannerDetectionData.options,i),this._reinitialize(t),this},decodeKeyEvent:function(t){var i=this._getNormalizedKeyNum(t);switch(!0){case(i>=48&&i<=90):case(i>=106&&i<=111):if(t.key!==void 0&&t.key!=="")return t.key;var s=String.fromCharCode(i);switch(t.shiftKey){case!1:s=s.toLowerCase();break;case!0:s=s.toUpperCase();break}return s;case(i>=96&&i<=105):return 0+(i-96)}return""},simulate:function(t,i){return this._reinitialize(t),Array.isArray(i)?i.forEach(function(s){var o={};(typeof s=="object"||typeof s=="function")&&s!==null?o=s:o.keyCode=parseInt(s);var a=new KeyboardEvent("keydown",o);document.dispatchEvent(a)}):this._validateScanCode(t,i),this},_reinitialize:function(t){var i=t.scannerDetectionData.vars;i.firstCharTime=0,i.lastCharTime=0,i.accumulatedString=""},_isFocusOnIgnoredElement:function(t){var i=t.scannerDetectionData.options.ignoreIfFocusOn;if(!i)return!1;var s=document.activeElement;if(Array.isArray(i)){for(var o=0;o<i.length;o++)if(s.matches(i[o])===!0)return!0}else if(s.matches(i))return!0;return!1},_validateScanCode:function(t,i){var s=t.scannerDetectionData,o=s.options,a=s.options.singleScanQty,r=s.vars.firstCharTime,n=s.vars.lastCharTime,d={},_;switch(!0){case i.length<o.minLength:d={message:"Receieved code is shorter then minimal length"};break;case n-r>i.length*o.avgTimeByChar:d={message:"Receieved code was not entered in time"};break;default:return o.onScan.call(t,i,a),_=new CustomEvent("scan",{detail:{scanCode:i,qty:a}}),t.dispatchEvent(_),e._reinitialize(t),!0}return d.scanCode=i,d.scanDuration=n-r,d.avgTimeByChar=o.avgTimeByChar,d.minLength=o.minLength,o.onScanError.call(t,d),_=new CustomEvent("scanError",{detail:d}),t.dispatchEvent(_),e._reinitialize(t),!1},_mergeOptions:function(t,i){var s={},o;for(o in t)Object.prototype.hasOwnProperty.call(t,o)&&(s[o]=t[o]);for(o in i)Object.prototype.hasOwnProperty.call(i,o)&&(s[o]=i[o]);return s},_getNormalizedKeyNum:function(t){return t.which||t.keyCode},_handleKeyDown:function(t){var i=e._getNormalizedKeyNum(t),s=this.scannerDetectionData.options,o=this.scannerDetectionData.vars,a=!1;if(s.onKeyDetect.call(this,i,t)!==!1&&!e._isFocusOnIgnoredElement(this)){if(s.scanButtonKeyCode!==!1&&i==s.scanButtonKeyCode){o.longPressed||(o.longPressTimer=setTimeout(s.onScanButtonLongPress,s.scanButtonLongPressTime,this),o.longPressed=!0);return}switch(!0){case(o.firstCharTime&&s.suffixKeyCodes.indexOf(i)!==-1):t.preventDefault(),t.stopImmediatePropagation(),a=!0;break;case(!o.firstCharTime&&s.prefixKeyCodes.indexOf(i)!==-1):t.preventDefault(),t.stopImmediatePropagation(),a=!1;break;default:var r=s.keyCodeMapper.call(this,t);if(r===null)return;o.accumulatedString+=r,s.preventDefault&&t.preventDefault(),s.stopPropagation&&t.stopImmediatePropagation(),a=!1;break}o.firstCharTime||(o.firstCharTime=Date.now()),o.lastCharTime=Date.now(),o.testTimer&&clearTimeout(o.testTimer),a?(e._validateScanCode(this,o.accumulatedString),o.testTimer=!1):o.testTimer=setTimeout(e._validateScanCode,s.timeBeforeScanTest,this,o.accumulatedString),s.onKeyProcess.call(this,r,t)}},_handlePaste:function(t){var i=this.scannerDetectionData.options,s=this.scannerDetectionData.vars,o=(event.clipboardData||window.clipboardData).getData("text");e._isFocusOnIgnoredElement(this)||(t.preventDefault(),i.stopPropagation&&t.stopImmediatePropagation(),i.onPaste.call(this,o,event),s.firstCharTime=0,s.lastCharTime=0,e._validateScanCode(this,o))},_handleKeyUp:function(t){if(!e._isFocusOnIgnoredElement(this)){var i=e._getNormalizedKeyNum(t);i==this.scannerDetectionData.options.scanButtonKeyCode&&(clearTimeout(this.scannerDetectionData.vars.longPressTimer),this.scannerDetectionData.vars.longPressed=!1)}},isScanInProgressFor:function(t){return t.scannerDetectionData.vars.firstCharTime>0},isAttachedTo:function(t){return t.scannerDetectionData!==void 0}};return e})});var j=re(Z());custom_app.PointOfSale.ItemSelector=class{constructor({frm:e,wrapper:t,events:i,pos_profile:s,settings:o}){this.wrapper=t,this.events=i,this.pos_profile=s,this.hide_images=o.hide_images,this.auto_add_item=o.auto_add_item_to_cart,this.init_component()}init_component(){this.prepare_dom(),this.load_items_data(),this.make_search_bar(),this.bind_events(),this.attach_shortcuts(),this.inject_css()}inject_css(){let e=`
			.highlight {
				background-color: #0289f7;
                color: white;
                font-weight: bold;
			}
            .text{
                font-size: 1em;
                font-weight: semi-bold;
            }
            .text-description{
                font-size: 1em;
                font-weight: semi-bold;
            }
            .quantity-field{
                width: 1rem;
                height: 10rem;
            }
            .custom-quantity-field {
                width: 200px; /* Adjust the width as needed */
            }
		`,t=document.createElement("style");t.type="text/css",t.styleSheet?t.styleSheet.cssText=e:t.appendChild(document.createTextNode(e)),document.head.appendChild(t)}prepare_dom(){let e=localStorage.getItem("selected_warehouse");this.wrapper.append(`<section class="items-selector" style="margin-top:0rem; grid-column: span 4 / span 4;">
                <div class="filter-section" style="display: flex; align-items: center; gap: 10px;">
                    <div class="label" style="flex: 1;">
                        ${__("All Items")} ${e||""}
                    </div>
                    <div class="search-field" style="flex: 2;">
                        <input type="text" placeholder="Search by item code, serial number or barcode" style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;">
                    </div>
                    <div class="item-group-field" style="flex: 1;">
                        <input type="text" placeholder="Select item group" style="width: 100%; padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px;">
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table items-table">
                        <thead style="position: sticky; top: 0; background-color: #fff; z-index: 1; font-size:11px;">
                            <tr>
                                <th>Item Code</th>
                                <th>Name</th>
                                <th>Generic Name</th>
                                <th>Vat Type</th>
                                <th>Price</th>
                                <th>UOM</th>
                                <th>QOH</th>
                            </tr>
                        </thead>
                        <tbody class="items-container"></tbody>
                    </table>
                </div>
            </section>`),this.$component=this.wrapper.find(".items-selector"),this.$items_container=this.$component.find(".items-container")}async load_items_data(){if(!this.item_group){let t=await frappe.db.get_value("Item Group",{lft:1,is_group:1},"name");this.parent_item_group=t.message.name}if(!this.price_list){let t=await frappe.db.get_value("POS Profile",this.pos_profile,"selling_price_list");this.price_list=t.message.selling_price_list}this.selected_uom="PC",this.item_uom&&(this.item_uom.set_value("PC"),this.item_uom.refresh());let{message:e}=await this.get_items({});this.render_item_list(e.items),this.filter_items({uom:this.selected_uom})}get_items({start:e=0,page_length:t=20,search_term:i=""}){let s=this.events.get_frm().doc,o=s&&s.selling_price_list||this.price_list||"default_price_list",a=s&&s.item_group||this.item_group||"default_item_group",r=localStorage.getItem("selected_warehouse");return o?a?frappe.call({method:"custom_app.customapp.page.amesco_point_of_sale.amesco_point_of_sale.get_items",freeze:!0,args:{start:e,page_length:t,price_list:o,item_group:a,search_term:i,pos_profile:this.pos_profile,selected_warehouse:r}}):(console.error("Item group is required but missing."),frappe.msgprint({title:__("Error"),message:__("Item group is required but missing."),indicator:"red"}),Promise.reject(new Error("Item group is required but missing."))):(console.error("Price list is required but missing."),frappe.msgprint({title:__("Error"),message:__("Price list is required but missing."),indicator:"red"}),Promise.reject(new Error("Price list is required but missing.")))}render_item_list(e){this.$items_container.html(""),this.items=e,e.forEach(t=>{let i=this.get_item_html(t);this.$items_container.append(i)}),this.highlighted_row_index=0,this.highlight_row(this.highlighted_row_index)}get_item_html(e){let t=this,{item_code:i,item_image:s,serial_no:o,batch_no:a,barcode:r,actual_qty:n,uom:d,price_list_rate:_,description:g,latest_expiry_date:u,batch_number:p,custom_is_vatable:h,custom_generic_name:c,item_group:l}=e,m=flt(_,2)%1!=0?2:0,y,f=n;if(d!=="PC")return"";e.is_stock_item?y=n>10?"green":n<=0?"red":"orange":(y="",f="");let v=_/(1+.12),w=g||"Description not available";return`<tr class="item-wrapper" style="border-bottom: 1px solid #ddd; font-size: 12px;" 
        onmouseover="this.style.backgroundColor='#0289f7'; this.style.color='white'; this.style.fontWeight='bold';"
        onmouseout="this.style.backgroundColor=''; this.style.color=''; this.style.fontWeight='';"
            data-item-code="${escape(i)}" data-serial-no="${escape(o)}"
            data-batch-no="${escape(a)}" data-uom="${escape(d)}"
            data-rate="${escape(_||0)}" data-description="${escape(w)}" data-qty="${f}">
            <td class="item-code" style=" width: 1rem;">${i}</td> 
             <td class="item-name" style="width: 15rem; white-space: normal; overflow: hidden; text-overflow: ellipsis;">${e.item_name}</td>
            <td class="item-name" style="width: 8rem; white-space: normal; overflow: hidden; text-overflow: ellipsis;">${c||""}</td>
            <td class="item-vat" style=" width: 10%;">${h==0?"VAT-Exempt":"VATable"}</td>
            <td class="item-rate" style=" width:8%;">${format_currency(_,e.currency)}</td>
            <td class="item-uom" style=" width: 5%;">${d}</td>
            <td class="item-qty" style=" width: 8%;"><span class="indicator-pill whitespace-nowrap ${y}">${n}</span></td>
        </tr>`}handle_broken_image(e){let t=$(e).attr("alt");$(e).parent().replaceWith(`<div class="item-display abbr">${t}</div>`)}make_search_bar(){let e=this,t=e.events.get_frm().doc;this.$component.find(".search-field").html(""),this.$component.find(".item-group-field").html(""),this.search_field=frappe.ui.form.make_control({df:{label:__("Search"),fieldtype:"Data",placeholder:__("Search by item code, serial number, barcode, generic name or description")},parent:this.$component.find(".search-field"),render_input:!0}),this.search_field.$input.on("input",()=>{let i=this.search_field.get_value().trim()}),this.item_group_field=frappe.ui.form.make_control({df:{label:__("Item Group"),fieldtype:"Link",options:"Item Group",placeholder:__("Select item group"),onchange:function(){e.item_group=this.value,!e.item_group&&(e.item_group=e.parent_item_group),e.filter_items()},get_query:function(){return{query:"custom_app.customapp.page.amesco_point_of_sale.amesco_point_of_sale.item_group_query",filters:{pos_profile:t?t.pos_profile:""}}}},parent:this.$component.find(".item-group-field"),render_input:!0}),this.item_group_field.$input.on("input",()=>{let i=this.item_group_field.get_value().trim()}),this.search_field.toggle_label(!1),this.item_group_field.toggle_label(!1),this.attach_clear_btn()}attach_clear_btn(){this.search_field.$wrapper.find(".control-input").append(`<span class="link-btn" style="top: 2px;">
				<a class="btn-open no-decoration" title="${__("Clear")}">
					${frappe.utils.icon("close","sm")}
				</a>
			</span>`),this.$clear_search_btn=this.search_field.$wrapper.find(".link-btn"),this.$clear_search_btn.on("click","a",()=>{this.set_search_value(""),this.search_field.set_focus()})}set_search_value(e){$(this.search_field.$input[0]).val(e).trigger("input")}bind_events(){let e=this;window.onScan=j.default,j.default.decodeKeyEvent=function(i){var s=this._getNormalizedKeyNum(i);switch(!0){case(s>=48&&s<=90):case(s>=106&&s<=111):case(s>=160&&s<=164||s==170):case(s>=186&&s<=194):case(s>=219&&s<=222):case s==32:if(i.key!==void 0&&i.key!=="")return i.key;var o=String.fromCharCode(s);switch(i.shiftKey){case!1:o=o.toLowerCase();break;case!0:o=o.toUpperCase();break}return o;case(s>=96&&s<=105):return 0+(s-96)}return""},j.default.attachTo(document,{onScan:i=>{this.search_field&&this.$component.is(":visible")&&(this.search_field.set_focus(),this.set_search_value(i),this.barcode_scanned=!0)}});let t;this.$component.on("click",".item-wrapper",async function(){let i=$(this);e.selectedItem=i;let s=unescape(i.attr("data-item-code")),o=unescape(i.attr("data-uom")),a=parseFloat(unescape(i.attr("data-rate"))),r=unescape(i.attr("data-description")),n=parseFloat(unescape(i.attr("data-qty"))),d=e.events.get_pos_profile();frappe.call({method:"custom_app.customapp.page.packing_list.packing_list.get_item_uom_prices",args:{item_code:s},callback:function(_){if(_.message){let g=_.message.uom_prices,u=Object.keys(g).filter(l=>l&&l!=="null").map(l=>({label:l,value:l})),p=o;if(!g.hasOwnProperty(p)&&(p=u.length>0?u[0].value:null,!p)){frappe.msgprint(__("No valid UOMs found for this item."));return}let h=g[p],c=new frappe.ui.Dialog({title:__("Item Details"),fields:[{fieldtype:"HTML",title:__("Item Details"),options:`
                                        <div class="row">
                                            <div class="col-lg">
                                                <div class="form-group">
                                                    <label class="control-label">Item Code</label>
                                                    <input class="form-control" readonly data-fieldname="description" type="text" value="${s}"/>
                                                </div>
                                            </div>
                                        </div>
                                    `},{fieldtype:"HTML",title:__("Item Details"),options:`
                                        <div class="row">
                                            <div class="col-lg">
                                                <div class="form-group">
                                                    <label class="control-label">Item Description</label>
                                                    <input class="form-control" readonly data-fieldname="description" type="text" value="${r}"/>
                                                </div>
                                            </div>
                                        </div>
                                    `},{fieldtype:"HTML",label:__("Quantity"),options:`
                                        <div class="row">
                                            <div class="col-lg">
                                                <div class="form-group">
                                                    <label class="control-label">${__("Quantity")}</label>
                                                    <input class="form-control" type="number" data-fieldname="quantity" required value="1" min="1" /> </div>
                                                </div>
                                            </div>
                                        </div>
                                    `},{fieldtype:"Select",label:__("UOM"),fieldname:"uom",options:u,default:p},{fieldtype:"HTML",label:__("Amount"),options:`
                                        <div class="row">
                                            <div class="col-lg">
                                                <div class="form-group">
                                                    <label class="control-label">Amount</label>
                                                    <input class="form-control" data-fieldname="total_amount" value="${h.toFixed(2)}" readonly />
                                                </div>
                                            </div>
                                        </div>
                                    `},{label:"Branch Item INVTY",fieldtype:"Button",btn_size:"sm",click:function(){let l=[];frappe.call({method:"frappe.client.get_list",args:{doctype:"Warehouse",fields:["name","warehouse_type","parent_warehouse"],limit_page_length:0},callback:function(m){l=m.message;let y=l.map(b=>new Promise((v,w)=>{frappe.call({method:"custom_app.customapp.page.packing_list.packing_list.get_item_qty_per_warehouse",args:{warehouse:b.name,item_code:s},callback:function(S){b.actual_qty=S.message,v(b)},error:function(S){w(S)}})}));Promise.all(y).then(b=>{b=b.filter(w=>w.actual_qty>0);let v=new frappe.ui.Dialog({title:`${s} ${r}`,fields:[{fieldtype:"HTML",fieldname:"warehouse_table_html",options:f(b)}],primary_action_label:__("Ok"),primary_action:function(){v.hide()}});v.show(),$(v.$wrapper).css({"max-height":"80vh","overflow-y":"auto"}),$(v.fields_dict.warehouse_table_html.$wrapper).css({"max-height":"60vh","overflow-y":"auto"})}).catch(b=>{console.error("Error fetching warehouse data:",b)});function f(b){let v='<table class="table table-bordered">';return v+="<thead><tr>",v+="<th>Name</th>",v+="<th>Quantity</th>",v+="</tr></thead>",v+="<tbody>",b.forEach(w=>{v+="<tr>",v+=`<td>${w.name}</td>`,v+=`<td>${w.actual_qty}</td>`,v+="</tr>"}),v+="</tbody>",v+="</table>",v}}})}}],primary_action_label:__("Ok"),primary_action:function(){let l=parseFloat(c.wrapper.find('input[data-fieldname="quantity"]').val()),m=c.wrapper.find('select[data-fieldname="uom"]').val(),y=parseFloat(c.wrapper.find('input[data-fieldname="total_amount"]').val());if(!l||l<=0){frappe.msgprint(__("Please enter a valid quantity."));return}if(!e.selectedItem){frappe.msgprint(__("No item selected."));return}if(l>n){frappe.msgprint(__("Entered Quantity Exceeded"));return}frappe.call({method:"custom_app.customapp.page.packing_list.packing_list.get_item_uom_conversion",args:{item_code:s,uom_code:m},callback:function(f){if(f.message){let b=f.message;if(l*b>n){frappe.msgprint(__("Entered Quantity Exceeded"));return}e.selectedItem.find(".item-uom").text(m);let w=unescape(e.selectedItem.attr("data-item-code")),S=unescape(e.selectedItem.attr("data-batch-no")),k=unescape(e.selectedItem.attr("data-serial-no"));e.events.item_selected({field:"qty",value:"+"+l,item:{item_code:w,batch_no:S,serial_no:k,uom:m,quantity:l,rate:y}}),e.search_field.set_focus(),c.hide()}else frappe.msgprint(__("Failed to fetch UOM conversion factor."))}})}});c.on_page_show=function(){setTimeout(()=>{let l=c.wrapper.find('input[data-fieldname="quantity"]');l.focus(),l.select()},300)},c.show(),c.wrapper.find('select[data-fieldname="uom"]').val(p),c.wrapper.find('input[data-fieldname="total_amount"]').val(h.toFixed(2)),c.wrapper.find('input[data-fieldname="quantity"]').on("input",function(){let l=parseFloat($(this).val()),m=c.wrapper.find('select[data-fieldname="uom"]').val(),y=g[m];if(isNaN(l))c.wrapper.find('input[data-fieldname="total_amount"]').val(y.toFixed(2));else{let f=(l*y).toFixed(2);c.wrapper.find('input[data-fieldname="total_amount"]').val(f)}}),c.wrapper.find('select[data-fieldname="uom"]').on("change",function(){let l=$(this).val(),m=g[l],y=parseFloat(c.wrapper.find('input[data-fieldname="quantity"]').val());if(isNaN(y))c.wrapper.find('input[data-fieldname="total_amount"]').val(m.toFixed(2));else{let f=(y*m).toFixed(2);c.wrapper.find('input[data-fieldname="total_amount"]').val(f)}}),c.wrapper.find('input[data-fieldname="quantity"]').on("keypress",function(l){l.which===13&&(l.preventDefault(),c.primary_action())})}}})}),this.search_field.$input.on("input",i=>{clearTimeout(this.last_search),this.last_search=setTimeout(()=>{let s=i.target.value;this.filter_items({search_term:s})},300),this.$clear_search_btn.toggle(Boolean(this.search_field.$input.val()))}),this.search_field.$input.on("focus",()=>{this.$clear_search_btn.toggle(Boolean(this.search_field.$input.val()))}),this.$component.on("keydown",i=>{let s=i.which||i.keyCode,o=i.ctrlKey;switch(s){case 38:i.preventDefault(),this.navigate_up();break;case 40:i.preventDefault(),this.navigate_down();break;case 9:i.preventDefault(),this.navigate_down(),this.focus_next_field();break;case 13:if(o)break;i.preventDefault(),this.select_highlighted_item();break}})}attach_shortcuts(){let e=frappe.utils.is_mac()?"\u2318":"Ctrl";this.search_field.parent.attr("title",`${e}+S`),frappe.ui.keys.add_shortcut({shortcut:"ctrl+s",action:()=>this.search_field.set_focus(),condition:()=>this.$component.is(":visible"),description:__("Focus on search input"),ignore_inputs:!0,page:cur_page.page.page}),this.item_group_field.parent.attr("title",`${e}+G`),frappe.ui.keys.add_shortcut({shortcut:"ctrl+g",action:()=>this.item_group_field.set_focus(),condition:()=>this.$component.is(":visible"),description:__("Focus on Item Group filter"),ignore_inputs:!0,page:cur_page.page.page}),document.addEventListener("keydown",t=>{if(t.key==="Enter"&&t.ctrlKey)return t.preventDefault(),console.log("Ctrl + Enter pressed for checkout"),!1}),frappe.ui.keys.on("enter",t=>{if(t.ctrlKey)return;let i=this.$component.is(":visible"),s=document.querySelector(".modal.show");if(!(!i||this.search_field.get_value()==="")&&(this.items.length==0&&this.barcode_scanned&&(frappe.show_alert({message:__("No items found. Scan barcode again."),indicator:"orange"}),frappe.utils.play_sound("error"),this.barcode_scanned=!1,this.set_search_value("")),s&&document.activeElement.tagName==="SELECT")){this.selectedItem.find(".item-uom").text(dialog.wrapper.find('select[data-fieldname="uom"]').val());let o=unescape(this.selectedItem.attr("data-item-code")),a=unescape(this.selectedItem.attr("data-batch-no")),r=unescape(this.selectedItem.attr("data-serial-no"));this.events.item_selected({field:"qty",value:quantity,item:{item_code:o,batch_no:a,serial_no:r,uom:selectedUOM,quantity,rate}}),this.search_field.set_focus()}})}navigate_up(){this.highlighted_row_index>-1&&(this.highlighted_row_index--,this.highlight_row(this.highlighted_row_index))}navigate_down(){this.highlighted_row_index<this.items.length-1&&(this.highlighted_row_index++,this.highlight_row(this.highlighted_row_index))}highlight_row(e){if(e===-1){this.$items_container.find(".item-wrapper").removeClass("highlight");return}this.$items_container.find(".item-wrapper").removeClass("highlight"),e>=0&&e<this.items.length&&this.$items_container.find(".item-wrapper").eq(e).addClass("highlight")}select_highlighted_item(){if(this.isClicking)return;if(this.highlighted_row_index===-1){frappe.msgprint({title:__("No Item Highlighted"),indicator:"orange",message:__("Please select an item to highlight before proceeding.")});return}this.isClicking=!0;let e=this.$items_container.find(".item-wrapper").eq(this.highlighted_row_index);e.length&&e.click(),setTimeout(()=>{this.isClicking=!1},1e3)}filter_items({search_term:e="",uom:t=""}={}){if(e&&(e=e.toLowerCase(),this.search_index=this.search_index||{},this.search_index[e])){let i=this.search_index[e];this.items=i,t&&(this.items=this.items.filter(s=>s.uom===t)),this.render_item_list(this.items),this.auto_add_item&&this.items.length==1&&this.add_filtered_item_to_cart();return}this.get_items({search_term:e}).then(({message:i})=>{let{items:s,serial_no:o,batch_no:a,barcode:r}=i;e&&!r&&(this.search_index[e]=s),t&&(s=s.filter(n=>n.uom===t)),this.items=s,this.render_item_list(s),this.auto_add_item&&this.items.length==1&&this.add_filtered_item_to_cart()})}add_filtered_item_to_cart(){this.$items_container.find(".item-wrapper").click(),this.set_search_value("")}resize_selector(e){e?this.$component.css({opacity:"0","pointer-events":"none","grid-column":"span 1 / span 1","grid-template-columns":"repeat(13, minmax(0, 1fr))"}):(this.$component.css({opacity:"1","pointer-events":"auto","grid-column":"span 4 / span 4"}),this.$component.find(".filter-section").css("grid-template-columns","repeat(12, minmax(0, 1fr))"),this.$component.find(".search-field").css("margin","0px var(--margin-sm)"),this.$items_container.css("grid-template-columns","repeat(4, minmax(0, 1fr))"))}toggle_component(e){this.set_search_value(""),this.$component.css("display",e?"flex":"none")}};custom_app.PointOfSale.ItemCart=class{constructor({wrapper:e,events:t,settings:i}){this.wrapper=e,this.events=t,this.customer_info=void 0,this.hide_images=i.hide_images,this.allowed_customer_groups=i.customer_groups,this.allowed_doctor_groups=i.doctor_groups,this.allow_rate_change=i.allow_rate_change,this.allow_discount_change=i.allow_discount_change,this.init_component()}init_component(){this.prepare_dom(),this.init_child_components(),this.bind_events(),this.attach_shortcuts()}prepare_dom(){this.wrapper.append('<section class="customer-cart-container" style="grid-column: span 6/ span 6; margin-top: 0rem;""></section>'),this.$component=this.wrapper.find(".customer-cart-container")}init_child_components(){this.init_customer_selector(),this.init_doctor_selector(),this.init_cart_components()}init_customer_selector(){this.$component.append('<div class="customer-section"></div>'),this.$customer_section=this.$component.find(".customer-section"),this.make_customer_selector()}init_doctor_selector(){this.$component.append(`<div class="doctor-section" style="display: flex;
		flex-direction: column;
		padding: var(--padding-md) var(--padding-lg);
		overflow: visible; background-color: var(--fg-color);
		box-shadow: var(--shadow-base);
		border-radius: var(--border-radius-md);
	  }; margin-top: 1em;"></div>`),this.$doctor_section=this.$component.find(".doctor-section"),this.make_doctor_selector()}reset_customer_selector(){this.events.get_frm().set_value("customer",""),this.make_customer_selector(),this.customer_field.set_focus()}reset_doctor_selector(){this.events.get_frm().set_value("doctor",""),this.make_doctor_selector(),this.doctor_field.set_focus()}init_cart_components(){this.$component.append(`<div class="cart-container">
				<div class="abs-cart-container">
					<div class="cart-label" >${__("Item Cart")}</div>
					<div class="cart-header">
						<div class="name-header">${__("Item")}</div>

						<div class="qty-header">${__("Vat Type")}</div>
						<div class="qty-header">${__("Price")}</div>
						<div class="qty-header" >${__("Disc %")}</div>

						<div class="qty-header">${__("Quantity")}</div>
						
						<div class="rate-amount-header">${__("Amount")}</div>
					</div>
					<div class="cart-items-section"></div>
					<div class="cart-totals-section"></div>
					<div class="numpad-section"></div>
				</div>
			</div>`),this.$cart_container=this.$component.find(".cart-container"),this.make_cart_totals_section(),this.make_cart_items_section(),this.make_cart_numpad()}make_cart_items_section(){this.$cart_header=this.$component.find(".cart-header"),this.$cart_items_wrapper=this.$component.find(".cart-items-section"),this.make_no_items_placeholder()}make_no_items_placeholder(){this.$cart_header.css("display","none"),this.$cart_items_wrapper.html(`<div class="no-item-wrapper">${__("No items in cart")}</div>`)}get_discount_icon(){return`<svg class="discount-icon" width="24" height="24" viewBox="0 0 24 24" stroke="currentColor" fill="none" xmlns="http://www.w3.org/2000/svg">
				<path d="M19 15.6213C19 15.2235 19.158 14.842 19.4393 14.5607L20.9393 13.0607C21.5251 12.4749 21.5251 11.5251 20.9393 10.9393L19.4393 9.43934C19.158 9.15804 19 8.7765 19 8.37868V6.5C19 5.67157 18.3284 5 17.5 5H15.6213C15.2235 5 14.842 4.84196 14.5607 4.56066L13.0607 3.06066C12.4749 2.47487 11.5251 2.47487 10.9393 3.06066L9.43934 4.56066C9.15804 4.84196 8.7765 5 8.37868 5H6.5C5.67157 5 5 5.67157 5 6.5V8.37868C5 8.7765 4.84196 9.15804 4.56066 9.43934L3.06066 10.9393C2.47487 11.5251 2.47487 12.4749 3.06066 13.0607L4.56066 14.5607C4.84196 14.842 5 15.2235 5 15.6213V17.5C5 18.3284 5.67157 19 6.5 19H8.37868C8.7765 19 9.15804 19.158 9.43934 19.4393L10.9393 20.9393C11.5251 21.5251 12.4749 21.5251 13.0607 20.9393L14.5607 19.4393C14.842 19.158 15.2235 19 15.6213 19H17.5C18.3284 19 19 18.3284 19 17.5V15.6213Z" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
				<path d="M15 9L9 15" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
				<path d="M10.5 9.5C10.5 10.0523 10.0523 10.5 9.5 10.5C8.94772 10.5 8.5 10.0523 8.5 9.5C8.5 8.94772 8.94772 8.5 9.5 8.5C10.0523 8.5 10.5 8.94772 10.5 9.5Z" fill="white" stroke-linecap="round" stroke-linejoin="round"/>
				<path d="M15.5 14.5C15.5 15.0523 15.0523 15.5 14.5 15.5C13.9477 15.5 13.5 15.0523 13.5 14.5C13.5 13.9477 13.9477 13.5 14.5 13.5C15.0523 13.5 15.5 13.9477 15.5 14.5Z" fill="white" stroke-linecap="round" stroke-linejoin="round"/>
			</svg>`}make_cart_totals_section(){this.$totals_section=this.$component.find(".cart-totals-section"),this.$totals_section.append(`
			<div class="item-qty-total-container">
				<div class="item-qty-total-label">${__("Total Items")}</div>
				<div class="item-qty-total-value">0.00</div>
			</div>
			<div class="vatable-sales-container"></div>
			<div class="vat-exempt-container"></div>
			<div class="zero-rated-container"></div>
			
			
			<div class="ex-total-container"></div>
				<div class="net-total-container" style="line-height: 0rem; font-size:12px;">
				<div class="net-total-label">${__("Sub Total:")}</div>
				<div class="net-total-value" style="font-size:12px;">0.00</div>
			</div>

		 <div class="taxes-container"></div>
		 <div class="vat-container"></div>
		<div class="total-vat-container"></div>
			<div class="grand-total-container" style="line-height: 0rem;">
				<div>${__("Total")}</div>
				<div>0.00</div>
			</div> 

			<div class="checkout-btn">${__("Order")}</div>
			<div class="edit-cart-btn">${__("Edit Cart")}</div>`),this.$add_discount_elem=this.$component.find(".add-discount-wrapper")}make_cart_numpad(){this.$numpad_section=this.$component.find(".numpad-section"),this.number_pad=new custom_app.PointOfSale.NumberPad({wrapper:this.$numpad_section,events:{numpad_event:this.on_numpad_event.bind(this)},cols:5,keys:[["Discount","Quantity","","Remove"]],css_classes:[["","","","col-span-2 remove-btn"],["","","","col-span-2"],["","","","col-span-2"]],fieldnames_map:{Quantity:"qty",Discount:"discount_percentage"}}),this.$numpad_section.prepend(`<div class="numpad-totals">
			<span class="numpad-item-qty-total"></span>
				<span class="numpad-net-total"></span>
				<span class="numpad-grand-total"></span>
			</div>`),this.$numpad_section.append(`<div class="numpad-btn checkout-btn" data-button-value="checkout">${__("Checkout")}</div>`)}bind_events(){let e=this;this.$customer_section.on("click",".reset-customer-btn",function(){e.reset_customer_selector()}),this.$customer_section.on("click",".close-details-btn",function(){e.toggle_customer_info(!1)}),this.$customer_section.on("click",".customer-display",function(t){if($(t.target).closest(".reset-customer-btn").length)return;let i=e.$cart_container.is(":visible");e.toggle_customer_info(i)}),this.$doctor_section.on("click",".reset-doctor-btn",function(){e.reset_doctor_selector()}),this.$doctor_section.on("click",".close-details-btn",function(){e.toggle_doctor_info(!1)}),this.$doctor_section.on("click",".doctor-display",function(t){if($(t.target).closest(".reset-doctor-btn").length)return;let i=e.$cart_container.is(":visible");e.toggle_doctor_info(i)}),this.$cart_items_wrapper.on("click",".cart-item-wrapper",function(){let t=$(this);if(e.toggle_item_highlight(this),!!e.$totals_section.find(".edit-cart-btn").is(":visible")){e.$totals_section.find(".edit-cart-btn").click();return}let s=unescape(t.attr("data-row-name"));e.events.cart_item_clicked({name:s}),this.numpad_value=""}),this.$component.on("click",".checkout-btn",async function(){$(this).attr("style").indexOf("--blue-500")!=-1&&(await e.events.checkout(),e.toggle_checkout_btn(!1),e.allow_discount_change&&e.$add_discount_elem.removeClass("d-none"))}),this.$totals_section.on("click",".edit-cart-btn",()=>{this.passwordDialog&&(this.passwordDialog.$wrapper.remove(),delete this.passwordDialog),this.passwordDialog=new frappe.ui.Dialog({title:__("Enter OIC Password"),fields:[{fieldtype:"HTML",fieldname:"password_html",options:`
							<div class="form-group">
								<label for="password_field">${__("Password")}</label>
								<input type="password" id="password_field" class="form-control" required>
							</div>
						`}],primary_action_label:__("Ok"),primary_action:()=>{let t=document.getElementById("password_field").value;frappe.call({method:"custom_app.customapp.page.packing_list.packing_list.confirm_user_password",args:{password:t},callback:i=>{i.message&&i.message.name?(this.events.edit_cart(),this.toggle_checkout_btn(!0),this.passwordDialog.hide()):frappe.show_alert({message:__("Incorrect password or user is not an OIC"),indicator:"red"})}})}}),this.passwordDialog.show(),this.passwordDialog.$wrapper.on("shown.bs.modal",function(){setTimeout(()=>{document.getElementById("password_field").focus()},100)})}),this.$component.on("click",".add-discount-wrapper",()=>{if(this.is_oic_authenticated){let t=this.$add_discount_elem.find(".edit-discount-btn").length;(!this.discount_field||t)&&this.show_discount_control()}else{let t=new frappe.ui.Dialog({title:__("Enter OIC Password"),fields:[{fieldname:"password",fieldtype:"Password",label:__("Password"),reqd:1}],primary_action_label:__("Add Discount"),primary_action:i=>{let s=i.password,o="oic";frappe.call({method:"custom_app.customapp.page.amesco_point_of_sale.amesco_point_of_sale.confirm_user_password",args:{password:s,role:o},callback:a=>{a.message?(this.is_oic_authenticated=!0,this.show_discount_control(),t.hide()):frappe.show_alert({message:__("Incorrect password or user is not an OIC"),indicator:"red"})}})}});t.show()}}),this.$add_discount_elem.find(".edit-discount-btn").on("click",()=>{this.is_oic_authenticated=!1,this.$component.trigger("click",".add-discount-wrapper")}),frappe.ui.form.on("POS Invoice","paid_amount",t=>{this.update_totals_section(t)})}attach_shortcuts(){document.addEventListener("keydown",function(t){let i={116:!0,"Ctrl+82":!0,"Ctrl+16+82":!0,"Ctrl+83":!0,"Ctrl+80":!0,"Ctrl+87":!0,"Ctrl+Shift+73":!0,"Ctrl+74":!0,"Ctrl+69":!0},s=(t.ctrlKey?"Ctrl+":"")+(t.shiftKey?"Shift+":"")+(t.altKey?"Alt+":"")+t.keyCode;(i[s]||i[t.keyCode])&&t.preventDefault()});for(let t of this.number_pad.keys)for(let i of t){if(typeof i!="string")continue;let s=`ctrl+${frappe.scrub(String(i))[0]}`;i==="Delete"&&(s="ctrl+backspace"),i==="Remove"&&(s="ctrl+x"),i==="Quantity"&&(s="ctrl+q"),i==="Rate"&&(s="ctrl+a"),i==="."&&(s="ctrl+>");let o=this.number_pad.fieldnames[i]?this.number_pad.fieldnames[i]:typeof i=="string"?frappe.scrub(i):i,a=s.split("+").map(frappe.utils.to_title_case).join("+");a=frappe.utils.is_mac()?a.replace("Ctrl","\u2318"):a,this.$numpad_section.find(`.numpad-btn[data-button-value="${o}"]`).attr("title",a),frappe.ui.keys.on(`${s}`,()=>{this.$component.is(":visible")&&this.item_is_selected&&this.$numpad_section.is(":visible")&&this.$numpad_section.find(`.numpad-btn[data-button-value="${o}"]`).click()})}let e=frappe.utils.is_mac()?"\u2318":"Ctrl";this.$component.find(".checkout-btn").attr("title",`${e}+Enter`),frappe.ui.keys.add_shortcut({shortcut:"ctrl+enter",action:()=>this.$component.find(".checkout-btn").click(),condition:()=>this.$component.is(":visible")&&!this.$totals_section.find(".edit-cart-btn").is(":visible"),description:__("Checkout Order / Submit Order / New Order"),ignore_inputs:!0,page:cur_page.page.page}),this.$component.find(".edit-cart-btn").attr("title",`${e}+E`),frappe.ui.keys.on("ctrl+e",()=>{let t=this.$component.is(":visible"),i=!this.$totals_section.find(".checkout-btn").is("visible");t&&i&&this.$component.find(".edit-cart-btn").click()}),this.$component.find(".add-discount-wrapper").attr("title",`${e}+D`),frappe.ui.keys.add_shortcut({shortcut:"ctrl+d",action:()=>this.$component.find(".add-discount-wrapper").click(),condition:()=>this.$add_discount_elem.is(":visible"),description:__("Add Order Discount"),ignore_inputs:!0,page:cur_page.page.page}),frappe.ui.keys.on("escape",()=>{this.$component.is(":visible")&&this.discount_field&&this.discount_field.parent.is(":visible")&&this.discount_field.set_value(0)}),this.doctor_field.parent.attr("title",`${e}+R`),frappe.ui.keys.add_shortcut({shortcut:"ctrl+r",action:()=>this.doctor_field.set_focus(),condition:()=>this.$component.is(":visible"),description:__("Doctor"),ignore_inputs:!0,page:cur_page.page.page}),this.customer_field.parent.attr("title",`${e}+M`),frappe.ui.keys.add_shortcut({shortcut:"ctrl+m",action:()=>this.customer_field.set_focus(),condition:()=>this.$component.is(":visible"),description:__("Customer"),ignore_inputs:!0,page:cur_page.page.page}),frappe.ui.keys.add_shortcut({shortcut:"ctrl+<",action:()=>{this.reset_customer_selector()},condition:()=>!0,description:__("Reset Customer Selector"),ignore_inputs:!0,page:cur_page.page.page})}toggle_item_highlight(e){let t=$(e),i=t.attr("style")=="background-color:var(--gray-50);";!e||i?(this.item_is_selected=!1,this.$cart_container.find(".cart-item-wrapper").css("background-color","")):(t.css("background-color","var(--control-bg)"),this.item_is_selected=!0,this.$cart_container.find(".cart-item-wrapper").not(e).css("background-color",""))}make_customer_selector(){this.$customer_section.html(`
			<div class="customer-field"></div>
		`);let e=this,t=this.allowed_customer_groups||[],i={};t.length&&(i={customer_group:["in",t]}),this.customer_field=frappe.ui.form.make_control({df:{label:__("Customer"),fieldtype:"Link",options:"Customer",placeholder:__("Search by customer name, phone, email."),get_query:function(){return{filters:i}},onchange:function(){if(this.value){let s=e.events.get_frm();frappe.dom.freeze(),frappe.model.set_value(s.doc.doctype,s.doc.name,"customer",this.value),s.script_manager.trigger("customer",s.doc.doctype,s.doc.name).then(()=>{frappe.run_serially([()=>e.fetch_customer_details(this.value),()=>e.events.customer_details_updated(e.customer_info),()=>e.update_customer_section(),()=>frappe.dom.unfreeze()])})}}},parent:this.$customer_section.find(".customer-field"),render_input:!0}),this.customer_field.toggle_label(!1)}make_doctor_selector(){this.$doctor_section.html(`

			<div class="doctor-field" tabindex="0"></div>

		`);let e=this,t=this.allowed_doctor_groups||[],i={};t.length&&(i={doctor_group:["in",t]}),this.doctor_field=frappe.ui.form.make_control({df:{label:__("Doctor"),fieldtype:"Link",options:"Doctor",placeholder:__("Doctor"),onchange:function(){if(this.value){let s=e.events.get_frm();frappe.dom.freeze(),frappe.model.set_value(s.doc.doctype,s.doc.name,"custom_doctors_information",this.value),s.script_manager.trigger("custom_doctors_information",s.doc.doctype,s.doc.name).then(()=>{frappe.run_serially([()=>frappe.dom.unfreeze()])})}}},parent:this.$doctor_section.find(".doctor-field"),render_input:!0}),this.doctor_field.toggle_label(!1)}fetch_customer_details(e){return e?new Promise(t=>{frappe.db.get_value("Customer",e,["email_id","customer_name","mobile_no","image","loyalty_program","custom_osca_id","custom_pwd_id","customer_group"]).then(({message:i})=>{let{loyalty_program:s}=i;s?frappe.call({method:"erpnext.accounts.doctype.loyalty_program.loyalty_program.get_loyalty_program_details_with_points",args:{customer:e,loyalty_program:s,silent:!0},callback:o=>{let{loyalty_points:a,conversion_factor:r}=o.message;o.exc||(this.customer_info=N(A({},i),{customer:e,loyalty_points:a,conversion_factor:r}),t())}}):(this.customer_info=N(A({},i),{customer:e}),t())})}):new Promise(t=>{this.customer_info={},t()})}fetch_doctor_details(e){return e?new Promise(t=>{frappe.db.get_value("Doctor",e,["first_name","last_name","prc_number","image"]).then(({message:i})=>{this.doctor_info=N(A({},i),{doctor:e}),console.log(this.doctor_info),t()})}):new Promise(t=>{this.doctor_info={},t()})}show_discount_control(){this.$add_discount_elem.css({padding:"0px",border:"none"}),this.$add_discount_elem.html('<div class="add-discount-field"></div>');let e=this,t=e.events.get_frm(),i=t.doc.additional_discount_percentage;this.discount_field=frappe.ui.form.make_control({df:{label:__("Discount"),fieldtype:"Data",placeholder:i?i+"%":__("Enter discount percentage."),input_class:"input-xs",onchange:function(){flt(this.value)!=0?(frappe.model.set_value(t.doc.doctype,t.doc.name,"additional_discount_percentage",flt(this.value)),e.hide_discount_control(this.value)):(frappe.model.set_value(t.doc.doctype,t.doc.name,"additional_discount_percentage",0),e.$add_discount_elem.css({border:"1px dashed var(--gray-500)",padding:"var(--padding-sm) var(--padding-md)"}),e.$add_discount_elem.html(`${e.get_discount_icon()} ${__("Add Discount")}`),e.discount_field=void 0)}},parent:this.$add_discount_elem.find(".add-discount-field"),render_input:!0}),this.discount_field.toggle_label(!1),this.discount_field.set_focus()}hide_discount_control(e){e?(this.$add_discount_elem.css({border:"1px dashed var(--dark-green-500)",padding:"var(--padding-sm) var(--padding-md)"}),this.$add_discount_elem.html(`<div class="edit-discount-btn">
					${this.get_discount_icon()} ${__("Additional")}&nbsp;${String(e).bold()}% ${__("discount applied")}
				</div>`)):(this.$add_discount_elem.css({padding:"0px",border:"none"}),this.$add_discount_elem.html('<div class="add-discount-field"></div>'))}update_customer_section(){let e=this,{customer:t,email_id:i="",mobile_no:s="",image:o,customer_name:a="",customer_group:r=""}=this.customer_info||{};t?this.$customer_section.html(`<div class="customer-details">
					<div class="customer-display">
						${this.get_customer_image()}
						<div class="customer-name-desc">
							<div class="customer-name"> ${a} -  ${r} </div>
							${n()}
						</div>
					</div>
				</div>`):this.reset_customer_selector();function n(){return!i&&!s?`<div class="customer-desc">${__("Click to add email / phone")}</div>`:i&&!s?`<div class="customer-desc">${i}</div>`:s&&!i?`<div class="customer-desc">${s}</div>`:`<div class="customer-desc">${i} - ${s}</div>`}}update_doctor_section(){let e=this,{doctor:t,first_name:i="",last_name:s="",prc_number:o="",image:a}=this.doctor_info||{};t?this.$doctor_section.html(`<div class="doctor-details">
					<div class="doctor-display">
						${this.get_doctor_image()}
						<div class="doctor-name-desc">
							<div class="doctor-name">${t}</div>
							${r()}
						</div>
						<div class="reset-doctors-btn" data-doctors="${escape(doctors)}">
							<svg width="32" height="32" viewBox="0 0 14 14" fill="none">
								<path d="M4.93764 4.93759L7.00003 6.99998M9.06243 9.06238L7.00003 6.99998M7.00003 6.99998L4.93764 9.06238L9.06243 4.93759" stroke="#8D99A6"/>
							</svg>
						</div>
					</div>
				</div>`):this.reset_doctor_selector();function r(){return!email_id&&!mobile_no?`<div class="doctor-desc">${__("Click to add email / phone")}</div>`:email_id&&!mobile_no?`<div class="doctor-desc">${email_id}</div>`:mobile_no&&!email_id?`<div class="doctor-desc">${mobile_no}</div>`:`<div class="doctorvv-desc">${email_id} - ${mobile_no}</div>`}}get_customer_image(){let{customer:e,image:t}=this.customer_info||{};return t?`<div class="customer-image"><img src="${t}" alt="${t}""></div>`:`<div class="customer-image customer-abbr">${frappe.get_abbr(e)}</div>`}get_doctor_image(){let{doctor:e,image:t}=this.doctor_info||{};return t?`<div class="doctor-image"><img src="${t}" alt="${t}""></div>`:`<div class="doctor-image doctor-abbr">${frappe.get_abbr(e)}</div>`}update_totals_section(e){e||(e=this.events.get_frm()),this.render_vatable_sales(e.doc.custom_vatable_sales),this.render_vat_exempt_sales(e.doc.custom_vat_exempt_sales),this.render_zero_rated_sales(e.doc.custom_zero_rated_sales),this.render_net_total(e.doc.net_total),this.render_total_item_qty(e.doc.items);let t=cint(frappe.sys_defaults.disable_rounded_total)?e.doc.grand_total:e.doc.rounded_total;this.render_grand_total(t),this.render_total_vat(e.doc.total_taxes_and_charges)}render_net_total(e){let t=this.events.get_frm().doc.currency;this.$totals_section.find(".net-total-container").html(`<div style="font-size:12px;">${__("Sub Total")}</div> <div>${format_currency(e,t)}</div>`),this.$numpad_section.find(".numpad-net-total").html(`<div>${__("Sub Total")}: <span>${format_currency(e,t)}</span></div>`)}render_vatable_sales(e){let t=this.events.get_frm().doc.currency;this.$totals_section.find(".vatable-sales-container").html(`
				<div style="display: flex; align-items: center; width: 100%; font-size:12px;">
					<span style="flex: 1;">
						${__("VATable Sales")}: 
					</span>
					<span style="flex-shrink: 0;  ">${format_currency(e,t)}</span>
					</span>
				</div>
			`)}render_vat_exempt_sales(e){let t=this.events.get_frm().doc.currency;this.$totals_section.find(".vat-exempt-container").html(`
				<div style="display: flex; align-items: center; width: 100%; font-size:12px;">
					<span style="flex: 1;">
						${__("VAT-Exempt Sales")}: 
					</span>
					<span style="flex-shrink: 0;">${format_currency(e,t)}</span>
				</div>
			`)}render_zero_rated_sales(e){let t=this.events.get_frm().doc.currency;this.$totals_section.find(".zero-rated-container").html(`
				<div style="display: flex; align-items: center; width: 100%; font-size:12px;">
					<span style="flex: 1;">
						${__("Zero Rated Sales")}: 
					</span>
					<span style="flex-shrink: 0;">${format_currency(e,t)}</span>
				</div>
			`)}render_vat(e){let t=this.events.get_frm().doc.currency;this.$totals_section.find(".vat-container").html(`
				<div style="display: flex; align-items: center; width: 100%; font-size:12px;">
					<span style="flex: 1;">
						${__("VAT 12%")}:
					</span>
					<span style="flex-shrink: 0;">${format_currency(e,t)}</span>
				</div>
			`)}render_total_vat(e){let t=this.events.get_frm().doc.currency;this.$totals_section.find(".total-vat-container").html(`
				<div style="display: flex; justify-content: space-between; font-size:12px;">
					<span style="flex: 1;">${__("Total VAT")}: </span>
					<span style="flex-shrink: 0;">${format_currency(e,t)}</span>
				</div>
			`)}render_ex_total(e){let t=this.events.get_frm().doc.currency;this.$totals_section.find(".ex-total-container").html(`
				<div style="display: flex; align-items: center; width: 100%; font-size:10px;>
					<span style="flex: 1;">
						${__("Ex Total")}: 
					</span>
					<span style="flex-shrink: 0;">${format_currency(e,t)}</span>
				</div>
			`)}render_total_item_qty(e){var t=0;e.map(i=>{t=t+i.qty}),this.$totals_section.find(".item-qty-total-container").html(`<div>${__("Total Quantity")}</div><div>${t}</div>`),this.$numpad_section.find(".numpad-item-qty-total").html(`<div>${__("Total Quantity")}: <span>${t}</span></div>`)}render_grand_total(e){let t=this.events.get_frm().doc.currency;this.$totals_section.find(".grand-total-container").html(`<div style="font-size:14px;">${__("Total")}</div><div>${format_currency(e,t)}</div>`),this.$numpad_section.find(".numpad-grand-total").html(`<div>${__("Total")}: <span>${format_currency(e,t)}</span></div>`)}render_taxes(e){if(e&&e.length){let t=this.events.get_frm().doc.currency,i=e.map(s=>s.tax_amount_after_discount_amount==0?void 0:`<div class="tax-row">
					<div class="tax-label">${/[0-9]+/.test(s.description)?s.description:s.rate!=0?`${s.description} @ ${s.rate}%`:s.description}</div>
					<div class="tax-value">${format_currency(s.tax_amount_after_discount_amount,t)}</div>
				</div>`).join("");this.$totals_section.find(".taxes-container").css("display","flex").html(i)}else this.$totals_section.find(".taxes-container").css("display","none").html("")}get_cart_item({name:e}){let t=`.cart-item-wrapper[data-row-name="${escape(e)}"]`;return this.$cart_items_wrapper.find(t)}get_item_from_frm(e){return this.events.get_frm().doc.items.find(i=>i.name==e.name)}update_item_html(e,t){let i=this.get_cart_item(e),s=JSON.parse(localStorage.getItem("posCartItems"))||[];if(t)i&&(i.next().remove(),i.remove(),s=s.filter(a=>a.item_code!==e.item_code),localStorage.setItem("posCartItems",JSON.stringify(s)),this.remove_customer(),this.set_cash_customer(),frappe.run_serially([()=>frappe.dom.unfreeze()]));else{let a=this.get_item_from_frm(e);this.render_cart_item(a,i);let r=s.findIndex(n=>n.item_code===e.item_code);r>-1?s[r]=e:s.push(e),localStorage.setItem("posCartItems",JSON.stringify(s))}let o=this.$cart_items_wrapper.find(".cart-item-wrapper").length;this.highlight_checkout_btn(o>0),this.update_empty_cart_section(o)}remove_customer(){let e=this.events.get_frm(),t=e.doc.customer;frappe.model.set_value(e.doc.doctype,e.doc.name,"custom_customer_2",t),frappe.model.set_value(e.doc.doctype,e.doc.name,"customer",""),this.update_customer_section()}set_cash_customer(){let e=this.events.get_frm(),t=e.doc.custom_customer_2;frappe.model.set_value(e.doc.doctype,e.doc.name,"customer",t),this.update_customer_section()}render_cart_item(e,t){let i=this.events.get_frm().doc.currency,s=this,o=s.events.get_frm().doc.customer_group,a=.12,r=e.price_list_rate/(1+a);t.length||(this.$cart_items_wrapper.append(`<div class="cart-item-wrapper" tabindex="0" data-row-name="${escape(e.name)}" style="font-size: 12px; padding: 5px;">
					<div class="separator" style="height: 0.8px; background-color: #e0e0e0; margin: 4px 0;"></div>`),t=this.get_cart_item(e)),t.html(`${u()}
			<div class="item-name-desc" style="font-size: 10px;">
				<div class="item-name" style="font-size: 12px;">
					${e.item_name}
				</div>
				${g()}
			</div>
			
			<div class="item-vat mx-3" style="font-size: 10px;">
				<strong>${d(e)}</strong>
			</div> 
			
			<div class="item-vat mx-3" style="font-size: 10px;">
				<strong>${format_currency(e.price_list_rate,i)}</strong>
			</div>
			
			<div class="item-discount mx-3" style="font-size: 10px;">
				<strong>${Math.round(e.discount_percentage)}%</strong>
			</div>
			${_(o)}`),n();function n(){let p=Array.from(s.$cart_items_wrapper.find(".item-rate-amount"));s.$cart_header.find(".rate-amount-header").css("width",""),s.$cart_items_wrapper.find(".item-rate-amount").css("width","");let h=p.reduce((c,l)=>($(l).width()>c&&(c=$(l).width()),c),0);h+=1,h===1&&(h=""),s.$cart_header.find(".rate-amount-header").css("width",h),s.$cart_items_wrapper.find(".item-rate-amount").css("width",h)}function d(p){return p.custom_vat_exempt_amount&&p.custom_vat_exempt_amount!=0?"VAT-E":p.custom_vatable_amount&&p.custom_vatable_amount!=0?"VAT":p.custom_zero_rated_amount&&p.custom_zero_rated_amount!=0?"ZR":p.custom_free===1?"FREE":"Unknown"}function _(p){return p==="Zero Rated"?`
						<div class="item-qty-rate">
							<div class="item-qty" style="font-size:10px;"><span>${e.qty||0} ${e.uom}</span></div>
							<div class="item-rate-amount">
								<div class="item-rate" style="font-size:11px;">${format_currency(e.custom_zero_rated_amount,i)}</div>
								
							</div>
						</div>`:p==="Senior Citizen"||p==="PWD"?`
					<div class="item-qty-rate">
						<div class="item-qty" style="font-size:10px;"><span>${e.qty||0} ${e.uom}</span></div>
						<div class="item-rate-amount">
							<div class="item-rate" style="font-size:11px;">${format_currency(e.pricing_rules===`[
 "PRLE-0005330"
]`||e.pricing_rules===""?e.amount:e.custom_vatable_amount?e.custom_vatable_amount:e.custom_vat_exempt_amount,i)}</div>
						</div>
					</div>`:e.rate&&e.amount&&e.rate!==e.amount?`
						<div class="item-qty-rate">
							<div class="item-qty" style="font-size:10px;"><span>${e.qty||0} ${e.uom}</span></div>
							<div class="item-rate-amount">
								<div class="item-rate" style="font-size:11px;">${format_currency(e.amount,i)}</div>
							</div>
						</div>`:`
						<div class="item-qty-rate">
							<div class="item-qty" style="font-size:10px;"><span>${e.qty||0} ${e.uom}</span></div>
							<div class="item-rate-amount">
								<div class="item-rate" style="font-size:11px;">${format_currency(e.rate,i)}</div>
							</div>
						</div>`}function g(){if(e.description){if(e.description.indexOf("<div>")!==-1)try{e.description=$(e.description).text()}catch(p){e.description=e.description.replace(/<div>/g," ").replace(/<\/div>/g," ").replace(/ +/g," ")}return e.description=frappe.ellipsis(e.description,45),`<div class="item-desc" style="font-size:10px;">${e.description}</div>`}return""}function u(){let{image:p,item_name:h}=e;return!s.hide_images&&p?`
					<div class="item-image">
						<img
							onerror="cur_pos.cart.handle_broken_image(this)"
							src="${p}" alt="${frappe.get_abbr(h)}">
					</div>`:`<div class="item-image item-abbr">${frappe.get_abbr(h)}</div>`}this.$cart_items_wrapper.off("keydown",".cart-item-wrapper").on("keydown",".cart-item-wrapper",function(p){let h=s.$cart_items_wrapper.find(".cart-item-wrapper"),c=h.index($(this)),l=c;switch(p.which){case 13:$(this).click();break;case 38:l=c>0?c-1:h.length-1;break;case 40:l=c<h.length-1?c+1:0;break;default:return}h.eq(l).focus()}),frappe.ui.keys.add_shortcut({shortcut:"ctrl+c",action:()=>{let p=s.$cart_items_wrapper.find(".cart-item-wrapper");p.length&&p.first().focus()},condition:()=>s.$cart_items_wrapper.is(":visible"),description:__("Activate Cart Item Focus"),ignore_inputs:!0,page:cur_page.page.page})}handle_broken_image(e){let t=$(e).attr("alt");$(e).parent().replaceWith(`<div class="item-image item-abbr">${t}</div>`)}update_selector_value_in_cart_item(e,t,i){this.get_cart_item(i).attr(`data-${e}`,escape(t))}toggle_checkout_btn(e){e?(this.$totals_section.find(".checkout-btn").css("display","flex"),this.$totals_section.find(".edit-cart-btn").css("display","none")):(this.$totals_section.find(".checkout-btn").css("display","none"),this.$totals_section.find(".edit-cart-btn").css("display","flex"))}highlight_checkout_btn(e){e?(this.$add_discount_elem.css("display","flex"),this.$cart_container.find(".checkout-btn").css({"background-color":"var(--blue-500)"})):(this.$add_discount_elem.css("display","none"),this.$cart_container.find(".checkout-btn").css({"background-color":"var(--blue-200)"}))}update_empty_cart_section(e){let t=this.$cart_items_wrapper.find(".no-item-wrapper");e>0&&t&&t.remove()&&this.$cart_header.css("display","flex"),e===0&&!t.length&&this.make_no_items_placeholder()}on_numpad_event(e){let t=e.attr("data-button-value"),i=["qty","discount_percentage","rate"].includes(t),s=i?t=="rate"&&this.allow_rate_change||t=="discount_percentage"&&this.allow_discount_change||t=="qty":!0,o=this.prev_action===t,a=!this.prev_action,r=this.prev_action&&this.prev_action!=t;if(i){if(!s){let d=t=="rate"?"Rate".bold():"Discount".bold(),_=__("Editing {0} is not allowed as per POS Profile settings",[d]);frappe.show_alert({indicator:"red",message:_}),frappe.utils.play_sound("error");return}a||r?this.prev_action=t:o&&(this.prev_action=void 0),this.numpad_value=""}else if(t==="checkout"){this.prev_action=void 0,this.toggle_item_highlight(),this.events.numpad_event(void 0,t);return}else if(t==="remove"){this.prev_action=void 0,this.toggle_item_highlight(),this.events.numpad_event(void 0,t);return}else this.numpad_value=t==="delete"?this.numpad_value.slice(0,-1):this.numpad_value+t,this.numpad_value=this.numpad_value||0;if(!i&&a){frappe.show_alert({indicator:"red",message:__("Please select a field to edit from numpad")}),frappe.utils.play_sound("error");return}flt(this.numpad_value)>100&&this.prev_action==="discount_percentage"&&(frappe.show_alert({message:__("Discount cannot be greater than 100%"),indicator:"orange"}),frappe.utils.play_sound("error"),this.numpad_value=t),this.highlight_numpad_btn(e,t),this.events.numpad_event(this.numpad_value,this.prev_action)}highlight_numpad_btn(e,t){let i=e.hasClass("highlighted-numpad-btn"),s=["qty","discount_percentage","rate","done"].includes(t);i||e.addClass("highlighted-numpad-btn"),this.prev_action===t&&i&&e.removeClass("highlighted-numpad-btn"),this.prev_action&&this.prev_action!==t&&s&&$(`[data-button-value='${this.prev_action}']`).removeClass("highlighted-numpad-btn"),(!s||t==="done")&&setTimeout(()=>{e.removeClass("highlighted-numpad-btn")},200)}toggle_numpad(e){e?(this.$totals_section.css("display","none"),this.$numpad_section.css("display","flex")):(this.$totals_section.css("display","flex"),this.$numpad_section.css("display","none")),this.reset_numpad()}reset_numpad(){this.numpad_value="",this.prev_action=void 0,this.$numpad_section.find(".highlighted-numpad-btn").removeClass("highlighted-numpad-btn")}toggle_numpad_field_edit(e){["qty","discount_percentage","rate"].includes(e)&&this.$numpad_section.find(`[data-button-value="${e}"]`).click()}toggle_customer_info(e){if(e){let{customer:t}=this.customer_info||{};this.$cart_container.css("display","none"),this.$customer_section.css({height:"100%","padding-top":"0px"}),this.$customer_section.find(".customer-details").html(`<div class="header">
					<div class="label">Contact Details</div>
					<div class="close-details-btn">
						<svg width="32" height="32" viewBox="0 0 14 14" fill="none">
							<path d="M4.93764 4.93759L7.00003 6.99998M9.06243 9.06238L7.00003 6.99998M7.00003 6.99998L4.93764 9.06238L9.06243 4.93759" stroke="#8D99A6"/>
						</svg>
					</div>
				</div>
				<div class="customer-display">
					${this.get_customer_image()}
					<div class="customer-name-desc">
						<div class="customer-name">${t}</div>
						<div class="customer-desc"></div>
					</div>
				</div>
				<div class="customer-fields-container">
					<div class="email_id-field"></div>
					<div class="mobile_no-field"></div>
					<div class="custom_osca_id-field"></div>
					<div class="custom_pwd_id-field"></div>
					<div class="loyalty_program-field"></div>
					<div class="loyalty_points-field"></div>
				</div>
				<div class="transactions-label">Recent Transactions</div>`),this.$customer_section.append('<div class="customer-transactions"></div>'),this.render_customer_fields(),this.fetch_customer_transactions()}else this.$cart_container.css("display","flex"),this.$customer_section.css({height:"","padding-top":""}),this.update_customer_section()}render_customer_fields(){let e=this.$customer_section.find(".customer-fields-container"),t=[{fieldname:"email_id",label:__("Email"),fieldtype:"Data",options:"email",placeholder:__("Enter customer's email")},{fieldname:"mobile_no",label:__("Phone Number"),fieldtype:"Data",placeholder:__("Enter customer's phone number")},{fieldname:"loyalty_program",label:__("Loyalty Program"),fieldtype:"Link",options:"Loyalty Program",placeholder:__("Select Loyalty Program")},{fieldname:"loyalty_points",label:__("Loyalty Points"),fieldtype:"Data",read_only:1},{fieldname:"custom_osca_id",label:__("OSCA ID"),fieldtype:"Data",read_only:1},{fieldname:"custom_pwd_id",label:__("PWD ID"),fieldtype:"Data",read_only:1}],i=this;t.forEach(o=>{this[`customer_${o.fieldname}_field`]=frappe.ui.form.make_control({df:N(A({},o),{onchange:s}),parent:e.find(`.${o.fieldname}-field`),render_input:!0}),this[`customer_${o.fieldname}_field`].set_value(this.customer_info[o.fieldname])});function s(){let o=i.customer_info[this.df.fieldname],a=i.customer_info.customer;this.value&&o!=this.value&&this.df.fieldname!="loyalty_points"&&frappe.call({method:"custom_app.customapp.page.amesco_point_of_sale.amesco_point_of_sale.set_customer_info",args:{fieldname:this.df.fieldname,customer:a,value:this.value},callback:r=>{r.exc||(i.customer_info[this.df.fieldname]=this.value,frappe.show_alert({message:__("Customer contact updated successfully."),indicator:"green"}),frappe.utils.play_sound("submit"))}})}}fetch_customer_transactions(){frappe.db.get_list("POS Invoice",{filters:{customer:this.customer_info.customer,docstatus:1},fields:["name","grand_total","status","posting_date","posting_time","currency","custom_invoice_series"],limit:20}).then(e=>{let t=this.$customer_section.find(".customer-transactions");if(!e.length){t.html('<div class="no-transactions-placeholder">No recent transactions found</div>');return}let i=moment(e[0].posting_date+" "+e[0].posting_time).fromNow();this.$customer_section.find(".customer-desc").html(`Last transacted ${i}`),e.forEach(s=>{let o=moment(s.posting_date+" "+s.posting_time).format("Do MMMM, h:mma"),a={Paid:"green",Draft:"red",Return:"gray",Consolidated:"blue"};t.append(`<div class="invoice-wrapper" data-invoice-name="${escape(s.name)}">
						<div class="invoice-name-date">
							<div class="invoice-name">${s.custom_invoice_series}</div>
							<div class="invoice-date">${o}</div>
						</div>
						<div class="invoice-total-status">
							<div class="invoice-total">
								${format_currency(s.grand_total,s.currency,0)||0}
							</div>
							<div class="invoice-status">
								<span class="indicator-pill whitespace-nowrap ${a[s.status]}">
									<span>${s.status}</span>
								</span>
							</div>
						</div>
					</div>
					<div class="seperator"></div>`)})})}attach_refresh_field_event(e){$(e.wrapper).off("refresh-fields"),$(e.wrapper).on("refresh-fields",()=>{e.doc.items.length&&(this.$cart_items_wrapper.html(""),e.doc.items.forEach(t=>{this.update_item_html(t)})),this.update_totals_section(e)})}load_invoice(){let e=this.events.get_frm();this.attach_refresh_field_event(e),this.fetch_customer_details(e.doc.customer).then(()=>{this.events.customer_details_updated(this.customer_info),this.update_customer_section()}),this.$cart_items_wrapper.html(""),e.doc.items.length?e.doc.items.forEach(t=>{this.update_item_html(t)}):(this.make_no_items_placeholder(),this.highlight_checkout_btn(!1)),this.update_totals_section(e),e.doc.docstatus===1?(this.$totals_section.find(".checkout-btn").css("display","none"),this.$totals_section.find(".edit-cart-btn").css("display","none")):(this.$totals_section.find(".checkout-btn").css("display","flex"),this.$totals_section.find(".edit-cart-btn").css("display","none")),this.toggle_component(!0)}toggle_component(e){e?this.$component.css("display","flex"):this.$component.css("display","none")}};custom_app.PointOfSale.ItemDetails=class{constructor({wrapper:e,events:t,settings:i}){this.wrapper=e,this.events=t,this.hide_images=i.hide_images,this.allow_rate_change=i.allow_rate_change,this.allow_discount_change=i.allow_discount_change,this.current_item={},this.init_component()}init_component(){this.prepare_dom(),this.init_child_components(),this.bind_events(),this.attach_shortcuts()}prepare_dom(){this.wrapper.append('<section class="item-details-container" style="grid-column:span 3 / span 3;"></section>'),this.$component=this.wrapper.find(".item-details-container")}init_child_components(){this.$component.html(`<div class="item-details-header">
				<div class="label">${__("Item Details")}</div>
				<div class="close-btn">
					<svg width="32" height="32" viewBox="0 0 14 14" fill="none">
						<path d="M4.93764 4.93759L7.00003 6.99998M9.06243 9.06238L7.00003 6.99998M7.00003 6.99998L4.93764 9.06238L9.06243 4.93759" stroke="#8D99A6"/>
					</svg>
				</div>
			</div>
			<div class="item-display">
				<div class="item-name-desc-price">
					<div class="item-name"></div>
					<div class="item-desc"></div>
					<div class="item-price"></div>
					<div class="expiry-date"></div>
				</div>
				<div class="item-image"></div>
			</div>
			<div class="discount-section"></div>
			<div class="form-container"></div>
			<div class="serial-batch-container"></div>`),this.$item_name=this.$component.find(".item-name"),this.$item_description=this.$component.find(".item-desc"),this.$item_price=this.$component.find(".item-price"),this.$item_image=this.$component.find(".item-image"),this.$form_container=this.$component.find(".form-container"),this.$dicount_section=this.$component.find(".discount-section"),this.$serial_batch_container=this.$component.find(".serial-batch-container")}compare_with_current_item(e){return e&&e.name==this.current_item.name}async toggle_item_details_section(e){let t=!this.compare_with_current_item(e),i=!Boolean(e)||!t;(!i&&t||i)&&await this.validate_serial_batch_item(),this.events.toggle_item_selector(!i),this.toggle_component(!i),e&&t?(this.doctype=e.doctype,this.item_meta=frappe.get_meta(this.doctype),this.name=e.name,this.item_row=e,this.currency=this.events.get_frm().doc.currency,this.current_item=e,this.render_dom(e),this.render_discount_dom(e),this.render_form(e),this.events.highlight_cart_item(e)):this.current_item={}}validate_serial_batch_item(){let t=this.events.get_frm().doc.items.find(a=>a.name===this.name);if(!t)return;let i=t.has_serial_no,s=t.has_batch_no,o=!t.serial_and_batch_bundle;if(i&&o||s&&o)return frappe.show_alert({message:__("Item is removed since no serial / batch no selected."),indicator:"orange"}),frappe.utils.play_sound("cancel"),this.events.remove_item_from_cart()}render_dom(e){let{item_name:t,description:i,image:s,price_list_rate:o}=e;function a(){return i?(i=i.indexOf("...")===-1&&i.length>140?i.substr(0,139)+"...":i,i):""}this.$item_name.html(t),this.$item_description.html(a()),this.$item_price.html(format_currency(o,this.currency)),!this.hide_images&&s?this.$item_image.html(`<img
					onerror="cur_pos.item_details.handle_broken_image(this)"
					class="h-full" src="${s}"
					alt="${frappe.get_abbr(t)}"
					style="object-fit: cover;">`):this.$item_image.html(`<div class="item-abbr">${frappe.get_abbr(t)}</div>`)}handle_broken_image(e){let t=$(e).attr("alt");$(e).replaceWith(`<div class="item-abbr">${t}</div>`)}render_discount_dom(e){e.discount_percentage?(this.$dicount_section.html(`<div class="item-rate">${format_currency(e.price_list_rate,this.currency)}</div>
				<div class="item-discount">${e.discount_percentage}% off</div>`),this.$item_price.html(format_currency(e.rate,this.currency))):this.$dicount_section.html("")}render_form(e){let t=this.get_form_fields(e);this.$form_container.html(""),this.original_rate=e.rate,t.forEach((i,s)=>{this.$form_container.append(`<div class="${i}-control" data-fieldname="${i}"></div>`);let o=this.item_meta.fields.find(r=>r.fieldname===i);i==="discount_percentage"&&(o.label=__("Discount (%)"));let a=this;this[`${i}_control`]=frappe.ui.form.make_control({df:N(A({},o),{onchange:function(){i==="uom"&&a.calculate_conversion_factor(this.value,e),a.events.form_updated(a.current_item,i,this.value),a.is_oic_authenticated=!1}}),parent:this.$form_container.find(`.${i}-control`),render_input:!0}),this[`${i}_control`].set_value(e[i]),(i==="discount_percentage"||i==="discount_amount"||i==="rate")&&this.$form_container.find(`.${i}-control input`).on("focus",function(){a.is_oic_authenticated||a.oic_authentication(i,e)})}),this.make_auto_serial_selection_btn(e),this.bind_custom_control_change_event()}calculate_conversion_factor(e,t){let i=t.stock_uom,s=frappe.convert_uom(1,i,e),o=t.rate*s;this.$item_price.html(format_currency(o,this.currency))}oic_authentication(e,t){let i=this,s=i.events.get_frm(),o=new frappe.ui.Dialog({title:__("Authorization Required OIC"),fields:[{fieldname:"password",fieldtype:"Password",label:__("Password"),reqd:1}],primary_action_label:__("Authorize"),primary_action:a=>{let r=a.password;frappe.call({method:"custom_app.customapp.page.amesco_point_of_sale.amesco_point_of_sale.confirm_user_password",args:{password:r},callback:n=>{n.message?n.message.name?(frappe.show_alert({message:__("Verified"),indicator:"green"}),o.hide(),i.enable_discount_input(e),i.set_discount_log(s,t,n),i.is_oic_authenticated=!0):frappe.show_alert({message:__("Incorrect password"),indicator:"red"}):frappe.show_alert({message:__("Incorrect password or user is not an OIC"),indicator:"red"})}})}});o.show()}set_discount_log(e,t,i){let s=e.doc.custom_manual_dicsount||"",o=`${t.item_code} - ${i.message.full_name} - ${frappe.datetime.now_datetime()}
`,a=s+o;e.set_value("custom_manual_dicsount",a)}enable_discount_input(e){this.$form_container.find(`.${e}-control input`).prop("disabled",!1)}get_form_fields(e){let t=["custom_free","qty","price_list_rate","rate","uom","discount_percentage","discount_amount","custom_batch_number","custom_batch_expiry","custom_vat_amount","custom_vatable_amount","custom_vat_exempt_amount","custom_zero_rated_amount","custom_remarks"];return e.has_serial_no&&t.push("serial_no"),e.has_batch_no&&t.push("batch_no"),t}make_auto_serial_selection_btn(e){if(e.has_serial_no||e.has_batch_no){let t=e.has_serial_no?__("Select Serial No"):__("Select Batch No");this.$form_container.append(`<div class="btn btn-sm btn-secondary auto-fetch-btn">${t}</div>`),this.$form_container.find(".serial_no-control").find("textarea").css("height","6rem")}}bind_custom_control_change_event(){let e=this;if(this.rate_control){let t=e.events.get_frm();if(this.rate_control.df.onchange=null,this.rate_control.df.onchange=function(){(this.value||flt(this.value)===0)&&(this._debounce&&clearTimeout(this._debounce),this._debounce=setTimeout(()=>{e.events.form_updated(e.current_item,"rate",this.value).then(()=>{let i=frappe.get_doc(e.doctype,e.name),s=e.events.get_frm().doc;e.$item_price.html(format_currency(i.rate,s.currency)),e.render_discount_dom(i)})},200))},t.doc.customer_group==="Senior Citizen")return;this.rate_control.df.read_only=!this.allow_rate_change,this.rate_control.refresh()}if(e.events&&e.events.get_frm()&&e.events.get_frm().doc){let t=e.events.get_frm();if(t.doc.customer_group==="Senior Citizen"||t.doc.customer_group==="PWD")return;e.discount_percentage_control&&!e.allow_discount_change&&(e.discount_percentage_control.df.read_only=1,e.discount_percentage_control.refresh())}this.warehouse_control&&(this.warehouse_control.df.reqd=1,this.warehouse_control.df.onchange=function(){this.value&&e.events.form_updated(e.current_item,"warehouse",this.value).then(()=>{e.item_stock_map=e.events.get_item_stock_map();let t=e.item_stock_map[e.item_row.item_code][this.value][0],i=Boolean(e.item_stock_map[e.item_row.item_code][this.value][1]);if(t===void 0)e.events.get_available_stock(e.item_row.item_code,this.value).then(()=>{e.warehouse_control.set_value(this.value)});else if(t===0&&i){e.warehouse_control.set_value("");let s=e.item_row.item_code.bold(),o=this.value.bold();frappe.throw(__("Item Code: {0} is not available under warehouse {1}.",[s,o]))}e.actual_qty_control.set_value(t)})},this.warehouse_control.df.get_query=()=>({filters:{company:this.events.get_frm().doc.company}}),this.warehouse_control.refresh()),this.serial_no_control&&(this.serial_no_control.df.reqd=1,this.serial_no_control.df.onchange=async function(){!e.current_item.batch_no&&await e.auto_update_batch_no(),e.events.form_updated(e.current_item,"serial_no",this.value)},this.serial_no_control.refresh()),this.batch_no_control&&(this.batch_no_control.df.reqd=1,this.batch_no_control.df.get_query=()=>({query:"erpnext.controllers.queries.get_batch_no",filters:{item_code:e.item_row.item_code,warehouse:e.item_row.warehouse,posting_date:e.events.get_frm().doc.posting_date}}),this.batch_no_control.refresh()),this.uom_control&&(this.uom_control.df.onchange=function(){e.events.form_updated(e.current_item,"uom",this.value);let t=frappe.get_doc(e.doctype,e.name);e.conversion_factor_control.df.read_only=t.stock_uom==this.value,e.conversion_factor_control.refresh()}),frappe.model.on("POS Invoice Item","*",(t,i,s)=>{let o=this[`${t}_control`];this.compare_with_current_item(s)&&o&&o.get_value()!==i&&(o.set_value(i),cur_pos.update_cart_html(s))})}async auto_update_batch_no(){if(this.serial_no_control&&this.batch_no_control){let e=this.serial_no_control.get_value().split(`
`).filter(n=>n);if(!e.length)return;let i=(await frappe.db.get_list("Serial No",{filters:{name:["in",e]},fields:["batch_no","name"]})).reduce((n,d)=>(n[d.batch_no]||(n[d.batch_no]=[]),n[d.batch_no]=[...n[d.batch_no],d.name],n),{}),s=Object.keys(i)[0],o=i[s].join(`
`),a=e.length!==i[s].length;this.batch_no_control.get_value()!=s&&await this.batch_no_control.set_value(s),a&&(this.serial_no_control.set_value(o),this.qty_control.set_value(i[s].length),delete i[s],this.events.clone_new_batch_item_in_frm(i,this.current_item))}}bind_events(){this.bind_auto_serial_fetch_event(),this.bind_fields_to_numpad_fields(),this.$component.on("click",".close-btn",()=>{this.events.close_item_details()})}attach_shortcuts(){this.wrapper.find(".close-btn").attr("title","Esc"),frappe.ui.keys.on("escape",()=>{this.$component.is(":visible")&&this.events.close_item_details()})}bind_fields_to_numpad_fields(){let e=this;this.$form_container.on("click",".input-with-feedback",function(){let t=$(this).attr("data-fieldname");this.last_field_focused!=t&&(e.events.item_field_focused(t),this.last_field_focused=t)})}bind_auto_serial_fetch_event(){this.$form_container.on("click",".auto-fetch-btn",()=>{let e=this.events.get_frm(),t=this.item_row;t.type_of_transaction="Outward",new erpnext.SerialBatchPackageSelector(e,t,i=>{i&&frappe.model.set_value(t.doctype,t.name,{serial_and_batch_bundle:i.name,qty:Math.abs(i.total_qty)})})})}toggle_component(e){e?this.$component.css("display","flex"):this.$component.css("display","none")}};custom_app.PointOfSale.NumberPad=class{constructor({wrapper:e,events:t,cols:i,keys:s,css_classes:o,fieldnames_map:a}){this.wrapper=e,this.events=t,this.cols=i,this.keys=s,this.css_classes=o||[],this.fieldnames=a||{},this.init_component()}init_component(){this.prepare_dom(),this.bind_events()}prepare_dom(){let{cols:e,keys:t,css_classes:i,fieldnames:s}=this;function o(){return t.reduce((a,r,n)=>a+r.reduce((d,_,g)=>{let u=i&&i[n]?i[n][g]:"",p=s&&s[_]?s[_]:typeof _=="string"?frappe.scrub(_):_;return d+`<div class="numpad-btn ${u}" data-button-value="${p}">${__(_)}</div>`},""),"")}this.wrapper.html(`<div class="numpad-container">
				${o()}
			</div>`)}bind_events(){let e=this;this.wrapper.on("click",".numpad-btn",function(){let t=$(this);e.events.numpad_event(t)})}};custom_app.PointOfSale.Payment=class{constructor({events:e,wrapper:t}){this.wrapper=t,this.events=e,this.init_component()}init_component(){this.prepare_dom(),this.bind_events(),this.attach_shortcuts()}prepare_dom(){this.wrapper.append(`<section class="payment-container" style="grid-column:span 4 / span 4;">
				<div class="fields-numpad-container">
					<div class="fields-section">
						<div class="section-label payment-section">${__("Payment Method")}</div>
						<div class="payment-modes"></div>
					</div>
				</div>
				<div class="totals-section">
					<div class="totals"></div>
				</div>
				<div class="submit-order-btn">${__("Complete Order")}</div>
			</section>`),this.$component=this.wrapper.find(".payment-container"),this.$payment_modes=this.$component.find(".payment-modes"),this.$totals_section=this.$component.find(".totals-section"),this.$totals=this.$component.find(".totals"),this.$numpad=this.$component.find(".number-pad"),this.$invoice_fields_section=this.$component.find(".fields-section")}make_invoice_fields_control(){frappe.db.get_doc("POS Settings",void 0).then(e=>{let t=e.invoice_fields;if(!t.length)return;this.$invoice_fields=this.$invoice_fields_section.find(".invoice-fields"),this.$invoice_fields.html("");let i=this.events.get_frm();t.forEach(s=>{this.$invoice_fields.append(`<div class="invoice_detail_field ${s.fieldname}-field" data-fieldname="${s.fieldname}"></div>`);let o={onchange:function(){i.set_value(this.df.fieldname,this.get_value())}};s.fieldtype=="Button"&&(o={click:function(){i.script_manager.has_handlers(s.fieldname,i.doc.doctype)&&i.script_manager.trigger(s.fieldname,i.doc.doctype,i.doc.docname)}}),this[`${s.fieldname}_field`]=frappe.ui.form.make_control({df:A(A({},s),o),parent:this.$invoice_fields.find(`.${s.fieldname}-field`),render_input:!0}),this[`${s.fieldname}_field`].set_value(i.doc[s.fieldname])})})}initialize_numpad(){let e=this;this.number_pad=new erpnext.PointOfSale.NumberPad({wrapper:this.$numpad,events:{numpad_event:function(t){e.on_numpad_clicked(t)}},cols:3,keys:[[1,2,3],[4,5,6],[7,8,9],[".",0,"Delete"]]}),this.numpad_value=""}on_numpad_clicked(e){let t=e.attr("data-button-value");i(e),this.numpad_value=t==="delete"?this.numpad_value.slice(0,-1):this.numpad_value+t,this.selected_mode.$input.get(0).focus(),this.selected_mode.set_value(this.numpad_value);function i(s){s.addClass("shadow-base-inner bg-selected"),setTimeout(()=>{s.removeClass("shadow-base-inner bg-selected")},100)}}bind_events(){let e=this;function t(){$(".mode-of-payment-control").hide(),$(".mobile-number").hide(),$(".approval-code").hide(),$(".reference-number").hide(),$(".bank-name").hide(),$(".holder-name").hide(),$(".card_type_control").hide(),$(".card-number").hide(),$(".expiry-date").hide(),$(".confirmation-code").hide(),$(".cash-shortcuts").hide(),$(".check-name").hide(),$(".check-number").hide(),$(".check-date").hide(),$(".actual-gov-one").hide(),$(".actual-gov-two").hide(),$(".payment-type").hide(),$(".bank-type").hide(),$(".qr-reference-number").hide(),$(".customer").hide(),$(".charge-invoice-number").hide(),$(".po-number").hide(),$(".representative").hide(),$(".id-number").hide(),$(".approved-by").hide(),$(".gift-code").hide(),$(".button-code").hide(),$(".amesco-code").hide(),$(".button-amesco-plus").hide(),$(".save-button").hide(),$(".discard-button").hide(),$(".cash-button").hide(),e.$payment_modes.find(".pay-amount").css("display","inline"),e.$payment_modes.find(".loyalty-amount-name").hide()}function i(r){let n=r.find(".frappe-control.input-max-width[data-fieldtype='Currency'] input");n.focus(),n[0].setSelectionRange(0,n.val().length)}this.$payment_modes.on("click",".mode-of-payment",function(r){let n=$(this);if(!$(r.target).is(n))return;let d=n.offset().left-e.$payment_modes.offset().left+e.$payment_modes.scrollLeft();e.$payment_modes.animate({scrollLeft:d});let _=n.attr("data-mode");t(),$(".mode-of-payment").removeClass("border-primary"),n.hasClass("border-primary")?(n.removeClass("border-primary"),t()):(n.addClass("border-primary"),n.find(".mode-of-payment-control").css("display","flex"),n.find(".cash-button").css("display","flex"),_==="gcash"||_==="paymaya"?(n.find(".mobile-number").css("display","flex"),n.find(".reference-number").css("display","flex"),n.find(".save-button").css("display","flex"),n.find(".discard-button").css("display","flex")):_==="cards"||_==="debit_card"||_==="credit_card"?(n.find(".bank-name").css("display","flex"),n.find(".holder-name").css("display","flex"),n.find(".card_type_control").css("display","flex"),n.find(".card-number").css("display","flex"),n.find(".expiry-date").css("display","flex"),n.find(".approval-code").css("display","flex"),n.find(".save-button").css("display","flex"),n.find(".discard-button").css("display","flex")):_==="cheque"?(n.find(".bank-name").css("display","flex"),n.find(".check-name").css("display","flex"),n.find(".check-number").css("display","flex"),n.find(".check-date").css("display","flex"),n.find(".save-button").css("display","flex"),n.find(".discard-button").css("display","flex")):_==="2307g"?(n.find(".actual-gov-one").css("display","flex"),n.find(".save-button").css("display","flex"),n.find(".discard-button").css("display","flex")):_==="2307"?(n.find(".actual-gov-two").css("display","flex"),n.find(".save-button").css("display","flex"),n.find(".discard-button").css("display","flex")):_==="qr_payment"?(n.find(".payment-type").css("display","flex"),n.find(".bank-type").css("display","flex"),n.find(".qr-reference-number").css("display","flex"),n.find(".save-button").css("display","flex"),n.find(".discard-button").css("display","flex")):_==="charge"?(n.find(".customer").css("display","flex"),n.find(".charge-invoice-number").css("display","flex"),n.find(".po-number").css("display","flex"),n.find(".representative").css("display","flex"),n.find(".id-number").css("display","flex"),n.find(".approved-by").css("display","flex"),n.find(".save-button").css("display","flex"),n.find(".discard-button").css("display","flex")):_==="gift_certificate"?(n.find(".gift-code").css("display","flex"),n.find(".button-code").css("display","flex"),n.find(".discard-button").css("display","flex")):_==="amesco_plus"&&(n.find(".amesco-code").css("display","flex"),n.find(".button-amesco-plus").css("display","flex"),n.find(".discard-button").css("display","flex")),i(n),e.selected_mode&&e.selected_mode.$input.get(),e.auto_set_remaining_amount())}),$(document).on("click",function(r){$(r.target).closest(".mode-of-payment").length||(t(),$(".mode-of-payment").removeClass("border-primary"))}),frappe.ui.form.on("POS Invoice","contact_mobile",r=>{var _;let n=r.doc.contact_mobile,d=$((_=this.request_for_payment_field)==null?void 0:_.$input[0]);n?d.removeClass("btn-default").addClass("btn-primary"):d.removeClass("btn-primary").addClass("btn-default")}),frappe.ui.form.on("POS Invoice","coupon_code",r=>{r.doc.coupon_code&&!r.applying_pos_coupon_code&&(r.doc.ignore_pricing_rule?r.doc.ignore_pricing_rule&&frappe.show_alert({message:__("Ignore Pricing Rule is enabled. Cannot apply coupon code."),indicator:"orange"}):(r.applying_pos_coupon_code=!0,frappe.run_serially([()=>r.doc.ignore_pricing_rule=1,()=>r.trigger("ignore_pricing_rule"),()=>r.doc.ignore_pricing_rule=0,()=>r.trigger("apply_pricing_rule"),()=>r.save(),()=>this.update_totals_section(r.doc),()=>r.applying_pos_coupon_code=!1])))}),this.setup_listener_for_payments(),this.$payment_modes.on("click",".shortcut",function(){let r=$(this).attr("data-value");e.selected_mode.set_value(r)}),this.$component.on("click",".submit-order-btn",()=>{let r=this.events.get_frm().doc,n=parseFloat(r.paid_amount).toFixed(2),d=r.items,_=r.payments,g=cint(frappe.sys_defaults.disable_rounded_total)?parseFloat(r.grand_total).toFixed(2):parseFloat(r.rounded_total).toFixed(2);if(n===0||!d.length){let l=d.length?__("You cannot submit the order without payment."):__("You cannot submit an empty order.");frappe.show_alert({message:l,indicator:"orange"}),frappe.utils.play_sound("error");return}let u=_.reduce((l,m)=>l+(m.amount||0),0),p=parseFloat(u).toFixed(2),h=parseFloat(g).toFixed(2),c=_.some(l=>l.mode_of_payment==="Cash"||l.mode_of_payment==="Gift Certificate"&&l.amount>0);if(parseFloat(p)>parseFloat(h)&&!c){frappe.show_alert({message:__("Paid amount cannot be greater than the grand total for non-cash payments."),indicator:"orange"}),frappe.utils.play_sound("error");return}!s(r)||this.events.submit_invoice()});function s(r){let n=!1;return r.payments.forEach(d=>{let _=d.mode_of_payment?d.mode_of_payment.trim():null;if((d.amount||0)>0){if(!_)return frappe.show_alert({message:__("No payment method selected."),indicator:"orange"}),n=!0,!1;switch(_){case"Cash":let u=o(["amount"],d);if(u.length)return a(__("The following fields are required for Cash payment: {0}",[u.join(", ")])),n=!0,!1;break;case"Gift Certificate":case"Amesco Plus":let p=o(["amount"],d);if(p.length)return a(__("The following fields are required for Amesco Plus payment: {0}",[p.join(", ")])),n=!0,!1;break;case"Charge":let h=o(["amount","custom_customer","custom_charge_invoice_number","custom_po_number","custom_representative","custom_id_number"],d);if(h.length)return a(__("The following fields are required for Charge payment: {0}",[h.join(", ")])),n=!0,!1;break;case"Debit Card":case"Credit Card":let c=o(["amount","custom_bank_name","custom_card_name","custom_card_number","custom_card_expiration_date","custom_approval_code"],d);if(c.length)return console.log("Missing fields for Debit payment:",c),a(__("The following fields are required for Debit/Credit payment: {0}",[c.join(", ")])),n=!0,!1;break;case"Cheque":case"Government":let l=o(["amount","custom_check_bank_name","custom_name_on_check","custom_check_number"],d);if(l.length)return console.log("Missing fields for Cheque/Government payment:",l),a(__("The following fields are required for Cheque payment: {0}",[l.join(", ")])),n=!0,!1;break;case"Cards":let m=o(["amount","custom_bank_name","custom_card_name","custom_card_type","custom_card_number","custom_card_expiration_date","custom_approval_code"],d);if(m.length)return console.log("Missing fields for Cards payment:",m),a(__("The following fields are required for Cards payment: {0}",[m.join(", ")])),n=!0,!1;break;case"QR Payment":let y=o(["amount","custom_payment_type","custom_bank_type","custom_qr_reference_number"],d);if(y.length)return console.log("Missing fields for QR payment:",y),a(__("The following fields are required for QR payment: {0}",[y.join(", ")])),n=!0,!1;break;case"GCash":case"PayMaya":let f=o(["amount","reference_no"],d);if(f.length)return console.log("Missing fields for QR payment:",f),a(__("The following fields are required for GCash/PayMaya payment: {0}",[f.join(", ")])),n=!0,!1;break;case"2307":case"2307G":let b=o(["amount"],d);if(b.length)return console.log("Missing fields for QR payment:",b),a(__("The following fields are required for 2307/2307G payment: {0}",[b.join(", ")])),n=!0,!1;break;default:return frappe.show_alert({message:__("Invalid payment method selected: {0}",[_]),indicator:"orange"}),n=!0,!1}}}),!n}function o(r,n){let d=[];return r.forEach(_=>{n[_]||""||d.push(_)}),d}function a(r){let n=frappe.msgprint({title:__("Validation Warning"),message:r,indicator:"orange",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(d){d.which===13&&n.$wrapper.is(":visible")&&n.get_primary_btn().trigger("click")}),n.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")})}frappe.ui.form.on("POS Invoice","paid_amount",r=>{this.update_totals_section(r.doc);let n=!this.$payment_modes.find(".cash-shortcuts").is(":visible");this.attach_cash_shortcuts(r.doc),!n&&this.$payment_modes.find(".cash-shortcuts").css("display","grid"),this.render_payment_mode_dom()}),frappe.ui.form.on("POS Invoice","loyalty_amount",r=>{let n=format_currency(r.doc.loyalty_amount,r.doc.currency);this.$payment_modes.find(".loyalty-amount-amount").html(n)}),frappe.ui.form.on("Sales Invoice Payment","amount",(r,n,d)=>{let _=locals[n][d],g=_.mode_of_payment.replace(/ +/g,"_").toLowerCase();this[`${g}_control`]&&this[`${g}_control`].get_value()!=_.amount&&this[`${g}_control`].set_value(_.amount)})}setup_listener_for_payments(){frappe.realtime.on("process_phone_payment",e=>{let t=this.events.get_frm().doc,{response:i,amount:s,success:o,failure_message:a}=e,r,n;if(o){n=__("Payment Received");let d=cint(frappe.sys_defaults.disable_rounded_total)?t.grand_total:t.rounded_total;s>=d?(frappe.dom.unfreeze(),r=__("Payment of {0} received successfully.",[format_currency(s,t.currency,0)]),this.events.submit_invoice(),cur_frm.reload_doc()):r=__("Payment of {0} received successfully. Waiting for other requests to complete...",[format_currency(s,t.currency,0)])}else a&&(r=a,n=__("Payment Failed"));frappe.msgprint({message:r,title:n})})}auto_set_remaining_amount(){let e=this.events.get_frm().doc,i=(cint(frappe.sys_defaults.disable_rounded_total)?e.grand_total:e.rounded_total)-e.paid_amount;!(this.selected_mode?this.selected_mode.get_value():void 0)&&i>0&&this.selected_mode&&this.selected_mode.set_value(i)}attach_shortcuts(){let e=frappe.utils.is_mac()?"\u2318":"Shift";this.$component.find(".submit-order-btn").attr("title",`${e}+Enter`),frappe.ui.keys.on("shift+enter",()=>{this.$component.find(".payment-section").is(":visible")&&this.$component.find(".submit-order-btn").click()}),frappe.ui.keys.add_shortcut({shortcut:"shift+tab",action:()=>{let t=this.$component.is(":visible"),i=this.$payment_modes.find(".border-primary");if(i=i.length?i.attr("data-mode"):void 0,!i)return;let s=Array.from(this.$payment_modes.find(".mode-of-payment")).map(n=>$(n).attr("data-mode")),o=s.indexOf(i),a=(o+1)%s.length,r=this.$payment_modes.find(`.mode-of-payment[data-mode="${s[a]}"]`);t&&o!=a&&r.click()},condition:()=>this.$component.is(":visible")&&this.$payment_modes.find(".border-primary").length,description:__("Switch Between Payment Modes"),ignore_inputs:!0,page:cur_page.page.page})}toggle_numpad(){}render_payment_section(){this.render_payment_mode_dom(),this.make_invoice_fields_control(),this.update_totals_section(),this.focus_on_default_mop()}after_render(){let e=this.events.get_frm();e.script_manager.trigger("after_payment_render",e.doc.doctype,e.doc.docname)}edit_cart(){this.events.toggle_other_sections(!1),this.toggle_component(!1)}checkout(){this.events.toggle_other_sections(!0),this.toggle_component(!0),this.render_payment_section(),this.after_render()}toggle_remarks_control(){this.$remarks.find(".frappe-control").length?this.$remarks.html("+ Add Remark"):(this.$remarks.html(""),this.remark_control=frappe.ui.form.make_control({df:{label:__("Remark"),fieldtype:"Data",onchange:function(){}},parent:this.$totals_section.find(".remarks"),render_input:!0}),this.remark_control.set_value(""))}render_payment_mode_dom(){let e=this.events.get_frm().doc,t=e.payments,i=e.currency,s=e.customer_group,o=["2306","2307"];this.$payment_modes.html(`<div style="display: flex; flex-wrap: wrap; gap: 16px;">
				${t.map((a,r)=>{let n=a.mode_of_payment.replace(/ +/g,"_").toLowerCase(),d=a.type,_=a.amount>0?format_currency(a.amount,i):"",u=`
						<div class="payment-mode-wrapper" style="flex: 0 0 calc(50% - 16px); min-width: calc(50% - 16px); ${a.mode_of_payment==="2307G"&&s!=="Government"?"display: none;":""}">
						<div class="mode-of-payment" data-mode="${n}" data-payment-type="${d}" style="border: 1px solid #ccc; border-radius: 8px; padding: 16px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); background-color: #fff;">
							<span>${a.mode_of_payment}</span>
							<div class="${n}-amount pay-amount" style="font-weight: bold; justify-content: space-between; align-items: end;">${_}</div>
							<div class="${n} mode-of-payment-control"></div>
							<div class="${n} cash-button"></div>
							
					`;switch(a.mode_of_payment){case"Cards":case"Debit Card":case"Credit Card":u+=`
								<div class="${n} bank-name"></div>
								<div class="${n} holder-name"></div>
								<div class="${n} card_type_control"></div>
								<div class="${n} card-number"></div>
								<div class="${n} expiry-date"></div>
								<div class="${n} approval-code"></div>
								<div class="${n} button-row" style="display: flex; gap: 5px; align-items: center;">
									<div class="${n} save-button"></div>
									<div class="${n} discard-button"></div>
								</div>
							`;break;case"GCash":case"PayMaya":u+=`
								<div class="${n} mobile-number" style="margin-top:10px;"></div>
								<div class="${n} reference-number" style="margin-top:10px;"></div>
								<div class="${n} button-row" style="display: flex; gap: 5px; align-items: center;">
									<div class="${n} save-button"></div>
									<div class="${n} discard-button"></div>
								</div>
							`;break;case"Cheque":u+=`
								<div class="${n} bank-name"></div>
								<div class="${n} check-name"></div>
								<div class="${n} check-number"></div>
								<div class="${n} check-date"></div>
								<div class="${n} button-row" style="display: flex; gap: 5px; align-items: center;">
									<div class="${n} save-button"></div>
									<div class="${n} discard-button"></div>
								</div>
							`;break;case"2307G":u+=`
								<div class="${n} actual-gov-one"></div>
								<div class="${n} button-row" style="display: flex; gap: 5px; align-items: center;">
									<div class="${n} save-button"></div>
									<div class="${n} discard-button"></div>
								</div>
							`;break;case"2307":u+=`
								<div class="${n} actual-gov-two"></div>
								<div class="${n} button-row" style="display: flex; gap: 5px; align-items: center;">
									<div class="${n} save-button"></div>
									<div class="${n} discard-button"></div>
								</div>
							`;break;case"QR Payment":u+=`
								<div class="${n} payment-type"></div>
								<div class="${n} bank-type"></div>
								<div class="${n} qr-reference-number"></div>
								<div class="${n} button-row" style="display: flex; gap: 5px; align-items: center;">
									<div class="${n} save-button"></div>
									<div class="${n} discard-button"></div>
								</div>
							`;break;case"Charge":u+=`
								<div class="${n} customer"></div>
								<div class="${n} charge-invoice-number"></div>
								<div class="${n} po-number"></div>
								<div class="${n} representative"></div>
								<div class="${n} id-number"></div>
								<div class="${n} approved-by"></div>
								<div class="${n} button-row" style="display: flex; gap: 5px; align-items: center;">
									<div class="${n} save-button"></div>
									<div class="${n} discard-button"></div>
								</div>
								
							`;break;case"Gift Certificate":u+=`
							  <div class="${n} gift-code"></div>
							  <div class="${n} button-row" style="display: flex; gap: 3px; align-items: center;">
							  		<div class="${n} button-code mt-2" ></div>
									<div class="${n} discard-button"></div>
								</div>
						   `;break;case"Amesco Plus":u+=`
							<div class="${n} amesco-code"></div>
							<div class="${n} button-row" style="display: flex; gap: 3px; align-items: center;">
								<div class="${n} button-amesco-plus mt-2" ></div>
								<div class="${n} discard-button"></div>
							</div>	
							
							   `;break}return u+=`
							</div>
						</div>
					`,u}).join("")}
			</div>`),t.forEach(a=>{let r=a.mode_of_payment.replace(/ +/g,"_").toLowerCase(),n=this,d=this.events.get_frm();if(this[`${r}_control`]=frappe.ui.form.make_control({df:{label:"Amount",fieldtype:"Currency",placeholder:__("Enter {0} amount.",[a.mode_of_payment]),read_only:r==="gift_certificate",onchange:function(){if(frappe.model.get_value(a.doctype,a.name,"amount")!=this.value){let u=format_currency(this.value,i);n.$payment_modes.find(`.${r}-amount`).html(u)}},reqd:!0},parent:this.$payment_modes.find(`.${r}.mode-of-payment-control`),render_input:!0}),setTimeout(()=>{let g=this.$payment_modes.find(`.${r}.mode-of-payment-control input[data-fieldname="amount"]`);g.focus(),g.select()},300),r==="cash"){let g=$("<button/>",{text:"Save",class:"btn btn-primary",click:function(){let h=n[`${r}_control`].get_value();if(!h){let c=frappe.msgprint({title:__("Validation Warning"),message:__("All fields are required."),indicator:"orange",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(l){l.which===13&&c.$wrapper.is(":visible")&&c.get_primary_btn().trigger("click")}),c.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")});return}frappe.model.set_value(a.doctype,a.name,"amount",flt(h)).then(()=>{n.update_totals_section();let c=format_currency(h,i);n.$payment_modes.find(`.${r}-amount`).html(c);let l=frappe.msgprint({title:__("Success"),message:__("Cash payment details have been saved."),indicator:"green",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(m){m.which===13&&l.$wrapper.is(":visible")&&l.get_primary_btn().trigger("click")}),l.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")})})}}),u=$("<button/>",{text:"Discard",class:"btn btn-secondary",click:function(){n[`${r}_control`].set_value(0),frappe.model.set_value(a.doctype,a.name,"amount",0).then(()=>{n.update_totals_section(),n.$payment_modes.find(`.${r}-amount`).html(format_currency(0,i));let h=frappe.msgprint({message:__("Cash payment details have been discarded."),indicator:"blue",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(c){c.which===46&&h.$wrapper.is(":visible")&&h.get_secondary_btn().trigger("click")}),h.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")})})}}),p=$("<div/>",{style:"display: flex; gap: 5px; align-items: center;"});p.append(g),p.append(u),this.$payment_modes.find(`.${r}.cash-button`).append(p),this.$payment_modes.find(`.${r}.mode-of-payment-control input`).keypress(function(h){h.which===13&&g.click()})}if(this[`${r}_control`].set_value(0),a.mode_of_payment==="Cards"){let P=function(C){return/^\d{4}$/.test(C)};var _=P;let g=frappe.model.get_value(a.doctype,a.name,"custom_bank_name"),u=frappe.ui.form.make_control({df:{label:"Bank",fieldtype:"Data",placeholder:"Bank Name",reqd:!0},parent:this.$payment_modes.find(`.${r}.bank-name`),render_input:!0});u.set_value(g||""),u.refresh();let p=cur_frm.doc.customer,h=frappe.model.get_value(a.doctype,a.name,"custom_card_name"),c=frappe.ui.form.make_control({df:{label:"Name on Card",fieldtype:"Data",placeholder:"Card name holder",reqd:!0},parent:this.$payment_modes.find(`.${r}.holder-name`),render_input:!0});frappe.db.get_value("Customer",p,"customer_name").then(C=>{let x=C.message.customer_name;c.set_value(h||x||"")}).catch(C=>{console.error("Error fetching customer name:",C)}),c.refresh();let l=frappe.model.get_value(a.doctype,a.name,"custom_card_type"),m=frappe.ui.form.make_control({df:{label:"Card Type",fieldtype:"Select",options:[{label:"Select Card Type",value:""},{label:"Visa",value:"Visa"},{label:"Visa Debit",value:"Visa Debit"},{label:"Visa Electron",value:"Visa Electron"},{label:"Credit Card",value:"Credit Card"},{label:"Mastercard",value:"Mastercard"},{label:"Mastercard Debit",value:"Mastercard Debit"},{label:"Maestro",value:"Maestro"},{label:"American Express (Amex)",value:"American Express (Amex)"},{label:"Discover",value:"Discover"},{label:"Diners Club",value:"Diners Club"},{label:"JCB",value:"JCB"},{label:"UnionPay",value:"UnionPay"},{label:"RuPay",value:"RuPay"},{label:"Interac",value:"Interac"},{label:"Carte Bancaire (CB)",value:"Carte Bancaire (CB)"},{label:"Elo",value:"Elo"},{label:"Mir",value:"Mir"},{label:"Others",value:"Others"}],reqd:!0},parent:this.$payment_modes.find(`.${r}.card_type_control`),render_input:!0});m.set_value(l||""),m.refresh();let y=frappe.model.get_value(a.doctype,a.name,"custom_card_number"),f=frappe.ui.form.make_control({df:{label:"Card Number",fieldtype:"Data",placeholder:"Last 4 digits",maxlength:4,reqd:!0},parent:this.$payment_modes.find(`.${r}.card-number`),render_input:!0});f.set_value(y||""),f.refresh();let b=frappe.model.get_value(a.doctype,a.name,"custom_card_expiration_date"),v=frappe.ui.form.make_control({df:{label:"Card Expiration Date",fieldtype:"Data",placeholder:"MM/YY",reqd:!0},parent:this.$payment_modes.find(`.${r}.expiry-date`),render_input:!0});v.set_value(b||""),v.refresh(),v.$input.on("input",function(){let C=this.value.replace(/\D/g,"");C.length>=2?this.value=C.slice(0,2)+"/"+C.slice(2):this.value=C});let w=frappe.model.get_value(a.doctype,a.name,"custom_approval_code"),S=frappe.ui.form.make_control({df:{label:"Approval Code",fieldtype:"Data",placeholder:"Approval Code",reqd:!0},parent:this.$payment_modes.find(`.${r}.approval-code`),render_input:!0});S.set_value(w||""),S.refresh();let k=$('<button class="btn btn-primary"style="text-align: right;"">Save</button>');this.$payment_modes.find(`.${r}.save-button`).append(k);let D=$('<button class="btn btn-secondary" style="text-align: right; margin-left: 10px;">Discard</button>');this.$payment_modes.find(`.${r}.discard-button`).append(D);let O=this;k.on("click",function(){let C=O[`${r}_control`].get_value(),x=u.get_value(),q=c.get_value(),I=m.get_value(),z=f.get_value(),B=v.get_value(),K=S.get_value();if(!C||!x||!q||!I||!z||!B||!K){let T=frappe.msgprint({title:__("Validation Warning"),message:__("All fields are required."),indicator:"orange",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(E){E.which===13&&T.$wrapper.is(":visible")&&T.get_primary_btn().trigger("click")}),T.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")});return}if(!P(z)){let T=frappe.msgprint({title:__("Validation Warning"),message:__("Card number must be exactly 4 digits."),indicator:"orange",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(E){E.which===13&&T.$wrapper.is(":visible")&&T.get_primary_btn().trigger("click")}),T.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")});return}let L=cint(frappe.sys_defaults.disable_rounded_total)?e.grand_total:e.rounded_total,F=e.currency;if(C>L){frappe.msgprint({title:__("Validation Warning"),message:__("Amount must not exceed the grand total."),indicator:"orange"});return}frappe.model.set_value(a.doctype,a.name,"amount",flt(C)),frappe.model.set_value(a.doctype,a.name,"custom_bank_name",x),frappe.model.set_value(a.doctype,a.name,"custom_card_name",q),frappe.model.set_value(a.doctype,a.name,"custom_card_type",I),frappe.model.set_value(a.doctype,a.name,"custom_card_number",z),frappe.model.set_value(a.doctype,a.name,"custom_card_expiration_date",B),frappe.model.set_value(a.doctype,a.name,"custom_approval_code",K);let V=frappe.msgprint({title:__("Success"),message:__("Card payment details have been saved."),indicator:"green",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(T){T.which===13&&V.$wrapper.is(":visible")&&V.get_primary_btn().trigger("click")}),V.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")})}),D.on("click",function(){this[`${r}_control`].set_value(0),u.set_value(""),c.set_value(""),m.set_value(""),f.set_value(""),v.set_value(""),S.set_value(""),frappe.model.set_value(a.doctype,a.name,"amount",0),frappe.model.set_value(a.doctype,a.name,"custom_bank_name",""),frappe.model.set_value(a.doctype,a.name,"custom_card_name",""),frappe.model.set_value(a.doctype,a.name,"custom_card_type",""),frappe.model.set_value(a.doctype,a.name,"custom_card_number",""),frappe.model.set_value(a.doctype,a.name,"custom_card_expiration_date",""),frappe.model.set_value(a.doctype,a.name,"custom_approval_code",""),frappe.msgprint({message:__("Payment details have been discarded."),indicator:"blue",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}})}),[O[`${r}_control`],u,c,m,f,v,S].forEach(C=>{C.$input&&C.$input.keypress(function(x){x.which===13&&k.click()})})}if(a.mode_of_payment==="GCash"||a.mode_of_payment==="PayMaya"){let g=frappe.model.get_value(a.doctype,a.name,"custom_phone_number"),u=frappe.ui.form.make_control({df:{label:"Number",fieldtype:"Data",placeholder:"09876543212"},parent:this.$payment_modes.find(`.${r}.mobile-number`),render_input:!0});u.set_value(g||""),u.refresh();let p=frappe.model.get_value(a.doctype,a.name,"reference_no"),h=frappe.ui.form.make_control({df:{label:"Reference No",fieldtype:"Data",placeholder:"Reference No.",reqd:!0},parent:this.$payment_modes.find(`.${r}.reference-number`),render_input:!0,default:a.reference_no||""});h.set_value(p||""),h.refresh();let c=$('<button class="btn btn-primary" style="text-align: right;">save</button>');this.$payment_modes.find(`.${r}.save-button`).append(c);let l=$('<button class="btn btn-secondary" style="text-align: right; margin-left: 10px;">Discard</button>');this.$payment_modes.find(`.${r}.discard-button`).append(l);let m=this;c.on("click",function(){let f=m[`${r}_control`].get_value(),b=u.get_value(),v=h.get_value();if(!f||!v){let D=frappe.msgprint({title:__("Validation Warning"),message:__("All fields are required."),indicator:"orange",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(O){O.which===13&&D.$wrapper.is(":visible")&&D.get_primary_btn().trigger("click")}),D.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")});return}let w=cint(frappe.sys_defaults.disable_rounded_total)?e.grand_total:e.rounded_total,S=e.currency;if(f>w){let D=frappe.msgprint({title:__("Validation Warning"),message:__("Amount must not exceed the grand total."),indicator:"orange",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(O){O.which===13&&D.$wrapper.is(":visible")&&D.get_primary_btn().trigger("click")}),D.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")});return}frappe.model.set_value(a.doctype,a.name,"amount",flt(f)),frappe.model.set_value(a.doctype,a.name,"custom_phone_number",b),frappe.model.set_value(a.doctype,a.name,"reference_no",v);let k=frappe.msgprint({title:__("Success"),message:__("Payment details have been saved."),indicator:"green",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(D){D.which===13&&k.$wrapper.is(":visible")&&k.get_primary_btn().trigger("click")}),k.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")})}),l.on("click",function(){m[`${r}_control`].set_value(0),u.set_value(""),h.set_value(""),frappe.model.set_value(a.doctype,a.name,"amount",0),frappe.model.set_value(a.doctype,a.name,"custom_phone_number",""),frappe.model.set_value(a.doctype,a.name,"reference_no",""),frappe.msgprint({message:__("Payment details have been discarded."),indicator:"blue",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}})}),[m[`${r}_control`],u,h].forEach(f=>{f.$input&&f.$input.keypress(function(b){b.which===13&&c.click()})})}if(a.mode_of_payment==="Debit Card"||a.mode_of_payment==="Credit Card"){let M=function(x){return/^\d{4}$/.test(x)};var _=M;let g=frappe.model.get_value(a.doctype,a.name,"custom_bank_name"),u=frappe.model.get_value(a.doctype,a.name,"custom_card_name"),p=frappe.model.get_value(a.doctype,a.name,"custom_card_type"),h=frappe.model.get_value(a.doctype,a.name,"custom_card_number"),c=frappe.model.get_value(a.doctype,a.name,"custom_card_expiration_date"),l=frappe.model.get_value(a.doctype,a.name,"custom_approval_code"),m=frappe.ui.form.make_control({df:{label:"Bank",fieldtype:"Data",placeholder:"Bank Name",reqd:!0},parent:this.$payment_modes.find(`.${r}.bank-name`),render_input:!0});m.set_value(g||""),m.refresh();let y=cur_frm.doc.customer,f=frappe.ui.form.make_control({df:{label:"Name on Card",fieldtype:"Data",placeholder:"Card name holder",reqd:!0},parent:this.$payment_modes.find(`.${r}.holder-name`),render_input:!0});frappe.db.get_value("Customer",y,"customer_name").then(x=>{let q=x.message.customer_name;f.set_value(u||q||"")}).catch(x=>{console.error("Error fetching customer name:",x)}),f.refresh();let b=frappe.ui.form.make_control({df:{label:"Card Type",fieldtype:"Select",options:[{label:"Select Card Type",value:""},{label:"Visa",value:"Visa"},{label:"Visa Debit",value:"Visa Debit"},{label:"Visa Electron",value:"Visa Electron"},{label:"Credit Card",value:"Credit Card"},{label:"Mastercard",value:"Mastercard"},{label:"Mastercard Debit",value:"Mastercard Debit"},{label:"Maestro",value:"Maestro"},{label:"American Express (Amex)",value:"American Express (Amex)"},{label:"Discover",value:"Discover"},{label:"Diners Club",value:"Diners Club"},{label:"JCB",value:"JCB"},{label:"UnionPay",value:"UnionPay"},{label:"RuPay",value:"RuPay"},{label:"Interac",value:"Interac"},{label:"Carte Bancaire (CB)",value:"Carte Bancaire (CB)"},{label:"Elo",value:"Elo"},{label:"Mir",value:"Mir"},{label:"Others",value:"Others"}],reqd:!0},parent:this.$payment_modes.find(`.${r}.card_type_control`),render_input:!0});b.set_value(p||""),b.refresh();let v=frappe.ui.form.make_control({df:{label:"Card Number",fieldtype:"Data",placeholder:"Last 4 digits",maxlength:4,reqd:!0},parent:this.$payment_modes.find(`.${r}.card-number`),render_input:!0});v.set_value(h||""),v.refresh();let w=frappe.ui.form.make_control({df:{label:"Card Expiration Date",fieldtype:"Data",placeholder:"MM/YY",reqd:!0},parent:this.$payment_modes.find(`.${r}.expiry-date`),render_input:!0});w.set_value(c||""),w.refresh(),w.$input.on("input",function(){let x=this.value.replace(/\D/g,"");x.length>=2?this.value=x.slice(0,2)+"/"+x.slice(2):this.value=x});let S=frappe.ui.form.make_control({df:{label:"Approval Code",fieldtype:"Data",placeholder:"Approval Code",reqd:!0},parent:this.$payment_modes.find(`.${r}.approval-code`),render_input:!0});S.set_value(l||""),S.refresh();let k=$('<button class="btn btn-primary" style="text-align: right;">Save</button>');this.$payment_modes.find(`.${r}.save-button`).append(k);let D=$('<button class="btn btn-secondary" style="text-align: right; margin-left: 10px;">Discard</button>');this.$payment_modes.find(`.${r}.discard-button`).append(D);let O=this;k.on("click",function(){let x=O[`${r}_control`].get_value(),q=m.get_value(),I=f.get_value(),z=b.get_value(),B=v.get_value(),K=w.get_value(),L=S.get_value();if(!x||!q||!I||!B||!K||!L){let E=frappe.msgprint({title:__("Validation Warning"),message:__("All fields are required."),indicator:"orange",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(R){R.which===13&&E.$wrapper.is(":visible")&&E.get_primary_btn().trigger("click")}),E.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")});return}if(!M(B)){let E=frappe.msgprint({title:__("Validation Warning"),message:__("Card number must be exactly 4 digits."),indicator:"orange",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(R){R.which===13&&E.$wrapper.is(":visible")&&E.get_primary_btn().trigger("click")}),E.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")});return}let F=cint(frappe.sys_defaults.disable_rounded_total)?e.grand_total:e.rounded_total,V=e.currency;if(x>F){let E=frappe.msgprint({title:__("Validation Warning"),message:__("Amount must not exceed the grand total."),indicator:"orange"});$(document).on("keydown",function(R){R.which===13&&E.$wrapper.is(":visible")&&E.get_primary_btn().trigger("click")}),E.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")});return}frappe.model.set_value(a.doctype,a.name,"amount",flt(x)),frappe.model.set_value(a.doctype,a.name,"custom_bank_name",q),frappe.model.set_value(a.doctype,a.name,"custom_card_name",I),frappe.model.set_value(a.doctype,a.name,"custom_card_type",z),frappe.model.set_value(a.doctype,a.name,"custom_card_number",B),frappe.model.set_value(a.doctype,a.name,"custom_card_expiration_date",K),frappe.model.set_value(a.doctype,a.name,"custom_approval_code",L);let T=frappe.msgprint({title:__("Success"),message:__("Card payment details have been saved."),indicator:"green",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(E){E.which===13&&T.$wrapper.is(":visible")&&T.get_primary_btn().trigger("click")}),T.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")})}),D.on("click",function(){O[`${r}_control`].set_value(0),m.set_value(""),f.set_value(""),v.set_value(""),w.set_value(""),S.set_value(""),frappe.model.set_value(a.doctype,a.name,"amount",0),frappe.model.set_value(a.doctype,a.name,"custom_bank_name",""),frappe.model.set_value(a.doctype,a.name,"custom_card_name",""),frappe.model.set_value(a.doctype,a.name,"custom_card_number",""),frappe.model.set_value(a.doctype,a.name,"custom_card_expiration_date",""),frappe.model.set_value(a.doctype,a.name,"custom_approval_code","");let x=frappe.msgprint({message:__("Payment details have been discarded."),indicator:"blue",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(q){q.which===13&&x.$wrapper.is(":visible")&&x.get_primary_btn().trigger("click")}),x.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")})}),[O[`${r}_control`],m,f,v,w,S].forEach(x=>{x.$input&&x.$input.keypress(function(q){q.which===13&&k.click()})})}if(a.mode_of_payment==="Cheque"||a.mode_of_payment==="Government"){let g=frappe.model.get_value(a.doctype,a.name,"custom_check_bank_name"),u=frappe.ui.form.make_control({df:{label:"Bank Of Cheque",fieldtype:"Data",placeholder:"Bank Of Cheque",reqd:!0},parent:this.$payment_modes.find(`.${r}.bank-name`),render_input:!0});u.set_value(g||""),u.refresh();let p=cur_frm.doc.customer,h=frappe.model.get_value(a.doctype,a.name,"custom_name_on_check"),c=frappe.ui.form.make_control({df:{label:"Name On Cheque",fieldtype:"Data",placeholder:"Cheque Name",reqd:!0},parent:this.$payment_modes.find(`.${r}.check-name`),render_input:!0});frappe.db.get_value("Customer",p,"customer_name").then(k=>{let D=k.message.customer_name;c.set_value(h||D||"")}).catch(k=>{console.error("Error fetching customer name:",k)}),c.refresh();let l=frappe.model.get_value(a.doctype,a.name,"custom_check_number"),m=frappe.ui.form.make_control({df:{label:"Cheque Number",fieldtype:"Data",placeholder:"Cheque Number",reqd:!0},parent:this.$payment_modes.find(`.${r}.check-number`),render_input:!0});m.set_value(l||""),m.refresh();let y=frappe.model.get_value(a.doctype,a.name,"custom_check_date"),f=frappe.ui.form.make_control({df:{fieldname:"custom_check_date",label:"Cheque Date",fieldtype:"Date",placeholder:"Cheque Date",reqd:!0},parent:this.$payment_modes.find(`.${r}.check-date`),render_input:!0});f.set_value(y||frappe.datetime.nowdate()),f.refresh();let b=$('<button class="btn btn-primary"style="text-align: right;"">Save</button>');this.$payment_modes.find(`.${r}.save-button`).append(b);let v=$('<button class="btn btn-secondary" style="text-align: right; margin-left: 10px;">Discard</button>');this.$payment_modes.find(`.${r}.discard-button`).append(v);let w=this;b.on("click",function(){let k=w[`${r}_control`].get_value(),D=u.get_value(),O=c.get_value(),M=m.get_value(),P=f.get_value();if(!k||!D||!O||!M||!P){let I=frappe.msgprint({title:__("Validation Warning"),message:__("All fields are required."),indicator:"orange",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(z){z.which===13&&I.$wrapper.is(":visible")&&I.get_primary_btn().trigger("click")}),I.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")});return}let C=cint(frappe.sys_defaults.disable_rounded_total)?e.grand_total:e.rounded_total,x=e.currency;if(k>C){let I=frappe.msgprint({title:__("Validation Warning"),message:__("Amount must not exceed the grand total."),indicator:"orange",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(z){z.which===13&&I.$wrapper.is(":visible")&&I.get_primary_btn().trigger("click")}),I.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")});return}frappe.model.set_value(a.doctype,a.name,"amount",flt(k)),frappe.model.set_value(a.doctype,a.name,"custom_check_bank_name",D),frappe.model.set_value(a.doctype,a.name,"custom_name_on_check",O),frappe.model.set_value(a.doctype,a.name,"custom_check_number",M),frappe.model.set_value(a.doctype,a.name,"custom_check_date",P);let q=frappe.msgprint({title:__("Success"),message:__("Cheque payment details have been saved."),indicator:"green",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(I){I.which===13&&q.$wrapper.is(":visible")&&q.get_primary_btn().trigger("click")}),q.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")})}),v.on("click",function(){w[`${r}_control`].set_value(0),u.set_value(""),c.set_value(""),m.set_value(""),f.set_value(""),frappe.model.set_value(a.doctype,a.name,"amount",0),frappe.model.set_value(a.doctype,a.name,"custom_check_bank_name",""),frappe.model.set_value(a.doctype,a.name,"custom_name_on_check",""),frappe.model.set_value(a.doctype,a.name,"custom_check_number",""),frappe.model.set_value(a.doctype,a.name,"custom_check_date","");let k=frappe.msgprint({message:__("Payment details have been discarded."),indicator:"blue",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(D){D.which===13&&k.$wrapper.is(":visible")&&k.get_primary_btn().trigger("click")}),k.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")})}),[w[`${r}_control`],u,c,m,f].forEach(k=>{k.$input&&k.$input.keypress(function(D){D.which===13&&b.click()})})}if(a.mode_of_payment==="2307G"){let g=frappe.ui.form.make_control({df:{label:"Expected 2307G Amount",fieldtype:"Currency",placeholder:"Actual 2307G",read_only:1},parent:this.$payment_modes.find(`.${r}.actual-gov-one`),render_input:!0}),u=e.custom_2306;frappe.model.set_value(a.doctype,a.name,"custom_form_2306",u),g.set_value(u||""),g.refresh();let p=$('<button class="btn btn-primary"style="text-align: right;"">Save</button>');this.$payment_modes.find(`.${r}.save-button`).append(p);let h=$('<button class="btn btn-secondary" style="text-align: right; margin-left: 10px;">Discard</button>');this.$payment_modes.find(`.${r}.discard-button`).append(h);let c=this;p.on("click",function(){let m=c[`${r}_control`].get_value();if(!m){let f=frappe.msgprint({title:__("Validation Warning"),message:__("All fields are required."),indicator:"orange",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(b){b.which===13&&f.$wrapper.is(":visible")&&f.get_primary_btn().trigger("click")}),f.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")});return}frappe.model.set_value(a.doctype,a.name,"amount",flt(m));let y=frappe.msgprint({title:__("Success"),message:__("Payment details have been saved."),indicator:"green",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(f){f.which===13&&y.$wrapper.is(":visible")&&y.get_primary_btn().trigger("click")}),y.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")})}),h.on("click",function(){c[`${r}_control`].set_value(""),frappe.model.set_value(a.doctype,a.name,"amount",0);let m=frappe.msgprint({message:__("Payment details have been discarded."),indicator:"blue",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(y){y.which===13&&m.$wrapper.is(":visible")&&m.get_primary_btn().trigger("click")}),m.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")})}),[c[`${r}_control`]].forEach(m=>{m.$input&&m.$input.keypress(function(y){y.which===13&&p.click()})})}if(a.mode_of_payment==="2307"){let g=frappe.ui.form.make_control({df:{label:"Expected 2307 Amount",fieldtype:"Currency",placeholder:"Actual 2307",read_only:1},parent:this.$payment_modes.find(`.${r}.actual-gov-two`),render_input:!0}),u=e.custom_2307;frappe.model.set_value(a.doctype,a.name,"custom_form_2307",u),g.set_value(u||""),g.refresh();let p=$('<button class="btn btn-primary"style="text-align: right;"">Save</button>');this.$payment_modes.find(`.${r}.save-button`).append(p);let h=$('<button class="btn btn-secondary" style="text-align: right; margin-left: 10px;">Discard</button>');this.$payment_modes.find(`.${r}.discard-button`).append(h);let c=this;p.on("click",function(){let m=c[`${r}_control`].get_value();if(!m){let f=frappe.msgprint({title:__("Validation Warning"),message:__("All fields are required."),indicator:"orange",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(b){b.which===13&&f.$wrapper.is(":visible")&&f.get_primary_btn().trigger("click")}),f.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")});return}frappe.model.set_value(a.doctype,a.name,"amount",flt(m));let y=frappe.msgprint({title:__("Success"),message:__("Payment details have been saved."),indicator:"green",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(f){f.which===13&&y.$wrapper.is(":visible")&&y.get_primary_btn().trigger("click")}),y.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")})}),h.on("click",function(){c[`${r}_control`].set_value(""),frappe.model.set_value(a.doctype,a.name,"amount",0);let m=frappe.msgprint({message:__("Payment details have been discarded."),indicator:"blue",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(y){y.which===13&&m.$wrapper.is(":visible")&&m.get_primary_btn().trigger("click")}),m.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")})}),[c[`${r}_control`]].forEach(m=>{m.$input&&m.$input.keypress(function(y){y.which===13&&p.click()})})}if(a.mode_of_payment==="QR Payment"){let g=frappe.model.get_value(a.doctype,a.name,"custom_payment_type"),u=frappe.ui.form.make_control({df:{label:"Payment Type",fieldtype:"Select",options:[{label:"Select Payment Type",value:""},{label:"Standee",value:"Standee"},{label:"Terminal",value:"Terminal"}],reqd:!0},parent:this.$payment_modes.find(`.${r}.payment-type`),render_input:!0});u.set_value(g||""),u.refresh();let p=frappe.model.get_value(a.doctype,a.name,"custom_bank_type"),h=frappe.ui.form.make_control({df:{label:"Bank",fieldtype:"Select",options:[{label:"Select Bank Type",value:""},{label:"SBC",value:"SBC"},{label:"MBTC",value:"MBTC"},{label:"MAYA",value:"MAYA"},{label:"GCASH",value:"GCASH"},{label:"BDO",value:"BDO"}],reqd:!0},parent:this.$payment_modes.find(`.${r}.bank-type`),render_input:!0});h.set_value(p||""),h.refresh();let c=frappe.model.get_value(a.doctype,a.name,"custom_qr_reference_number"),l=frappe.ui.form.make_control({df:{label:"Confirmation Code",fieldtype:"Data",placeholder:"Reference # or Confirmation Code",reqd:!0},parent:this.$payment_modes.find(`.${r}.qr-reference-number`),render_input:!0});l.set_value(c||""),l.refresh();let m=$('<button class="btn btn-primary"style="text-align: right;"">Save</button>');this.$payment_modes.find(`.${r}.save-button`).append(m);let y=$('<button class="btn btn-secondary" style="text-align: right; margin-left: 10px;">Discard</button>');this.$payment_modes.find(`.${r}.discard-button`).append(y);let f=this;m.on("click",function(){let v=f[`${r}_control`].get_value(),w=u.get_value(),S=h.get_value(),k=l.get_value();if(!v||!w||!S||!k){let P=frappe.msgprint({title:__("Validation Warning"),message:__("All fields are required."),indicator:"orange",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(C){C.which===13&&P.$wrapper.is(":visible")&&P.get_primary_btn().trigger("click")}),P.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")});return}let D=cint(frappe.sys_defaults.disable_rounded_total)?e.grand_total:e.rounded_total,O=e.currency;if(v>D){let P=frappe.msgprint({title:__("Validation Warning"),message:__("Amount must not exceed the grand total."),indicator:"orange",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(C){C.which===13&&P.$wrapper.is(":visible")&&P.get_primary_btn().trigger("click")}),P.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")});return}frappe.model.set_value(a.doctype,a.name,"amount",flt(v)),frappe.model.set_value(a.doctype,a.name,"custom_payment_type",w),frappe.model.set_value(a.doctype,a.name,"custom_bank_type",S),frappe.model.set_value(a.doctype,a.name,"custom_qr_reference_number",k);let M=frappe.msgprint({title:__("Success"),message:__("Payment details have been saved."),indicator:"green",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(P){P.which===13&&M.$wrapper.is(":visible")&&M.get_primary_btn().trigger("click")}),M.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")})}),y.on("click",function(){f[`${r}_control`].set_value(0),u.set_value(""),h.set_value(""),l.set_value(""),frappe.model.set_value(a.doctype,a.name,"amount",0),frappe.model.set_value(a.doctype,a.name,"custom_payment_type",""),frappe.model.set_value(a.doctype,a.name,"custom_bank_type",""),frappe.model.set_value(a.doctype,a.name,"custom_qr_reference_number","");let v=frappe.msgprint({message:__("Payment details have been discarded."),indicator:"blue",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(w){w.which===13&&v.$wrapper.is(":visible")&&v.get_primary_btn().trigger("click")}),v.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")})}),[f[`${r}_control`],u,h,l].forEach(v=>{v.$input&&v.$input.keypress(function(w){w.which===13&&m.click()})})}if(a.mode_of_payment==="Charge"){let g=cur_frm.doc.customer,u=frappe.model.get_value(a.doctype,a.name,"custom_customer"),p=frappe.ui.form.make_control({df:{label:"Customer",fieldtype:"Data",placeholder:"Customer Name",reqd:!0},parent:this.$payment_modes.find(`.${r}.customer`),render_input:!0});frappe.db.get_value("Customer",g,"customer_name").then(P=>{let C=P.message.customer_name;p.set_value(u||C||"")}).catch(P=>{console.error("Error fetching customer name:",P)}),p.refresh();let h=frappe.model.get_value(a.doctype,a.name,"custom_charge_invoice_number"),c=frappe.ui.form.make_control({df:{label:"Charge Invoice Number",fieldtype:"Data",placeholder:"Charge Invoice Number",reqd:!0},parent:this.$payment_modes.find(`.${r}.charge-invoice-number`),render_input:!0});c.set_value(h||""),c.refresh();let l=frappe.model.get_value(a.doctype,a.name,"custom_po_number"),m=frappe.ui.form.make_control({df:{label:"PO Number",fieldtype:"Data",placeholder:"PO Number",reqd:!0},parent:this.$payment_modes.find(`.${r}.po-number`),render_input:!0});m.set_value(l||""),m.refresh();let y=frappe.model.get_value(a.doctype,a.name,"custom_representative"),f=frappe.ui.form.make_control({df:{label:"Representative",fieldtype:"Data",placeholder:"Representative",reqd:!0},parent:this.$payment_modes.find(`.${r}.representative`),render_input:!0});f.set_value(y||""),f.refresh();let b=frappe.model.get_value(a.doctype,a.name,"custom_id_number"),v=frappe.ui.form.make_control({df:{label:"ID Number",fieldtype:"Data",placeholder:"ID Number",reqd:!0},parent:this.$payment_modes.find(`.${r}.id-number`),render_input:!0});v.set_value(b||""),v.refresh();let w=frappe.model.get_value(a.doctype,a.name,"custom_approved_by"),S=frappe.ui.form.make_control({df:{label:"Approved By",fieldtype:"Data",placeholder:"Approver name"},parent:this.$payment_modes.find(`.${r}.approved-by`),render_input:!0});S.set_value(w||""),S.refresh();let k=$('<button class="btn btn-primary"style="text-align: right;"">Save</button>');this.$payment_modes.find(`.${r}.save-button`).append(k);let D=$('<button class="btn btn-secondary" style="text-align: right; margin-left: 10px;">Discard</button>');this.$payment_modes.find(`.${r}.discard-button`).append(D);let O=this;k.on("click",function(){let P=O[`${r}_control`].get_value(),C=p.get_value(),x=c.get_value(),q=m.get_value(),I=f.get_value(),z=v.get_value(),B=S.get_value();if(!P||!C||!x||!q||!I||!z){let L=frappe.msgprint({title:__("Validation Warning"),message:__("All fields are required."),indicator:"orange",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(F){F.which===13&&L.$wrapper.is(":visible")&&L.get_primary_btn().trigger("click")}),L.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")});return}frappe.model.set_value(a.doctype,a.name,"amount",flt(P)),frappe.model.set_value(a.doctype,a.name,"custom_customer",C),frappe.model.set_value(a.doctype,a.name,"custom_charge_invoice_number",x),frappe.model.set_value(a.doctype,a.name,"custom_po_number",q),frappe.model.set_value(a.doctype,a.name,"custom_representative",I),frappe.model.set_value(a.doctype,a.name,"custom_id_number",z),frappe.model.set_value(a.doctype,a.name,"custom_approved_by",B);let K=frappe.msgprint({title:__("Success"),message:__("Payment details have been saved."),indicator:"green",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(L){L.which===13&&K.$wrapper.is(":visible")&&K.get_primary_btn().trigger("click")}),K.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")})}),D.on("click",function(){O[`${r}_control`].set_value(0),p.set_value(""),c.set_value(""),m.set_value(""),f.set_value(""),v.set_value(""),S.set_value(""),frappe.model.set_value(a.doctype,a.name,"amount",0),frappe.model.set_value(a.doctype,a.name,"custom_customer",""),frappe.model.set_value(a.doctype,a.name,"custom_charge_invoice_number",""),frappe.model.set_value(a.doctype,a.name,"custom_po_number",""),frappe.model.set_value(a.doctype,a.name,"custom_representative",""),frappe.model.set_value(a.doctype,a.name,"custom_id_number",""),frappe.model.set_value(a.doctype,a.name,"custom_approved_by","");let P=frappe.msgprint({message:__("Payment details have been discarded."),indicator:"blue",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(C){C.which===13&&P.$wrapper.is(":visible")&&P.get_primary_btn().trigger("click")}),P.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")})}),[O[`${r}_control`],p,m,c,f,v,S].forEach(P=>{P.$input&&P.$input.keypress(function(C){C.which===13&&k.click()})})}if(a.mode_of_payment==="Gift Certificate"){let g=frappe.ui.form.make_control({df:{fieldtype:"Data",label:"Gift Code",placeholder:"Enter Gift Code"},parent:this.$payment_modes.find(`.${r}.gift-code`)[0],render_input:!0});g.refresh();let u=frappe.ui.form.make_control({df:{label:"Add Gift Code",fieldtype:"Button",btn_size:"sm",click:function(){let c=g.get_value();c?frappe.db.get_doc("Amesco Gift Certificate",c).then(l=>{if(l.is_used!==1){let m=flt(frappe.model.get_value(a.doctype,a.name,"amount"));frappe.model.set_value(a.doctype,a.name,"amount",m+flt(l.amount)),d.add_child("custom_gift_cert_used",{code:c});let y=frappe.msgprint({title:__("Success"),message:__("Gift Certificate code added successfully."),indicator:"green",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(f){f.which===13&&y.$wrapper.is(":visible")&&y.get_primary_btn().trigger("click")}),y.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")}),g.set_value("")}else frappe.msgprint({title:__("Error"),indicator:"red",message:__("Gift Code Already Used. Please check the code and try again.")})}).catch(l=>{frappe.msgprint({title:__("Error"),indicator:"red",message:__("Invalid Gift Code. Please check the code and try again.")})}):frappe.msgprint({title:__("Error"),indicator:"red",message:__("Please enter a gift code before clicking Add Gift Code.")})}},parent:this.$payment_modes.find(`.${r}.button-code`)[0],render_input:!0});u.refresh();let p=$('<button class="btn btn-secondary">Discard</button>');this.$payment_modes.find(`.${r}.discard-button`).append(p);let h=this;p.on("click",function(){h[`${r}_control`].set_value(""),frappe.model.set_value(a.doctype,a.name,"amount",0);let c=frappe.msgprint({message:__("Payment details have been discarded."),indicator:"blue",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(l){l.which===13&&c.$wrapper.is(":visible")&&c.get_primary_btn().trigger("click")}),c.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")})}),g.$input&&g.$input.keypress(function(c){c.which===13&&u.$input.trigger("click")})}if(a.mode_of_payment==="Amesco Plus"){frappe.ui.form.make_control({df:{label:"Scan",fieldtype:"Button",btn_size:"sm",click:function(){new frappe.ui.Scanner({dialog:!0,multiple:!1,on_scan(c){let l=c.decodedText.split(",");console.log("scannedData",l);let m=l[0],y=l[1],f=l[4],b=l[2];frappe.call({method:"custom_app.customapp.doctype.used_ameco_plus_code.used_ameco_plus_code.check_used_amesco_plus_code",args:{code:m},callback:function(v){if(v.message)frappe.msgprint(__("Amesco Plus voucher is already used."));else{let w=new frappe.ui.Dialog({title:__("Scanned Amesco Plus User"),fields:[{label:"Voucher Code",fieldname:"voucher_code",fieldtype:"Data",read_only:1,default:m},{label:"User ID",fieldname:"user_id",fieldtype:"Data",read_only:1,default:y},{label:"Email",fieldname:"email",fieldtype:"Data",read_only:1,default:f},{label:"Redeem Points",fieldname:"points",fieldtype:"Data",read_only:1,default:b}],primary_action_label:__("Ok"),primary_action:function(){frappe.model.set_value(a.doctype,a.name,"custom_am_voucher_code",m),frappe.model.set_value(a.doctype,a.name,"custom_am_plus_user_id",y),frappe.model.set_value(a.doctype,a.name,"custom_am_plus_user_email",f),frappe.model.set_value(a.doctype,a.name,"amount",flt(b)),d.add_child("custom_ameco_plus_code_used",{code:m}),w.hide()}});w.show()}}})}})}},parent:this.$payment_modes.find(`.${r}.button-amesco-plus`)[0],render_input:!0}).refresh();let u=$('<button class="btn btn-secondary" >Discard</button>');this.$payment_modes.find(`.${r}.discard-button`).append(u);let p=this;u.on("click",function(){p[`${r}_control`].set_value(""),frappe.model.set_value(a.doctype,a.name,"amount",0);let c=frappe.msgprint({message:__("Payment details have been discarded."),indicator:"blue",primary_action:{label:__("OK"),action:function(){frappe.msg_dialog.hide()}}});$(document).on("keydown",function(l){l.which===13&&c.$wrapper.is(":visible")&&c.get_primary_btn().trigger("click")}),c.$wrapper.on("hidden.bs.modal",function(){$(document).off("keydown")})}),[p[`${r}_control`]].forEach(c=>{c.$input&&c.$input.keypress(function(l){l.which===13&&save_button.click()})})}this[`${r}_control`].set_value(a.amount)}),this.render_loyalty_points_payment_mode(),this.attach_cash_shortcuts(e)}focus_on_default_mop(){this.events.get_frm().doc.payments.forEach(i=>{let s=i.mode_of_payment.replace(/ +/g,"_").toLowerCase();i.default&&setTimeout(()=>{this.$payment_modes.find(`.${s}.mode-of-payment-control`).parent().click()},500)})}attach_cash_shortcuts(e){let t=cint(frappe.sys_defaults.disable_rounded_total)?e.grand_total:e.rounded_total,i=e.currency,s=this.get_cash_shortcuts(flt(t));this.$payment_modes.find(".cash-shortcuts").remove();let o=s.map(a=>`<div class="shortcut" data-value="${a}">${format_currency(a,i,0)}</div>`).join("");this.$payment_modes.find('[data-payment-type="Cash"]').find(".mode-of-payment-control").after(`<div class="cash-shortcuts">${o}</div>`)}get_cash_shortcuts(e){let t=[1,5,10],i=String(Math.round(e)).length;t=t.map(a=>a*10**(i-2));let s=(a,r)=>{let n=Math.ceil(a/r)*r;return n===a?n+r:n},o=t.reduce((a,r)=>{let n=s(e,r);return n=a.indexOf(n)!=-1?n+r:n,[...a,n]},[]);return e>100&&(o.includes(500)||o.push(500),o.includes(1e3)||o.push(1e3)),o.sort((a,r)=>a-r),o}render_loyalty_points_payment_mode(){let e=this,t=this.events.get_frm().doc,{loyalty_program:i,loyalty_points:s,conversion_factor:o}=this.events.get_customer_details();if(this.$payment_modes.find('.mode-of-payment[data-mode="loyalty-amount"]').parent().remove(),!i)return;let a,r,n;s?(n=flt(flt(s)*flt(o),precision("loyalty_amount",t)),a=__("You can redeem upto {0}.",[format_currency(n)]),r=!1):(a=__("You don't have enough points to redeem."),r=!0);let d=this.$payment_modes.children().length%2===0?"pr-2":"pl-2",_=t.loyalty_amount>0?format_currency(t.loyalty_amount,t.currency):"";this.$payment_modes.append(`<div class="payment-mode-wrapper">
				<div class="mode-of-payment loyalty-card" data-mode="loyalty-amount" data-payment-type="loyalty-amount">
					Redeem Loyalty Points
					<div class="loyalty-amount-amount pay-amount">${_}</div>
					<div class="loyalty-amount-name">${i}</div>
					<div class="loyalty-amount mode-of-payment-control"></div>
				</div>
			</div>`),this["loyalty-amount_control"]=frappe.ui.form.make_control({df:{label:__("Redeem Loyalty Points"),fieldtype:"Currency",placeholder:__("Enter amount to be redeemed."),options:"company:currency",read_only:r,onchange:async function(){if(!s)return;if(this.value>n){frappe.show_alert({message:__("You cannot redeem more than {0}.",[format_currency(n)]),indicator:"red"}),frappe.utils.play_sound("submit"),e["loyalty-amount_control"].set_value(0);return}let g=this.value>0?1:0;await frappe.model.set_value(t.doctype,t.name,"redeem_loyalty_points",g),frappe.model.set_value(t.doctype,t.name,"loyalty_points",parseInt(this.value/o))},description:a},parent:this.$payment_modes.find(".loyalty-amount.mode-of-payment-control"),render_input:!0}),this["loyalty-amount_control"].toggle_label(!1)}render_add_payment_method_dom(){this.events.get_frm().doc.docstatus===0&&this.$payment_modes.append(`<div class="w-full pr-2">
					<div class="add-mode-of-payment w-half text-grey mb-4 no-select pointer">+ Add Payment Method</div>
				</div>`)}update_totals_section(e){e||(e=this.events.get_frm().doc);let t=e.paid_amount,i=cint(frappe.sys_defaults.disable_rounded_total)?e.grand_total:e.rounded_total,s=i-e.paid_amount,o=e.change_amount||s<=0?-1*s:void 0,a=e.currency,r=o?__("Change"):__("To Be Paid");this.$totals.html(`<div class="col">
				<div class="total-label">${__("Grand Total")}</div>
				<div class="value">${format_currency(i,a)}</div>
			</div>
			<div class="seperator-y"></div>
			<div class="col">
				<div class="total-label">${__("Paid Amount")}</div>
				<div class="value">${format_currency(t,a)}</div>
			</div>
			<div class="seperator-y"></div>
			<div class="col">
				<div class="total-label">${r}</div>
				<div class="value">${format_currency(o||s,a)}</div>
			</div>`)}toggle_component(e){e?this.$component.css("display","flex"):this.$component.css("display","none")}};custom_app.PointOfSale.PastOrderList=class{constructor({wrapper:e,events:t}){this.wrapper=e,this.events=t,this.init_component()}init_component(){this.prepare_dom(),this.make_filter_section(),this.bind_events()}prepare_dom(){this.wrapper.append(`<section class="past-order-list">
				<div class="filter-section">
					<div class="label">${__("Pending Orders")} <span class="invoice-count ml-3 badge rounded-pill bg-danger text-white"></span> </div>
					<div class="search-field"></div>
					<div class="status-field"></div>
				</div>
				<div class="invoices-container"></div>
			</section>`),this.$component=this.wrapper.find(".past-order-list"),this.$invoices_container=this.$component.find(".invoices-container"),this.$invoice_count=this.$component.find(".invoice-count")}bind_events(){this.search_field.$input.on("input",t=>{clearTimeout(this.last_search),this.last_search=setTimeout(()=>{let i=t.target.value;this.refresh_list(i,this.status_field.get_value())},300)});let e=this;this.$invoices_container.on("click",".invoice-wrapper",function(){let t=unescape($(this).attr("data-invoice-name"));e.events.open_invoice_data(t)}),this.$invoices_container.off("keydown",".invoice-wrapper").on("keydown",".invoice-wrapper",function(t){let i=e.$invoices_container.find(".invoice-wrapper"),s=i.index($(this)),o=s;switch(t.which){case 13:$(this).trigger("click");break;case 38:o=s>0?s-1:i.length-1;break;case 40:o=s<i.length-1?s+1:0;break;default:return}i.eq(o).focus()}),frappe.ui.keys.add_shortcut({shortcut:"ctrl+i",action:()=>{let t=e.$invoices_container.find(".invoice-wrapper");t.length&&t.first().focus()},condition:()=>e.$invoices_container.is(":visible"),description:__("Activate Cart Item Focus"),ignore_inputs:!0,page:cur_page.page.page})}make_filter_section(){let e=this;this.search_field=frappe.ui.form.make_control({df:{label:__("Search"),fieldtype:"Data",placeholder:__("Search by invoice id or customer name")},parent:this.$component.find(".search-field"),render_input:!0}),this.status_field=frappe.ui.form.make_control({df:{label:__("Invoice Status"),fieldtype:"Select",options:"Draft",placeholder:__("Filter by invoice status"),onchange:function(){e.$component.is(":visible")&&e.refresh_list()}},parent:this.$component.find(".status-field"),render_input:!0}),this.search_field.toggle_label(!0),this.status_field.toggle_label(!1),this.status_field.set_value("Draft"),setTimeout(()=>{this.search_field.$input.focus()},100)}refresh_list(e=1){frappe.dom.freeze(),this.events.reset_summary();let t=this.search_field.get_value(),i=this.status_field.get_value(),s=this.events.pos_profile(),o=this.events.source_warehouse();this.$invoices_container.html("");let a=40,r=(e-1)*a;return frappe.call({method:"custom_app.customapp.page.amesco_point_of_sale.amesco_point_of_sale.get_past_order_list",freeze:!0,args:{search_term:t,status:i,pos_profile:s,limit:a,offset:r},callback:n=>{frappe.dom.unfreeze(),n.message.forEach(d=>{let _=this.get_invoice_html(d);this.$invoices_container.append(_)}),this.$invoice_count.text(n.message.length),this.render_pagination_controls(e,n.message.length)}})}get_invoice_html(e){let t=moment(e.posting_date+" "+e.posting_time).format("Do MMMM, h:mma");return`<div class="invoice-wrapper" tabindex="0" data-invoice-name="${escape(e.name)}">
				<div class="invoice-name-date">
					<div class="invoice-name">${e.name}</div>
					<div class="invoice-date">
						<svg class="mr-2" width="12" height="12" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round">
							<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
						</svg>
						${frappe.ellipsis(e.customer_name,20)}
					</div>
				</div>
				<div class="invoice-total-status">
					<div class="invoice-total">${format_currency(e.grand_total,e.currency)||0}</div>
					<div class="invoice-date">${t}</div>
				</div>
			</div>
			<div class="seperator"></div>`}toggle_component(e){e?this.$component.css("display","flex")&&this.refresh_list():this.$component.css("display","none")}};custom_app.PointOfSale.PastOrderSummary=class{constructor({wrapper:e,events:t}){this.wrapper=e,this.events=t,this.init_component()}init_component(){this.prepare_dom(),this.init_email_print_dialog(),this.bind_events(),this.attach_shortcuts()}prepare_dom(){this.wrapper.append(`<section class="past-order-summary">
				<div class="no-summary-placeholder">
					${__("Select an invoice to load summary data")}
				</div>
				<div class="invoice-summary-wrapper" style="width:50rem !important;">
					<div class="abs-container">
						<div class="upper-section"></div>
						<div class="label">${__("Items")}</div>
						<div class="items-container summary-container"></div>
						<div class="label">${__("Totals")}</div>
						<div class="totals-container summary-container"></div>
						<div class="label">${__("Payments")}</div>
						<div class="payments-container summary-container"></div>
						<div class="summary-btns"></div>
					</div>
				</div>
			</section>`),this.$component=this.wrapper.find(".past-order-summary"),this.$summary_wrapper=this.$component.find(".invoice-summary-wrapper"),this.$summary_container=this.$component.find(".abs-container"),this.$upper_section=this.$summary_container.find(".upper-section"),this.$items_container=this.$summary_container.find(".items-container"),this.$totals_container=this.$summary_container.find(".totals-container"),this.$payment_container=this.$summary_container.find(".payments-container"),this.$summary_btns=this.$summary_container.find(".summary-btns")}init_email_print_dialog(){let e=new frappe.ui.Dialog({title:"Email Receipt",fields:[{fieldname:"email_id",fieldtype:"Data",options:"Email",label:"Email ID",reqd:1},{fieldname:"content",fieldtype:"Small Text",label:"Message (if any)"}],primary_action:()=>{this.send_email()},primary_action_label:__("Send")});this.email_dialog=e;let t=new frappe.ui.Dialog({title:"Print Receipt",fields:[{fieldname:"print",fieldtype:"Data",label:"Print Preview"}],primary_action:()=>{this.print_receipt()},primary_action_label:__("Print")});this.print_dialog=t}get_upper_section_html(e){let{status:t}=e,i="",s=t==="Draft"?e.custom_pa_name:e.custom_cashier_name;return["Paid","Consolidated"].includes(t)&&(i="green"),t==="Draft"&&(i="red"),t==="Return"&&(i="grey"),`<div class="left-section">
					<div class="customer-name">${e.customer_name}</div>
					<div class="customer-email">${this.customer_email}</div>
					<div class="cashier"> Take by:  ${__(s)}</div>
				</div>
				<div class="right-section">
					<div class="paid-amount">${format_currency(e.grand_total,e.currency)}</div>
					<div class="invoice-name">${e.name}</div>
					<span class="indicator-pill whitespace-nowrap ${i}"><span>${e.status}</span></span>
				</div>`}get_item_html(e,t){return`<div class="item-row-wrapper">
					<div class="item-name">${t.item_name}</div>
					<div class="item-qty"></div>
					<div class="item-rate-disc">${i()}</div>
				</div>`;function i(){let s="",o=`<span class="item-amount" style="padding-left:1rem;">${format_currency(t.amount,e.currency)}</span>`,a=`<span class="qty" style="padding-left:1rem;">${t.qty||0} ${t.uom}</span>`;return t.rate&&t.price_list_rate&&t.rate!==t.price_list_rate?s=`<span class="item-disc">(${t.discount_percentage}% off)</span>
							 <div class="item-rate">${format_currency(t.rate,e.currency)}</div>`:s=`<div class="item-rate">${format_currency(t.price_list_rate||t.rate,e.currency)}</div>`,`${s} ${a} ${o}`}}get_discount_html(e){return e.discount_amount?`<div class="summary-row-wrapper">
						<div>Discount (${e.additional_discount_percentage} %)</div>
						<div>${format_currency(e.discount_amount,e.currency)}</div>
					</div>`:""}get_vatable_sales_html(e){return`<div class="summary-row-wrapper">
					<div>${__("VATable Sales")}</div>
					<div>${format_currency(e.custom_vatable_sales,e.currency)}</div>
				</div>`}get_vatable_exempt_html(e){return`<div class="summary-row-wrapper">
					<div>${__("VAT-Exempt Sales")}</div>
					<div>${format_currency(e.custom_vat_exempt_sales,e.currency)}</div>
				</div>`}get_zero_rated_html(e){return`<div class="summary-row-wrapper">
					<div>${__("Zero-Rated")}</div>
					<div>${format_currency(e.custom_zero_rated_sales,e.currency)}</div>
				</div>`}get_vat_amount_html(e){return`<div class="summary-row-wrapper">
					<div>${__("VAT 12%")}</div>
					<div>${format_currency(e.custom_vat_amount,e.currency)}</div>
				</div>`}get_net_total_html(e){return`<div class="summary-row-wrapper">
					<div>${__("Net Total")}</div>
					<div>${format_currency(e.net_total,e.currency)}</div>
				</div>`}get_grand_total_html(e){return`<div class="summary-row-wrapper grand-total">
					<div>${__("Grand Total")}</div>
					<div>${format_currency(e.grand_total,e.currency)}</div>
				</div>`}get_payment_html(e,t){return`<div class="summary-row-wrapper payments">
					<div>${__(t.mode_of_payment)}</div>
					<div>${format_currency(t.amount,e.currency)}</div>
				</div>
				<div class="summary-row-wrapper change">
					<div>${__("Change")}</div>
					<div>${format_currency(e.change_amount,e.currency)}</div>
				</div>
				`}bind_events(){this.$summary_container.on("click",".return-btn",()=>{this.events.process_return(this.doc.name),this.toggle_component(!1),this.$component.find(".no-summary-placeholder").css("display","flex"),this.$summary_wrapper.css("display","none")}),this.$summary_container.on("click",".edit-btn",()=>{this.events.edit_order(this.doc.name),this.toggle_component(!1),this.$component.find(".no-summary-placeholder").css("display","flex"),this.$summary_wrapper.css("display","none")}),this.$summary_container.on("click",".delete-btn",()=>{this.events.delete_order(this.doc.name),this.show_summary_placeholder()}),this.$summary_container.on("click",".delete-btn",()=>{this.events.delete_order(this.doc.name),this.show_summary_placeholder()}),this.$summary_container.on("click",".new-btn",()=>{this.events.new_order(),this.toggle_component(!1),this.$component.find(".no-summary-placeholder").css("display","flex"),this.$summary_wrapper.css("display","none")}),this.$summary_container.on("click",".email-btn",()=>{this.email_dialog.fields_dict.email_id.set_value(this.customer_email),this.email_dialog.show()}),this.$summary_container.on("click",".print-btn",()=>{this.print_receipt()}),this.$summary_container.on("click",".proceed-btn",()=>{this.events.proceed_order(this.doc.name),this.toggle_component(!1),this.$component.find(".no-summary-placeholder").css("display","flex"),this.$summary_wrapper.css("display","none")})}print_receipt(){let e=this.events.get_frm();frappe.utils.print(this.doc.doctype,this.doc.name,e.pos_print_format,this.doc.letter_head,this.doc.language||frappe.boot.lang)}attach_shortcuts(){let e=frappe.utils.is_mac()?"\u2318":"Ctrl";this.$summary_container.find(".print-btn").attr("title",`${e}+P`),frappe.ui.keys.add_shortcut({shortcut:"ctrl+p",action:()=>this.$summary_container.find(".print-btn").click(),condition:()=>this.$component.is(":visible")&&this.$summary_container.find(".print-btn").is(":visible"),description:__("Print Receipt"),page:cur_page.page.page}),this.$summary_container.find(".new-btn").attr("title",`${e}+Enter`),frappe.ui.keys.on("ctrl+enter",()=>{this.$component.is(":visible")&&this.$summary_container.find(".new-btn").is(":visible")&&this.$summary_container.find(".new-btn").click()}),this.$summary_container.find(".edit-btn").attr("title",`${e}+>`),frappe.ui.keys.add_shortcut({shortcut:"ctrl+>",action:()=>this.$summary_container.find(".edit-btn").click(),condition:()=>this.$component.is(":visible")&&this.$summary_container.find(".edit-btn").is(":visible"),description:__("Edit Receipt"),page:cur_page.page.page}),this.$summary_container.find(".proceed-btn").attr("title",`${e}+O`),frappe.ui.keys.add_shortcut({shortcut:"ctrl+o",action:()=>this.$summary_container.find(".proceed-btn").click(),condition:()=>this.$component.is(":visible")&&this.$summary_container.find(".proceed-btn").is(":visible"),description:__("Proceed Order"),page:cur_page.page.page}),this.$summary_container.find(".edit-btn").attr("title",`${e}+E`),frappe.ui.keys.add_shortcut({shortcut:"ctrl+e",action:()=>this.$summary_container.find(".edit-btn").click(),condition:()=>this.$component.is(":visible")&&this.$summary_container.find(".edit-btn").is(":visible"),description:__("Edit Order"),page:cur_page.page.page}),this.$summary_container.find(".delete-btn").attr("title",`${e}+X`),frappe.ui.keys.add_shortcut({shortcut:"ctrl+x",action:()=>this.$summary_container.find(".delete-btn").click(),condition:()=>this.$component.is(":visible")&&this.$summary_container.find(".delete-btn").is(":visible"),description:__("Delete Order"),page:cur_page.page.page})}send_email(){let e=this.events.get_frm(),t=this.email_dialog.get_values().email_id,i=this.email_dialog.get_values().content,s=this.doc||e.doc,o=e.pos_print_format;frappe.call({method:"frappe.core.doctype.communication.email.make",args:{recipients:t,subject:__(e.meta.name)+": "+s.name,content:i||__(e.meta.name)+": "+s.name,doctype:s.doctype,name:s.name,send_email:1,print_format:o,sender_full_name:frappe.user.full_name(),_lang:s.language},callback:a=>{a.exc?frappe.msgprint(__("There were errors while sending email. Please try again.")):(frappe.utils.play_sound("email"),a.message.emails_not_sent_to?frappe.msgprint(__("Email not sent to {0} (unsubscribed / disabled)",[frappe.utils.escape_html(a.message.emails_not_sent_to)])):frappe.show_alert({message:__("Email sent successfully."),indicator:"green"}),this.email_dialog.hide())}})}add_summary_btns(e){this.$summary_btns.html(""),e.forEach(t=>{t.condition&&t.visible_btns.forEach(i=>{let s=i.split(" ")[0].toLowerCase(),o=__(i);this.$summary_btns.append(`<div class="summary-btn btn btn-default ${s}-btn">${o}</div>`)})}),this.$summary_btns.children().last().removeClass("mr-4")}toggle_summary_placeholder(e){e?(this.$summary_wrapper.css("display","none"),this.$component.find(".no-summary-placeholder").css("display","flex")):(this.$summary_wrapper.css("display","flex"),this.$component.find(".no-summary-placeholder").css("display","none"))}get_condition_btn_map(e){return e?[{condition:!0,visible_btns:["Print Receipt","Email Receipt","New Order"]}]:[{condition:this.doc.docstatus===0,visible_btns:["Edit Order","Proceed Order"]},{condition:!this.doc.is_return&&this.doc.docstatus===1,visible_btns:["Print Receipt","Email Receipt","Return"]},{condition:this.doc.is_return&&this.doc.docstatus===1,visible_btns:["Print Receipt","Email Receipt"]}]}load_summary_of(e,t=!1){t?this.$component.css("grid-column","span 10 / span 10"):this.$component.css("grid-column","span 6 / span 6"),this.toggle_summary_placeholder(!1),this.doc=e,this.attach_document_info(e),this.attach_items_info(e),this.attach_totals_info(e),this.attach_payments_info(e);let i=this.get_condition_btn_map(t);this.add_summary_btns(i)}attach_document_info(e){frappe.db.get_value("Customer",this.doc.customer,"email_id").then(({message:t})=>{this.customer_email=t.email_id||"";let i=this.get_upper_section_html(e);this.$upper_section.html(i)})}attach_items_info(e){this.$items_container.html(""),e.items.forEach(t=>{let i=this.get_item_html(e,t);this.$items_container.append(i),this.set_dynamic_rate_header_width()})}set_dynamic_rate_header_width(){let e=Array.from(this.$items_container.find(".item-rate-disc"));this.$items_container.find(".item-rate-disc").css("width","");let t=e.reduce((i,s)=>($(s).width()>i&&(i=$(s).width()),i),0);t+=1,t==1&&(t=""),this.$items_container.find(".item-rate-disc").css("width",t)}attach_payments_info(e){if(this.$payment_container.html(""),e.payments.forEach(t=>{if(t.amount){let i=this.get_payment_html(e,t);this.$payment_container.append(i)}}),e.redeem_loyalty_points&&e.loyalty_amount){let t=this.get_payment_html(e,{mode_of_payment:"Loyalty Points",amount:e.loyalty_amount});this.$payment_container.append(t)}}attach_totals_info(e){this.$totals_container.html("");let t=this.get_net_total_html(e),i=this.get_vatable_sales_html(e),s=this.get_vatable_exempt_html(e),o=this.get_zero_rated_html(e),a=this.get_vat_amount_html(e),r=this.get_discount_html(e),n=this.get_grand_total_html(e);this.$totals_container.append(t),this.$totals_container.append(i),this.$totals_container.append(s),this.$totals_container.append(o),this.$totals_container.append(a),this.$totals_container.append(r),this.$totals_container.append(n)}toggle_component(e){e?this.$component.css({display:"flex","grid-column":"span 6 / span 6"}):this.$component.css("display","none")}};custom_app.PointOfSale.Controller=class{constructor(e){this.wrapper=$(e).find(".layout-main-section"),this.page=e.page,this.check_opening_entry()}fetch_opening_entry(){return frappe.call("custom_app.customapp.page.amesco_point_of_sale.amesco_point_of_sale.check_opening_entry",{user:frappe.session.user})}check_opening_entry(){this.fetch_opening_entry().then(e=>{if(e.message.length){let t=e.message[0];localStorage.setItem("pos_profile",t.pos_profile),console.log("r.message:",e.message[0].pos_profile),console.log("user: ",frappe.session.user);let i=localStorage.getItem("pos_profile");i&&(t.pos_profile=i,console.log("savedPosProfile:","true")),this.prepare_app_defaults(t)}else this.create_opening_voucher()})}create_opening_voucher(){let e=this,t=[{fieldname:"mode_of_payment",fieldtype:"Link",in_list_view:1,label:"Mode of Payment",options:"Mode of Payment",read_only:1,reqd:1},{fieldname:"opening_amount",fieldtype:"Currency",in_list_view:1,label:"Opening Amount",read_only:1,options:"company:company_currency",change:function(){o.fields_dict.balance_details.df.data.some(r=>{if(r.idx==this.doc.idx)return r.opening_amount=this.value,o.fields_dict.balance_details.grid.refresh(),!0})}}],i=()=>{let r=o.fields_dict.pos_profile.get_value();!r||frappe.db.get_doc("POS Profile",r).then(({payments:n})=>{o.fields_dict.balance_details.df.data=[],n.forEach(d=>{let{mode_of_payment:_}=d;if(_==="Cash"){let g="1500";o.fields_dict.balance_details.df.data.push({mode_of_payment:_,opening_amount:g})}}),o.fields_dict.balance_details.grid.refresh()})},s=async r=>{let n=await frappe.call({method:"custom_app.customapp.page.amesco_point_of_sale.amesco_point_of_sale.get_shift_count",args:{pos_profile:r}}),_=(await frappe.call({method:"custom_app.customapp.page.amesco_point_of_sale.amesco_point_of_sale.get_pos_profile_shift",args:{pos_profile:r}})).message;if(n.message>=_)throw frappe.msgprint(__("You have already reached the maximum of shifts for todays opening")),frappe.utils.play_sound("error"),new Error("Max shifts reached");return`Shift ${n.message+1}`},o=new frappe.ui.Dialog({title:__("Create POS Opening Entry"),static:!0,fields:[{fieldtype:"Link",label:__("Company"),default:frappe.defaults.get_default("company"),options:"Company",fieldname:"company",reqd:1},{fieldtype:"Link",label:__("POS Profile"),options:"POS Profile",fieldname:"pos_profile",reqd:1,get_query:()=>a(),onchange:()=>i()},{fieldname:"balance_details",fieldtype:"Table",label:"Opening Balance Details",cannot_add_rows:!1,in_place_edit:!0,reqd:1,data:[],fields:t,read_only:1}],primary_action:async function({company:r,pos_profile:n,balance_details:d}){try{let _=await s(n);if(!d.length)return frappe.show_alert({message:__("Please add Mode of payments and opening balance details."),indicator:"red"}),frappe.utils.play_sound("error");d=d.filter(p=>p.mode_of_payment);let g="custom_app.customapp.page.amesco_point_of_sale.amesco_point_of_sale.create_opening_voucher",u=await frappe.call({method:g,args:{pos_profile:n,company:r,balance_details:d,custom_shift:_},freeze:!0});u.exc||e.prepare_app_defaults(u.message),o.hide()}catch(_){console.error("Error creating POS Opening Entry:",_)}},primary_action_label:__("Submit")});o.show();let a=()=>({query:"erpnext.accounts.doctype.pos_profile.pos_profile.pos_profile_query",filters:{company:o.fields_dict.company.get_value()}})}async prepare_app_defaults(e){this.pos_opening=e.name,this.company=e.company,this.pos_profile=e.pos_profile,this.pos_opening_time=e.period_start_date,this.item_stock_map={},this.settings={},frappe.db.get_value("Stock Settings",void 0,"allow_negative_stock").then(({message:t})=>{this.allow_negative_stock=flt(t.allow_negative_stock)||!1}),frappe.call({method:"custom_app.customapp.page.amesco_point_of_sale.amesco_point_of_sale.get_pos_profile_data",args:{pos_profile:this.pos_profile},callback:t=>{let i=t.message;Object.assign(this.settings,i),this.settings.customer_groups=i.customer_groups.map(s=>s.name),this.make_app()}})}set_opening_entry_status(){this.page.set_title_sub(`<span class="indicator orange">
				<a class="text-muted" href="#Form/POS%20Opening%20Entry/${this.pos_opening}">
					Opened at ${moment(this.pos_opening_time).format("Do MMMM, h:mma")}
				</a>
			</span>`)}make_app(){this.prepare_dom(),this.prepare_components(),this.toggle_recent_order_list(!0),this.add_buttons_to_toolbar(),this.prepare_menu(),this.make_new_invoice()}prepare_dom(){this.wrapper.append('<div class="point-of-sale-app"></div>'),this.$components_wrapper=this.wrapper.find(".point-of-sale-app")}prepare_components(){this.init_recent_order_list(),this.init_order_summary(),this.init_item_selector(),this.init_item_details(),this.init_item_cart(),this.init_payments()}prepare_menu(){this.page.clear_menu(),this.page.add_menu_item(__("Item Selector (F1)"),this.add_new_order.bind(this),!1,"f1"),this.page.add_menu_item(__("Pending Transaction (F2)"),this.pending_orders.bind(this),!1,"f2"),this.page.add_menu_item(__("Save as Draft"),this.save_draft_invoice.bind(this),!1,"f3"),this.page.add_menu_item(__("Check Encashment"),this.check_encashment.bind(this),!1,"f6"),this.page.add_menu_item(__("Z Reading (BIR)"),this.z_reading.bind(this),!1,"f5"),this.page.add_menu_item(__("DSRS"),this.dsrs_reading.bind(this),!1,"f0"),this.page.add_menu_item(__("Close the POS(X Reading)"),this.close_pos.bind(this),!1,"Shift+Ctrl+C")}add_buttons_to_toolbar(){let e=[{label:__("Item Selector (F1)"),action:this.add_new_order.bind(this),shortcut:"f1"},{label:__("Pending Transaction (F2)"),action:this.pending_orders.bind(this),shortcut:"f2"},{label:__("Save as Draft (F3)"),action:this.save_draft_invoice.bind(this),shortcut:"f3"},{label:__("Amesco Plus Member"),action:this.amesco_plus_scan.bind(this),shortcut:"f4"},{label:__("Close the POS(X Reading)"),action:this.close_pos.bind(this),shortcut:"Shift+Ctrl+C"}];$(".page-actions .btn-custom").remove(),e.forEach(t=>{this.page.add_button(t.label,t.action,{shortcut:t.shortcut}).addClass("btn-custom")})}showPasswordDialog(e,t){let i=new frappe.ui.Dialog({title:__(e),fields:[{fieldname:"password",fieldtype:"Password",label:__("Password"),reqd:1}],primary_action_label:__("Authorize"),primary_action:s=>{let o=s.password;frappe.call({method:"custom_app.customapp.page.amesco_point_of_sale.amesco_point_of_sale.confirm_user_password",args:{password:o},callback:a=>{a.message.name?(frappe.show_alert({message:__("Verified"),indicator:"green"}),i.hide(),t()):frappe.show_alert({message:__("Incorrect password or user is not an OIC"),indicator:"red"})}})}});i.show()}showSystemManagerPasswordDialog(e,t){let i=new frappe.ui.Dialog({title:__(e),fields:[{fieldname:"password",fieldtype:"Password",label:__("Password"),reqd:1}],primary_action_label:__("Authorize"),primary_action:s=>{let o=s.password;frappe.call({method:"custom_app.customapp.page.amesco_point_of_sale.amesco_point_of_sale.confirm_system_manager_password",args:{password:o},callback:a=>{a.message.name?(frappe.show_alert({message:__("Verified"),indicator:"green"}),i.hide(),t()):frappe.show_alert({message:__("Incorrect password or user is not an OIC"),indicator:"red"})}})}});i.show()}z_reading(){let e=()=>{!this.$components_wrapper.is(":visible")||frappe.db.get_doc("POS Profile",this.frm.doc.pos_profile).then(t=>{let i=frappe.model.get_new_doc("POS Z Reading");i.pos_profile=this.frm.doc.pos_profile,i.date_from=t.custom_start_operating_date,i.date_to=frappe.datetime.now_datetime(),frappe.set_route("Form","POS Z Reading",i.name)}).catch(t=>{console.error("Error fetching POS Profile:",t),frappe.msgprint(__("Failed to fetch POS Profile. Please try again."))})};this.showSystemManagerPasswordDialog("System Manager Authorization Required for Z Reading",e)}dsrs_reading(){let e=()=>{if(!this.$components_wrapper.is(":visible"))return;let t=frappe.model.get_new_doc("POS Daily Sales Report Summary");t.pos_profile=this.frm.doc.pos_profile,t.custom_date_created=frappe.datetime.now_datetime(),frappe.set_route("Form","POS Daily Sales Report Summary",t.name)};this.showPasswordDialog("OIC Authorization Required for DSRS",e)}cash_voucher(){if(!this.$components_wrapper.is(":visible"))return;let e=frappe.model.get_new_doc("Cash Voucher Entry");e.custom_pos_profile=this.frm.doc.pos_profile,e.custom_cashier=frappe.session.user,e.custom_opening_entry=this.pos_opening,frappe.set_route("Form","Cash Voucher Entry",e.name)}check_encashment(){let e=()=>{if(!this.$components_wrapper.is(":visible"))return;let t=frappe.model.get_new_doc("Check Encashment Entry");t.custom_pos_profile=this.frm.doc.pos_profile,t.custom_received_by=frappe.session.user,t.custom_opening_entry=this.pos_opening,frappe.set_route("Form","Check Encashment Entry",t.name).catch(i=>{console.error("Error fetching POS Profile:",i),frappe.msgprint(__("Failed to fetch POS Profile. Please try again."))})};this.showPasswordDialog("OIC Authorization Required for Check Encashment Entry",e)}add_new_order(){frappe.run_serially([()=>this.frm.reload_doc(),()=>frappe.dom.freeze(__("Starting new order...")),()=>this.frm.call("reset_mode_of_payments"),()=>this.cart.load_invoice(),()=>this.remove_pos_cart_items(),()=>this.make_new_invoice(),()=>this.item_selector.toggle_component(!0),()=>this.item_details.toggle_item_details_section(!1),()=>this.toggle_recent_order_list(!1),()=>$(".payment-container").css("display","none"),()=>frappe.dom.unfreeze()]).then(()=>{frappe.show_alert({message:__("New order started successfully!"),indicator:"green"}),$(document).off("keydown.changeDialog")}).catch(e=>{frappe.msgprint({title:__("Error"),message:__("Failed to start a new order: ")+e.message,indicator:"red"}),console.error("Error in add_new_order:",e),frappe.dom.unfreeze()})}remove_pos_cart_items(){localStorage.removeItem("posCartItems")}pending_orders(){frappe.run_serially([()=>frappe.dom.freeze(),()=>this.item_selector.toggle_component(!1),()=>this.toggle_recent_order_list(!0),()=>$(".payment-container").css("display","none"),()=>frappe.dom.unfreeze()])}amesco_plus_scan(){let t=this.frm,i=new frappe.ui.Dialog({title:__("Enter Scanned Data"),fields:[{label:"Scanned Data",fieldname:"scanned_data",fieldtype:"Data",reqd:1,description:"Enter the scanned data (comma-separated format)"}],primary_action_label:__("Submit"),primary_action(s){let o=s.scanned_data.split(",");if(o.length>=5){let a=o[0],r=o[2],n=o[3],d=o[4];t.set_value("custom_ameso_user",n),t.set_value("custom_amesco_user_id",a);let _=new frappe.ui.Dialog({title:__("Scanned User Details"),fields:[{label:"Name",fieldname:"user_name",fieldtype:"Data",read_only:1,default:r},{label:"Email",fieldname:"email",fieldtype:"Data",read_only:1,default:n},{label:"Points",fieldname:"points",fieldtype:"Data",read_only:1,default:d}],primary_action_label:__("Close"),primary_action:function(){_.hide()}});_.show()}else frappe.msgprint(__("Invalid data format. Please enter at least 5 comma-separated values."));i.hide()}});i.show()}set_discount_log(e,t,i){e.set_value("custom_ameso_user",updated_discount_log),e.set_value("custom_manual_dicsount",updated_discount_log)}handle_scanned_barcode(e){console.log("Scanned Barcode:",e)}open_form_view(){frappe.model.sync(this.frm.doc),frappe.set_route("Form",this.frm.doc.doctype,this.frm.doc.name)}toggle_recent_order(){let e=this.recent_order_list.$component.is(":hidden");this.toggle_recent_order_list(e),this.payment.toggle_component(!1),this.item_details.toggle_component(!1)}save_draft_invoice(){if(!!this.$components_wrapper.is(":visible")){if(this.frm.doc.items.length==0){frappe.show_alert({message:__("You must add atleast one item to save it as draft."),indicator:"red"}),frappe.utils.play_sound("error");return}this.frm.save(void 0,void 0,void 0,()=>{frappe.show_alert({message:__("There was an error saving the document."),indicator:"red"}),frappe.utils.play_sound("error")}).then(()=>{frappe.run_serially([()=>this.toggle_recent_order_list(show)])})}}save_draft(){if(!this.$components_wrapper.is(":visible"))return;if(this.frm.doc.items.length==0){frappe.show_alert({message:__("You must add atleast one item to complete the order."),indicator:"red"}),frappe.utils.play_sound("error");return}let e=new frappe.ui.Dialog({title:__("Enter Your Password"),fields:[{fieldname:"password",fieldtype:"Password",label:__("Password"),reqd:1}],primary_action_label:__("Ok"),primary_action:t=>{let i=t.password;frappe.call({method:"custom_app.customapp.page.packing_list.packing_list.get_user_details_by_password",args:{password:i},callback:s=>{s.message.name?(this.set_pharmacist_assist(this.frm,s.message.name),this.frm.save(void 0,void 0,void 0,()=>{frappe.show_alert({message:__("There was an error saving the document."),indicator:"red"}),frappe.utils.play_sound("error")}).then(()=>{frappe.run_serially([()=>frappe.dom.freeze(),()=>this.make_new_invoice(),()=>frappe.dom.unfreeze()]),e.hide(),localStorage.removeItem("posCartItems")})):frappe.show_alert({message:`${s.message.error}`,indicator:"red"})}})}});e.show()}close_pos(){let e=this,t=new frappe.ui.Dialog({title:__("Authorization Required OIC"),fields:[{fieldname:"password",fieldtype:"Password",label:__("Password"),reqd:1}],primary_action_label:__("Authorize"),primary_action:i=>{let s=i.password;frappe.call({method:"custom_app.customapp.page.amesco_point_of_sale.amesco_point_of_sale.confirm_user_password",args:{password:s},callback:o=>{if(o.message.error)frappe.show_alert({message:__("Incorrect password or user"),indicator:"red"});else{if(frappe.show_alert({message:__("Verified"),indicator:"green"}),t.hide(),!this.$components_wrapper.is(":visible"))return;let a=frappe.model.get_new_doc("POS Closing Entry");a.pos_profile=this.frm.doc.pos_profile,a.user=frappe.session.user,a.company=this.frm.doc.company,a.pos_opening_entry=this.pos_opening,a.period_end_date=frappe.datetime.now_datetime(),a.posting_date=frappe.datetime.now_date(),a.posting_time=frappe.datetime.now_time(),frappe.set_route("Form","POS Closing Entry",a.name)}}})}});t.show()}cash_count(){if(!this.$components_wrapper.is(":visible"))return;let e=frappe.model.get_new_doc("Cash Count Denomination Entry");e.custom_pos_profile=this.frm.doc.pos_profile,e.user=frappe.session.user,e.custom_pos_opening_entry_id=this.pos_opening,frappe.set_route("Form","Cash Count Denomination Entry",e.name)}init_item_selector(){this.selected_uom="PC",this.item_selector=new custom_app.PointOfSale.ItemSelector({wrapper:this.$components_wrapper,pos_profile:this.pos_profile,settings:this.settings,events:{item_selected:e=>{frappe.call({method:"custom_app.customapp.page.amesco_point_of_sale.amesco_point_of_sale.get_pos_warehouse",args:{pos_profile:this.pos_profile},callback:t=>{if(t.message){let i=t.message,s=localStorage.getItem("selected_warehouse");if(i===s||s===null)this.on_cart_update(e);else{frappe.show_alert({message:__("You cannot add items from a different branch."),indicator:"red"}),frappe.utils.play_sound("error");return}}else{frappe.show_alert({message:__("Could not retrieve the warehouse for the POS Profile."),indicator:"red"}),frappe.utils.play_sound("error");return}}})},get_frm:()=>this.frm||{},get_pos_profile:()=>this.pos_profile}})}init_item_cart(){this.cart=new custom_app.PointOfSale.ItemCart({wrapper:this.$components_wrapper,settings:this.settings,events:{get_frm:()=>this.frm,cart_item_clicked:e=>{let t=this.get_item_from_frm(e);this.item_details.toggle_item_details_section(t)},numpad_event:(e,t)=>this.update_item_field(e,t),checkout:()=>this.save_and_checkout(),edit_cart:()=>this.payment.edit_cart(),customer_details_updated:e=>{this.customer_details=e,this.payment.render_loyalty_points_payment_mode()}}})}init_item_details(){this.item_details=new custom_app.PointOfSale.ItemDetails({wrapper:this.$components_wrapper,settings:this.settings,events:{get_frm:()=>this.frm,toggle_item_selector:e=>{this.item_selector.resize_selector(e),this.cart.toggle_numpad(e)},form_updated:(e,t,i)=>{let s=frappe.model.get_doc(e.doctype,e.name);if(s&&s[t]!=i){let o={field:t,value:i,item:this.item_details.current_item};return this.on_cart_update(o)}return Promise.resolve()},highlight_cart_item:e=>{let t=this.cart.get_cart_item(e);this.cart.toggle_item_highlight(t)},item_field_focused:e=>{this.cart.toggle_numpad_field_edit(e)},set_value_in_current_cart_item:(e,t)=>{this.cart.update_selector_value_in_cart_item(e,t,this.item_details.current_item)},clone_new_batch_item_in_frm:(e,t)=>{Object.keys(e).forEach(i=>{let s=this.frm.doc.items.find(r=>r.name==t.name),o=this.frm.doc.items.find(r=>r.latest_expiry_date==t.latest_expiry_date),a=this.frm.add_child("items",A({},s));a.batch_no=i,a.serial_no=e[i].join(`
`),a.qty=e[i].length,this.frm.doc.items.forEach(r=>{t.item_code===r.item_code&&this.update_cart_html(r)})})},remove_item_from_cart:()=>this.remove_item_from_cart(),get_item_stock_map:()=>this.item_stock_map,close_item_details:()=>{this.item_details.toggle_item_details_section(null),this.cart.prev_action=null,this.cart.toggle_item_highlight()},get_available_stock:(e,t)=>this.get_available_stock(e,t)}})}init_payments(){this.payment=new custom_app.PointOfSale.Payment({wrapper:this.$components_wrapper,events:{get_frm:()=>this.frm||{},get_customer_details:()=>this.customer_details||{},toggle_other_sections:e=>{e?(this.item_details.$component.is(":visible")&&this.item_details.$component.css("display","none"),this.item_selector.toggle_component(!1)):this.item_selector.toggle_component(!0)},submit_invoice:()=>{let e=this.frm.doc.payments.reduce((i,s)=>i+s.amount,0);if(parseFloat(e.toFixed(2))<this.frm.doc.grand_total){let i=new frappe.ui.Dialog({title:__("Insufficient Payment"),primary_action_label:__("OK"),primary_action:()=>{i.hide()}});i.body.innerHTML=`
							<div style="text-align: center; font-size: 30px; margin: 20px 0;">
								${__("The payment amount is not enough to cover the grand total.")}
							</div>
						`,i.show();return}let t=!1;this.frm.save("Submit",void 0,void 0,()=>{frappe.show_alert({message:__("There was an error saving the document."),indicator:"red"}),frappe.utils.play_sound("error"),t=!0}).then(()=>{if(t)return;this.toggle_components(!1),this.cart.toggle_component(!1),this.order_summary.toggle_component(!1),this.remove_pos_cart_items(),this.order_summary.load_summary_of(this.frm.doc,!0),this.order_summary.print_receipt();let i=e-this.frm.doc.grand_total,s=new frappe.ui.Dialog({title:__("Change Amount"),secondary_action_label:__("Item Selector(F1)"),secondary_action:()=>{this.add_new_order(),s.hide()},primary_action_label:__("Pending Orders"),primary_action:()=>{this.pending_orders(),s.hide()}});s.body.innerHTML=`
							<div style="text-align: center; font-size: 60px; margin: 20px 0;">
								${format_currency(i)}
							</div>
						`,s.show(),$(document).off("keydown.changeDialog").on("keydown.changeDialog",o=>{o.key==="Enter"&&(o.preventDefault(),s.primary_action())}),$(document).off("keydown.changeDialog").on("keydown.changeDialog",o=>{o.key==="F1"&&(o.preventDefault(),s.secondary_action())})})}}})}init_recent_order_list(){this.recent_order_list=new custom_app.PointOfSale.PastOrderList({wrapper:this.$components_wrapper,events:{get_frm:()=>this.frm,open_invoice_data:e=>{frappe.db.get_doc("POS Invoice",e).then(t=>{this.order_summary.load_summary_of(t)})},pos_profile:()=>this.pos_profile,source_warehouse:()=>this.settings.warehouse,reset_summary:()=>this.order_summary.toggle_summary_placeholder(!0)}})}init_order_summary(){this.order_summary=new custom_app.PointOfSale.PastOrderSummary({wrapper:this.$components_wrapper,events:{get_frm:()=>this.frm,process_return:e=>{this.recent_order_list.toggle_component(!1),frappe.db.get_doc("POS Invoice",e).then(t=>{frappe.run_serially([()=>this.make_return_invoice(t),()=>this.cart.load_invoice(),()=>this.item_selector.toggle_component(!0)])})},edit_order:e=>{this.oic_edit_confirm(e)},delete_order:e=>{this.oic_delete_confirm(e)},new_order:()=>{frappe.run_serially([()=>frappe.dom.freeze(),()=>this.make_new_invoice(),()=>this.cart.load_invoice(),()=>this.item_selector.toggle_component(!0),()=>frappe.dom.unfreeze()])},proceed_order:e=>{this.recent_order_list.toggle_component(!1),frappe.run_serially([()=>this.frm.reload_doc(),()=>this.frm.refresh(e),()=>this.cart.load_invoice(),()=>this.item_selector.toggle_component(!0),()=>this.payment.toggle_component(!0),()=>this.save_and_checkout(!0),()=>this.cart.toggle_checkout_btn(!1)])},order_list:()=>{frappe.run_serially([()=>frappe.dom.freeze(),()=>this.item_selector.toggle_component(!1),()=>this.toggle_recent_order_list(!0),()=>frappe.dom.unfreeze()])}}})}oic_edit_confirm(e){this.passwordDialog&&(this.passwordDialog.$wrapper.remove(),delete this.passwordDialog);let t=!1;this.passwordDialog=new frappe.ui.Dialog({title:__("Authorization Required OIC"),fields:[{fieldtype:"HTML",fieldname:"password_html",options:`
						<div class="form-group">
							<label for="password_field">${__("Password")}</label>
							<input type="password" id="password_field" class="form-control" required>
						</div>
					`}],primary_action_label:__("Authorize"),primary_action:()=>{let i=document.getElementById("password_field").value;frappe.call({method:"custom_app.customapp.page.packing_list.packing_list.confirm_user_password",args:{password:i},callback:s=>{s.message?s.message.name?(t=!0,frappe.show_alert({message:__("Verified"),indicator:"green"}),frappe.run_serially([()=>this.frm.refresh(e),()=>this.cart.load_invoice(),()=>this.item_selector.toggle_component(!0),()=>this.toggle_recent_order_list(!1),()=>this.item_selector.load_items_data()]).then(()=>{this.passwordDialog.hide()})):frappe.show_alert({message:__("Incorrect password or user is not an OIC"),indicator:"red"}):frappe.show_alert({message:__("Incorrect password or user is not an OIC"),indicator:"red"})}})}}),this.passwordDialog.$wrapper.on("hidden.bs.modal",()=>{t||window.location.reload()}),this.passwordDialog.show(),this.passwordDialog.$wrapper.on("shown.bs.modal",()=>{setTimeout(()=>{document.getElementById("password_field").focus()},100)})}oic_delete_confirm(e){let t=new frappe.ui.Dialog({title:__("Enter OIC Password"),fields:[{fieldname:"password",fieldtype:"Password",label:__("Password"),reqd:1}],primary_action_label:__("Authenticate"),primary_action:i=>{let s=i.password,o="oic";frappe.call({method:"custom_app.customapp.page.amesco_point_of_sale.amesco_point_of_sale.confirm_user_password",args:{password:s,role:o},callback:a=>{a.message?frappe.model.delete_doc(this.frm.doc.doctype,e,()=>{this.recent_order_list.refresh_list(),this.recent_order_list.toggle_component(!0),t.hide()}):frappe.show_alert({message:__("Incorrect password or user is not an OIC"),indicator:"red"})}})}});t.show()}toggle_recent_order_list(e){this.recent_order_list.toggle_component(e),this.order_summary.toggle_component(e),this.cart.toggle_component(!e),this.item_selector.toggle_component(!e),e||this.item_details.toggle_component(!1)||this.payment.toggle_component(!1)}toggle_components(e){this.cart.toggle_component(!e),this.item_selector.toggle_component(e),e||this.item_details.toggle_component(!1)||this.payment.toggle_component(!1)}make_new_invoice(){return frappe.run_serially([()=>frappe.dom.freeze(),()=>this.make_sales_invoice_frm(),()=>this.set_pos_profile_data(),()=>this.set_pos_profile_status(),()=>this.cart.load_invoice(),()=>frappe.dom.unfreeze(),()=>this.cart.toggle_component(!1)])}make_sales_invoice_frm(){let e="POS Invoice";return new Promise(t=>{this.frm?(this.frm=this.get_new_frm(this.frm),this.frm.doc.pos_profile=this.pos_profile,this.frm.doc.items=[],this.frm.doc.is_pos=1,t()):frappe.model.with_doctype(e,()=>{this.frm=this.get_new_frm(),this.frm.doc.items=[],this.frm.doc.is_pos=1,t()})})}get_new_frm(e){let t="POS Invoice",i=$("<div>"),s=e||new frappe.ui.form.Form(t,i,!1),o=frappe.model.make_new_doc_and_get_name(t,!0);return s.refresh(o),s}async make_return_invoice(e){return frappe.dom.freeze(),this.frm=this.get_new_frm(this.frm),this.frm.doc.items=[],frappe.call({method:"erpnext.accounts.doctype.pos_invoice.pos_invoice.make_sales_return",args:{source_name:e.name,target_doc:this.frm.doc},callback:t=>{frappe.model.sync(t.message),frappe.get_doc(t.message.doctype,t.message.name).__run_link_triggers=!1,this.set_pos_profile_data().then(()=>{frappe.dom.unfreeze()})}})}set_pos_profile_data(){if(this.company&&!this.frm.doc.company&&(this.frm.doc.company=this.company),(this.pos_profile&&!this.frm.doc.pos_profile)|(this.frm.doc.is_return&&this.pos_profile!=this.frm.doc.pos_profile)&&(this.frm.doc.pos_profile=this.pos_profile),!!this.frm.doc.company)return this.frm.trigger("set_pos_data")}set_pos_profile_status(){this.page.set_indicator(this.pos_profile,"blue")}async on_cart_update(e){frappe.dom.freeze();let t;try{let{field:i,value:s,item:o}=e;t=this.get_item_from_frm(o);let a=!$.isEmptyObject(t),r=i==="qty"&&s==="+1";if(r&&(s=flt(t.stock_qty)+flt(s)),a){if(i==="qty"&&(s=flt(s)),["qty","conversion_factor"].includes(i)&&s>0&&!this.allow_negative_stock){let n=i==="qty"?s*t.conversion_factor:t.qty*s;await this.check_stock_availability(t,n,this.frm.doc.set_warehouse)}(this.is_current_item_being_edited(t)||r)&&(await frappe.model.set_value(t.doctype,t.name,i,s),this.update_cart_html(t))}else{if(!this.frm.doc.customer)return this.raise_customer_selection_alert();let{item_code:n,batch_no:d,serial_no:_,rate:g,uom:u}=o;if(!n)return;let p={item_code:n,batch_no:d,rate:g,uom:u,[i]:s};if(_&&_!=="undefined"&&(await this.check_serial_no_availablilty(n,this.frm.doc.set_warehouse,_),p.serial_no=_),i==="serial_no"&&(p.qty=s.split(`
`).length||0),t=this.frm.add_child("items",p),i==="qty"&&s!==0&&!this.allow_negative_stock){let h=s*t.conversion_factor;await this.check_stock_availability(t,h,this.frm.doc.set_warehouse)}await this.trigger_new_item_events(t),this.update_cart_html(t),this.item_details.$component.is(":visible")&&this.edit_item_details_of(t),this.check_serial_batch_selection_needed(t)&&!this.item_details.$component.is(":visible")&&this.edit_item_details_of(t)}}catch(i){console.log(i)}finally{return frappe.dom.unfreeze(),t}}raise_customer_selection_alert(){frappe.dom.unfreeze(),frappe.show_alert({message:__("You must select a customer before adding an item."),indicator:"orange"}),frappe.utils.play_sound("error")}get_item_from_frm({name:e,item_code:t,batch_no:i,uom:s,rate:o}){let a=null;if(e)a=this.frm.doc.items.find(r=>r.name==e);else{let r=i!=="null"&&i!==null;a=this.frm.doc.items.find(n=>n.item_code===t&&(!r||r&&n.batch_no===i)&&n.uom===s&&n.rate===flt(o))}return a||{}}edit_item_details_of(e){this.item_details.toggle_item_details_section(e)}is_current_item_being_edited(e){return e.name==this.item_details.current_item.name}update_cart_html(e,t){this.cart.update_item_html(e,t),this.cart.update_totals_section(this.frm)}check_serial_batch_selection_needed(e){let t=e.has_serial_no,i=e.has_batch_no,s=!e.serial_no,o=!e.batch_no;return!!(t&&s||i&&o||t&&i&&(o||s))}async trigger_new_item_events(e){await this.frm.script_manager.trigger("item_code",e.doctype,e.name),await this.frm.script_manager.trigger("qty",e.doctype,e.name)}async check_stock_availability(e,t,i){let s=(await this.get_available_stock(e.item_code,i)).message,o=s[0],a=s[1];frappe.dom.unfreeze();let r=e.stock_uom.bold(),n=e.item_code.bold(),d=i.bold(),_=o.toString().bold();if(o>0)a&&o<t&&(frappe.throw({message:__("Stock quantity not enough for Item Code: {0} under warehouse {1}. Available quantity {2} {3}.",[n,d,_,r]),indicator:"orange"}),frappe.utils.play_sound("error"));else if(a)frappe.model.clear_doc(e.doctype,e.name),frappe.throw({title:__("Not Available"),message:__("Item Code: {0} is not available under warehouse {1}.",[n,d])});else return;frappe.dom.freeze()}async check_serial_no_availablilty(e,t,i){let s="erpnext.stock.doctype.serial_no.serial_no.get_pos_reserved_serial_nos",o={filters:{item_code:e,warehouse:t}};(await frappe.call({method:s,args:o})).message.includes(i)&&frappe.throw({title:"Not Available",message:[i.bold()]})}get_available_stock(e,t){let i=this;return frappe.call({method:"erpnext.accounts.doctype.pos_invoice.pos_invoice.get_stock_availability",args:{item_code:e,warehouse:t},callback(s){i.item_stock_map[e]||(i.item_stock_map[e]={}),i.item_stock_map[e][t]=s.message}})}async auto_add_batch(e){try{let t=await frappe.db.get_list("Batch",{filters:{item:e.item_code,expiry_date:[">=",frappe.datetime.now_date()]},fields:["name","expiry_date"],order_by:"expiry_date desc"});if(t.length>0){let s=[{batch_no:t[0].name,qty:e.qty,name:"row 1",warehouse:this.frm.doc.set_warehouse}],o=await frappe.call({method:"erpnext.stock.doctype.serial_and_batch_bundle.serial_and_batch_bundle.add_serial_batch_ledgers",args:{entries:s,child_row:e,doc:this.frm.doc,warehouse:this.frm.doc.set_warehouse}});frappe.model.set_value(e.doctype,e.name,{serial_and_batch_bundle:o.message.name,qty:Math.abs(o.message.total_qty)})}}catch(t){frappe.show_alert({message:__("Batch fetch failed. Please try again."),indicator:"red"}),console.error(t)}}async update_item_field(e,t){if(t==="checkout")this.item_details.toggle_item_details_section(null);else if(t==="remove")this.remove_item_from_cart();else{let i=this.item_details[`${t}_control`];if(!i)return;i.set_focus(),e!=""&&i.set_value(e)}}remove_item_from_cart(){let e=new frappe.ui.Dialog({title:__("Enter OIC Password"),fields:[{fieldname:"password",fieldtype:"Password",label:__("Password"),reqd:1}],primary_action_label:__("Ok"),primary_action:t=>{let i=t.password;frappe.call({method:"custom_app.customapp.page.amesco_point_of_sale.amesco_point_of_sale.confirm_user_password",args:{password:i},callback:s=>{if(s.message)if(s.message.name){frappe.dom.freeze();let{doctype:o,name:a,current_item:r}=this.item_details;frappe.model.set_value(o,a,"qty",0).then(()=>{frappe.model.clear_doc(o,a),this.update_cart_html(r,!0),this.item_details.toggle_item_details_section(null),frappe.dom.unfreeze(),e.hide()}).catch(n=>{console.log(n),frappe.dom.unfreeze(),e.hide()})}else frappe.show_alert({message:"Incorrect password",indicator:"red"});else frappe.show_alert({message:"Incorrect password",indicator:"red"})}})}});e.show()}async save_and_checkout(){if(this.frm.is_dirty()){let e=!1;!e&&this.payment.checkout(),e&&setTimeout(()=>{this.cart.toggle_checkout_btn(!0)},300)}else this.payment.checkout()}};})();
//# sourceMappingURL=amesco-point-of-sale.bundle.4MKDGLIR.js.map
